<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>TaktLab + WB – Cycle Time & Capacity Analyzer</title>

<style>
  :root{
    /* Base: blanco sobrio */
    --bg-main:#ffffff;
    --bg-soft:#f5f7fb;

    /* Cards por sección (paleta sobria) */
    --card-blue:#f3f9ff;
    --card-green:#f3fff9;
    --card-amber:#fffaf0;
    --card-red:#fff5f6;
    --card-gray:#f6f7f9;

    --border:rgba(0,0,0,.08);
    --shadow:0 10px 26px rgba(0,0,0,.06);

    --text:#101828;
    --text-muted:#475467;

    --accent-blue:#2e90fa;
    --accent-green:#12b76a;
    --accent-amber:#f79009;
    --accent-red:#f04438;

    --btn:#101828;
    --btnText:#ffffff;

    --radius:18px;
  }

  *{ box-sizing:border-box; }
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    background:var(--bg-main);
    color:var(--text);
  }

  .container{
    max-width:1200px;
    margin:0 auto;
    padding:18px;
  }

  /* Header */
  .topHeader{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:12px;
    margin-bottom:14px;
  }
  .brand{
    display:flex;
    flex-direction:column;
    gap:4px;
  }
  .brand h1{
    margin:0;
    font-size:1.25rem;
    letter-spacing:.2px;
  }
  .brand p{
    margin:0;
    color:var(--text-muted);
    font-weight:700;
    font-size:.9rem;
  }

  .kpiStrip{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    justify-content:flex-end;
  }
  .kpi{
    background:var(--card-gray);
    border:1px solid var(--border);
    border-radius:14px;
    padding:10px 12px;
    min-width:150px;
    box-shadow:0 6px 16px rgba(0,0,0,.04);
  }
  .kpi .label{
    font-size:.75rem;
    color:var(--text-muted);
    font-weight:900;
    letter-spacing:.4px;
    text-transform:uppercase;
  }
  .kpi .value{
    margin-top:6px;
    font-size:1.05rem;
    font-weight:1000;
  }

  /* Sticky timer bar */
  .stickyBar{
    position:sticky;
    top:0;
    z-index:50;
    background:rgba(255,255,255,.92);
    backdrop-filter:blur(8px);
    border:1px solid var(--border);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    padding:12px;
    margin-bottom:14px;
  }
  .barRow{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    flex-wrap:wrap;
  }
  .timerLeft{
    display:flex;
    align-items:center;
    gap:12px;
    flex-wrap:wrap;
  }
  .clock{
    font-size:1.4rem;
    font-weight:1000;
    letter-spacing:.6px;
    padding:8px 12px;
    border-radius:14px;
    background:var(--bg-soft);
    border:1px solid var(--border);
    min-width:150px;
    text-align:center;
  }
  .badge{
    font-weight:900;
    font-size:.85rem;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid var(--border);
    background:rgba(0,0,0,.04);
    color:var(--text-muted);
  }
  .tagInput{
    display:flex;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
  }
  .tagInput label{
    font-weight:900;
    color:var(--text-muted);
    font-size:.85rem;
  }
  input[type="text"], input[type="number"], textarea, select{
    border:1px solid var(--border);
    border-radius:12px;
    padding:10px 12px;
    font-weight:800;
    outline:none;
    background:#fff;
    color:var(--text);
  }
  textarea{
    width:100%;
    min-height:88px;
    resize:vertical;
  }

  .btnRow{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    justify-content:flex-end;
  }
  .btn{
    border:none;
    border-radius:12px;
    padding:10px 12px;
    font-weight:1000;
    cursor:pointer;
    background:var(--btn);
    color:var(--btnText);
    box-shadow:0 10px 24px rgba(16,24,40,.15);
  }
  .btn:active{ transform:translateY(1px); }
  .btn.secondary{
    background:#344054;
  }
  .btn.green{
    background:var(--accent-green);
  }
  .btn.blue{
    background:var(--accent-blue);
  }
  .btn.red{
    background:var(--accent-red);
  }
  .btn.amber{
    background:var(--accent-amber);
    color:#111;
  }

  /* Layout grid */
  .grid{
    display:grid;
    grid-template-columns: 1.1fr .9fr;
    gap:14px;
  }
  @media (max-width: 980px){
    .grid{ grid-template-columns: 1fr; }
  }

  /* Cards */
  .card{
    border-radius:var(--radius);
    border:1px solid var(--border);
    box-shadow:var(--shadow);
    overflow:hidden;
  }
  .cardHead{
    padding:12px 14px;
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:12px;
  }
  .cardHead h2{
    margin:0;
    font-size:1rem;
    font-weight:1000;
    letter-spacing:.2px;
  }
  .cardHead p{
    margin:4px 0 0 0;
    color:var(--text-muted);
    font-weight:800;
    font-size:.85rem;
  }
  .cardBody{
    padding:12px 14px 14px 14px;
  }

  .blue{ background:var(--card-blue); }
  .green{ background:var(--card-green); }
  .amber{ background:var(--card-amber); }
  .red{ background:var(--card-red); }
  .gray{ background:var(--card-gray); }

  /* Tables */
  table{
    width:100%;
    border-collapse:collapse;
    background:#fff;
    border:1px solid var(--border);
    border-radius:14px;
    overflow:hidden;
  }
  th{
    text-align:left;
    padding:10px;
    font-size:.78rem;
    letter-spacing:.3px;
    text-transform:uppercase;
    color:var(--text-muted);
    background:rgba(0,0,0,.03);
    border-bottom:1px solid var(--border);
  }
  td{
    padding:10px;
    border-bottom:1px solid rgba(0,0,0,.06);
    font-weight:800;
  }
  tr:last-child td{ border-bottom:none; }

  .twoCol{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
  }
  @media (max-width: 700px){
    .twoCol{ grid-template-columns: 1fr; }
  }

  .field{
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .field label{
    font-size:.78rem;
    font-weight:1000;
    color:var(--text-muted);
    text-transform:uppercase;
    letter-spacing:.35px;
  }

  .pill{
    display:inline-block;
    padding:8px 10px;
    border-radius:999px;
    border:1px solid var(--border);
    font-weight:1000;
    background:rgba(0,0,0,.04);
    color:var(--text-muted);
  }

  canvas{
    width:100%;
    height:170px;
    background:#fff;
    border:1px solid var(--border);
    border-radius:14px;
    display:block;
  }

  .miniNote{
    margin-top:8px;
    font-weight:800;
    color:var(--text-muted);
    font-size:.9rem;
  }

  .footerSpace{ height:24px; }
</style>
</head>

<body>
<div class="container">

  <div class="topHeader">
    <div class="brand">
      <h1>TaktLab + WB</h1>
      <p>Cycle Time & Capacity Analyzer (white + sobrio)</p>
    </div>

    <div class="kpiStrip">
      <div class="kpi">
        <div class="label">Median</div>
        <div class="value" id="kpiMedian">—</div>
      </div>
      <div class="kpi">
        <div class="label">P10 / P90</div>
        <div class="value" id="kpiP10P90">—</div>
      </div>
      <div class="kpi">
        <div class="label">Samples</div>
        <div class="value" id="kpiSamples">0</div>
      </div>
    </div>
  </div>

  <!-- Sticky timer bar -->
  <div class="stickyBar">
    <div class="barRow">
      <div class="timerLeft">
        <div class="clock" id="timerClock">00:00.0</div>
        <span class="badge" id="runBadge">Stopped</span>

        <div class="tagInput">
          <label for="lapTag">Tag</label>
          <input id="lapTag" type="text" placeholder="e.g. Machine A / Load-Unload / Note" />
        </div>
      </div>

      <div class="btnRow">
        <button class="btn green" id="btnStart">Start</button>
        <button class="btn blue" id="btnLap">Lap</button>
        <button class="btn secondary" id="btnStop">Stop</button>
        <button class="btn red" id="btnReset">Reset</button>
      </div>
    </div>
  </div>
  <div class="grid">

    <!-- LEFT COLUMN -->
    <div style="display:flex; flex-direction:column; gap:14px;">

      <!-- Contract vs Capacity Summary (primero) -->
      <div class="card green">
        <div class="cardHead">
          <div>
            <h2>Contract vs Capacity Summary (WB)</h2>
            <p>Compara Contract (UPH) vs tu UPH efectivo y pérdidas (minutos).</p>
          </div>
          <span class="pill" id="wbDecision">—</span>
        </div>

        <div class="cardBody">
          <div class="twoCol">
            <div class="field">
              <label>Contract (UPH)</label>
              <input id="wbContract" type="number" min="0" step="0.1" value="0" />
            </div>
            <div class="field">
              <label>Ideal CT (sec) (optional)</label>
              <input id="wbIdealCT" type="number" min="0" step="0.01" value="0" />
            </div>
          </div>

          <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn amber" id="btnUseMedian">Use Median CT</button>
            <button class="btn blue" id="btnWBCalc">Recalc</button>
            <button class="btn red" id="btnWBClear">Clear</button>
          </div>

          <div style="margin-top:12px;" class="twoCol">
            <div class="field">
              <label>Net Minutes</label>
              <div class="pill" id="wbNetMin">—</div>
            </div>
            <div class="field">
              <label>Theoretical Pieces</label>
              <div class="pill" id="wbTheoPcs">—</div>
            </div>
          </div>

          <div style="margin-top:10px;" class="twoCol">
            <div class="field">
              <label>Effective UPH</label>
              <div class="pill" id="wbUPH">—</div>
            </div>
            <div class="field">
              <label>Explain</label>
              <div class="miniNote" id="wbExplain">—</div>
            </div>
          </div>

          <div style="margin-top:10px;">
            <canvas id="wbCanvas" height="170"></canvas>
          </div>
        </div>
      </div>

      <!-- Data Controls (más grande) -->
      <div class="card blue">
        <div class="cardHead">
          <div>
            <h2>Data Controls (WB inputs)</h2>
            <p>Todos son desplegables como pediste (sin “cosas raras”).</p>
          </div>
          <span class="pill">Dropdown-only</span>
        </div>

        <div class="cardBody">
          <div class="twoCol">
            <div class="field">
              <label>Operators (0–10)</label>
              <select id="wbOperators"></select>
            </div>
            <div class="field">
              <label>Shift (1–4)</label>
              <select id="wbShift"></select>
            </div>
          </div>

          <div class="twoCol" style="margin-top:10px;">
            <div class="field">
              <label>Hours (0–24, step 0.5)</label>
              <select id="wbHours"></select>
            </div>
            <div class="field">
              <label>Machines (1–50)</label>
              <select id="wbMachines"></select>
            </div>
          </div>

          <div class="twoCol" style="margin-top:10px;">
            <div class="field">
              <label>Lunch (0–1440 min)</label>
              <select id="wbLunch"></select>
            </div>
            <div class="field">
              <label>Changeover (1–1440 min)</label>
              <select id="wbChangeover"></select>
            </div>
          </div>

          <div class="twoCol" style="margin-top:10px;">
            <div class="field">
              <label>5S (0–1440 min)</label>
              <select id="wb5s"></select>
            </div>
            <div class="field">
              <label>Maintenance (1–1440 min)</label>
              <select id="wbMaint"></select>
            </div>
          </div>

          <div class="twoCol" style="margin-top:10px;">
            <div class="field">
              <label>Other (0–1440 min)</label>
              <select id="wbOther"></select>
            </div>
            <div class="field">
              <label>Shared (0–1440 min daily)</label>
              <select id="wbShared"></select>
            </div>
          </div>

          <div class="twoCol" style="margin-top:10px;">
            <div class="field">
              <label>Scrap (0–100%)</label>
              <select id="wbScrap"></select>
            </div>
            <div class="field">
              <label>A / P / Q (0–100%)</label>
              <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px;">
                <select id="wbA"></select>
                <select id="wbP"></select>
                <select id="wbQ"></select>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Notes -->
      <div class="card gray">
        <div class="cardHead">
          <div>
            <h2>Notes</h2>
            <p>Se exportan en CSV junto con tus laps.</p>
          </div>
          <span class="pill">Optional</span>
        </div>
        <div class="cardBody">
          <textarea id="notes" placeholder="Write notes here… (line, model, constraints, observations)"></textarea>
        </div>
      </div>

    </div>
  <div class="grid">

    <!-- LEFT COLUMN -->
    <div style="display:flex; flex-direction:column; gap:14px;">

      <!-- Contract vs Capacity Summary (primero) -->
      <div class="card green">
        <div class="cardHead">
          <div>
            <h2>Contract vs Capacity Summary (WB)</h2>
            <p>Compara Contract (UPH) vs tu UPH efectivo y pérdidas (minutos).</p>
          </div>
          <span class="pill" id="wbDecision">—</span>
        </div>

        <div class="cardBody">
          <div class="twoCol">
            <div class="field">
              <label>Contract (UPH)</label>
              <input id="wbContract" type="number" min="0" step="0.1" value="0" />
            </div>
            <div class="field">
              <label>Ideal CT (sec) (optional)</label>
              <input id="wbIdealCT" type="number" min="0" step="0.01" value="0" />
            </div>
          </div>

          <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn amber" id="btnUseMedian">Use Median CT</button>
            <button class="btn blue" id="btnWBCalc">Recalc</button>
            <button class="btn red" id="btnWBClear">Clear</button>
          </div>

          <div style="margin-top:12px;" class="twoCol">
            <div class="field">
              <label>Net Minutes</label>
              <div class="pill" id="wbNetMin">—</div>
            </div>
            <div class="field">
              <label>Theoretical Pieces</label>
              <div class="pill" id="wbTheoPcs">—</div>
            </div>
          </div>

          <div style="margin-top:10px;" class="twoCol">
            <div class="field">
              <label>Effective UPH</label>
              <div class="pill" id="wbUPH">—</div>
            </div>
            <div class="field">
              <label>Explain</label>
              <div class="miniNote" id="wbExplain">—</div>
            </div>
          </div>

          <div style="margin-top:10px;">
            <canvas id="wbCanvas" height="170"></canvas>
          </div>
        </div>
      </div>

      <!-- Data Controls (más grande) -->
      <div class="card blue">
        <div class="cardHead">
          <div>
            <h2>Data Controls (WB inputs)</h2>
            <p>Todos son desplegables como pediste (sin “cosas raras”).</p>
          </div>
          <span class="pill">Dropdown-only</span>
        </div>

        <div class="cardBody">
          <div class="twoCol">
            <div class="field">
              <label>Operators (0–10)</label>
              <select id="wbOperators"></select>
            </div>
            <div class="field">
              <label>Shift (1–4)</label>
              <select id="wbShift"></select>
            </div>
          </div>

          <div class="twoCol" style="margin-top:10px;">
            <div class="field">
              <label>Hours (0–24, step 0.5)</label>
              <select id="wbHours"></select>
            </div>
            <div class="field">
              <label>Machines (1–50)</label>
              <select id="wbMachines"></select>
            </div>
          </div>

          <div class="twoCol" style="margin-top:10px;">
            <div class="field">
              <label>Lunch (0–1440 min)</label>
              <select id="wbLunch"></select>
            </div>
            <div class="field">
              <label>Changeover (1–1440 min)</label>
              <select id="wbChangeover"></select>
            </div>
          </div>

          <div class="twoCol" style="margin-top:10px;">
            <div class="field">
              <label>5S (0–1440 min)</label>
              <select id="wb5s"></select>
            </div>
            <div class="field">
              <label>Maintenance (1–1440 min)</label>
              <select id="wbMaint"></select>
            </div>
          </div>

          <div class="twoCol" style="margin-top:10px;">
            <div class="field">
              <label>Other (0–1440 min)</label>
              <select id="wbOther"></select>
            </div>
            <div class="field">
              <label>Shared (0–1440 min daily)</label>
              <select id="wbShared"></select>
            </div>
          </div>

          <div class="twoCol" style="margin-top:10px;">
            <div class="field">
              <label>Scrap (0–100%)</label>
              <select id="wbScrap"></select>
            </div>
            <div class="field">
              <label>A / P / Q (0–100%)</label>
              <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px;">
                <select id="wbA"></select>
                <select id="wbP"></select>
                <select id="wbQ"></select>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Notes -->
      <div class="card gray">
        <div class="cardHead">
          <div>
            <h2>Notes</h2>
            <p>Se exportan en CSV junto con tus laps.</p>
          </div>
          <span class="pill">Optional</span>
        </div>
        <div class="cardBody">
          <textarea id="notes" placeholder="Write notes here… (line, model, constraints, observations)"></textarea>
        </div>
      </div>

    </div>
<script>
/* ===================== Helpers ===================== */
const $ = (id) => document.getElementById(id);

const fmt = (n, d=2) => {
  if (!isFinite(n)) return "—";
  return Number(n).toLocaleString(undefined, { minimumFractionDigits: d, maximumFractionDigits: d });
};

const clamp = (v, a, b) => Math.max(a, Math.min(b, v));

function percentile(sortedArr, p){
  if(!sortedArr.length) return NaN;
  const i = (sortedArr.length - 1) * p;
  const lo = Math.floor(i);
  const hi = Math.ceil(i);
  if (lo === hi) return sortedArr[lo];
  const w = i - lo;
  return sortedArr[lo] * (1 - w) + sortedArr[hi] * w;
}

function mean(arr){
  if(!arr.length) return NaN;
  return arr.reduce((a,b)=>a+b,0)/arr.length;
}
function stddev(arr){
  if(arr.length < 2) return NaN;
  const m = mean(arr);
  const v = arr.reduce((s,x)=>s+(x-m)*(x-m),0)/(arr.length-1);
  return Math.sqrt(v);
}
function trimmedMean(arr, trimFrac=0.10){
  if(!arr.length) return NaN;
  const s = [...arr].sort((a,b)=>a-b);
  const k = Math.floor(s.length * trimFrac);
  const mid = s.slice(k, s.length-k);
  return mean(mid);
}

/* ===================== State ===================== */
let laps = []; // seconds (float)
let lapTags = []; // strings
let timerRunning = false;
let t0 = 0;
let lastLapMark = 0;
let tickHandle = null;

/* ===================== Timer UI ===================== */
function setTimerText(sec){
  const s = Math.max(0, sec);
  const m = Math.floor(s/60);
  const r = s - m*60;
  $("timerClock").textContent = `${String(m).padStart(2,"0")}:${String(Math.floor(r)).padStart(2,"0")}.${String(Math.floor((r%1)*10))}`;
}

function updateRunBadge(){
  const b = $("runBadge");
  if(timerRunning){
    b.textContent = "Running";
    b.style.background = "rgba(18,183,106,.14)";
    b.style.borderColor = "rgba(18,183,106,.35)";
    b.style.color = "#0f5132";
  }else{
    b.textContent = "Stopped";
    b.style.background = "rgba(0,0,0,.04)";
    b.style.borderColor = "rgba(0,0,0,.10)";
    b.style.color = "var(--text-muted)";
  }
}

function startTimer(){
  if(timerRunning) return;
  timerRunning = true;
  t0 = performance.now();
  lastLapMark = t0;
  updateRunBadge();
  tickHandle = setInterval(()=>{
    const now = performance.now();
    setTimerText((now - t0)/1000);
  }, 100);
}

function stopTimer(){
  if(!timerRunning) return;
  timerRunning = false;
  updateRunBadge();
  clearInterval(tickHandle);
  tickHandle = null;
}

function resetTimer(){
  stopTimer();
  setTimerText(0);
}

/* ===================== Laps ===================== */
function addLap(){
  if(!timerRunning) return;
  const now = performance.now();
  const lapSec = (now - lastLapMark)/1000;
  lastLapMark = now;

  laps.push(lapSec);
  lapTags.push(($("lapTag").value || "").trim());
  renderLaps();
  computeAndRenderStats();
}

function removeLapAt(i){
  laps.splice(i,1);
  lapTags.splice(i,1);
  renderLaps();
  computeAndRenderStats();
}

function undoLap(){
  if(!laps.length) return;
  laps.pop();
  lapTags.pop();
  renderLaps();
  computeAndRenderStats();
}

function clearLaps(){
  laps = [];
  lapTags = [];
  renderLaps();
  computeAndRenderStats();
}

function renderLaps(){
  const body = $("lapsBody");
  body.innerHTML = "";
  laps.forEach((sec, i)=>{
    const tr = document.createElement("tr");
    tr.style.borderTop = "1px solid rgba(0,0,0,.06)";
    tr.innerHTML = `
      <td style="padding:10px; font-weight:1000; font-size:.85rem;">${i+1}</td>
      <td style="padding:10px; font-weight:900;">${fmt(sec,2)}</td>
      <td style="padding:10px; font-weight:900;">${fmt(sec/60,3)}</td>
      <td style="padding:10px; color:var(--text-muted); font-weight:900;">${(lapTags[i]||"—")}</td>
      <td style="padding:10px; text-align:right;">
        <button class="btn" style="background:var(--accent-red); color:#fff; padding:8px 10px;" data-del="${i}">Delete</button>
      </td>
    `;
    body.appendChild(tr);
  });

  body.querySelectorAll("button[data-del]").forEach(btn=>{
    btn.addEventListener("click", (e)=>{
      const idx = Number(e.currentTarget.getAttribute("data-del"));
      removeLapAt(idx);
    });
  });
}

function exportCSV(){
  const rows = [["Lap#", "Seconds", "Minutes", "Tag", "Notes"]];
  const notes = ($("notes").value || "").replace(/\n/g," ").trim();
  laps.forEach((sec,i)=>{
    rows.push([String(i+1), fmt(sec,3), fmt(sec/60,5), (lapTags[i]||""), notes]);
  });
  const csv = rows.map(r=>r.map(x=>{
    const s = String(x ?? "");
    return /[,"\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
  }).join(",")).join("\n");

  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "taktlab_laps.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* ===================== Stats / KPIs ===================== */
function computeSampleTarget(meanVal, sdVal){
  if(!isFinite(meanVal) || meanVal <= 0 || !isFinite(sdVal) || sdVal <= 0) return { nReq: NaN };
  const nReq = Math.ceil(Math.pow((1.96*sdVal)/(0.03*meanVal),2));
  return { nReq };
}

function computeAndRenderStats(){
  if(!laps.length){
    $("kpiPcts").textContent = "—";
    $("kpiMeanStd").textContent = "—";
    $("kpiMinMax").textContent = "—";
    $("kpiTrimmed").textContent = "—";
    $("kpiSampleQuality").textContent = "—";
    $("kpiSampleHelp").textContent = "—";
    $("p25").textContent = "—";
    $("p50").textContent = "—";
    $("p75").textContent = "—";
    $("iqr").textContent = "—";
    $("kpiMedian").textContent = "—";
    $("kpiP10P90").textContent = "—";
    $("kpiSamples").textContent = "0";
    drawDist([]);
    return;
  }

  const s = [...laps].sort((a,b)=>a-b);
  const p10 = percentile(s,0.10);
  const p25 = percentile(s,0.25);
  const p50 = percentile(s,0.50);
  const p75 = percentile(s,0.75);
  const p90 = percentile(s,0.90);

  const m = mean(laps);
  const sd = stddev(laps);
  const cv = (isFinite(m) && m>0 && isFinite(sd)) ? (sd/m*100) : NaN;

  const mn = s[0];
  const mx = s[s.length-1];
  const tmean = trimmedMean(laps, 0.10);
  const iqr = p75 - p25;

  const n = laps.length;
  let msg = `Samples: ${n}`;
  let help = "—";

  if(isFinite(m) && isFinite(sd) && m>0 && sd>0){
    const errPct = (1.96*sd/Math.sqrt(n))/m * 100;
    const { nReq } = computeSampleTarget(m, sd);
    const nReqShow = isFinite(nReq) ? nReq : "—";
    msg = `Samples: ${n} / ${nReqShow} · Est. error: ±${fmt(errPct,1)}% (95%)`;
    if(isFinite(nReq) && n < nReq){
      help = `Sample too small for ±3% – use only as reference.`;
    }else if(isFinite(nReq)){
      help = `OK for ±3% target (95%).`;
    }else{
      help = `Need more data to estimate ±3% target.`;
    }
  }else{
    help = `Need more variation data (keep sampling).`;
  }

  $("kpiPcts").textContent = `${fmt(p10,2)} / ${fmt(p50,2)} / ${fmt(p90,2)} sec`;
  $("kpiMeanStd").textContent = `${fmt(m,2)} / ${fmt(sd,2)} / ${fmt(cv,1)}%`;
  $("kpiMinMax").textContent = `${fmt(mn,2)} / ${fmt(mx,2)} sec`;
  $("kpiTrimmed").textContent = `${fmt(tmean,2)} sec`;
  $("kpiSampleQuality").textContent = msg;
  $("kpiSampleHelp").textContent = help;

  $("p25").textContent = fmt(p25,2);
  $("p50").textContent = fmt(p50,2);
  $("p75").textContent = fmt(p75,2);
  $("iqr").textContent = fmt(iqr,2);

  $("kpiMedian").textContent = `${fmt(p50,2)} s`;
  $("kpiP10P90").textContent = `${fmt(p10,2)} / ${fmt(p90,2)} s`;
  $("kpiSamples").textContent = String(n);

  drawDist(s, {p10,p25,p50,p75,p90});
}

/* ===================== Canvas utils ===================== */
function clearCanvas(c){
  const ctx = c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);
}

function fitCanvasToCSS(canvas){
  const rect = canvas.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;
  const w = Math.max(300, Math.floor(rect.width));
  const h = Math.max(120, canvas.height);
  canvas.width = Math.floor(w * dpr);
  canvas.height = Math.floor(h * dpr);
  const ctx = canvas.getContext("2d");
  ctx.setTransform(dpr,0,0,dpr,0,0);
  return {w, h};
}

function drawDist(sorted, meta={}){
  const c = $("distCanvas");
  const {w,h} = fitCanvasToCSS(c);
  const ctx = c.getContext("2d");
  ctx.clearRect(0,0,w,h);

  if(!sorted.length){
    ctx.font = "12px system-ui";
    ctx.fillText("No data yet.", 10, 20);
    return;
  }

  const min = sorted[0];
  const max = sorted[sorted.length-1];
  const span = Math.max(1e-9, max-min);

  ctx.globalAlpha = 0.55;
  ctx.beginPath();
  ctx.moveTo(10, h-20);
  ctx.lineTo(w-10, h-20);
  ctx.stroke();
  ctx.globalAlpha = 1;

  const bins = 10;
  const counts = Array(bins).fill(0);
  sorted.forEach(v=>{
    const t = clamp((v-min)/span, 0, 0.999999);
    const b = Math.floor(t*bins);
    counts[b] += 1;
  });
  const peak = Math.max(...counts);

  const left = 10, right = w-10, base = h-20, top = 12;
  const bw = (right-left)/bins;

  for(let i=0;i<bins;i++){
    const bh = (counts[i]/Math.max(1,peak))*(base-top);
    ctx.fillRect(left + i*bw + 2, base - bh, bw - 4, bh);
    ctx.globalAlpha = 0.15;
    ctx.strokeRect(left + i*bw + 2, base - bh, bw - 4, bh);
    ctx.globalAlpha = 1;
  }

  const marks = [
    {v: meta.p10, label:"P10"},
    {v: meta.p25, label:"P25"},
    {v: meta.p50, label:"P50"},
    {v: meta.p75, label:"P75"},
    {v: meta.p90, label:"P90"}
  ].filter(x=>isFinite(x.v));

  ctx.font = "12px system-ui";
  marks.forEach((m,i)=>{
    const x = left + ((m.v-min)/span)*(right-left);
    ctx.beginPath();
    ctx.moveTo(x, base);
    ctx.lineTo(x, top);
    ctx.stroke();
    ctx.fillText(m.label, x+4, top+12+(i%2)*14);
  });
}

/* ===================== WB Dropdown Builders ===================== */
function fillSelectRange(sel, start, end, step=1, fmtFn=null){
  sel.innerHTML = "";
  for(let v=start; v<=end+1e-9; v+=step){
    const vv = Math.round(v*1000)/1000;
    const opt = document.createElement("option");
    opt.value = String(vv);
    opt.textContent = fmtFn ? fmtFn(vv) : String(vv);
    sel.appendChild(opt);
  }
}
function fillPercent(sel){
  fillSelectRange(sel, 0, 100, 1, (v)=>`${v}%`);
}

function initWBDropdowns(){
  fillSelectRange($("wbOperators"), 0, 10, 1);
  fillSelectRange($("wbShift"), 1, 4, 1);
  fillSelectRange($("wbHours"), 0, 24, 0.5, (v)=>String(v));
  fillSelectRange($("wbMachines"), 1, 50, 1);

  fillSelectRange($("wbLunch"), 0, 1440, 1);
  fillSelectRange($("wbChangeover"), 1, 1440, 1);
  fillSelectRange($("wb5s"), 0, 1440, 1);
  fillSelectRange($("wbMaint"), 1, 1440, 1);

  fillSelectRange($("wbOther"), 0, 1440, 1);
  fillSelectRange($("wbShared"), 0, 1440, 1);

  fillSelectRange($("wbScrap"), 0, 100, 1, (v)=>`${v}%`);
  fillPercent($("wbA"));
  fillPercent($("wbP"));
  fillPercent($("wbQ"));

  $("wbOperators").value = "1";
  $("wbShift").value = "1";
  $("wbHours").value = "8";
  $("wbMachines").value = "1";

  $("wbLunch").value = "30";
  $("wbChangeover").value = "1";
  $("wb5s").value = "0";
  $("wbMaint").value = "1";
  $("wbOther").value = "0";
  $("wbShared").value = "0";

  $("wbScrap").value = "0";
  $("wbA").value = "100";
  $("wbP").value = "100";
  $("wbQ").value = "100";
}

function wbGetNum(id){
  return Number($(id).value || 0);
}

function wbCalc(){
  const operators = wbGetNum("wbOperators");
  const shiftCount = wbGetNum("wbShift");
  const hours = Number($("wbHours").value || 0);
  const machines = wbGetNum("wbMachines");

  const contractUPH = Number($("wbContract").value || 0);
  let ct = Number($("wbIdealCT").value || 0);

  if(!(ct>0)){
    const medText = $("kpiMedian").textContent;
    const med = parseFloat((medText||"").replace(/[^\d.]/g,""));
    if(isFinite(med) && med>0) ct = med;
  }

  const lunch = wbGetNum("wbLunch");
  const changeover = wbGetNum("wbChangeover");
  const s5 = wbGetNum("wb5s");
  const maint = wbGetNum("wbMaint");
  const other = wbGetNum("wbOther");
  const shared = wbGetNum("wbShared");

  const scrap = wbGetNum("wbScrap")/100;
  const A = wbGetNum("wbA")/100;
  const P = wbGetNum("wbP")/100;
  const Q = wbGetNum("wbQ")/100;

  const totalHours = hours * shiftCount;
  const totalMin = totalHours * 60;

  const losses = lunch + changeover + s5 + maint + other + shared;
  const netMin = Math.max(0, totalMin - losses);

  const effMachines = operators === 0 ? 0 : Math.min(machines, operators);

  const theoPcs = (ct>0 && effMachines>0) ? (netMin*60/ct) * effMachines : 0;

  const afterScrap = theoPcs * (1 - scrap);
  const oee = A * P * Q;
  const effPcs = afterScrap * oee;

  const uph = totalHours>0 ? (effPcs/totalHours) : 0;

  $("wbNetMin").textContent = fmt(netMin,0);
  $("wbTheoPcs").textContent = fmt(theoPcs,0);
  $("wbUPH").textContent = fmt(uph,1);

  const pill = $("wbDecision");
  const explain = $("wbExplain");

  const ok = (contractUPH>0) ? (uph >= contractUPH) : (uph > 0);

  if(contractUPH <= 0){
    pill.textContent = "SET CONTRACT TO COMPARE";
    pill.style.background = "rgba(0,0,0,.04)";
    pill.style.borderColor = "rgba(0,0,0,.10)";
    pill.style.color = "var(--text-muted)";
    explain.textContent = "Ingresa Contract (UPH) para decidir cumplimiento. El cálculo ya trae tu UPH efectivo.";
  }else if(ok){
    pill.textContent = "MEETS CONTRACT ✅";
    pill.style.background = "rgba(18,183,106,.14)";
    pill.style.borderColor = "rgba(18,183,106,.35)";
    pill.style.color = "#0f5132";
    explain.textContent = `UPH efectivo (${fmt(uph,1)}) ≥ Contract (${fmt(contractUPH,1)}).`;
  }else{
    pill.textContent = "BELOW CONTRACT ❌";
    pill.style.background = "rgba(240,68,56,.12)";
    pill.style.borderColor = "rgba(240,68,56,.35)";
    pill.style.color = "#842029";
    explain.textContent = `UPH efectivo (${fmt(uph,1)}) < Contract (${fmt(contractUPH,1)}).`;
  }

  drawWB({uph, contractUPH, netMin, totalMin, losses});
}

function wbClear(){
  $("wbContract").value = "0";
  $("wbIdealCT").value = "0";

  $("wbOperators").value = "1";
  $("wbShift").value = "1";
  $("wbHours").value = "8";
  $("wbMachines").value = "1";

  $("wbLunch").value = "30";
  $("wbChangeover").value = "1";
  $("wb5s").value = "0";
  $("wbMaint").value = "1";
  $("wbOther").value = "0";
  $("wbShared").value = "0";

  $("wbScrap").value = "0";
  $("wbA").value = "100";
  $("wbP").value = "100";
  $("wbQ").value = "100";

  $("wbNetMin").textContent = "—";
  $("wbTheoPcs").textContent = "—";
  $("wbUPH").textContent = "—";
  $("wbDecision").textContent = "—";
  $("wbExplain").textContent = "—";
  clearCanvas($("wbCanvas"));
}

/* ===================== Canvas: WB ===================== */
function drawWB(meta){
  const c = $("wbCanvas");
  const {w,h} = fitCanvasToCSS(c);
  const ctx = c.getContext("2d");
  ctx.clearRect(0,0,w,h);

  const left = 14, right = w-14, top = 14, base = h-22;

  const contract = Math.max(0, meta.contractUPH || 0);
  const uph = Math.max(0, meta.uph || 0);
  const maxV = Math.max(1, contract, uph);

  const barW = 60;
  const gap = 40;
  const x1 = left + 40;
  const x2 = x1 + barW + gap;

  const scale = (base-top) / maxV;

  const h1 = contract * scale;
  const h2 = uph * scale;

  ctx.globalAlpha = 0.55;
  ctx.beginPath();
  ctx.moveTo(left, base);
  ctx.lineTo(right, base);
  ctx.stroke();
  ctx.globalAlpha = 1;

  ctx.fillRect(x1, base - h1, barW, h1);
  ctx.globalAlpha = 0.15;
  ctx.strokeRect(x1, base - h1, barW, h1);
  ctx.globalAlpha = 1;

  ctx.fillRect(x2, base - h2, barW, h2);
  ctx.globalAlpha = 0.15;
  ctx.strokeRect(x2, base - h2, barW, h2);
  ctx.globalAlpha = 1;

  ctx.font = "12px system-ui";
  ctx.fillText("Contract", x1-4, base+16);
  ctx.fillText("UPH", x2+10, base+16);

  ctx.fillText(fmt(contract,1), x1-2, base - h1 - 6);
  ctx.fillText(fmt(uph,1), x2+6, base - h2 - 6);

  ctx.globalAlpha = 0.85;
  ctx.fillText(`Total min: ${fmt(meta.totalMin,0)}  Losses: ${fmt(meta.losses,0)}  Net: ${fmt(meta.netMin,0)}`, left, top+10);
  ctx.globalAlpha = 1;
}

/* ===================== Wiring ===================== */
function wireButtons(){
  $("btnStart").addEventListener("click", ()=> startTimer());
  $("btnLap").addEventListener("click", ()=> addLap());
  $("btnStop").addEventListener("click", ()=> stopTimer());
  $("btnReset").addEventListener("click", ()=> resetTimer());

  $("btnUndoLap").addEventListener("click", ()=> undoLap());
  $("btnClearLaps").addEventListener("click", ()=> clearLaps());
  $("btnExport").addEventListener("click", ()=> exportCSV());

  $("btnUseMedian").addEventListener("click", ()=>{
    const medText = $("kpiMedian").textContent;
    const med = parseFloat((medText||"").replace(/[^\d.]/g,""));
    if(isFinite(med) && med>0){
      $("wbIdealCT").value = String(med.toFixed(2));
    }
  });

  $("btnWBCalc").addEventListener("click", ()=> wbCalc());
  $("btnWBClear").addEventListener("click", ()=> wbClear());

  const wbIds = [
    "wbOperators","wbShift","wbHours","wbMachines","wbLunch","wbChangeover","wb5s","wbMaint",
    "wbOther","wbShared","wbScrap","wbA","wbP","wbQ","wbContract","wbIdealCT"
  ];
  wbIds.forEach(id=>{
    $(id).addEventListener("change", ()=> wbCalc());
    $(id).addEventListener("input", ()=> wbCalc());
  });

  window.addEventListener("resize", ()=>{
    computeAndRenderStats();
    wbCalc();
  });
}

/* ===================== Boot ===================== */
(function init(){
  updateRunBadge();
  setTimerText(0);
  initWBDropdowns();
  wireButtons();
  renderLaps();
  computeAndRenderStats();
  wbCalc();
})();
</script>

</body>
</html>
