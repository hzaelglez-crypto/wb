<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>WB – TaktLab + Workbench</title>

<style>
  :root{
    --bg:#f2f4f7;
    --card:#ffffff;
    --border:#cfd6de;
    --text:#1f2937;
    --muted:#6b7280;
    --good:#16a34a;
    --warn:#f59e0b;
    --bad:#ef4444;
    --blue:#2563eb;
    --soft:#eef2f7;
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    background:var(--bg);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    color:var(--text);
  }

  .topbar{
    position:sticky; top:0; z-index:50;
    background:linear-gradient(180deg,#ffffff, #f7f8fb);
    border-bottom:1px solid var(--border);
    padding:10px 14px;
    display:flex;
    align-items:center;
    gap:10px;
  }
  .brand{
    display:flex; align-items:center; gap:10px;
    font-weight:800;
    letter-spacing:.2px;
  }
  .pill{
    display:inline-flex; align-items:center; gap:8px;
    padding:6px 10px; border-radius:999px;
    background:var(--soft);
    border:1px solid var(--border);
    font-size:12px;
    color:var(--muted);
    white-space:nowrap;
  }
  .spacer{flex:1}

  .btn{
    appearance:none;
    border:1px solid var(--border);
    background:#fff;
    padding:8px 10px;
    border-radius:10px;
    font-weight:700;
    cursor:pointer;
    font-size:13px;
    transition:transform .06s ease, opacity .2s ease;
  }
  .btn:active{transform:scale(.98)}
  .btn.primary{border-color:rgba(37,99,235,.35); background:#f2f6ff; color:#1d4ed8}
  .btn.danger{border-color:rgba(239,68,68,.35); background:#fff1f2; color:#b91c1c}
  .btn.small{padding:6px 8px; border-radius:9px; font-size:12px}
  .btn:disabled{opacity:.55; cursor:not-allowed}

  .wrap{max-width:1180px; margin:14px auto; padding:0 14px 22px}
  .grid{
    display:grid;
    grid-template-columns: 1.1fr .9fr;
    gap:12px;
  }
  @media (max-width: 980px){
    .grid{grid-template-columns:1fr}
  }

  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:16px;
    padding:12px;
    box-shadow:0 2px 10px rgba(31,41,55,.05);
  }
  .cardHead{
    display:flex; align-items:flex-start; gap:10px;
    margin-bottom:8px;
  }
  .cardHead h2{
    margin:0;
    font-size:14px;
    letter-spacing:.2px;
  }
  .cardHead p{
    margin:2px 0 0;
    font-size:12px;
    color:var(--muted);
    line-height:1.25;
  }

  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end}
  .field{min-width:160px; flex:1}
  .field label{
    display:block;
    font-size:12px;
    font-weight:800;
    margin:0 0 4px;
    color:#374151;
  }
  .field .hint{
    font-size:11px;
    color:var(--muted);
    margin-top:4px;
    line-height:1.25;
  }

  input, select, textarea{
    width:100%;
    padding:9px 10px;
    border:1px solid var(--border);
    border-radius:12px;
    font-size:13px;
    outline:none;
    background:#fff;
  }
  textarea{min-height:72px; resize:vertical}

  .split{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
  }
  @media (max-width: 560px){
    .split{grid-template-columns:1fr}
  }

  .kpiBar{
    display:flex; flex-wrap:wrap; gap:8px;
    margin-top:10px;
  }
  .kpi{
    flex:1;
    min-width:170px;
    border:1px solid var(--border);
    background:#fff;
    border-radius:14px;
    padding:10px;
  }
  .kpi .t{font-size:11px; color:var(--muted); font-weight:800}
  .kpi .v{font-size:18px; font-weight:900; margin-top:4px}

  .tabs{
    display:flex; gap:8px; flex-wrap:wrap;
    margin:12px 0 0;
  }
  .tab{
    border:1px solid var(--border);
    background:#fff;
    border-radius:999px;
    padding:8px 12px;
    font-weight:900;
    font-size:12px;
    cursor:pointer;
  }
  .tab.active{
    border-color:rgba(37,99,235,.35);
    background:#f2f6ff;
    color:#1d4ed8;
  }
  .panel{display:none; margin-top:10px}
  .panel.active{display:block}

  table{width:100%; border-collapse:separate; border-spacing:0}
  th, td{
    border-bottom:1px solid var(--border);
    padding:8px 8px;
    font-size:12px;
    text-align:left;
    vertical-align:top;
  }
  th{
    background:#fafbfc;
    color:#374151;
    font-weight:900;
  }
  tr:last-child td{border-bottom:none}

  .badge{
    display:inline-flex;
    align-items:center;
    padding:3px 8px;
    border-radius:999px;
    border:1px solid var(--border);
    background:#fff;
    font-weight:900;
    font-size:11px;
    color:#374151;
    gap:6px;
    white-space:nowrap;
  }
  .badge.good{border-color:rgba(22,163,74,.35); background:#f0fdf4; color:#166534}
  .badge.warn{border-color:rgba(245,158,11,.35); background:#fffbeb; color:#92400e}
  .badge.bad{border-color:rgba(239,68,68,.35); background:#fff1f2; color:#9f1239}

  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  .muted{color:var(--muted)}
  .tight{margin:0}

  .timerBox{
    display:flex; align-items:center; gap:10px; flex-wrap:wrap;
    margin-top:8px;
  }
  .timer{
    font-size:28px;
    font-weight:1000;
    letter-spacing:.5px;
    padding:8px 12px;
    border:1px solid var(--border);
    border-radius:16px;
    background:#fff;
    min-width:180px;
    text-align:center;
  }
  .timerSub{
    font-size:12px;
    color:var(--muted);
    line-height:1.25;
  }

  .miniBtns{display:flex; gap:8px; flex-wrap:wrap}
  .divider{height:1px; background:var(--border); margin:10px 0}

  .twoLine{
    display:inline-block;
    line-height:1.05;
    text-align:center;
  }

  .copyRow{
    display:flex; align-items:center; justify-content:space-between;
    gap:10px;
    margin-top:6px;
  }
  .copyRow .muted{font-size:12px}
</style>
</head>

<body>
  <div class="topbar">
    <div class="brand">
      <span class="pill">WB</span>
      <span>Workbench + TaktLab</span>
    </div>
    <div class="spacer"></div>
    <button class="btn danger" id="btnReset">Reset Total</button>
  </div>

  <div class="wrap">
    <div class="grid">
      <!-- LEFT: Measurement + Stats -->
      <div class="card">
        <div class="cardHead">
          <div style="flex:1">
            <h2>Configuración de Medición</h2>
            <p>Captura laps de tiempo (CT o Machine+Load/Unload) y genera estadísticas con tamaño de muestra. Todo queda guardado en tu navegador.</p>
          </div>
          <button class="btn small" id="btnCopyConfig">Copiar</button>
        </div>

        <div class="split">
          <div class="field">
            <label>Proceso / Operación</label>
            <input id="inpProcess" placeholder="Ej: OP10 Pre-machining diameter" />
            <div class="hint">Nombre exacto de la operación. Se usa para agrupar laps y alimentar WB.</div>
          </div>

          <div class="field">
            <label>Modo</label>
            <select id="selMode">
              <option value="CT">CT (ciclo total)</option>
              <option value="MLD">Machine + L/U (dos tiempos)</option>
            </select>
            <div class="hint">CT: un solo tiempo. MLD: primero capturas Machine, luego Load/Unload, y se suma.</div>
          </div>
        </div>

        <div class="split" style="margin-top:8px">
          <div class="field">
            <label>Eficiencia (%)</label>
            <input id="inpEff" type="number" min="0" max="200" step="1" value="100" />
            <div class="hint">Factor de eficiencia para la capacidad (100 = ideal). Puedes usar 85–95% si aplica.</div>
          </div>
          <div class="field">
            <label>PCD (min/día)</label>
            <input id="inpPCD" type="number" min="0" max="99999" step="1" value="0" />
            <div class="hint">Pérdidas planeadas o no planeadas convertidas a minutos por día (si lo usas en tu cálculo).</div>
          </div>
        </div>

        <div class="timerBox">
          <div>
            <div class="timer mono" id="timerDisplay">00:00.00</div>
            <div class="timerSub" id="timerSub">MLD: listo para Machine (T1).</div>
          </div>

          <div class="miniBtns">
            <button class="btn primary" id="btnStartLap">Inicio / Vuelta</button>
            <button class="btn" id="btnStop">Stop</button>
            <button class="btn" id="btnManual">Agregar Lap Manual</button>
            <button class="btn" id="btnClearLaps">Borrar Laps</button>
          </div>

          <span class="pill">Último Lap: <b class="mono" id="lastLap">0.00 s</b></span>
          <span class="pill">Muestras: <b id="sampleCount">0</b></span>
          <span class="pill">Error est.: <b id="sampleErr">—</b></span>
        </div>

        <div class="divider"></div>

        <!-- DATA CONTROLS MUST BE BELOW CONFIG -->
        <div class="cardHead" style="margin:0">
          <div style="flex:1">
            <h2>Controles de Datos</h2>
            <p>Exporta, importa y copia por sección. El botón Reset total borra absolutamente todo.</p>
          </div>
          <button class="btn small" id="btnCopyControls">Copiar</button>
        </div>

        <div class="row" style="margin-top:8px">
          <div class="field">
            <label>Export (JSON)</label>
            <textarea id="txtExport" placeholder="Aquí aparecerá el JSON para copiar o guardar..."></textarea>
            <div class="hint">Sirve para migrar conversación/estado sin perder nada. Copia el JSON y pégalo en Import.</div>
          </div>

          <div class="field">
            <label>Import (JSON)</label>
            <textarea id="txtImport" placeholder="Pega aquí el JSON exportado y presiona Importar..."></textarea>
            <div class="hint">Si pegas un JSON válido, se restauran laps + WB + settings.</div>
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <button class="btn" id="btnDoExport">Generar Export</button>
          <button class="btn" id="btnDoImport">Importar</button>
          <span class="pill">Guardado: <b id="saveState">OK</b></span>
        </div>

        <div class="divider"></div>

        <div class="cardHead" style="margin:0">
          <div style="flex:1">
            <h2>Contract vs Capacity Summary</h2>
            <p>Resumen rápido de capacidad estimada vs contrato (por vista Día/Semana). Usa el CT mediano del proceso actual.</p>
          </div>
          <button class="btn small" id="btnCopySummary">Copiar</button>
        </div>

        <div class="split" style="margin-top:8px">
          <div class="field">
            <label>Horas / Día</label>
            <input id="inpHours" type="number" min="0" max="24" step="0.5" value="8" />
            <div class="hint">Para la vista de capacidad.</div>
          </div>
          <div class="field">
            <label>Días / Semana</label>
            <input id="inpDays" type="number" min="1" max="7" step="1" value="5" />
            <div class="hint">Para capacidad semanal.</div>
          </div>
        </div>

        <div class="split" style="margin-top:8px">
          <div class="field">
            <label>Vista</label>
            <select id="selView">
              <option value="day">Día</option>
              <option value="week">Semana</option>
            </select>
            <div class="hint">Cambia el resumen entre capacidad diaria o semanal.</div>
          </div>
          <div class="field">
            <label>Contract (pzs / vista)</label>
            <input id="inpContract" type="number" min="0" step="1" value="0" />
            <div class="hint">Puedes editar aquí o en la tabla WB por operación.</div>
          </div>
        </div>

        <div class="kpiBar">
          <div class="kpi">
            <div class="t">CT Mediana (s)</div>
            <div class="v mono" id="kpiMed">—</div>
          </div>
          <div class="kpi">
            <div class="t">Capacidad Est. (pzs / vista)</div>
            <div class="v mono" id="kpiCap">—</div>
          </div>
          <div class="kpi">
            <div class="t">Cumplimiento</div>
            <div class="v" id="kpiComp">—</div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="cardHead" style="margin:0">
          <div style="flex:1">
            <h2>Stats Focus</h2>
            <p>Estadísticas por el proceso actual (laps capturados). Incluye P10/P90, promedio, desviación y lectura de muestra.</p>
          </div>
          <button class="btn small" id="btnCopyStats">Copiar</button>
        </div>

        <div style="margin-top:8px" id="statsBlock"></div>

        <div class="tabs">
          <button class="tab active" data-tab="wb">WB (Capacity)</button>
          <button class="tab" data-tab="raw">Datos Crudos</button>
          <button class="tab" data-tab="guide">Método &amp; Guía</button>
        </div>

        <div class="panel active" id="panel-wb">
          <div class="muted" style="font-size:12px; line-height:1.25; margin-bottom:8px">
            WB: simula capacidad por operación. Ajusta recursos, pérdidas y calidad. “DT no planeado” y “Pzs/Op” incluidos.
          </div>
          <div id="wbTableWrap"></div>
          <div class="copyRow">
            <span class="muted">Tip: cada fila se guarda automáticamente.</span>
            <button class="btn small" id="btnCopyWB">Copiar WB</button>
          </div>
        </div>

        <div class="panel" id="panel-raw">
          <div class="copyRow" style="margin-top:0">
            <span class="muted">Listado de laps para auditar datos y copiar.</span>
            <button class="btn small" id="btnCopyRaw">Copiar Datos Crudos</button>
          </div>
          <div id="rawWrap" style="margin-top:8px"></div>
        </div>

        <div class="panel" id="panel-guide">
          <div class="copyRow" style="margin-top:0">
            <span class="muted">Guía completa de llenado (sin excusas, con ejemplo).</span>
            <button class="btn small" id="btnCopyGuide">Copiar Guía</button>
          </div>
          <div id="guideWrap" style="margin-top:8px"></div>
        </div>

      </div>

      <!-- RIGHT: Quick Notes / Help -->
      <div class="card">
        <div class="cardHead">
          <div style="flex:1">
            <h2>Notas rápidas</h2>
            <p>Pequeño espacio para dejar contexto. Se guarda junto con todo.</p>
          </div>
          <button class="btn small" id="btnCopyNotes">Copiar</button>
        </div>

        <div class="field">
          <label>Notas</label>
          <textarea id="txtNotes" placeholder="Ej: La restricción es OP10, cambios de turno, mantenimiento el 29-30..."></textarea>
          <div class="hint">Útil para explicar por qué ciertos números se ven “raros” (spoiler: casi siempre es realidad, no el sistema).</div>
        </div>

        <div class="divider"></div>

        <div class="field">
          <label>Estado</label>
          <div class="pill">Autosave: <b id="autosaveTxt">Activo</b></div>
          <div class="hint">Si algo no se guarda, no es magia: revisa que el navegador permita LocalStorage.</div>
        </div>
      </div>
    </div>
  </div>
<script>
(() => {
  const LS_KEY = "WB_TAKTLAB_V1_FULL";

  // ===== Helpers =====
  const $ = (id) => document.getElementById(id);

  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
  function round2(n){ return Math.round(n*100)/100; }

  function formatMS(ms){
    ms = Math.max(0, ms);
    const s = ms/1000;
    const m = Math.floor(s/60);
    const sec = (s - m*60);
    const ss = String(Math.floor(sec)).padStart(2,'0');
    const mm = String(m).padStart(2,'0');
    const cs = String(Math.floor((sec - Math.floor(sec))*100)).padStart(2,'0');
    return `${mm}:${ss}.${cs}`;
  }
  function formatSecs(s){
    s = Math.max(0, s);
    return (Math.round(s*100)/100).toFixed(2);
  }

  function percentile(sorted, p){
    if(sorted.length===0) return NaN;
    const idx = (sorted.length-1)*p;
    const lo = Math.floor(idx), hi = Math.ceil(idx);
    if(lo===hi) return sorted[lo];
    const w = idx - lo;
    return sorted[lo]*(1-w) + sorted[hi]*w;
  }

  function mean(arr){
    if(!arr.length) return NaN;
    return arr.reduce((a,b)=>a+b,0)/arr.length;
  }
  function stddev(arr){
    if(arr.length<2) return NaN;
    const m = mean(arr);
    const v = arr.reduce((a,b)=>a+(b-m)*(b-m),0)/(arr.length-1);
    return Math.sqrt(v);
  }
  function median(arr){
    if(!arr.length) return NaN;
    const s = [...arr].sort((a,b)=>a-b);
    return percentile(s, 0.5);
  }

  async function copyText(text){
    try{
      await navigator.clipboard.writeText(text);
      return true;
    }catch{
      // fallback
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      try{ document.execCommand('copy'); }catch{}
      document.body.removeChild(ta);
      return true;
    }
  }

  function lockBtn(btn, ms){
    btn.disabled = true;
    setTimeout(()=>btn.disabled=false, ms);
  }

  // ===== DOM =====
  const inpProcess  = $("inpProcess");
  const selMode     = $("selMode");
  const inpEff      = $("inpEff");
  const inpPCD      = $("inpPCD");

  const timerDisplay= $("timerDisplay");
  const timerSub    = $("timerSub");
  const btnStartLap = $("btnStartLap");
  const btnStop     = $("btnStop");
  const btnManual   = $("btnManual");
  const btnClearLaps= $("btnClearLaps");

  const lastLap     = $("lastLap");
  const sampleCount = $("sampleCount");
  const sampleErr   = $("sampleErr");

  const txtExport   = $("txtExport");
  const txtImport   = $("txtImport");
  const btnDoExport = $("btnDoExport");
  const btnDoImport = $("btnDoImport");
  const saveState   = $("saveState");

  const inpHours    = $("inpHours");
  const inpDays     = $("inpDays");
  const selView     = $("selView");
  const inpContract = $("inpContract");

  const kpiMed      = $("kpiMed");
  const kpiCap      = $("kpiCap");
  const kpiComp     = $("kpiComp");

  const statsBlock  = $("statsBlock");
  const wbTableWrap = $("wbTableWrap");
  const rawWrap     = $("rawWrap");
  const guideWrap   = $("guideWrap");

  const txtNotes    = $("txtNotes");

  // Copy buttons per section
  const btnCopyConfig   = $("btnCopyConfig");
  const btnCopyControls = $("btnCopyControls");
  const btnCopySummary  = $("btnCopySummary");
  const btnCopyStats    = $("btnCopyStats");
  const btnCopyWB       = $("btnCopyWB");
  const btnCopyRaw      = $("btnCopyRaw");
  const btnCopyGuide    = $("btnCopyGuide");
  const btnCopyNotes    = $("btnCopyNotes");

  const btnReset        = $("btnReset");

  // Tabs
  const tabs = [...document.querySelectorAll(".tab")];
  const panels = [
    $("panel-wb"),
    $("panel-raw"),
    $("panel-guide")
  ];

  // ===== State =====
  let laps = [];   // {id, process, mode, t1, t2, total, ts}
  let wbRows = []; // {op, operators, shift, hours, machines, contract, lunch, changeover, s5, maint, other, shared, dtUnplanned, pzsOp, scrap, p, q}
  let timer = {
    running:false,
    t0:0,
    mldStep:1,
    mldT1:0
  };

  let saveTimer = null;

  function defaultRow(op){
    return {
      op: op || "",
      operators: 0,
      shift: 1,
      hours: 8,
      machines: 1,
      contract: 0,
      lunch: 0,
      changeover: 0,
      s5: 0,
      maint: 0,
      other: 0,
      shared: 0,
      dtUnplanned: 0,
      pzsOp: 1,
      scrap: 0,
      p: 0,
      q: 0
    };
  }

  function ensureWBRow(op){
    const name = (op||"").trim();
    if(!name) return;
    if(!wbRows.some(r => (r.op||"").trim().toLowerCase() === name.toLowerCase())){
      wbRows.push(defaultRow(name));
    }
  }

  // ===== Save / Load =====
  function scheduleSave(){
    saveState.textContent = "…";
    if(saveTimer) clearTimeout(saveTimer);
    saveTimer = setTimeout(saveNow, 220);
  }

  function saveNow(){
    try{
      const st = {
        process: inpProcess.value,
        mode: selMode.value,
        eff: inpEff.value,
        pcd: inpPCD.value,
        hours: inpHours.value,
        days: inpDays.value,
        view: selView.value,
        contract: inpContract.value,
        laps,
        wbRows,
        notes: txtNotes.value,
        tab: document.querySelector(".tab.active")?.dataset?.tab || "wb"
      };
      localStorage.setItem(LS_KEY, JSON.stringify(st));
      saveState.textContent = "OK";
    }catch(e){
      saveState.textContent = "ERR";
      console.warn(e);
    }
  }

  function restore(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return;
      const st = JSON.parse(raw);

      if(st.process!=null) inpProcess.value = st.process;
      if(st.mode!=null) selMode.value = st.mode;
      if(st.eff!=null) inpEff.value = st.eff;
      if(st.pcd!=null) inpPCD.value = st.pcd;

      if(st.hours!=null) inpHours.value = st.hours;
      if(st.days!=null) inpDays.value = st.days;
      if(st.view!=null) selView.value = st.view;
      if(st.contract!=null) inpContract.value = st.contract;

      if(Array.isArray(st.laps)) laps = st.laps;
      if(Array.isArray(st.wbRows)) wbRows = st.wbRows;

      if(st.notes!=null) txtNotes.value = st.notes;

      if(st.tab){
        setTab(st.tab);
      }
    }catch(e){
      console.warn("restore failed", e);
    }
  }

  // ===== Timer =====
  function updateDisplay(){
    if(!timer.running) return;
    timerDisplay.textContent = formatMS(performance.now() - timer.t0);
    requestAnimationFrame(updateDisplay);
  }

  function start(){
    if(timer.running) return;
    timer.running = true;
    timer.t0 = performance.now();
    requestAnimationFrame(updateDisplay);
  }

  function stop(){
    timer.running = false;
    timer.t0 = 0;
    timerDisplay.textContent = "00:00.00";
  }

  function setLastLap(sec){
    lastLap.textContent = `${formatSecs(sec)} s`;
  }

  function addLap(op, mode, t1, t2){
    const id = "L" + Date.now() + "_" + Math.random().toString(16).slice(2);
    const total = round2((t1||0) + (t2||0));
    laps.push({
      id,
      ts: new Date().toISOString(),
      process: op,
      mode,
      t1: round2(t1||0),
      t2: round2(t2||0),
      total
    });
    ensureWBRow(op);
    scheduleSave();
  }
  function doLap(){
    const op = (inpProcess.value||"").trim();
    if(!op){
      alert("Escribe el Proceso / Operación antes de capturar.");
      return;
    }

    if(!timer.running){
      start();
      return;
    }

    const elapsed = (performance.now() - timer.t0) / 1000;
    stop();

    const mode = (selMode.value==="MLD") ? "MLD" : "CT";
    if(mode==="CT"){
      addLap(op,"CT", elapsed, 0);
      setLastLap(elapsed);
    }else{
      if(timer.mldStep===1){
        timer.mldT1 = elapsed;
        timer.mldStep = 2;
        setLastLap(elapsed);
      }else{
        const t1 = timer.mldT1 || 0;
        const t2 = elapsed;
        addLap(op,"MLD", t1, t2);
        setLastLap(t1+t2);
        timer.mldStep = 1;
        timer.mldT1 = 0;
      }
    }

    renderAll();
  }

  function doStop(){
    stop();
    timer.mldStep = 1;
    timer.mldT1 = 0;
    timerSub.textContent = "MLD: listo para Machine (T1).";
    setLastLap(0);
    renderAll();
  }

  function manualLap(){
    const op = (prompt("Proceso / Operación:", (inpProcess.value||"").trim())||"").trim();
    if(!op) return;

    const mode = (prompt("Modo (CT/MLD):", selMode.value)||"CT").trim().toUpperCase()==="MLD" ? "MLD":"CT";
    const t1 = parseFloat(prompt("T1 segundos:", "0")||"0") || 0;
    const t2 = parseFloat(prompt("T2 segundos (CT = 0):", "0")||"0") || 0;

    addLap(op, mode, t1, mode==="CT"?0:t2);
    setLastLap((mode==="CT")?t1:(t1+t2));
    renderAll();
  }

  function clearLaps(){
    if(!confirm("¿Borrar TODOS los laps?")) return;
    laps = [];
    scheduleSave();
    renderAll();
  }

  // ===== Stats + Capacity =====
  function sampleErrorPct(arr){
    // estimación simple 95%: 1.96 * s / sqrt(n) / mean
    const n = arr.length;
    if(n<2) return NaN;
    const m = mean(arr);
    const s = stddev(arr);
    if(!isFinite(m) || m<=0 || !isFinite(s)) return NaN;
    const err = 1.96 * (s/Math.sqrt(n)) / m;
    return err * 100;
  }

  function capFromCT(ctSec){
    // cap = (availableSeconds / ctSec) * eff
    const view = selView.value;
    const hours = parseFloat(inpHours.value)||0;
    const days  = parseFloat(inpDays.value)||0;
    const eff   = (parseFloat(inpEff.value)||0)/100;

    const availableSec = (view==="day")
      ? hours*3600
      : (hours*days*3600);

    if(!isFinite(ctSec) || ctSec<=0) return NaN;
    return (availableSec/ctSec) * eff;
  }

  function renderStats(){
    const op = (inpProcess.value||"").trim();
    const arr = laps.filter(x => (x.process||"").trim().toLowerCase()===op.toLowerCase())
                    .map(x => x.total)
                    .filter(v => isFinite(v) && v>0);

    sampleCount.textContent = String(arr.length);

    const err = sampleErrorPct(arr);
    sampleErr.textContent = isFinite(err) ? `±${err.toFixed(1)}% (95%)` : "—";

    if(arr.length===0){
      statsBlock.innerHTML = `<div class="badge warn">Sin datos: captura laps para ver estadísticas.</div>`;
      kpiMed.textContent = "—";
      kpiCap.textContent = "—";
      kpiComp.innerHTML = "—";
      return;
    }

    const s = [...arr].sort((a,b)=>a-b);
    const p10 = percentile(s,0.10);
    const p90 = percentile(s,0.90);
    const med = percentile(s,0.50);
    const avg = mean(arr);
    const sd  = stddev(arr);

    kpiMed.textContent = isFinite(med) ? med.toFixed(2) : "—";

    const cap = capFromCT(med);
    kpiCap.textContent = isFinite(cap) ? Math.floor(cap).toLocaleString() : "—";

    const contract = parseFloat(inpContract.value)||0;
    const comp = (isFinite(cap) && contract>0) ? (cap/contract)*100 : NaN;

    let b = "badge warn";
    let label = "Referencia";
    if(isFinite(comp)){
      if(comp>=100){ b="badge good"; label="Cumple"; }
      else if(comp>=90){ b="badge warn"; label="Casi"; }
      else{ b="badge bad"; label="No cumple"; }
      kpiComp.innerHTML = `<span class="${b}">${label}: ${comp.toFixed(1)}%</span>`;
    }else{
      kpiComp.innerHTML = `<span class="badge warn">Define Contract para ver cumplimiento</span>`;
    }

    // muestra legible tipo lo que pediste
    let sampleBadge = "badge warn";
    let sampleMsg = `Muestras: ${arr.length} · Error est.: ${isFinite(err)?`±${err.toFixed(1)}% (95%)`:"—"}`
    if(arr.length>=30) sampleBadge="badge good";
    if(arr.length<10) sampleBadge="badge bad";

    statsBlock.innerHTML = `
      <div class="row" style="gap:8px">
        <span class="${sampleBadge}">${sampleMsg}</span>
        <span class="badge">P10: <b class="mono">${p10.toFixed(2)} s</b></span>
        <span class="badge">Mediana: <b class="mono">${med.toFixed(2)} s</b></span>
        <span class="badge">P90: <b class="mono">${p90.toFixed(2)} s</b></span>
        <span class="badge">Prom: <b class="mono">${avg.toFixed(2)} s</b></span>
        <span class="badge">σ: <b class="mono">${sd.toFixed(2)} s</b></span>
      </div>
      <div class="muted" style="margin-top:8px; font-size:12px; line-height:1.25">
        Interpretación rápida: si el error estimado es alto, tu CT mediano es “orientativo”. Si quieres ±3%,
        normalmente necesitas más muestra (depende de la variación).
      </div>
    `;
  }

  // ===== WB Render =====
  function optRange(min, max, step=1){
    const out = [];
    for(let v=min; v<=max; v+=step){
      out.push(`<option value="${v}">${v}</option>`);
    }
    return out.join("");
  }

  function optRangeFloat(min,max,step){
    const out=[];
    for(let v=min; v<=max+1e-9; v+=step){
      const s = (Math.round(v*10)/10).toFixed(1);
      out.push(`<option value="${s}">${s}</option>`);
    }
    return out.join("");
  }

  function renderWB(){
    // Keep contract synced if row exists
    const op = (inpProcess.value||"").trim();
    const row = wbRows.find(r => (r.op||"").trim().toLowerCase()===op.toLowerCase());
    if(row){
      inpContract.value = row.contract ?? inpContract.value;
    }

    if(wbRows.length===0){
      wbTableWrap.innerHTML = `<div class="badge warn">WB vacío: escribe un Proceso y captura al menos un lap para crear la fila.</div>`;
      return;
    }

    const dtOptions = optRange(0,1440,5);
    const pzsOptions = optRange(1,99,1);

    wbTableWrap.innerHTML = `
      <div style="overflow:auto; border:1px solid var(--border); border-radius:14px">
        <table>
          <thead>
            <tr>
              <th>Operación</th>
              <th>Operadores<br><span class="muted">(0–10)</span></th>
              <th>Shift<br><span class="muted">(1–4)</span></th>
              <th>Hours<br><span class="muted">(0–24)</span></th>
              <th>Machines<br><span class="muted">(1–50)</span></th>
              <th>Contract</th>
              <th>Lunch<br>(min)</th>
              <th>Changeover<br>(min)</th>
              <th>5S<br>(min)</th>
              <th>Maint<br>(min)</th>
              <th>Other<br>(min)</th>
              <th><span class="twoLine">Capacidad<br>Compartida</span><br>(min)</th>
              <th>DT no planeado<br>(min)</th>
              <th>Pzs/Op</th>
              <th>Scrap %</th>
              <th>P %</th>
              <th>Q %</th>
              <th>Acción</th>
            </tr>
          </thead>
          <tbody>
            ${wbRows.map((r,idx)=>`
              <tr>
                <td style="min-width:220px">
                  <input data-wb="op" data-idx="${idx}" value="${escapeHtml(r.op||"")}" />
                </td>

                <td style="min-width:120px">
                  <select data-wb="operators" data-idx="${idx}">
                    ${optRange(0,10,1)}
                  </select>
                </td>

                <td style="min-width:90px">
                  <select data-wb="shift" data-idx="${idx}">
                    ${optRange(1,4,1)}
                  </select>
                </td>

                <td style="min-width:110px">
                  <select data-wb="hours" data-idx="${idx}">
                    ${optRangeFloat(0,24,0.5)}
                  </select>
                </td>

                <td style="min-width:120px">
                  <select data-wb="machines" data-idx="${idx}">
                    ${optRange(1,50,1)}
                  </select>
                </td>

                <td style="min-width:120px">
                  <input type="number" min="0" step="1" data-wb="contract" data-idx="${idx}" value="${r.contract||0}" />
                </td>

                <td style="min-width:110px">
                  <input type="number" min="0" max="1440" step="1" data-wb="lunch" data-idx="${idx}" value="${r.lunch||0}" />
                </td>

                <td style="min-width:120px">
                  <input type="number" min="0" max="1440" step="1" data-wb="changeover" data-idx="${idx}" value="${r.changeover||0}" />
                </td>

                <td style="min-width:95px">
                  <input type="number" min="0" max="1440" step="1" data-wb="s5" data-idx="${idx}" value="${r.s5||0}" />
                </td>

                <td style="min-width:110px">
                  <input type="number" min="0" max="1440" step="1" data-wb="maint" data-idx="${idx}" value="${r.maint||0}" />
                </td>

                <td style="min-width:110px">
                  <input type="number" min="0" max="1440" step="1" data-wb="other" data-idx="${idx}" value="${r.other||0}" />
                </td>

                <td style="min-width:150px">
                  <input type="number" min="0" max="1440" step="1" data-wb="shared" data-idx="${idx}" value="${r.shared||0}" />
                </td>

                <td style="min-width:150px">
                  <select data-wb="dtUnplanned" data-idx="${idx}">
                    ${dtOptions}
                  </select>
                </td>

                <td style="min-width:110px">
                  <select data-wb="pzsOp" data-idx="${idx}">
                    ${pzsOptions}
                  </select>
                </td>

                <td style="min-width:95px">
                  <input type="number" min="0" max="100" step="1" data-wb="scrap" data-idx="${idx}" value="${r.scrap||0}" />
                </td>

                <td style="min-width:85px">
                  <input type="number" min="0" max="100" step="1" data-wb="p" data-idx="${idx}" value="${r.p||0}" />
                </td>

                <td style="min-width:85px">
                  <input type="number" min="0" max="100" step="1" data-wb="q" data-idx="${idx}" value="${r.q||0}" />
                </td>

                <td style="min-width:110px">
                  <button class="btn small danger" data-del="${idx}">Eliminar</button>
                </td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      </div>
      <div class="muted" style="margin-top:8px; font-size:12px; line-height:1.25">
        Guía rápida WB: Operators/Shift/Hours/Machines definen recursos. Lunch/Changeover/5S/Maint/Other/Shared/DT son pérdidas en minutos.
        Pzs/Op te permite mapear operaciones con múltiplas piezas por operación. Scrap/P/Q son porcentajes (0–100).
      </div>
    `;

    // set selected values after render
    wbRows.forEach((r,idx)=>{
      setSelect(`[data-wb="operators"][data-idx="${idx}"]`, String(r.operators??0));
      setSelect(`[data-wb="shift"][data-idx="${idx}"]`, String(r.shift??1));
      setSelect(`[data-wb="hours"][data-idx="${idx}"]`, (parseFloat(r.hours||8)).toFixed(1));
      setSelect(`[data-wb="machines"][data-idx="${idx}"]`, String(r.machines??1));
      setSelect(`[data-wb="dtUnplanned"][data-idx="${idx}"]`, String(r.dtUnplanned??0));
      setSelect(`[data-wb="pzsOp"][data-idx="${idx}"]`, String(r.pzsOp??1));
    });
  }

  function setSelect(selector, value){
    const el = document.querySelector(selector);
    if(!el) return;
    el.value = value;
  }

  function escapeHtml(s){
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function wireWBEvents(){
    wbTableWrap.addEventListener("input",(e)=>{
      const t = e.target;
      const idx = parseInt(t.getAttribute("data-idx"),10);
      const key = t.getAttribute("data-wb");
      if(!Number.isFinite(idx) || !key) return;

      const row = wbRows[idx];
      if(!row) return;

      if(key==="op"){
        row.op = t.value;
      }else if(["operators","shift","machines","dtUnplanned","pzsOp"].includes(key)){
        row[key] = parseInt(t.value,10);
      }else if(key==="hours"){
        row[key] = parseFloat(t.value);
      }else{
        row[key] = parseFloat(t.value)||0;
      }

      // sync contract to summary if editing current operation row
      const op = (inpProcess.value||"").trim().toLowerCase();
      if((row.op||"").trim().toLowerCase()===op){
        inpContract.value = row.contract || 0;
      }

      scheduleSave();
      renderStats(); // keep summary fresh
    });

    wbTableWrap.addEventListener("click",(e)=>{
      const del = e.target?.getAttribute?.("data-del");
      if(del==null) return;
      const idx = parseInt(del,10);
      if(!Number.isFinite(idx)) return;
      wbRows.splice(idx,1);
      scheduleSave();
      renderAll();
    });
  }
  // ===== Raw + Guide =====
  function renderRaw(){
    if(laps.length===0){
      rawWrap.innerHTML = `<div class="badge warn">Sin laps aún.</div>`;
      return;
    }
    rawWrap.innerHTML = `
      <div style="overflow:auto; border:1px solid var(--border); border-radius:14px">
        <table>
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Proceso</th>
              <th>Modo</th>
              <th>T1 (s)</th>
              <th>T2 (s)</th>
              <th>Total (s)</th>
            </tr>
          </thead>
          <tbody>
            ${laps.slice().reverse().map(x=>`
              <tr>
                <td class="mono">${escapeHtml(x.ts||"")}</td>
                <td>${escapeHtml(x.process||"")}</td>
                <td>${escapeHtml(x.mode||"")}</td>
                <td class="mono">${formatSecs(x.t1||0)}</td>
                <td class="mono">${formatSecs(x.t2||0)}</td>
                <td class="mono"><b>${formatSecs(x.total||0)}</b></td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      </div>
    `;
  }

  function renderGuide(){
    guideWrap.innerHTML = `
      <div class="card" style="border-radius:14px; padding:12px">
        <h3 class="tight">Método & Guía (llenado)</h3>
        <p class="muted" style="line-height:1.35; margin:6px 0 10px">
          Objetivo: medir CT real y traducirlo a capacidad. Si tu dato está mal, tu decisión está peor (y tu junta del lunes ni te cuento).
        </p>

        <div class="divider"></div>

        <h4 class="tight">1) Proceso / Operación</h4>
        <p class="muted" style="line-height:1.35; margin:6px 0 10px">
          Pon el nombre exacto (Ej: “OP10 Pre-machining diameter”). Este campo es la llave: agrupa laps, stats y WB.
          Si lo cambias, estás creando otra “familia” de datos.
        </p>

        <h4 class="tight">2) Modo</h4>
        <ul class="muted" style="line-height:1.35; margin:6px 0 10px">
          <li><b>CT</b>: captura una vuelta completa (tiempo total).</li>
          <li><b>MLD</b>: primero capturas <b>Machine (T1)</b> y luego <b>Load/Unload (T2)</b>. El total = T1 + T2.</li>
        </ul>

        <h4 class="tight">3) Eficiencia (%)</h4>
        <p class="muted" style="line-height:1.35; margin:6px 0 10px">
          Ajusta la capacidad por realidad (microparos, ritmo humano, variaciones). 100% = ideal. 85–95% suele ser más realista.
        </p>

        <h4 class="tight">4) Contract vs Capacity</h4>
        <p class="muted" style="line-height:1.35; margin:6px 0 10px">
          Contract es tu demanda objetivo por vista (día/semana). La capacidad se calcula con CT mediano y horas disponibles.
          Si no defines Contract, el sistema no puede decirte si cumples.
        </p>

        <h4 class="tight">5) WB (Workbench) – campos</h4>
        <ul class="muted" style="line-height:1.35; margin:6px 0 10px">
          <li><b>Operadores (0–10)</b>: cuántas manos reales trabajando esa operación.</li>
          <li><b>Shift (1–4)</b>: turnos.</li>
          <li><b>Hours (0–24 en .5)</b>: horas por turno.</li>
          <li><b>Machines (1–50)</b>: cantidad de equipos disponibles (si aplica).</li>
          <li><b>Lunch / Changeover / 5S / Maint / Other</b>: pérdidas en minutos (0–1440).</li>
          <li><b>Capacidad Compartida</b>: minutos que se comen por atender otras líneas/áreas (también 0–1440).</li>
          <li><b>DT no planeado</b>: paro no planeado total del día (0–1440, step 5).</li>
          <li><b>Pzs/Op</b>: piezas por operación (1–99). Útil cuando una operación produce múltiples piezas por ciclo.</li>
          <li><b>Scrap / P / Q</b>: porcentajes 0–100 para pérdidas por rechazo o métricas internas.</li>
        </ul>

        <div class="divider"></div>
        <p class="muted" style="line-height:1.35; margin:6px 0 0">
          Recomendación práctica: captura al menos 15–30 laps por operación crítica. Si la variación es alta, sube muestra.
        </p>
      </div>
    `;
  }

  // ===== Tabs =====
  function setTab(name){
    tabs.forEach(t => t.classList.toggle("active", t.dataset.tab===name));
    panels.forEach(p => p.classList.toggle("active", p.id==="panel-"+name));
    scheduleSave();
  }

  tabs.forEach(t=>{
    t.addEventListener("click",()=>{
      lockBtn(t, 6000);
      setTab(t.dataset.tab);
    });
  });

  // ===== Render all =====
  function renderAll(){
    // timer subtext
    if(selMode.value==="MLD"){
      timerSub.textContent = (timer.mldStep===1)
        ? "MLD: listo para Machine (T1)."
        : "MLD: ahora captura Load/Unload (T2).";
    }else{
      timerSub.textContent = "CT: captura vueltas completas.";
    }

    renderStats();
    renderWB();
    renderRaw();
    renderGuide();
  }

  // ===== Export/Import =====
  function getState(){
    return {
      process: inpProcess.value,
      mode: selMode.value,
      eff: inpEff.value,
      pcd: inpPCD.value,
      hours: inpHours.value,
      days: inpDays.value,
      view: selView.value,
      contract: inpContract.value,
      laps,
      wbRows,
      notes: txtNotes.value,
      tab: document.querySelector(".tab.active")?.dataset?.tab || "wb"
    };
  }

  function applyState(st){
    inpProcess.value = st.process ?? "";
    selMode.value = st.mode ?? "CT";
    inpEff.value = st.eff ?? "100";
    inpPCD.value = st.pcd ?? "0";
    inpHours.value = st.hours ?? "8";
    inpDays.value = st.days ?? "5";
    selView.value = st.view ?? "day";
    inpContract.value = st.contract ?? "0";
    laps = Array.isArray(st.laps) ? st.laps : [];
    wbRows = Array.isArray(st.wbRows) ? st.wbRows : [];
    txtNotes.value = st.notes ?? "";
    if(st.tab) setTab(st.tab);
    ensureWBRow((inpProcess.value||"").trim());
    saveNow();
    renderAll();
  }

  // ===== Wiring =====
  btnStartLap.addEventListener("click", ()=>{
    lockBtn(btnStartLap, 1000); // ✅ 1 segundo
    doLap();
  });
  btnStop.addEventListener("click", ()=>{
    lockBtn(btnStop, 1000); // ✅ 1 segundo
    doStop();
  });

  btnManual.addEventListener("click", ()=>{
    lockBtn(btnManual, 6000);
    manualLap();
  });

  btnClearLaps.addEventListener("click", ()=>{
    lockBtn(btnClearLaps, 6000);
    clearLaps();
  });

  [inpProcess, selMode, inpEff, inpPCD, inpHours, inpDays, selView, inpContract, txtNotes].forEach(el=>{
    el.addEventListener("input", ()=>{
      ensureWBRow((inpProcess.value||"").trim());
      scheduleSave();
      renderAll();
    });
    el.addEventListener("change", ()=>{
      ensureWBRow((inpProcess.value||"").trim());
      scheduleSave();
      renderAll();
    });
  });

  btnDoExport.addEventListener("click", ()=>{
    lockBtn(btnDoExport, 6000);
    txtExport.value = JSON.stringify(getState(), null, 2);
    scheduleSave();
  });

  btnDoImport.addEventListener("click", ()=>{
    lockBtn(btnDoImport, 6000);
    try{
      const st = JSON.parse(txtImport.value);
      applyState(st);
      alert("Importación completa ✅");
    }catch(e){
      alert("Import falló: JSON inválido.");
    }
  });

  btnReset.addEventListener("click", ()=>{
    lockBtn(btnReset, 6000);
    if(!confirm("Esto borra TODO (laps, WB, settings). ¿Seguro?")) return;
    laps = [];
    wbRows = [];
    localStorage.removeItem(LS_KEY);
    inpProcess.value="";
    selMode.value="CT";
    inpEff.value="100";
    inpPCD.value="0";
    inpHours.value="8";
    inpDays.value="5";
    selView.value="day";
    inpContract.value="0";
    txtNotes.value="";
    stop();
    timer.mldStep=1;
    timer.mldT1=0;
    setLastLap(0);
    saveNow();
    renderAll();
  });

  // Copy handlers (each section has its own)
  btnCopyConfig.addEventListener("click", ()=>{ lockBtn(btnCopyConfig,6000); copyText(`Configuración:\nProceso=${inpProcess.value}\nModo=${selMode.value}\nEficiencia=${inpEff.value}%\nPCD=${inpPCD.value} min/día`); });
  btnCopyControls.addEventListener("click", ()=>{ lockBtn(btnCopyControls,6000); copyText(`Controles de Datos:\nExport/Import para migración.\nNotas: ${txtNotes.value||"-"}`); });
  btnCopySummary.addEventListener("click", ()=>{ lockBtn(btnCopySummary,6000); copyText(`Summary:\nCT Mediana=${kpiMed.textContent}\nCapacidad=${kpiCap.textContent}\nCumplimiento=${kpiComp.textContent.replace(/\s+/g,' ').trim()}`); });
  btnCopyStats.addEventListener("click", ()=>{ lockBtn(btnCopyStats,6000); copyText(`Stats Focus:\n${statsBlock.innerText}`); });
  btnCopyWB.addEventListener("click", ()=>{ lockBtn(btnCopyWB,6000); copyText(JSON.stringify(wbRows,null,2)); });
  btnCopyRaw.addEventListener("click", ()=>{ lockBtn(btnCopyRaw,6000); copyText(JSON.stringify(laps,null,2)); });
  btnCopyGuide.addEventListener("click", ()=>{ lockBtn(btnCopyGuide,6000); copyText(guideWrap.innerText); });
  btnCopyNotes.addEventListener("click", ()=>{ lockBtn(btnCopyNotes,6000); copyText(txtNotes.value||""); });

  // WB events
  wireWBEvents();

  // Restore
  restore();

  // Ensure row for current process
  ensureWBRow((inpProcess.value||"").trim());

  // Initial render
  renderAll();

  window.addEventListener("beforeunload", saveNow);
})();
</script>
</body>
</html>
