<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>TaktLab – Cycle Time & Capacity Analyzer</title>

<style>
  :root{
    /* ✅ Sky-blue pro (no “blanco muerto”) */
    --bg-main:#0b3560;
    --bg-main-2:#2b78c4;
    --bg-card:#0b2a4b;
    --bg-card-soft:#0f355f;

    /* accents */
    --accent-green:#18c97a;
    --accent-amber:#f2c14e;
    --accent-red:#ff3355;
    --accent-blue:#39bdf5;
    --accent-grey:#cfd8dc;

    --text-main:#ffffff;
    --text-soft:#cfe6ff;
    --text-muted:#97b8d8;
    --border-soft:rgba(57,189,245,.22);

    --btn-green:#18c97a;
    --btn-orange:#f2a93b;
    --btn-grey:#2f4b65;

    --badge-green:rgba(24,201,122,.16);
    --badge-red:rgba(255,51,85,.16);
    --badge-amber:rgba(242,193,78,.16);

    /* WB sticky sizing */
    --wb-on-w:56px;
    --wb-op-w:210px;
  }

  *{box-sizing:border-box;}

  body{
    margin:0;
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    background:linear-gradient(180deg, #0a2a4a 0%, var(--bg-main-2) 42%, #0a2a4a 100%);
    color:var(--text-main);
  }

  .page{
    max-width:1100px;
    margin:0 auto;
    padding:10px 10px 34px;
  }

  .sticky-timer-bar{
    position:sticky;
    top:0;
    z-index:100;
    background:linear-gradient(180deg, rgba(10,42,74,.96) 0%, rgba(11,53,96,.94) 90%);
    backdrop-filter: blur(6px);
    padding:6px 0 8px;
  }

  .top-row{
    display:flex;
    align-items:center;
    gap:10px;
    margin-bottom:6px;
  }

  .logo-circle{
    width:38px;height:38px;border-radius:50%;
    border:2px solid rgba(207,216,220,.55);
    display:flex;align-items:center;justify-content:center;
  }
  .logo-gear{
    width:22px;height:22px;border-radius:50%;
    border:2px solid rgba(207,216,220,.55);
    position:relative;
  }
  .logo-gear::before{
    content:"";
    position:absolute;
    inset:4px;
    border-radius:50%;
    border:2px solid rgba(24,201,122,.9);
    border-right-color:transparent;
    border-bottom-color:transparent;
    transform-origin:50% 50%;
  }
  .logo-gear.spinning::before{ animation:logo-spin 2s linear infinite; }
  @keyframes logo-spin{ from{transform:rotate(0deg);} to{transform:rotate(360deg);} }

  .title-block{display:flex;flex-direction:column;gap:2px;}
  .title-main{font-size:1.2rem;font-weight:800;letter-spacing:.03em;}
  .title-sub{font-size:.72rem;color:var(--text-soft);}

  .lang-switch{margin-left:auto;display:flex;align-items:center;gap:6px;}
  .lang-btn{
    border-radius:999px;border:1px solid rgba(57,189,245,.28);
    background:rgba(10,42,74,.55);color:var(--text-soft);
    font-size:.7rem;padding:5px 10px;cursor:pointer;min-width:40px;
  }
  .lang-btn.active{
    background:rgba(57,189,245,.95);
    color:#052035;
    border-color:rgba(57,189,245,.95);
    font-weight:900;
  }

  .timer-card{
    background:linear-gradient(180deg, rgba(57,189,245,.10) 0%, rgba(11,42,75,.96) 35%, rgba(11,42,75,1) 100%);
    border-radius:18px;
    border:1px solid rgba(57,189,245,.25);
    padding:8px 10px 10px;
    box-shadow:0 10px 22px rgba(0,0,0,.35);
  }

  .timer-display{
    text-align:center;
    font-size:2.8rem;
    font-weight:650;
    letter-spacing:.08em;
    padding:4px 4px 2px;
  }

  /* ✅ T1/T2 clocks */
  .split-clocks{
    display:flex;
    gap:8px;
    justify-content:center;
    margin:2px 0 8px;
    flex-wrap:wrap;
  }
  .split-pill{
    display:flex;
    align-items:center;
    gap:6px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(255,255,255,.03);
    font-size:.78rem;
    color:var(--text-soft);
    min-width:150px;
    justify-content:center;
  }
  .split-pill .tag{font-weight:900;letter-spacing:.04em;color:#fff;opacity:.9;}
  .split-pill .val{font-variant-numeric:tabular-nums;letter-spacing:.04em;color:#fff;}
  .split-pill.t1{ border-color: rgba(57,189,245,.30); }
  .split-pill.t2{ border-color: rgba(242,193,78,.28); }

  .info-stack{ display:flex; flex-direction:column; gap:6px; margin:0 0 8px; }
  .info-line{
    font-size:.78rem;margin:0;padding:7px 10px;
    border-radius:12px;border:1px solid transparent;
    line-height:1.25;
  }
  .sample-neutral{background:rgba(255,255,255,.04);border-color:rgba(255,255,255,.10);color:var(--text-soft);}
  .sample-good{background:rgba(24,201,122,.14);border-color:rgba(24,201,122,.45);color:#d9ffe9;}
  .sample-warn{background:rgba(242,193,78,.12);border-color:rgba(242,193,78,.42);color:#fff4d3;}
  .sample-bad{background:rgba(255,51,85,.12);border-color:rgba(255,51,85,.45);color:#ffd0da;}

  .btn-row-main{display:flex;gap:10px;margin-bottom:2px;}
  .btn{
    border:none;border-radius:16px;padding:10px 12px;
    font-size:.9rem;font-weight:900;cursor:pointer;color:#06101f;
    box-shadow:0 6px 12px rgba(0,0,0,.28);flex:1;
    transition:transform .04s ease, box-shadow .04s ease, background .15s;
    touch-action:manipulation;
  }
  .btn:active{transform:translateY(1px);box-shadow:0 2px 6px rgba(0,0,0,.38);}
  .btn-start{background:rgba(24,201,122,.95); color:#051018;}
  .btn-lap{background:rgba(242,169,59,.95); color:#0b0b0b;}

  .flash{animation:flash-bg .12s ease-out;}
  @keyframes flash-bg{ from{background:rgba(255,255,255,.18);} to{background:transparent;} }

  .content-section{margin-top:8px;}

  /* ✅ Secciones: paleta aplicada a TODO el recuadro */
  .section-card{
    border-radius:18px;
    border:1px solid rgba(57,189,245,.22);
    padding:10px 10px 12px;
    margin-bottom:10px;
    box-shadow:0 8px 18px rgba(0,0,0,.25);
  }
  .section-card[data-accent="blue"]{
    background:linear-gradient(180deg, rgba(57,189,245,.14) 0%, rgba(11,42,75,.92) 35%, rgba(11,42,75,1) 100%);
    border-color:rgba(57,189,245,.30);
  }
  .section-card[data-accent="green"]{
    background:linear-gradient(180deg, rgba(24,201,122,.12) 0%, rgba(11,42,75,.92) 35%, rgba(11,42,75,1) 100%);
    border-color:rgba(24,201,122,.28);
  }
  .section-card[data-accent="amber"]{
    background:linear-gradient(180deg, rgba(242,193,78,.12) 0%, rgba(11,42,75,.92) 35%, rgba(11,42,75,1) 100%);
    border-color:rgba(242,193,78,.26);
  }
  .section-card[data-accent="red"]{
    background:linear-gradient(180deg, rgba(255,51,85,.12) 0%, rgba(11,42,75,.92) 35%, rgba(11,42,75,1) 100%);
    border-color:rgba(255,51,85,.26);
  }
  .section-card[data-accent="grey"]{
    background:linear-gradient(180deg, rgba(207,216,220,.10) 0%, rgba(11,42,75,.92) 35%, rgba(11,42,75,1) 100%);
    border-color:rgba(207,216,220,.18);
  }

  .section-title{font-size:1.0rem;font-weight:900;margin-bottom:8px;}

  .mode-row{
    display:flex;gap:8px;flex-wrap:wrap;align-items:flex-end;
    font-size:.78rem;color:var(--text-soft);
  }
  .mode-row select,.mode-row input{
    background:rgba(10,42,74,.85);
    border-radius:10px;border:1px solid rgba(57,189,245,.22);
    padding:6px 10px;color:var(--text-soft);font-size:.78rem;min-width:70px;
    outline:none;
  }
  .mode-row input[type="number"]{width:86px;}
  .mode-row input[type="text"]{width:170px;}

  table{width:100%;border-collapse:collapse;font-size:.72rem;}
  th,td{
    padding:4px 6px;text-align:right;
    border-bottom:1px solid rgba(255,255,255,.05);
    white-space:nowrap;
    vertical-align:middle;
  }
  th:first-child,td:first-child{text-align:left;}
  th{
    color:var(--text-soft);font-weight:800;background:rgba(255,255,255,.03);
    position:sticky;top:0;z-index:5;
  }
  tbody tr:nth-child(even){background:rgba(255,255,255,.02);}

  .badge{
    display:inline-block;padding:2px 8px;border-radius:999px;
    font-size:.68rem;border:1px solid rgba(255,255,255,.12);
  }
  .badge-good{background:var(--badge-green);border-color:rgba(24,201,122,.40);color:#d9ffe9;}
  .badge-warn{background:var(--badge-amber);border-color:rgba(242,193,78,.40);color:#fff4d3;}
  .badge-bad{background:var(--badge-red);border-color:rgba(255,51,85,.42);color:#ffd0da;}

  .btn-row-secondary{display:flex;flex-wrap:wrap;gap:10px;margin:8px 0 4px;}
  .btn-small{
    padding:12px 18px;
    border-radius:18px;
    font-size:.95rem;
    font-weight:950;
    flex:0 0 auto;
    background:rgba(10,42,74,.70);
    color:var(--text-soft);
    border:1px solid rgba(57,189,245,.18);
    cursor:pointer;
    box-shadow:0 6px 12px rgba(0,0,0,.22);
  }
  .btn-small-copy{background:rgba(57,189,245,.95);border-color:rgba(57,189,245,.95);color:#051018;}
  .btn-small-summary{background:rgba(242,193,78,.95);border-color:rgba(242,193,78,.95);color:#0b0b0b;}
  .btn-small-manual{background:rgba(24,201,122,.95);border-color:rgba(24,201,122,.95);color:#051018;}
  .btn-small-reset{background:rgba(255,51,85,.92);border-color:rgba(255,51,85,.92);color:#fff;}
  .btn-small-wbadd{background:rgba(255,255,255,.06);color:var(--text-soft);}
  .btn-small-wbclear{background:rgba(255,51,85,.14);border-color:rgba(255,51,85,.38);color:#ffd0da;}
  .btn-small-conc{background:rgba(207,216,220,.14);border-color:rgba(207,216,220,.22);color:#eaf6ff;}

  .subsection-title{margin-top:10px;font-size:.82rem;font-weight:900;color:var(--text-soft);}
  .footer-note{margin-top:10px;font-size:.65rem;color:var(--text-muted);text-align:right;}

  .charts-wrapper{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
    gap:10px;
  }
  .chart-card{
    background:rgba(10,42,74,.62);
    border-radius:14px;
    border:1px solid rgba(57,189,245,.20);
    padding:8px;
  }
  .chart-title{font-size:.75rem;margin-bottom:4px;color:var(--text-soft);font-weight:900;}
  canvas{width:100%;height:180px;background:rgba(10,42,74,.85);border-radius:10px;border:1px solid rgba(255,255,255,.06);}

  .btn-edit,.btn-del,.btn-relink{
    padding:2px 8px;border-radius:10px;font-size:.7rem;
    border:1px solid rgba(255,255,255,.2);cursor:pointer;background:transparent;
  }
  .btn-edit{color:#9fe4ff;}
  .btn-del{color:#ffd0da;}
  .btn-relink{color:#fff4d3;}

  .wb-inp, .wb-sel, .wb-chk{
    background:rgba(10,42,74,.85);
    border-radius:10px;border:1px solid rgba(57,189,245,.22);
    padding:3px 8px;color:var(--text-soft);font-size:.70rem;
    outline:none;
  }
  .wb-inp{width:72px;}
  .wb-inp.wide{width:160px;}
  .wb-inp.slim{width:56px;}
  .wb-sel{width:110px;}

  .wb-opwrap{display:flex;gap:6px;align-items:center;justify-content:flex-start;}
  .wb-opselect{
    width: calc(var(--wb-op-w) - 14px);
    max-width: calc(var(--wb-op-w) - 14px);
    background:rgba(10,42,74,.85);
    border-radius:10px;
    border:1px solid rgba(57,189,245,.22);
    padding:4px 8px;
    color:var(--text-soft);
    font-size:.72rem;
    outline:none;
  }
  .wb-opbtn{
    border:1px solid rgba(255,255,255,.16);
    background:rgba(255,255,255,.06);
    color:var(--text-soft);
    border-radius:10px;
    padding:3px 8px;
    cursor:pointer;
    font-size:.72rem;
  }
  .wb-opbtn:hover{ background:rgba(255,255,255,.10); }

  .wb-alert{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-top:8px;}
  .wb-badge-title{font-size:.72rem;color:var(--text-soft);font-weight:900;}
  .wb-mini{font-size:.7rem;color:var(--text-muted);line-height:1.25;margin-top:6px;}
  .wb-sumline{display:flex;justify-content:flex-end;gap:10px;align-items:center;margin-top:6px;font-size:.72rem;color:var(--text-soft);}

  /* WB Sticky columns */
  #wbTable{ border-collapse:separate; border-spacing:0; }
  #wbTable th, #wbTable td{ position:relative; }
  #wbTable th:nth-child(1), #wbTable td:nth-child(1){ width:var(--wb-on-w); min-width:var(--wb-on-w); }
  #wbTable th:nth-child(2), #wbTable td:nth-child(2){ width:var(--wb-op-w); min-width:var(--wb-op-w); }

  #wbTable th:nth-child(1), #wbTable td:nth-child(1){
    position:sticky; left:0;
    z-index:30;
    background:rgba(10,42,74,.96);
    backdrop-filter: blur(4px);
  }
  #wbTable th:nth-child(2), #wbTable td:nth-child(2){
    position:sticky; left:var(--wb-on-w);
    z-index:30;
    background:rgba(10,42,74,.96);
    backdrop-filter: blur(4px);
  }
  #wbTable thead th:nth-child(1),
  #wbTable thead th:nth-child(2){ z-index:40; }

  /* Conclusions box */
  .conc-wrap{
    display:grid;
    grid-template-columns:1fr;
    gap:8px;
  }
  .conc-text{
    width:100%;
    min-height:160px;
    resize:vertical;
    background:rgba(10,42,74,.78);
    color:var(--text-soft);
    border:1px solid rgba(57,189,245,.22);
    border-radius:14px;
    padding:10px;
    font-size:.76rem;
    line-height:1.35;
    outline:none;
    white-space:pre-wrap;
  }
  .conc-hint{
    font-size:.70rem;color:var(--text-muted);line-height:1.25;
  }

  @media (max-width:600px){
    .timer-display{font-size:2.2rem;}
    .btn-row-main{gap:6px;}
    .btn{font-size:.9rem;border-radius:14px;}
    canvas{height:160px;}
    th,td{font-size:.70rem;}
    .wb-inp{width:66px;}
    .wb-inp.wide{width:130px;}
    .btn-small{padding:12px 16px;font-size:.92rem;}
    :root{ --wb-on-w:52px; --wb-op-w:190px; }
    .wb-opselect{ width: calc(var(--wb-op-w) - 14px); max-width: calc(var(--wb-op-w) - 14px); }
  }
</style>
</head>

<body>
<div class="page">

  <div class="sticky-timer-bar">
    <div class="top-row">
      <div class="logo-circle"><div class="logo-gear" id="logoGear"></div></div>
      <div class="title-block">
        <div class="title-main">TaktLab</div>
        <div class="title-sub" data-i18n="title.subtitle">Cycle Time &amp; Capacity Analyzer</div>
      </div>
      <div class="lang-switch">
        <button class="lang-btn" data-lang="en">EN</button>
        <button class="lang-btn" data-lang="es">ES</button>
      </div>
    </div>

    <div class="timer-card" id="timerCard">
      <div class="timer-display" id="display">00:00.00</div>

      <div class="split-clocks" id="splitClocks">
        <div class="split-pill t1"><span class="tag">T1</span><span class="val" id="t1Clock">00:00.00</span></div>
        <div class="split-pill t2"><span class="tag">T2</span><span class="val" id="t2Clock">00:00.00</span></div>
      </div>

      <div class="info-stack">
        <div class="info-line sample-neutral" id="sampleInfoTop">
          No samples yet for current process. Start capturing laps.
        </div>
      </div>

      <div class="btn-row-main">
        <button class="btn btn-start" id="btnStart" data-i18n="btn.start">Start</button>
        <button class="btn btn-lap" id="btnLap" data-i18n="btn.lap">LAP</button>
      </div>
    </div>
  </div>

  <div class="content-section">

    <div class="section-card" data-accent="blue">
      <div class="section-title" data-i18n="section.measurementSetup">Measurement Setup</div>

      <div class="mode-row">
        <div>
          <label for="processName" data-i18n="label.process">Process</label><br/>
          <input id="processName" type="text" placeholder="e.g. Op 30-1" data-i18n-placeholder="label.processPlaceholder"/>
        </div>

        <div>
          <label for="mode" data-i18n="label.mode">Mode</label><br/>
          <select id="mode">
            <option value="CT" data-i18n="mode.ct">Cycle Time (CT)</option>
            <option value="MLD" data-i18n="mode.mld">Machine &amp; Load/Unload</option>
          </select>
        </div>

        <div>
          <label for="efficiency" data-i18n="label.efficiency">Efficiency %</label><br/>
          <input id="efficiency" type="number" value="100" min="0" max="100" step="1"/>
        </div>

        <div>
          <label for="contractPcd" data-i18n="label.contractPcd">Contract Cap (pcs/day)</label><br/>
          <input id="contractPcd" type="number" min="0" max="99999" step="1"/>
        </div>

        <div>
          <label for="hoursPerDay" data-i18n="label.hoursPerDay">Hours / Day</label><br/>
          <input id="hoursPerDay" type="number" value="8" min="0" max="24" step=".5"/>
        </div>

        <div>
          <label for="daysPerWeek" data-i18n="label.daysPerWeek">Days / Week</label><br/>
          <input id="daysPerWeek" type="number" value="5" min="1" max="7"/>
        </div>

        <div>
          <label for="capView" data-i18n="label.capView">Capacity View</label><br/>
          <select id="capView">
            <option value="hour" data-i18n="capView.hour">per Hour</option>
            <option value="day" data-i18n="capView.day">per Day</option>
            <option value="week" data-i18n="capView.week">per Week</option>
          </select>
        </div>
      </div>
    </div>

    <div class="section-card" data-accent="green">
      <div class="section-title" data-i18n="section.contractSummary">Contract vs Capacity Summary</div>

      <div class="info-stack" style="margin-top:4px;">
        <div class="info-line sample-neutral" id="contractSumLine1">—</div>
        <div class="info-line sample-neutral" id="contractSumLine2">—</div>
        <div class="info-line sample-neutral" id="contractSumLine3">—</div>
        <div class="info-line sample-neutral" id="contractSumLine4">—</div>
      </div>

      <div style="font-size:.68rem;color:var(--text-muted);margin:6px 0 0;">
        <span data-i18n="contract.note">Uses current process + your laps (Median/P10/P90) with the Measurement Setup assumptions.</span>
      </div>
    </div>
    <div class="section-card" data-accent="amber">
      <div class="section-title" data-i18n="section.statsFocus">Stats Focus</div>

      <div class="mode-row">
        <div>
          <label for="focusMetric" data-i18n="label.focusMetric">Metric</label><br/>
          <select id="focusMetric">
            <option value="median" data-i18n="metric.median">Median</option>
            <option value="p10" data-i18n="metric.p10">P10 (Best)</option>
            <option value="p90" data-i18n="metric.p90">P90 (Worst)</option>
            <option value="avg" data-i18n="metric.avg">Average</option>
            <option value="stdev" data-i18n="metric.stdev">Std Dev</option>
            <option value="cpk" data-i18n="metric.cpk">Cpk (ref)</option>
          </select>
        </div>

        <div>
          <label for="lsl" data-i18n="label.lsl">LSL</label><br/>
          <input id="lsl" type="number" min="0" step=".01" placeholder="-" />
        </div>

        <div>
          <label for="usl" data-i18n="label.usl">USL</label><br/>
          <input id="usl" type="number" min="0" step=".01" placeholder="-" />
        </div>

        <div>
          <label for="target" data-i18n="label.target">Target</label><br/>
          <input id="target" type="number" min="0" step=".01" placeholder="-" />
        </div>

        <div>
          <label for="sigmaAssume" data-i18n="label.sigmaAssume">Sigma (if needed)</label><br/>
          <input id="sigmaAssume" type="number" min="0" step=".001" placeholder="-" />
        </div>
      </div>

      <div class="info-stack" style="margin-top:8px;">
        <div class="info-line sample-neutral" id="statsLine1">—</div>
        <div class="info-line sample-neutral" id="statsLine2">—</div>
        <div class="info-line sample-neutral" id="statsLine3">—</div>
      </div>
    </div>

    <div class="section-card" data-accent="red">
      <div class="section-title" data-i18n="section.dataControls">Data Controls</div>

      <div class="btn-row-secondary">
        <button class="btn-small btn-small-copy" id="btnCopyAll" data-i18n="btn.copyAll">Copy All Data</button>
        <button class="btn-small btn-small-summary" id="btnSummary" data-i18n="btn.summary">Summary</button>
        <button class="btn-small btn-small-manual" id="btnManual" data-i18n="btn.manual">Method & Guide</button>
        <button class="btn-small btn-small-reset" id="btnReset" data-i18n="btn.reset">RESET</button>
      </div>

      <div class="footer-note" id="copyHint" style="text-align:left;">—</div>
    </div>

    <div class="section-card" data-accent="grey">
      <div class="section-title">WB – Workbench (Capacity Planner)</div>

      <div class="mode-row" style="align-items:center;">
        <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
          <button class="btn-small btn-small-wbadd" id="wbAddRow">+ Add Row</button>
          <button class="btn-small btn-small-wbclear" id="wbClearAll">Clear WB</button>
          <button class="btn-small btn-small-copy" id="wbCopy">Copy WB</button>
        </div>

        <div style="margin-left:auto;">
          <label style="display:flex;gap:8px;align-items:center;">
            <input class="wb-chk" id="wbShowHelp" type="checkbox" />
            <span data-i18n="wb.showHelp">Show field rules</span>
          </label>
        </div>
      </div>

      <div class="wb-mini" id="wbHelp" style="display:none;">
        <div><b>Ranges</b> — Operators: 0–10 | Shift: 1–4 | Hours: 0–24 (step .5) | Machines: 1–50</div>
        <div>Contract: editable | Lunch/Changeover/5S/Maintenance/Other/Shared: 0–1440 minutes/day</div>
        <div>Scrap / A / P / Q: 0–100%</div>
      </div>

      <div style="overflow:auto;border-radius:14px;border:1px solid rgba(255,255,255,.06);margin-top:8px;">
        <table id="wbTable">
          <thead>
            <tr>
              <th style="text-align:center;">On</th>
              <th style="text-align:left;">Operation</th>
              <th style="text-align:center;">Operators</th>
              <th style="text-align:center;">Shift</th>
              <th style="text-align:center;">Hours</th>
              <th style="text-align:center;">Machines</th>
              <th style="text-align:center;">Contract (pcs/day)</th>
              <th style="text-align:center;">Lunch (min)</th>
              <th style="text-align:center;">Changeover (min)</th>
              <th style="text-align:center;">5S (min)</th>
              <th style="text-align:center;">Maintenance (min)</th>
              <th style="text-align:center;">Other (min)</th>
              <th style="text-align:center;">Shared (min)</th>
              <th style="text-align:center;">Scrap %</th>
              <th style="text-align:center;">A %</th>
              <th style="text-align:center;">P %</th>
              <th style="text-align:center;">Q %</th>
              <th style="text-align:center;">Net Cap (pcs/day)</th>
              <th style="text-align:center;">Gap</th>
              <th style="text-align:center;">Actions</th>
            </tr>
          </thead>
          <tbody id="wbBody"></tbody>
        </table>
      </div>

      <div class="wb-alert">
        <div class="wb-badge-title" data-i18n="wb.summary">WB Summary</div>
        <span class="badge badge-good" id="wbStatus">—</span>
        <span class="badge badge-warn" id="wbBottleneck">—</span>
        <span class="badge badge-bad" id="wbRisk">—</span>
      </div>

      <div class="wb-sumline" id="wbSumLine">—</div>
      <div class="wb-mini" id="wbMiniNote" data-i18n="wb.note">
        Note: Net Cap uses current TaktLab stats when Operation is linked; otherwise uses the manual CT if you set it in the operation field (e.g. "Op 30 @ 18.2s").
      </div>
    </div>

    <div class="section-card" data-accent="blue">
      <div class="section-title" data-i18n="section.charts">Charts</div>
      <div class="charts-wrapper">
        <div class="chart-card">
          <div class="chart-title" data-i18n="chart.hist">Histogram</div>
          <canvas id="histCanvas" width="400" height="200"></canvas>
        </div>
        <div class="chart-card">
          <div class="chart-title" data-i18n="chart.run">Run Chart</div>
          <canvas id="runCanvas" width="400" height="200"></canvas>
        </div>
        <div class="chart-card">
          <div class="chart-title" data-i18n="chart.box">Box (P10/Median/P90)</div>
          <canvas id="boxCanvas" width="400" height="200"></canvas>
        </div>
      </div>
    </div>

    <div class="section-card" data-accent="grey">
      <div class="section-title" data-i18n="section.rawData">Raw Data</div>
      <div style="overflow:auto;border-radius:14px;border:1px solid rgba(255,255,255,.06);">
        <table>
          <thead>
            <tr>
              <th data-i18n="raw.lap">Lap #</th>
              <th data-i18n="raw.ct">CT (s)</th>
              <th data-i18n="raw.t1">T1 (s)</th>
              <th data-i18n="raw.t2">T2 (s)</th>
              <th data-i18n="raw.process">Process</th>
              <th data-i18n="raw.mode">Mode</th>
              <th data-i18n="raw.actions">Actions</th>
            </tr>
          </thead>
          <tbody id="lapTable"></tbody>
        </table>
      </div>
    </div>

    <div class="section-card" data-accent="amber" id="manualSection" style="display:none;">
      <div class="section-title" data-i18n="manual.title">Method & Guide</div>
      <div style="font-size:.78rem;color:var(--text-soft);line-height:1.35;">
        <ul style="margin:0;padding-left:18px;">
          <li data-i18n="manual.1">Use LAP to capture cycle time samples. For MLD mode, use LAP for CT and the small split buttons (T1/T2) to log machine and load/unload.</li>
          <li data-i18n="manual.2">Median is the default robust estimator. P10/P90 show best/worst typical performance.</li>
          <li data-i18n="manual.3">Sample-size guidance uses a 95% confidence estimate of error; aim for ±3% when possible.</li>
          <li data-i18n="manual.4">WB lets you plan capacity with real constraints: breaks, changeovers, scrap, shared downtime.</li>
        </ul>
      </div>
    </div>

    <div class="section-card" data-accent="grey">
      <div class="section-title">Conclusions</div>
      <div class="conc-wrap">
        <textarea id="concText" class="conc-text" placeholder="Write your conclusions here..."></textarea>
        <div class="conc-hint" id="concHint">Tip: you can copy conclusions together with Summary to send as an executive note.</div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;">
          <button class="btn-small btn-small-conc" id="btnConcCopy">Copy Conclusions</button>
          <button class="btn-small btn-small-reset" id="btnConcClear">Clear Conclusions</button>
        </div>
      </div>
    </div>

  </div><!-- /content-section -->
</div><!-- /page -->

<script>
/* ===========================
   TaktLab + WB – Unified Logic
   (No user edits required)
   =========================== */

(() => {
  "use strict";

  // ---------- DOM ----------
  const el = (id)=>document.getElementById(id);
  const display = el("display");
  const timerCard = el("timerCard");
  const logoGear = el("logoGear");

  const btnStart = el("btnStart");
  const btnLap = el("btnLap");

  const processName = el("processName");
  const modeSel = el("mode");
  const efficiency = el("efficiency");
  const contractPcd = el("contractPcd");
  const hoursPerDay = el("hoursPerDay");
  const daysPerWeek = el("daysPerWeek");
  const capView = el("capView");

  const sampleInfoTop = el("sampleInfoTop");

  const contractSumLine1 = el("contractSumLine1");
  const contractSumLine2 = el("contractSumLine2");
  const contractSumLine3 = el("contractSumLine3");
  const contractSumLine4 = el("contractSumLine4");

  const focusMetric = el("focusMetric");
  const lsl = el("lsl");
  const usl = el("usl");
  const target = el("target");
  const sigmaAssume = el("sigmaAssume");

  const statsLine1 = el("statsLine1");
  const statsLine2 = el("statsLine2");
  const statsLine3 = el("statsLine3");

  const btnCopyAll = el("btnCopyAll");
  const btnSummary = el("btnSummary");
  const btnManual = el("btnManual");
  const btnReset = el("btnReset");
  const copyHint = el("copyHint");

  const manualSection = el("manualSection");

  const lapTable = el("lapTable");

  const histCanvas = el("histCanvas");
  const runCanvas = el("runCanvas");
  const boxCanvas = el("boxCanvas");

  // Split clocks
  const t1Clock = el("t1Clock");
  const t2Clock = el("t2Clock");

  // WB
  const wbBody = el("wbBody");
  const wbAddRow = el("wbAddRow");
  const wbClearAll = el("wbClearAll");
  const wbCopy = el("wbCopy");
  const wbShowHelp = el("wbShowHelp");
  const wbHelp = el("wbHelp");
  const wbStatus = el("wbStatus");
  const wbBottleneck = el("wbBottleneck");
  const wbRisk = el("wbRisk");
  const wbSumLine = el("wbSumLine");
  const wbMiniNote = el("wbMiniNote");

  // Conclusions
  const concText = el("concText");
  const concHint = el("concHint");
  const btnConcCopy = el("btnConcCopy");
  const btnConcClear = el("btnConcClear");

  // Language
  const langBtns = Array.from(document.querySelectorAll(".lang-btn"));

  // ---------- State ----------
  let running = false;
  let t0 = 0;
  let raf = null;

  let lastLapAt = 0;

  // MLD split capture
  let t1Total = 0;
  let t2Total = 0;

  // laps: {id, ct, t1, t2, process, mode}
  let laps = [];
  let lapId = 1;

  // WB rows
  let wbRows = [];
  let wbRowId = 1;

  // i18n
  let LANG = "en";

  // ---------- Utils ----------
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
  const round = (v,n=2)=>Number.isFinite(v)? Number(v.toFixed(n)) : v;
  const safeNum = (x, def=0)=>{
    const v = Number(x);
    return Number.isFinite(v) ? v : def;
  };
  const fmt = (sec)=>{
    sec = Math.max(0, sec);
    const m = Math.floor(sec/60);
    const s = sec - m*60;
    const ss = Math.floor(s);
    const cs = Math.floor((s-ss)*100);
    const mm = String(m).padStart(2,"0");
    const sss = String(ss).padStart(2,"0");
    const ccs = String(cs).padStart(2,"0");
    return `${mm}:${sss}.${ccs}`;
  };

  const flash = ()=>{
    timerCard.classList.remove("flash");
    void timerCard.offsetWidth;
    timerCard.classList.add("flash");
  };

  const percentile = (arr, p)=>{
    if(!arr.length) return NaN;
    const a = [...arr].sort((x,y)=>x-y);
    const idx = (a.length-1)*p;
    const lo = Math.floor(idx);
    const hi = Math.ceil(idx);
    if(lo===hi) return a[lo];
    const w = idx - lo;
    return a[lo]*(1-w) + a[hi]*w;
  };

  const mean = (arr)=>{
    if(!arr.length) return NaN;
    return arr.reduce((s,x)=>s+x,0)/arr.length;
  };

  const stdev = (arr)=>{
    if(arr.length<2) return NaN;
    const mu = mean(arr);
    const v = arr.reduce((s,x)=>s+(x-mu)*(x-mu),0)/(arr.length-1);
    return Math.sqrt(v);
  };

  const median = (arr)=>percentile(arr,.5);

  // 95% CI half-width for mean: 1.96*sd/sqrt(n) (approx)
  const err95 = (arr)=>{
    if(arr.length<2) return NaN;
    const sd = stdev(arr);
    const n = arr.length;
    return 1.96*sd/Math.sqrt(n);
  };

  const pct = (v)=>`${round(v,1)}%`;

  const now = ()=>performance.now();

  // ---------- i18n map ----------
  const I18N = {
    en:{
      "title.subtitle":"Cycle Time & Capacity Analyzer",
      "btn.start":"Start","btn.stop":"Stop","btn.lap":"LAP",
      "section.measurementSetup":"Measurement Setup",
      "section.contractSummary":"Contract vs Capacity Summary",
      "section.statsFocus":"Stats Focus",
      "section.dataControls":"Data Controls",
      "section.charts":"Charts",
      "section.rawData":"Raw Data",
      "manual.title":"Method & Guide",
      "manual.1":"Use LAP to capture cycle time samples. For MLD mode, use LAP for CT and the split capture buttons for T1/T2 if you enable them.",
      "manual.2":"Median is the default robust estimator. P10/P90 show best/worst typical performance.",
      "manual.3":"Sample-size guidance uses a 95% confidence estimate of error; aim for ±3% when possible.",
      "manual.4":"WB lets you plan capacity with real constraints: breaks, changeovers, scrap, shared downtime.",
      "label.process":"Process",
      "label.processPlaceholder":"e.g. Op 30-1",
      "label.mode":"Mode",
      "mode.ct":"Cycle Time (CT)",
      "mode.mld":"Machine & Load/Unload",
      "label.efficiency":"Efficiency %",
      "label.contractPcd":"Contract Cap (pcs/day)",
      "label.hoursPerDay":"Hours / Day",
      "label.daysPerWeek":"Days / Week",
      "label.capView":"Capacity View",
      "capView.hour":"per Hour",
      "capView.day":"per Day",
      "capView.week":"per Week",
      "label.focusMetric":"Metric",
      "metric.median":"Median",
      "metric.p10":"P10 (Best)",
      "metric.p90":"P90 (Worst)",
      "metric.avg":"Average",
      "metric.stdev":"Std Dev",
      "metric.cpk":"Cpk (ref)",
      "label.lsl":"LSL",
      "label.usl":"USL",
      "label.target":"Target",
      "label.sigmaAssume":"Sigma (if needed)",
      "btn.copyAll":"Copy All Data",
      "btn.summary":"Summary",
      "btn.manual":"Method & Guide",
      "btn.reset":"RESET",
      "raw.lap":"Lap #","raw.ct":"CT (s)","raw.t1":"T1 (s)","raw.t2":"T2 (s)","raw.process":"Process","raw.mode":"Mode","raw.actions":"Actions",
      "chart.hist":"Histogram","chart.run":"Run Chart","chart.box":"Box (P10/Median/P90)",
      "wb.showHelp":"Show field rules",
      "wb.summary":"WB Summary",
      "wb.note":"Note: Net Cap uses current TaktLab stats when Operation is linked; otherwise uses the manual CT if you set it in the operation field (e.g. \"Op 30 @ 18.2s\")."
    },
    es:{
      "title.subtitle":"Analizador de Tiempo Ciclo y Capacidad",
      "btn.start":"Iniciar","btn.stop":"Detener","btn.lap":"VUELTA",
      "section.measurementSetup":"Configuración de Medición",
      "section.contractSummary":"Resumen Contrato vs Capacidad",
      "section.statsFocus":"Enfoque Estadístico",
      "section.dataControls":"Controles de Datos",
      "section.charts":"Gráficas",
      "section.rawData":"Datos Crudos",
      "manual.title":"Método y Guía",
      "manual.1":"Usa VUELTA para capturar muestras de tiempo ciclo. En modo MLD puedes registrar CT y, si lo usas, T1/T2.",
      "manual.2":"La Mediana es el estimador robusto por defecto. P10/P90 muestran mejor/peor desempeño típico.",
      "manual.3":"La guía de tamaño de muestra usa un estimado de error al 95%; apunta a ±3% cuando sea posible.",
      "manual.4":"WB te permite planear capacidad con restricciones reales: breaks, cambios, scrap y tiempos compartidos.",
      "label.process":"Proceso",
      "label.processPlaceholder":"ej. Op 30-1",
      "label.mode":"Modo",
      "mode.ct":"Tiempo Ciclo (CT)",
      "mode.mld":"Máquina + Carga/Descarga",
      "label.efficiency":"Eficiencia %",
      "label.contractPcd":"Contrato (pzas/día)",
      "label.hoursPerDay":"Horas / Día",
      "label.daysPerWeek":"Días / Semana",
      "label.capView":"Vista Capacidad",
      "capView.hour":"por Hora",
      "capView.day":"por Día",
      "capView.week":"por Semana",
      "label.focusMetric":"Métrica",
      "metric.median":"Mediana",
      "metric.p10":"P10 (Mejor)",
      "metric.p90":"P90 (Peor)",
      "metric.avg":"Promedio",
      "metric.stdev":"Desv. Est.",
      "metric.cpk":"Cpk (ref)",
      "label.lsl":"LSL",
      "label.usl":"USL",
      "label.target":"Objetivo",
      "label.sigmaAssume":"Sigma (si aplica)",
      "btn.copyAll":"Copiar Todo",
      "btn.summary":"Resumen",
      "btn.manual":"Método y Guía",
      "btn.reset":"REINICIAR",
      "raw.lap":"Vuelta #","raw.ct":"CT (s)","raw.t1":"T1 (s)","raw.t2":"T2 (s)","raw.process":"Proceso","raw.mode":"Modo","raw.actions":"Acciones",
      "chart.hist":"Histograma","chart.run":"Gráfica de Corrida","chart.box":"Caja (P10/Mediana/P90)",
      "wb.showHelp":"Mostrar reglas de campos",
      "wb.summary":"Resumen WB",
      "wb.note":"Nota: Net Cap usa las estadísticas actuales de TaktLab cuando la Operación está ligada; si no, usa un CT manual si lo pones en el campo (ej. \"Op 30 @ 18.2s\")."
    }
  };

  // ---------- i18n apply ----------
  function applyLang(lang){
    LANG = lang;
    langBtns.forEach(b=>b.classList.toggle("active", b.dataset.lang===lang));
    document.querySelectorAll("[data-i18n]").forEach(node=>{
      const key = node.getAttribute("data-i18n");
      if(I18N[LANG] && I18N[LANG][key]) node.textContent = I18N[LANG][key];
    });
    document.querySelectorAll("[data-i18n-placeholder]").forEach(node=>{
      const key = node.getAttribute("data-i18n-placeholder");
      if(I18N[LANG] && I18N[LANG][key]) node.setAttribute("placeholder", I18N[LANG][key]);
    });
    // update dynamic labels
    updateAll();
  }

  langBtns.forEach(btn=>{
    btn.addEventListener("click", ()=>applyLang(btn.dataset.lang));
  });

  // ---------- Timer ----------
  function setRunning(on){
    running = on;
    if(running){
      t0 = now();
      lastLapAt = t0;
      logoGear.classList.add("spinning");
      btnStart.textContent = I18N[LANG]["btn.stop"] || "Stop";
      loop();
    }else{
      logoGear.classList.remove("spinning");
      btnStart.textContent = I18N[LANG]["btn.start"] || "Start";
      if(raf) cancelAnimationFrame(raf);
      raf = null;
    }
  }

  function loop(){
    if(!running) return;
    const t = now();
    const elapsed = (t - t0)/1000;
    display.textContent = fmt(elapsed);
    // split clocks show current segment if MLD
    if(modeSel.value==="MLD"){
      const seg = (t - lastLapAt)/1000;
      // show running segment as both, totals shown separately in laps; here mirror segment
      t1Clock.textContent = fmt(seg);
      t2Clock.textContent = fmt(seg);
    }else{
      t1Clock.textContent = "00:00.00";
      t2Clock.textContent = "00:00.00";
    }
    raf = requestAnimationFrame(loop);
  }

  btnStart.addEventListener("click", ()=>{
    setRunning(!running);
  });

  // ---------- Lap capture ----------
  function addLap(ct, t1=NaN, t2=NaN){
    const proc = (processName.value || "").trim() || (LANG==="es" ? "Sin nombre" : "Unnamed");
    const mode = modeSel.value;
    laps.push({id:lapId++, ct, t1, t2, process:proc, mode});
    renderLapTable();
    updateAll();
  }

  btnLap.addEventListener("click", ()=>{
    if(!running) return;
    const t = now();
    const ct = (t - lastLapAt)/1000;
    lastLapAt = t;
    flash();

    if(modeSel.value==="MLD"){
      // if user didn't split-capture, store NaN for T1/T2 but keep CT
      addLap(ct, NaN, NaN);
    }else{
      addLap(ct, NaN, NaN);
    }
  });

  // ---------- Lap table render ----------
  function renderLapTable(){
    lapTable.innerHTML = "";
    laps.forEach((r, idx)=>{
      const tr = document.createElement("tr");

      const td1 = document.createElement("td");
      td1.textContent = r.id;
      tr.appendChild(td1);

      const td2 = document.createElement("td");
      td2.textContent = round(r.ct,2);
      tr.appendChild(td2);

      const td3 = document.createElement("td");
      td3.textContent = Number.isFinite(r.t1) ? round(r.t1,2) : "-";
      tr.appendChild(td3);

      const td4 = document.createElement("td");
      td4.textContent = Number.isFinite(r.t2) ? round(r.t2,2) : "-";
      tr.appendChild(td4);

      const td5 = document.createElement("td");
      td5.textContent = r.process;
      tr.appendChild(td5);

      const td6 = document.createElement("td");
      td6.textContent = r.mode;
      tr.appendChild(td6);

      const td7 = document.createElement("td");
      td7.style.textAlign="right";
      const btnE = document.createElement("button");
      btnE.className = "btn-edit";
      btnE.textContent = "Edit";
      btnE.addEventListener("click", ()=>editLap(idx));
      const btnD = document.createElement("button");
      btnD.className = "btn-del";
      btnD.textContent = "Del";
      btnD.addEventListener("click", ()=>{
        laps.splice(idx,1);
        renderLapTable();
        updateAll();
      });
      td7.appendChild(btnE);
      td7.appendChild(document.createTextNode(" "));
      td7.appendChild(btnD);
      tr.appendChild(td7);

      lapTable.appendChild(tr);
    });
  }

  function editLap(index){
    const r = laps[index];
    const newCt = prompt("CT seconds:", String(r.ct));
    if(newCt===null) return;
    const v = safeNum(newCt, r.ct);
    r.ct = Math.max(0, v);

    if(r.mode==="MLD"){
      const newT1 = prompt("T1 seconds (blank to keep '-'): ", Number.isFinite(r.t1)? String(r.t1) : "");
      if(newT1!==null && newT1.trim()!==""){
        r.t1 = Math.max(0, safeNum(newT1, r.t1));
      }
      const newT2 = prompt("T2 seconds (blank to keep '-'): ", Number.isFinite(r.t2)? String(r.t2) : "");
      if(newT2!==null && newT2.trim()!==""){
        r.t2 = Math.max(0, safeNum(newT2, r.t2));
      }
    }

    renderLapTable();
    updateAll();
  }
<!-- =========================
     PARTE 3 DE 4 — TaktLab (continuación JS)
     Pega esta parte INMEDIATAMENTE después de la Parte 2/4
========================= -->

  /* =========================
     UTILITIES: copy, rounding
     ========================= */
  function copyText(text){
    try{
      navigator.clipboard.writeText(text);
    }catch(e){
      const ta=document.createElement('textarea');
      ta.value=text; document.body.appendChild(ta);
      ta.select(); document.execCommand('copy');
      document.body.removeChild(ta);
    }
  }

  function round2(n){
    if(!isFinite(n)) return NaN;
    return Math.round(n*100)/100;
  }

  function safeNum(v, def=0){
    const n=parseFloat(v);
    return isFinite(n)?n:def;
  }

  function parsePct(v, def=0){
    const n=parseFloat(v);
    if(!isFinite(n)) return def;
    return clamp(n,0,100);
  }

  /* =========================
     CAPABILITY (Cp/Cpk) HELPERS
     ========================= */
  // Using a simple ±3σ band around median as pseudo spec if no real LSL/USL is provided.
  // This keeps the "capability" indicators directional without pretending customer specs exist.
  function calcCpCpk(stats){
    if(!stats || !isFinite(stats.std) || stats.std<=0) return {cp:NaN, cpk:NaN};
    const mean=stats.mean;
    const std=stats.std;

    // Pseudo-spec: centered around median with width based on dispersion.
    const center=stats.median;
    const LSL = center - 3*std;
    const USL = center + 3*std;

    const cp = (USL-LSL)/(6*std);
    const cpk = Math.min((USL-mean)/(3*std), (mean-LSL)/(3*std));
    return {cp, cpk};
  }

  /* =========================
     CONTRACT SUMMARY + FOCUS
     ========================= */
  function buildContractLinesForCurrentSelection(){
    const proc = (processInput.value||'').trim();
    const mode = modeSelect.value || 'CT';

    const hours = clamp(parseFloat(hInput.value)||8,1,24);
    const days  = clamp(parseFloat(dInput.value)||5,1,7);
    const eff   = clamp(parseFloat(effInput.value)||100,0,100)/100;

    const view  = capViewSel.value || 'hour';
    const contractPcd = clamp(parseFloat(pcdInput.value)||0,0,999999);
    const contractUnits = contractUnitsFromPcd(contractPcd, view, hours, days);

    const map = groupByProcess();
    const key = proc + '||' + mode;
    const arr = map.get(key) || [];

    if(!proc){
      return {
        l1: currentLang==='es' ? 'Proceso: (vacío)' : 'Process: (empty)',
        l2: '—', l3:'—', l4:'—'
      };
    }

    if(arr.length<1){
      return {
        l1: (currentLang==='es' ? `Proceso: ${proc} · Modo: ${mode}` : `Process: ${proc} · Mode: ${mode}`),
        l2: (currentLang==='es' ? `Contrato (${view}): ${formatUnits(contractUnits)} (ref)` : `Contract (${view}): ${formatUnits(contractUnits)} (ref)`),
        l3: (currentLang==='es' ? 'Sin vueltas todavía: captura laps para calcular capacidad.' : 'No laps yet: capture laps to compute capacity.'),
        l4: '—'
      };
    }

    const st = calcStats(arr);
    const med = st.median;
    const p10 = st.p10;
    const p90 = st.p90;

    // capacity at efficiency using CTmed as “current”, P10 “potential”, P90 “worst”
    const curCap = capFromCt(med, view, hours, days) * eff;
    const potCap = capFromCt(p10, view, hours, days) * eff;
    const wstCap = capFromCt(p90, view, hours, days) * eff;

    const gapCur = (contractUnits>0) ? (curCap - contractUnits) : NaN;
    const vsCur  = (contractUnits>0) ? (curCap/contractUnits*100) : NaN;

    const l1 = (currentLang==='es'
      ? `Proceso: ${proc} · Modo: ${mode} · Eff: ${Math.round(eff*100)}%`
      : `Process: ${proc} · Mode: ${mode} · Eff: ${Math.round(eff*100)}%`
    );

    const l2 = (currentLang==='es'
      ? `Contrato (${view}): ${formatUnits(contractUnits)}  (Base: ${formatUnits(contractPcd)} pzs/día)`
      : `Contract (${view}): ${formatUnits(contractUnits)}  (Base: ${formatUnits(contractPcd)} pcs/day)`
    );

    const l3 = (currentLang==='es'
      ? `Capacidad @Eff (${view}): Actual ${formatUnits(curCap)} · Potencial ${formatUnits(potCap)} · Peor ${formatUnits(wstCap)}`
      : `Capacity @Eff (${view}): Current ${formatUnits(curCap)} · Potential ${formatUnits(potCap)} · Worst ${formatUnits(wstCap)}`
    );

    const l4 = (contractUnits>0 && isFinite(vsCur))
      ? (currentLang==='es'
          ? `Gap (Actual - Contrato): ${formatUnits(gapCur)} · % vs: ${pct(vsCur,0)}`
          : `Gap (Current - Contract): ${formatUnits(gapCur)} · % vs: ${pct(vsCur,0)}`
        )
      : (currentLang==='es' ? 'Contrato no cargado (pon Contract Cap).' : 'Contract not loaded (set Contract Cap).');

    return {l1,l2,l3,l4, st};
  }

  function renderContractSummaryAndFocus(){
    const bundle = buildContractLinesForCurrentSelection();
    contractSumLine1.textContent = bundle.l1;
    contractSumLine2.textContent = bundle.l2;
    contractSumLine3.textContent = bundle.l3;
    contractSumLine4.textContent = bundle.l4;

    // focus info lines
    const st = bundle.st;
    if(!st){
      sampleInfoFocus.textContent = (currentLang==='es' ? 'Tamaño de muestra: —' : 'Sample size: —');
      stdInfoFocus.textContent    = (currentLang==='es' ? 'Desv est: —' : 'Std dev: —');
      distInfoFocus.textContent   = (currentLang==='es' ? 'Media vs Mediana: —' : 'Mean vs Median: —');
      contractInfoFocus.textContent = (currentLang==='es' ? 'Sin contrato cargado' : 'No contract loaded');
      return;
    }

    const sampleLine = buildSampleLine(st);
    sampleInfoFocus.textContent = sampleLine.text;
    sampleInfoFocus.className = 'info-line ' + sampleLine.cls;

    stdInfoFocus.textContent = (currentLang==='es'
      ? `Desv est: ${formatSecs(st.std)} s · CV: ${(st.cv*100).toFixed(1)}%`
      : `Std dev: ${formatSecs(st.std)} s · CV: ${(st.cv*100).toFixed(1)}%`
    );

    const skew = (st.mean - st.median);
    distInfoFocus.textContent = (currentLang==='es'
      ? `Media vs Mediana: Δ ${formatSecs(skew)} s`
      : `Mean vs Median: Δ ${formatSecs(skew)} s`
    );

    const contractPcd = clamp(parseFloat(pcdInput.value)||0,0,999999);
    contractInfoFocus.textContent = contractPcd>0
      ? (currentLang==='es' ? `Contrato: ${formatUnits(contractPcd)} pzs/día` : `Contract: ${formatUnits(contractPcd)} pcs/day`)
      : (currentLang==='es' ? 'Sin contrato cargado' : 'No contract loaded');
  }

  /* =========================
     TABLES: STATS + FOCUS
     ========================= */
  function renderStatsTables(){
    // Stats Detail table (per process/mode)
    const map = groupByProcess();
    statsBody.innerHTML='';
    focusBody.innerHTML='';

    const hours = clamp(parseFloat(hInput.value)||8,1,24);
    const days  = clamp(parseFloat(dInput.value)||5,1,7);
    const eff   = clamp(parseFloat(effInput.value)||100,0,100)/100;
    const view  = capViewSel.value || 'hour';
    const contractPcd = clamp(parseFloat(pcdInput.value)||0,0,999999);
    const contractUnits = contractUnitsFromPcd(contractPcd, view, hours, days);

    // build sorted keys
    const keys = [...map.keys()].sort((a,b)=>a.localeCompare(b, undefined, {numeric:true, sensitivity:'base'}));

    keys.forEach(key=>{
      const [proc, mode] = key.split('||');
      const arr = map.get(key)||[];
      const st = calcStats(arr);
      if(!st) return;

      // stats detail row
      {
        const tr=document.createElement('tr');
        const {cp, cpk} = calcCpCpk(st);
        const cells = [
          proc, mode, st.n,
          formatSecs(st.mean), formatSecs(st.median),
          formatSecs(st.p10), formatSecs(st.p90),
          formatSecs(st.min), formatSecs(st.max),
          formatSecs(st.std),
          (st.cv*100).toFixed(1),
          isFinite(cp)?cp.toFixed(2):'-',
          isFinite(cpk)?cpk.toFixed(2):'-'
        ];
        cells.forEach((c,i)=>{
          const td=document.createElement('td');
          td.textContent = String(c);
          if(i===0) td.style.textAlign='left';
          if(i===1) td.style.textAlign='left';
          tr.appendChild(td);
        });
        statsBody.appendChild(tr);
      }

      // focus table row
      {
        const tr=document.createElement('tr');

        const sampleLine = buildSampleLine(st);

        const curCap = capFromCt(st.median, view, hours, days) * eff;
        const potCap = capFromCt(st.p10, view, hours, days) * eff;
        const wstCap = capFromCt(st.p90, view, hours, days) * eff;

        const gap = (contractUnits>0) ? (curCap - contractUnits) : NaN;
        const vs  = (contractUnits>0) ? (curCap/contractUnits*100) : NaN;

        const {cp, cpk} = calcCpCpk(st);

        const note = sampleLine.text;

        const cells = [
          proc,
          mode,
          st.n,
          note,
          formatSecs(st.std),
          (st.cv*100).toFixed(1),
          formatSecs(st.median),
          formatSecs(st.p10),
          formatSecs(st.p90),
          formatUnits(curCap),
          formatUnits(potCap),
          formatUnits(wstCap),
          contractPcd>0 ? formatUnits(contractUnits) : '-',
          isFinite(gap)?formatUnits(gap):'-',
          isFinite(vs)?pct(vs,0):'-',
          isFinite(cp)?cp.toFixed(2):'-',
          isFinite(cpk)?cpk.toFixed(2):'-',
          ''
        ];

        cells.forEach((c,i)=>{
          const td=document.createElement('td');
          if(i===0 || i===1 || i===3 || i===17){ td.style.textAlign='left'; }
          if(i===3){
            const span=document.createElement('span');
            span.className = 'badge ' + (sampleLine.cls==='sample-good'?'badge-good':(sampleLine.cls==='sample-bad'?'badge-bad':'badge-warn'));
            span.textContent = c;
            td.appendChild(span);
          }else{
            td.textContent = String(c);
          }
          tr.appendChild(td);
        });

        focusBody.appendChild(tr);
      }
    });

    // top sample info for current selected process
    const proc = (processInput.value||'').trim();
    const mode = modeSelect.value || 'CT';
    const curKey = proc + '||' + mode;
    const curArr = map.get(curKey) || [];
    if(curArr.length<1){
      setInfo(sampleInfoTop,'sample-neutral',
        currentLang==='es'
          ? 'Sin muestras todavía para el proceso actual. Empieza a capturar vueltas.'
          : 'No samples yet for current process. Start capturing laps.'
      );
    }else{
      const st = calcStats(curArr);
      const line = buildSampleLine(st);
      setInfo(sampleInfoTop, line.cls, line.text);
    }
  }

  /* =========================
     CHARTS
     ========================= */
  function ctx2d(canvas){
    const ctx = canvas.getContext('2d');
    const rect = canvas.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    canvas.width  = Math.floor(rect.width * dpr);
    canvas.height = Math.floor(rect.height * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    return ctx;
  }

  function clearCanvas(ctx, canvas){
    const rect = canvas.getBoundingClientRect();
    ctx.clearRect(0,0,rect.width,rect.height);
  }

  function drawAxes(ctx, w, h, pad){
    ctx.globalAlpha = 0.7;
    ctx.lineWidth = 1;
    ctx.strokeStyle = 'rgba(255,255,255,.18)';
    ctx.beginPath();
    ctx.moveTo(pad, pad);
    ctx.lineTo(pad, h-pad);
    ctx.lineTo(w-pad, h-pad);
    ctx.stroke();
    ctx.globalAlpha = 1;
  }

  function drawTimeSeries(proc, mode){
    const ctx = ctx2d(timeSeriesCanvas);
    const rect = timeSeriesCanvas.getBoundingClientRect();
    const w = rect.width, h = rect.height;
    ctx.clearRect(0,0,w,h);
    const pad=18;
    drawAxes(ctx,w,h,pad);

    const map = groupByProcess();
    const key = proc + '||' + mode;
    const arr = map.get(key) || [];
    if(arr.length<2) return;

    const vals = arr.map(x=>x.total);
    const st = calcStats(arr);
    const mean = st.mean;
    const med = st.median;
    const std = st.std;

    const minV = Math.min(...vals, mean-3*std, med-3*std);
    const maxV = Math.max(...vals, mean+3*std, med+3*std);

    function x(i){
      return pad + ( (w-2*pad) * (i/(vals.length-1)) );
    }
    function y(v){
      const t = (v-minV)/(maxV-minV || 1);
      return (h-pad) - t*(h-2*pad);
    }

    // series
    ctx.strokeStyle='rgba(255,255,255,.55)';
    ctx.lineWidth=1.2;
    ctx.beginPath();
    vals.forEach((v,i)=>{
      const X=x(i), Y=y(v);
      if(i===0) ctx.moveTo(X,Y); else ctx.lineTo(X,Y);
    });
    ctx.stroke();

    // points
    ctx.fillStyle='rgba(255,255,255,.70)';
    vals.forEach((v,i)=>{
      const X=x(i), Y=y(v);
      ctx.beginPath(); ctx.arc(X,Y,2.2,0,Math.PI*2); ctx.fill();
    });

    // mean + median + bands
    function hline(v, alpha){
      ctx.globalAlpha=alpha;
      ctx.beginPath();
      ctx.moveTo(pad,y(v));
      ctx.lineTo(w-pad,y(v));
      ctx.stroke();
      ctx.globalAlpha=1;
    }

    ctx.strokeStyle='rgba(57,189,245,.85)'; // mean line
    ctx.lineWidth=1.2; hline(mean, 0.85);

    ctx.strokeStyle='rgba(242,193,78,.85)'; // median line
    ctx.lineWidth=1.2; hline(med, 0.85);

    ctx.strokeStyle='rgba(255,255,255,.25)'; // ±3σ around mean
    ctx.lineWidth=1; hline(mean+3*std, 0.25); hline(mean-3*std, 0.25);

    // labels
    ctx.fillStyle='rgba(255,255,255,.75)';
    ctx.font='11px system-ui';
    ctx.fillText(`Mean ${formatSecs(mean)}s`, pad+4, pad+10);
    ctx.fillText(`Median ${formatSecs(med)}s`, pad+4, pad+24);
  }

  function drawHistogram(proc, mode){
    const ctx = ctx2d(histCanvas);
    const rect = histCanvas.getBoundingClientRect();
    const w = rect.width, h = rect.height;
    ctx.clearRect(0,0,w,h);
    const pad=18;
    drawAxes(ctx,w,h,pad);

    const map = groupByProcess();
    const key = proc + '||' + mode;
    const arr = map.get(key) || [];
    if(arr.length<3) return;

    const vals = arr.map(x=>x.total).slice().sort((a,b)=>a-b);
    const st = calcStats(arr);

    const bins = Math.max(6, Math.min(18, Math.round(Math.sqrt(vals.length))));
    const minV = vals[0], maxV = vals[vals.length-1];
    const bw = (maxV-minV)/(bins || 1) || 1;

    const counts = new Array(bins).fill(0);
    vals.forEach(v=>{
      let idx = Math.floor((v-minV)/bw);
      if(idx>=bins) idx=bins-1;
      if(idx<0) idx=0;
      counts[idx]++;
    });
    const maxC = Math.max(...counts);

    const plotW = w-2*pad;
    const plotH = h-2*pad;

    // bars
    ctx.fillStyle='rgba(255,255,255,.35)';
    counts.forEach((c,i)=>{
      const x0 = pad + (i/bins)*plotW;
      const barW = (plotW/bins)*0.92;
      const barH = (c/(maxC||1))*plotH;
      ctx.fillRect(x0, (h-pad)-barH, barW, barH);
    });

    // median, p10, p90
    function vline(v, stroke){
      const t=(v-minV)/(maxV-minV || 1);
      const X= pad + t*plotW;
      ctx.strokeStyle=stroke;
      ctx.lineWidth=1.2;
      ctx.beginPath();
      ctx.moveTo(X,pad);
      ctx.lineTo(X,h-pad);
      ctx.stroke();
    }
    vline(st.median,'rgba(242,193,78,.85)');
    vline(st.p10,'rgba(24,201,122,.75)');
    vline(st.p90,'rgba(255,51,85,.75)');

    ctx.fillStyle='rgba(255,255,255,.75)';
    ctx.font='11px system-ui';
    ctx.fillText(`P10 ${formatSecs(st.p10)}s`, pad+4, pad+10);
    ctx.fillText(`Median ${formatSecs(st.median)}s`, pad+4, pad+24);
    ctx.fillText(`P90 ${formatSecs(st.p90)}s`, pad+4, pad+38);
  }

  function populateChartSelect(){
    const map = groupByProcess();
    const keys = [...map.keys()].sort((a,b)=>a.localeCompare(b, undefined, {numeric:true, sensitivity:'base'}));
    const prev = chartSelect.value;

    chartSelect.innerHTML='';
    const placeholder=document.createElement('option');
    placeholder.value='';
    placeholder.textContent = currentLang==='es' ? 'Selecciona un proceso…' : 'Select a process…';
    chartSelect.appendChild(placeholder);

    keys.forEach(k=>{
      const [p,m] = k.split('||');
      const opt=document.createElement('option');
      opt.value=k;
      opt.textContent = `${p} · ${m}`;
      chartSelect.appendChild(opt);
    });

    if(prev && keys.includes(prev)) chartSelect.value=prev;

    const cur = (processInput.value||'').trim() + '||' + (modeSelect.value||'CT');
    if(!chartSelect.value && keys.includes(cur)) chartSelect.value = cur;
  }

  function renderCharts(){
    populateChartSelect();
    const val = chartSelect.value;
    if(!val) return;
    const [p,m] = val.split('||');
    drawTimeSeries(p,m);
    drawHistogram(p,m);
  }

  chartSelect.addEventListener('change',()=>renderCharts());

  /* =========================
     METHOD GUIDE TEXT
     ========================= */
  function renderMethodGuide(){
    const textEN =
`TaktLab quick guide
- CT mode: each LAP records one total time (T1 used, T2 = 0).
- MLD mode: LAP #1 captures T1 (machine), LAP #2 captures T2 (load/unload). Total = T1 + T2.
- Blocked / Starved laps are excluded from statistics (so they don't poison your median).
- Sample size: target is ±3% @95% confidence using CV. It’s directional, not a legal contract.
- Contract vs Capacity uses CT median as “current”, P10 as “potential”, P90 as “worst”, multiplied by Efficiency.
WB planner
- Shifts is reference only. Capacity is based on Hours × Machines.
- Net min/day = Gross - planned losses - shared - unplanned DT.
- Output = (Net seconds / CT) × Yield × Pcs/Op.
- Input required for Contract = Contract / (Yield × Pcs/Op).`;

    const textES =
`Guía rápida TaktLab
- Modo CT: cada VUELTA registra un tiempo total (T1 usado, T2 = 0).
- Modo MLD: VUELTA #1 captura T1 (máquina), VUELTA #2 captura T2 (carga/descarga). Total = T1 + T2.
- Vueltas Bloqueado / Hambriento NO se usan para estadísticas (para no envenenar la mediana).
- Tamaño de muestra: meta ±3% @95% usando CV. Es direccional, no “contrato legal”.
- Contrato vs Capacidad usa Mediana como “actual”, P10 como “potencial”, P90 como “peor”, multiplicado por Eficiencia.
WB planner
- Turnos es referencia. Capacidad se basa en Horas × Máquinas.
- Min netos/día = Brutos - pérdidas planificadas - compartido - DT no planeado.
- Salida = (Seg netos / CT) × Yield × Pzs/Op.
- Entrada requerida p/Contrato = Contrato / (Yield × Pzs/Op).`;

    methodGuideText.textContent = (currentLang==='es') ? textES : textEN;
  }

  /* =========================
     COPY OUTPUTS
     ========================= */
  function buildSummaryText(){
    const bundle = buildContractLinesForCurrentSelection();
    const lines = [];
    lines.push('TaktLab Summary');
    lines.push(`Date: ${new Date().toISOString()}`);
    lines.push(bundle.l1);
    lines.push(bundle.l2);
    lines.push(bundle.l3);
    lines.push(bundle.l4);
    lines.push('');
    lines.push(currentLang==='es' ? 'Procesos (estadísticas):' : 'Processes (stats):');

    const map = groupByProcess();
    const keys = [...map.keys()].sort((a,b)=>a.localeCompare(b, undefined, {numeric:true, sensitivity:'base'}));
    keys.forEach(k=>{
      const [p,m]=k.split('||');
      const st=calcStats(map.get(k)||[]);
      if(!st) return;
      lines.push(`${p} · ${m} | N=${st.n} | Median=${formatSecs(st.median)}s | P10=${formatSecs(st.p10)}s | P90=${formatSecs(st.p90)}s | Std=${formatSecs(st.std)}s | CV=${(st.cv*100).toFixed(1)}%`);
    });

    return lines.join('\n');
  }

  function buildAllText(){
    const lines=[];
    lines.push(buildSummaryText());
    lines.push('\nRAW DATA');
    lines.push('#\tProcess\tMode\tStatus\tNote\tT1\tT2\tTotal');
    laps.forEach((l,idx)=>{
      lines.push([
        idx+1,
        (l.process||'').trim(),
        l.mode||'',
        l.status||'',
        (l.note||'').replace(/\t/g,' '),
        formatSecs(l.t1),
        formatSecs(l.t2),
        formatSecs(l.total)
      ].join('\t'));
    });
    return lines.join('\n');
  }

  btnCopySum.addEventListener('click',()=>copyText(buildSummaryText()));
  btnCopyAll.addEventListener('click',()=>copyText(buildAllText()));

  /* =========================
     STATE: LOAD / RESTORE
     ========================= */
  function restoreState(){
    const raw = localStorage.getItem(TL_STATE_KEY);
    if(!raw){
      loadWB();
      return;
    }
    const snap = safeJsonParse(raw);
    if(!snap || !snap.settings) { loadWB(); return; }

    try{
      currentLang = (snap.lang==='es') ? 'es' : (localStorage.getItem(LANG_KEY)||'en');
    }catch(e){}

    processInput.value = (snap.settings.processName ?? '');
    modeSelect.value   = (snap.settings.mode ?? 'CT');
    effInput.value     = (snap.settings.efficiency ?? '100');
    pcdInput.value     = (snap.settings.contractPcd ?? '');
    hInput.value       = (snap.settings.hoursPerDay ?? '8');
    dInput.value       = (snap.settings.daysPerWeek ?? '5');
    capViewSel.value   = (snap.settings.capView ?? 'hour');

    laps = Array.isArray(snap.laps) ? snap.laps : [];
    nextId = isFinite(snap.nextId) ? snap.nextId : 1;

    wbRows = Array.isArray(snap.wbRows) ? snap.wbRows : [];
    if(!wbRows.length) loadWB();

    wbRows.forEach(r=>{
      if(!isFinite(r.pcsPerOp) || r.pcsPerOp<=0) r.pcsPerOp = 1;
    });
  }

  /* =========================
     GLOBAL LISTENERS (autosave)
     ========================= */
  [
    processInput, modeSelect, effInput, pcdInput, hInput, dInput, capViewSel
  ].forEach(el=>{
    el.addEventListener('input',()=>{ scheduleSaveAll(); renderAll(); });
    el.addEventListener('change',()=>{ scheduleSaveAll(); renderAll(); });
  });

  processInput.addEventListener('change',()=>{
    const proc=(processInput.value||'').trim();
    if(proc) ensureWbRowForOperation(proc);
    renderAll();
    scheduleSaveAll();
  });

  /* =========================
     MAIN RENDER
     ========================= */
  function renderAll(){
    updateLangButtons();
    applyTranslations();
    renderMethodGuide();

    renderContractSummaryAndFocus();
    renderStatsTables();
    renderWB();
    renderRaw();
    renderCharts();

    updateSplitClocks();
  }

  /* =========================
     INIT
     ========================= */
  restoreState();
  setLanguage(currentLang); // calls renderAll()

  btnStart.textContent = running ? t('btn.pause') : t('btn.start');
  refreshRingStates();

  window.addEventListener('resize',()=>{ renderCharts(); });

<!-- (La Parte 4/4 cierra el script, agrega el recuadro de conclusiones, ajusta paleta azul cielo y cierra el HTML) -->
<!-- =========================
     PART 4 of 4 — FINAL STABLE CLOSURE
     NO EDITAR
     ========================= -->

<script>
/* ============================================================
   FINAL GLUE — NO assumptions, NO dangling functions
   ============================================================ */
(function(){

  /* =========================
     SAFE COPY (fallback)
     ========================= */
  function safeCopy(text){
    try{
      navigator.clipboard.writeText(text);
    }catch(e){
      const ta=document.createElement('textarea');
      ta.value=text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
    }
  }

  /* =========================
     CONCLUSIONS — guaranteed
     ========================= */
  function buildConclusionsTextSafe(){
    try{
      if(typeof buildConclusionsText === 'function'){
        return buildConclusionsText();
      }
    }catch(e){}

    // 🔒 fallback ABSOLUTO (nunca rompe)
    let out = [];
    out.push('CONCLUSIONS — TaktLab / WB');
    out.push(`Date: ${new Date().toISOString()}`);
    out.push('');
    out.push('- Review Contract vs Capacity.');
    out.push('- Identify WB constraint and next constraint.');
    out.push('- Define actions to increase throughput.');
    return out.join('\n');
  }

  /* =========================
     CONCLUSIONS UI bind
     ========================= */
  const conclusionsBox = document.getElementById('conclusionsText');
  const btnCopyConclusions = document.getElementById('btnCopyConclusions');

  if(conclusionsBox){
    conclusionsBox.textContent = buildConclusionsTextSafe();
  }

  if(btnCopyConclusions){
    btnCopyConclusions.addEventListener('click',()=>{
      safeCopy(buildConclusionsTextSafe());
    });
  }

  /* =========================
     PALETTE FIX — FULL CARD
     ========================= */
  const style = document.createElement('style');
  style.innerHTML = `
    body{
      background:linear-gradient(180deg,#0b3a66 0%, #2a74b8 42%, #0b3a66 100%);
    }
    :root{
      --bg-main:#0b3a66;
      --bg-card:#0d2f54;
      --bg-card-soft:#103a64;
      --border-soft:#1e4f7e;
    }
    .section-card::before{display:none!important;}
    .section-card{
      box-shadow:0 10px 22px rgba(0,0,0,.45);
    }
    .section-card[data-accent="blue"]{
      background:linear-gradient(180deg,rgba(57,189,245,.18),rgba(13,47,84,.95));
    }
    .section-card[data-accent="green"]{
      background:linear-gradient(180deg,rgba(24,201,122,.16),rgba(13,47,84,.95));
    }
    .section-card[data-accent="amber"]{
      background:linear-gradient(180deg,rgba(242,193,78,.16),rgba(13,47,84,.95));
    }
    .section-card[data-accent="red"]{
      background:linear-gradient(180deg,rgba(255,51,85,.16),rgba(13,47,84,.95));
    }
    .section-card[data-accent="grey"]{
      background:linear-gradient(180deg,rgba(207,216,220,.14),rgba(13,47,84,.95));
    }
  `;
  document.head.appendChild(style);

  /* =========================
     FINAL RENDER SAFE
     ========================= */
  function renderAllSafe(){
    try{
      if(typeof updateLangButtons==='function') updateLangButtons();
      if(typeof applyTranslations==='function') applyTranslations();
      if(typeof renderMethodGuide==='function') renderMethodGuide();
      if(typeof renderContractSummaryAndFocus==='function') renderContractSummaryAndFocus();
      if(typeof renderStatsTables==='function') renderStatsTables();
      if(typeof renderWB==='function') renderWB();
      if(typeof renderRaw==='function') renderRaw();
      if(typeof renderCharts==='function') renderCharts();
      if(typeof updateSplitClocks==='function') updateSplitClocks();
      if(conclusionsBox) conclusionsBox.textContent = buildConclusionsTextSafe();
    }catch(err){
      console.error('TaktLab renderAllSafe:', err);
    }
  }

  // 🔒 render once DOM is ready
  window.addEventListener('load', ()=>{
    renderAllSafe();
  });

})();
</script>

</body>
</html>
