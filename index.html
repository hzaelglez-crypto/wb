<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>TaktLab – Cycle Time & Capacity Analyzer</title>

<style>
  :root{
    --bg-main:#07152b;
    --bg-card:#0b1f3a;
    --bg-card-soft:#0f2544;

    /* toned-down accents (more pro, less neon) */
    --accent-green:#18c97a;
    --accent-amber:#f2c14e;
    --accent-red:#ff3355;
    --accent-blue:#39bdf5;
    --accent-grey:#cfd8dc;

    --text-main:#ffffff;
    --text-soft:#c5cae9;
    --text-muted:#90a4ae;
    --border-soft:#1c3357;

    --btn-green:#18c97a;
    --btn-orange:#f2a93b;
    --btn-grey:#455a64;

    /* subtler badges */
    --badge-green:rgba(24,201,122,.16);
    --badge-red:rgba(255,51,85,.16);
    --badge-amber:rgba(242,193,78,.16);

    /* WB sticky sizing (Seq removed) */
    --wb-on-w:56px;
    --wb-op-w:210px;
  }

  *{box-sizing:border-box;}

  body{
    margin:0;
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    background:linear-gradient(180deg,#020b1a 0%,#07152b 40%,#020b1a 100%);
    color:var(--text-main);
  }

  .page{
    max-width:1100px;
    margin:0 auto;
    padding:10px 10px 34px;
  }

  .sticky-timer-bar{
    position:sticky;
    top:0;
    z-index:100;
    background:linear-gradient(180deg,#020b1a 0%,#07152b 90%);
    padding:6px 0 8px;
  }

  .top-row{
    display:flex;
    align-items:center;
    gap:10px;
    margin-bottom:6px;
  }

  .logo-circle{
    width:38px;height:38px;border-radius:50%;
    border:2px solid rgba(207,216,220,.65);
    display:flex;align-items:center;justify-content:center;
  }
  .logo-gear{
    width:22px;height:22px;border-radius:50%;
    border:2px solid rgba(207,216,220,.65);
    position:relative;
  }
  .logo-gear::before{
    content:"";
    position:absolute;
    inset:4px;
    border-radius:50%;
    border:2px solid rgba(24,201,122,.9);
    border-right-color:transparent;
    border-bottom-color:transparent;
    transform-origin:50% 50%;
  }
  .logo-gear.spinning::before{ animation:logo-spin 2s linear infinite; }
  @keyframes logo-spin{ from{transform:rotate(0deg);} to{transform:rotate(360deg);} }

  .title-block{display:flex;flex-direction:column;gap:2px;}
  .title-main{font-size:1.2rem;font-weight:700;letter-spacing:.03em;}
  .title-sub{font-size:.72rem;color:var(--text-soft);}

  .lang-switch{margin-left:auto;display:flex;align-items:center;gap:4px;}
  .lang-btn{
    border-radius:999px;border:1px solid var(--border-soft);
    background:rgba(2,11,26,.6);color:var(--text-soft);
    font-size:.7rem;padding:4px 8px;cursor:pointer;min-width:34px;
  }
  .lang-btn.active{background:rgba(57,189,245,.95);color:#fff;border-color:rgba(57,189,245,.95);font-weight:700;}

  .timer-card{
    background:var(--bg-card);
    border-radius:18px;
    border:1px solid var(--border-soft);
    padding:6px 10px 10px;
    box-shadow:0 8px 18px rgba(0,0,0,.45);
  }

  .timer-display{
    text-align:center;
    font-size:2.8rem;
    font-weight:600;
    letter-spacing:.08em;
    padding:4px 4px 2px;
  }

  /* ✅ Restored T1/T2 clocks */
  .split-clocks{
    display:flex;
    gap:8px;
    justify-content:center;
    margin:2px 0 8px;
    flex-wrap:wrap;
  }
  .split-pill{
    display:flex;
    align-items:center;
    gap:6px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(255,255,255,.03);
    font-size:.78rem;
    color:var(--text-soft);
    min-width:150px;
    justify-content:center;
  }
  .split-pill .tag{
    font-weight:800;
    letter-spacing:.04em;
    color:#fff;
    opacity:.85;
  }
  .split-pill .val{
    font-variant-numeric:tabular-nums;
    letter-spacing:.04em;
    color:#fff;
  }
  .split-pill.t1{ border-color: rgba(57,189,245,.30); }
  .split-pill.t2{ border-color: rgba(242,193,78,.28); }

  .info-stack{ display:flex; flex-direction:column; gap:6px; margin:0 0 8px; }
  .info-line{
    font-size:.78rem;margin:0;padding:6px 10px;
    border-radius:12px;border:1px solid transparent;
    line-height:1.25;
  }
  .sample-neutral{background:rgba(255,255,255,.03);border-color:rgba(255,255,255,.08);color:var(--text-soft);}
  .sample-good{background:rgba(24,201,122,.12);border-color:rgba(24,201,122,.45);color:#d9ffe9;}
  .sample-warn{background:rgba(242,193,78,.10);border-color:rgba(242,193,78,.40);color:#fff4d3;}
  .sample-bad{background:rgba(255,51,85,.10);border-color:rgba(255,51,85,.42);color:#ffd0da;}

  .btn-row-main{display:flex;gap:10px;margin-bottom:2px;}
  .btn{
    border:none;border-radius:16px;padding:10px 12px;
    font-size:.9rem;font-weight:700;cursor:pointer;color:#06101f;
    box-shadow:0 4px 10px rgba(0,0,0,.4);flex:1;
    transition:transform .04s ease, box-shadow .04s ease, background .15s;
    touch-action:manipulation;
  }
  .btn:active{transform:translateY(1px);box-shadow:0 1px 4px rgba(0,0,0,.5);}
  .btn-start{background:rgba(24,201,122,.95); color:#051018;}
  .btn-lap{background:rgba(242,169,59,.95); color:#0b0b0b;}

  .flash{animation:flash-bg .12s ease-out;}
  @keyframes flash-bg{ from{background:rgba(255,255,255,.18);} to{background:transparent;} }

  .content-section{margin-top:8px;}

  /* ✅ Subtle section theming */
  .section-card{
    background:var(--bg-card);
    border-radius:18px;
    border:1px solid rgba(28,51,87,.92);
    padding:8px 10px 10px;
    margin-bottom:10px;
    position:relative;
  }
  .section-card::before{
    content:"";
    position:absolute;
    left:10px; right:10px; top:0;
    height:2px;
    border-radius:999px;
    background:rgba(255,255,255,.06);
  }
  .section-card[data-accent="blue"]::before{ background:rgba(57,189,245,.26); }
  .section-card[data-accent="green"]::before{ background:rgba(24,201,122,.22); }
  .section-card[data-accent="amber"]::before{ background:rgba(242,193,78,.22); }
  .section-card[data-accent="red"]::before{ background:rgba(255,51,85,.20); }
  .section-card[data-accent="grey"]::before{ background:rgba(207,216,220,.18); }

  .section-title{font-size:1.0rem;font-weight:750;margin-bottom:6px;}

  .mode-row{
    display:flex;gap:8px;flex-wrap:wrap;align-items:flex-end;
    font-size:.78rem;color:var(--text-soft);
  }
  .mode-row select,.mode-row input{
    background:#020b1a;border-radius:10px;border:1px solid var(--border-soft);
    padding:5px 10px;color:var(--text-soft);font-size:.78rem;min-width:70px;
  }
  .mode-row input[type="number"]{width:78px;}

  table{width:100%;border-collapse:collapse;font-size:.72rem;}
  th,td{
    padding:3px 5px;text-align:right;
    border-bottom:1px solid rgba(255,255,255,.04);
    white-space:nowrap;
    vertical-align:middle;
  }
  th:first-child,td:first-child{text-align:left;}
  th{
    color:var(--text-soft);font-weight:650;background:rgba(255,255,255,.02);
    position:sticky;top:0;z-index:5;
  }
  tbody tr:nth-child(even){background:rgba(255,255,255,.02);}

  .badge{
    display:inline-block;padding:2px 8px;border-radius:999px;
    font-size:.68rem;border:1px solid rgba(255,255,255,.12);
  }
  .badge-good{background:var(--badge-green);border-color:rgba(24,201,122,.40);color:#d9ffe9;}
  .badge-warn{background:var(--badge-amber);border-color:rgba(242,193,78,.40);color:#fff4d3;}
  .badge-bad{background:var(--badge-red);border-color:rgba(255,51,85,.42);color:#ffd0da;}

  .btn-row-secondary{display:flex;flex-wrap:wrap;gap:10px;margin:8px 0 4px;}
  .btn-small{
    padding:12px 18px;
    border-radius:18px;
    font-size:.95rem;
    font-weight:850;
    flex:0 0 auto;background:var(--bg-card-soft);color:var(--text-soft);
    border:1px solid var(--border-soft);cursor:pointer;box-shadow:0 3px 8px rgba(0,0,0,.35);
  }
  .btn-small-copy{background:rgba(57,189,245,.95);border-color:rgba(57,189,245,.95);color:#051018;}
  .btn-small-summary{background:rgba(242,193,78,.95);border-color:rgba(242,193,78,.95);color:#0b0b0b;}
  .btn-small-manual{background:rgba(24,201,122,.95);border-color:rgba(24,201,122,.95);color:#051018;}
  .btn-small-reset{background:rgba(255,51,85,.92);border-color:rgba(255,51,85,.92);color:#fff;}
  .btn-small-wbadd{background:rgba(255,255,255,.06);color:var(--text-soft);}
  .btn-small-wbclear{background:rgba(255,51,85,.12);border-color:rgba(255,51,85,.35);color:#ffd0da;}

  .subsection-title{margin-top:10px;font-size:.82rem;font-weight:700;color:var(--text-soft);}
  .footer-note{margin-top:10px;font-size:.65rem;color:var(--text-muted);text-align:right;}

  .charts-wrapper{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
    gap:10px;
  }
  .chart-card{
    background:var(--bg-card-soft);
    border-radius:14px;
    border:1px solid var(--border-soft);
    padding:8px;
  }
  .chart-title{font-size:.75rem;margin-bottom:4px;color:var(--text-soft);}
  canvas{width:100%;height:180px;background:#020b1a;border-radius:10px;}

  .btn-edit,.btn-del,.btn-relink{
    padding:2px 8px;border-radius:10px;font-size:.7rem;
    border:1px solid rgba(255,255,255,.2);cursor:pointer;background:transparent;
  }
  .btn-edit{color:#9fe4ff;}
  .btn-del{color:#ffd0da;}
  .btn-relink{color:#fff4d3;}

  .wb-inp, .wb-sel, .wb-chk{
    background:#020b1a;border-radius:10px;border:1px solid var(--border-soft);
    padding:2px 8px;color:var(--text-soft);font-size:.70rem;
    outline:none;
  }
  .wb-inp{width:72px;}
  .wb-inp.wide{width:160px;}
  .wb-inp.slim{width:56px;}
  .wb-sel{width:110px;}

  /* Operation dropdown like Charts */
  .wb-opwrap{
    display:flex;
    gap:6px;
    align-items:center;
    justify-content:flex-start;
  }
  .wb-opselect{
    width: calc(var(--wb-op-w) - 14px);
    max-width: calc(var(--wb-op-w) - 14px);
    background:#020b1a;
    border-radius:10px;
    border:1px solid var(--border-soft);
    padding:3px 8px;
    color:var(--text-soft);
    font-size:.72rem;
  }
  .wb-opbtn{
    border:1px solid rgba(255,255,255,.16);
    background:rgba(255,255,255,.04);
    color:var(--text-soft);
    border-radius:10px;
    padding:2px 8px;
    cursor:pointer;
    font-size:.72rem;
  }
  .wb-opbtn:hover{ background:rgba(255,255,255,.06); }

  .wb-pill{
    display:inline-block;padding:3px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.03);font-size:.72rem;color:var(--text-soft);
  }
  .wb-alert{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-top:8px;}
  .wb-alert .badge{font-size:.72rem;padding:4px 10px;}
  .wb-badge-title{font-size:.72rem;color:var(--text-soft);}
  .wb-mini{font-size:.7rem;color:var(--text-muted);line-height:1.25;margin-top:6px;}
  .wb-sumline{
    display:flex;justify-content:flex-end;gap:10px;align-items:center;
    margin-top:6px;font-size:.72rem;color:var(--text-soft);
  }
  .wb-sumline .badge{font-size:.70rem}

  /* =========================
     ✅ WB STICKY COLUMNS (On, Operation) — Seq removed
     ========================= */
  #wbTable{ border-collapse:separate; border-spacing:0; }
  #wbTable th, #wbTable td{ position:relative; }

  /* widths so offsets are correct */
  #wbTable th:nth-child(1), #wbTable td:nth-child(1){ width:var(--wb-on-w); min-width:var(--wb-on-w); }
  #wbTable th:nth-child(2), #wbTable td:nth-child(2){ width:var(--wb-op-w); min-width:var(--wb-op-w); }

  /* 1st col: On */
  #wbTable th:nth-child(1), #wbTable td:nth-child(1){
    position:sticky; left:0;
    z-index:30;
    background:linear-gradient(180deg, rgba(2,11,26,.98) 0%, rgba(7,21,43,.98) 100%);
  }
  /* 2nd col: Operation */
  #wbTable th:nth-child(2), #wbTable td:nth-child(2){
    position:sticky; left:var(--wb-on-w);
    z-index:30;
    background:linear-gradient(180deg, rgba(2,11,26,.98) 0%, rgba(7,21,43,.98) 100%);
  }

  /* header priority */
  #wbTable thead th:nth-child(1),
  #wbTable thead th:nth-child(2){
    z-index:40;
  }

  @media (max-width:600px){
    .timer-display{font-size:2.2rem;}
    .btn-row-main{gap:6px;}
    .btn{font-size:.9rem;border-radius:14px;}
    canvas{height:160px;}
    th,td{font-size:.70rem;}
    .wb-inp{width:66px;}
    .wb-inp.wide{width:130px;}
    .btn-small{padding:12px 16px;font-size:.92rem;}

    :root{
      --wb-on-w:52px;
      --wb-op-w:190px;
    }
    .wb-opselect{
      width: calc(var(--wb-op-w) - 14px);
      max-width: calc(var(--wb-op-w) - 14px);
    }
  }
</style>
</head>

<body>
<div class="page">

  <div class="sticky-timer-bar">
    <div class="top-row">
      <div class="logo-circle"><div class="logo-gear" id="logoGear"></div></div>
      <div class="title-block">
        <div class="title-main">TaktLab</div>
        <div class="title-sub" data-i18n="title.subtitle">Cycle Time &amp; Capacity Analyzer</div>
      </div>
      <div class="lang-switch">
        <button class="lang-btn" data-lang="en">EN</button>
        <button class="lang-btn" data-lang="es">ES</button>
      </div>
    </div>

    <div class="timer-card" id="timerCard">
      <div class="timer-display" id="display">00:00.00</div>

      <!-- ✅ Restored T1/T2 clocks -->
      <div class="split-clocks" id="splitClocks">
        <div class="split-pill t1"><span class="tag">T1</span><span class="val" id="t1Clock">00:00.00</span></div>
        <div class="split-pill t2"><span class="tag">T2</span><span class="val" id="t2Clock">00:00.00</span></div>
      </div>

      <div class="info-stack">
        <div class="info-line sample-neutral" id="sampleInfoTop">
          No samples yet for current process. Start capturing laps.
        </div>
      </div>

      <div class="btn-row-main">
        <button class="btn btn-start" id="btnStart" data-i18n="btn.start">Start</button>
        <button class="btn btn-lap" id="btnLap" data-i18n="btn.lap">LAP</button>
      </div>
    </div>
  </div>

  <div class="content-section">

    <div class="section-card" data-accent="blue">
      <div class="section-title" data-i18n="section.measurementSetup">Measurement Setup</div>

      <div class="mode-row">
        <div>
          <label for="processName" data-i18n="label.process">Process</label><br/>
          <input id="processName" type="text" placeholder="e.g. Op 30-1" data-i18n-placeholder="label.processPlaceholder"/>
        </div>

        <div>
          <label for="mode" data-i18n="label.mode">Mode</label><br/>
          <select id="mode">
            <option value="CT" data-i18n="mode.ct">Cycle Time (CT)</option>
            <option value="MLD" data-i18n="mode.mld">Machine &amp; Load/Unload</option>
          </select>
        </div>

        <div>
          <label for="efficiency" data-i18n="label.efficiency">Efficiency %</label><br/>
          <input id="efficiency" type="number" value="100" min="0" max="100" step="1"/>
        </div>

        <div>
          <label for="contractPcd" data-i18n="label.contractPcd">Contract Cap (pcs/day)</label><br/>
          <input id="contractPcd" type="number" min="0" max="99999" step="1"/>
        </div>

        <div>
          <label for="hoursPerDay" data-i18n="label.hoursPerDay">Hours / Day</label><br/>
          <input id="hoursPerDay" type="number" value="8" min="1" max="24" step=".5"/>
        </div>

        <div>
          <label for="daysPerWeek" data-i18n="label.daysPerWeek">Days / Week</label><br/>
          <input id="daysPerWeek" type="number" value="5" min="1" max="7"/>
        </div>

        <div>
          <label for="capView" data-i18n="label.capView">Capacity View</label><br/>
          <select id="capView">
            <option value="hour" data-i18n="capView.hour">per Hour</option>
            <option value="day" data-i18n="capView.day">per Day</option>
            <option value="week" data-i18n="capView.week">per Week</option>
          </select>
        </div>
      </div>
    </div>

    <div class="section-card" data-accent="green">
      <div class="section-title" data-i18n="section.contractSummary">Contract vs Capacity Summary</div>

      <div class="info-stack" style="margin-top:4px;">
        <div class="info-line sample-neutral" id="contractSumLine1">—</div>
        <div class="info-line sample-neutral" id="contractSumLine2">—</div>
        <div class="info-line sample-neutral" id="contractSumLine3">—</div>
        <div class="info-line sample-neutral" id="contractSumLine4">—</div>
      </div>

      <div style="font-size:.68rem;color:var(--text-muted);margin:6px 0 0;">
        <span data-i18n="contract.note">Uses current process + your laps (Median/P10/P90) with the Measurement Setup assumptions.</span>
      </div>
    </div>

    <div class="section-card" data-accent="amber">
      <div class="section-title" data-i18n="section.statsFocus">Stat Focus</div>

      <div class="info-stack" style="margin-top:4px;">
        <div class="info-line sample-neutral" id="sampleInfoFocus">Sample size: —</div>
        <div class="info-line sample-neutral" id="stdInfoFocus">Std dev: —</div>
        <div class="info-line sample-neutral" id="distInfoFocus">Mean vs Median: —</div>
        <div class="info-line sample-neutral" id="contractInfoFocus">No contract loaded</div>
      </div>

      <div style="font-size:.68rem;color:var(--text-muted);margin:6px 0 6px;">
        <span data-i18n="stats.note">Simple language on purpose: few / enough samples, low / high variation, capable / not capable.</span>
      </div>

      <div style="max-height:300px;overflow:auto;">
        <table>
          <thead>
            <tr>
              <th data-i18n="col.process">Process</th>
              <th data-i18n="col.mode">Mode</th>
              <th>N</th>
              <th data-i18n="col.sample">Sample size / Error</th>
              <th>Std</th>
              <th>CV%</th>
              <th>CTmed</th>
              <th>P10</th>
              <th>P90</th>
              <th data-i18n="col.capCurrent">Current @Eff</th>
              <th data-i18n="col.capPotential">Potential @Eff</th>
              <th data-i18n="col.capWorst">Worst @Eff</th>
              <th data-i18n="col.contract">Contract</th>
              <th data-i18n="col.gap">Gap</th>
              <th data-i18n="col.vsContract">% vs</th>
              <th>Cp</th>
              <th>Cpk</th>
              <th data-i18n="col.note">Note</th>
            </tr>
          </thead>
          <tbody id="focusBody"></tbody>
        </table>
      </div>

      <div class="subsection-title" data-i18n="section.wbPlanner">WB – Capacity Planner (by process)</div>

      <div class="btn-row-secondary" style="margin-top:8px;">
        <button class="btn-small btn-small-wbadd" id="btnWbAdd" data-i18n="btn.wbAdd">+ Add Operation</button>
        <button class="btn-small btn-small-wbclear" id="btnWbClear" data-i18n="btn.wbClear">Clear WB</button>
        <button class="btn-small btn-small-copy" id="btnCopyWB" data-i18n="btn.copyWB">Copy WB</button>
      </div>

      <div style="max-height:320px;overflow:auto;">
        <table id="wbTable">
          <thead>
            <tr>
              <th data-i18n="wb.enabled">On</th>
              <th data-i18n="wb.operation">Operation</th>
              <th data-i18n="wb.operators">Operators</th>
              <th data-i18n="wb.shifts">Shifts</th>
              <th data-i18n="wb.hours">Hours</th>
              <th data-i18n="wb.machines"># Machines</th>
              <th data-i18n="wb.contract">Contract (pcs/day)</th>

              <th data-i18n="wb.gross">Gross min/day</th>
              <th data-i18n="wb.lunch">Lunch min/day</th>
              <th data-i18n="wb.changeover">Changeover</th>
              <th data-i18n="wb.cleaning">5S/Clean</th>
              <th data-i18n="wb.maint">Maintenance</th>
              <th data-i18n="wb.other">Other</th>

              <th data-i18n="wb.shared">Shared Capacity</th>

              <th data-i18n="wb.udt">Unplanned DT</th>
              <th data-i18n="wb.udtUnit">Unit</th>

              <th data-i18n="wb.net">Net min/day</th>

              <th data-i18n="wb.scrap">Scrap %</th>
              <th data-i18n="wb.yield">Yield</th>

              <th data-i18n="wb.oeeA">A%</th>
              <th data-i18n="wb.oeeP">P%</th>
              <th data-i18n="wb.oeeQ">Q%</th>
              <th data-i18n="wb.oee">OEE%</th>

              <th data-i18n="wb.ctCur">CT Current</th>
              <th data-i18n="wb.ctWst">CT Worst</th>
              <th data-i18n="wb.ctPot">CT Potential</th>

              <th data-i18n="wb.ctCurOee">CT@OEE (Cur)</th>

              <th data-i18n="wb.cap100">Cap 100% (Cur)</th>
              <th data-i18n="wb.capOee">Cap@OEE (Cur)</th>

              <th data-i18n="wb.vsContract">% vs contract</th>
              <th data-i18n="wb.inputReq">Input req. for Contract</th>

              <th data-i18n="wb.actions">Actions</th>
            </tr>
          </thead>
          <tbody id="wbBody"></tbody>
        </table>
      </div>

      <div class="wb-sumline">
        <span data-i18n="wb.opsSum">Operators total:</span>
        <span class="badge badge-warn" id="wbOperatorsSum">0</span>
      </div>

      <div class="wb-alert">
        <span class="wb-badge-title" data-i18n="wb.constraintTitle">Constraint / Next:</span>
        <span class="badge badge-bad" id="wbConstraint">—</span>
        <span class="badge badge-warn" id="wbNextConstraint">—</span>
      </div>
      <div class="wb-mini" id="wbConstraintNote"></div>

      <div class="subsection-title" data-i18n="section.statsDetail">Statistical Detail (per process)</div>
      <div style="max-height:240px;overflow:auto;">
        <table id="statsTable">
          <thead>
            <tr>
              <th data-i18n="col.process">Process</th>
              <th data-i18n="col.mode">Mode</th>
              <th data-i18n="col.n">N</th>
              <th>Mean</th>
              <th>Median</th>
              <th>P10</th>
              <th>P90</th>
              <th>Min</th>
              <th>Max</th>
              <th>Std</th>
              <th>CV%</th>
              <th>Cp</th>
              <th>Cpk</th>
            </tr>
          </thead>
          <tbody id="statsBody"></tbody>
        </table>
      </div>
    </div>

    <div class="section-card" data-accent="red">
      <div class="section-title" data-i18n="section.dataControls">Data Controls</div>
      <div class="btn-row-secondary">
        <button class="btn-small btn-small-copy" id="btnCopyAll" data-i18n="btn.copyAll">Copy All</button>
        <button class="btn-small btn-small-summary" id="btnCopySummary" data-i18n="btn.copySummary">Copy Summary</button>
        <button class="btn-small btn-small-manual" id="btnAddManualLap" data-i18n="btn.addManualLap">Add Manual Lap</button>
        <button class="btn-small btn-small-reset" id="btnReset" data-i18n="btn.reset">Reset</button>
      </div>
    </div>

    <div class="section-card" data-accent="grey">
      <div class="section-title" data-i18n="section.charts">Charts (selected process)</div>

      <div style="margin-bottom:6px;font-size:.75rem;">
        <label for="chartProcessSelect" data-i18n="label.chartProcessLabel">Process / Mode:</label>
        <select id="chartProcessSelect"></select>
      </div>

      <div class="charts-wrapper">
        <div class="chart-card">
          <div class="chart-title" data-i18n="chart.timeSeriesTitle">Time Series with Mean, Median, ±3σ</div>
          <canvas id="timeSeriesCanvas"></canvas>
        </div>

        <div class="chart-card">
          <div class="chart-title" data-i18n="chart.histTitle">Histogram with Median &amp; Percentiles</div>
          <canvas id="histCanvas"></canvas>
        </div>
      </div>
    </div>

    <div class="section-card" data-accent="blue">
      <div class="section-title" data-i18n="section.rawData">Raw Time Data</div>
      <div style="max-height:300px;overflow:auto;">
        <table id="dataTable">
          <thead>
            <tr>
              <th data-i18n="col.index">#</th>
              <th data-i18n="col.process">Process</th>
              <th data-i18n="col.mode">Mode</th>
              <th data-i18n="col.status">Status</th>
              <th data-i18n="col.note">Note</th>
              <th data-i18n="col.t1">T1 (s)</th>
              <th data-i18n="col.t2">T2 (s)</th>
              <th data-i18n="col.total">Total (s)</th>
              <th data-i18n="col.edit">Edit</th>
              <th data-i18n="col.del">Del</th>
            </tr>
          </thead>
          <tbody id="dataBody"></tbody>
        </table>
      </div>
    </div>

    <div class="section-card" data-accent="amber">
      <div class="section-title" data-i18n="section.methodGuide">Method &amp; Guide</div>
      <details style="background:var(--bg-card-soft);border:1px solid var(--border-soft);border-radius:14px;padding:10px;">
        <summary style="cursor:pointer;color:var(--text-soft);font-weight:800;">
          <span data-i18n="method.open">Open</span>
        </summary>
        <div style="margin-top:8px;font-size:.72rem;color:var(--text-soft);line-height:1.35;white-space:pre-wrap;" id="methodGuideText"></div>
      </details>
    </div>

  </div>

  <div class="footer-note" data-i18n="footer.note">
    Created by Roberto González – Contact: hzaelglez@gmail.com
  </div>
</div>

<script>
(function(){
  const display = document.getElementById('display');
  const btnStart = document.getElementById('btnStart');
  const btnLap = document.getElementById('btnLap');
  const timerCard = document.getElementById('timerCard');
  const logoGear = document.getElementById('logoGear');

  // ✅ restored split clocks
  const t1Clock = document.getElementById('t1Clock');
  const t2Clock = document.getElementById('t2Clock');

  const sampleInfoTop = document.getElementById('sampleInfoTop');
  const sampleInfoFocus = document.getElementById('sampleInfoFocus');
  const stdInfoFocus = document.getElementById('stdInfoFocus');
  const distInfoFocus = document.getElementById('distInfoFocus');
  const contractInfoFocus = document.getElementById('contractInfoFocus');

  const contractSumLine1 = document.getElementById('contractSumLine1');
  const contractSumLine2 = document.getElementById('contractSumLine2');
  const contractSumLine3 = document.getElementById('contractSumLine3');
  const contractSumLine4 = document.getElementById('contractSumLine4');

  const processInput = document.getElementById('processName');
  const modeSelect   = document.getElementById('mode');
  const effInput     = document.getElementById('efficiency');
  const pcdInput     = document.getElementById('contractPcd');
  const hInput       = document.getElementById('hoursPerDay');
  const dInput       = document.getElementById('daysPerWeek');
  const capViewSel   = document.getElementById('capView');

  const focusBody     = document.getElementById('focusBody');
  const statsBody     = document.getElementById('statsBody');

  const dataBody    = document.getElementById('dataBody');
  const btnCopyAll  = document.getElementById('btnCopyAll');
  const btnCopySum  = document.getElementById('btnCopySummary');
  const btnAddMan   = document.getElementById('btnAddManualLap');
  const btnReset    = document.getElementById('btnReset');

  const chartSelect      = document.getElementById('chartProcessSelect');
  const timeSeriesCanvas = document.getElementById('timeSeriesCanvas');
  const histCanvas       = document.getElementById('histCanvas');

  const langButtons = document.querySelectorAll('.lang-btn');

  const wbBody = document.getElementById('wbBody');
  const btnWbAdd = document.getElementById('btnWbAdd');
  const btnWbClear = document.getElementById('btnWbClear');
  const btnCopyWB = document.getElementById('btnCopyWB');
  const wbConstraint = document.getElementById('wbConstraint');
  const wbNextConstraint = document.getElementById('wbNextConstraint');
  const wbConstraintNote = document.getElementById('wbConstraintNote');
  const wbOperatorsSum = document.getElementById('wbOperatorsSum');
  const methodGuideText = document.getElementById('methodGuideText');

  /* ============================
     ✅ Formatting (MAX 2 decimals)
     ============================ */
  function formatSecs(s){
    if(!isFinite(s)) return '-';
    return (Math.round(s*100)/100).toFixed(2);
  }
  function formatTime(ms){
    const total=Math.max(ms,0);
    const mins=Math.floor(total/60000);
    const secs=Math.floor((total%60000)/1000);
    const cent=Math.floor((total%1000)/10);
    return (mins<10?'0'+mins:mins)+':'+(secs<10?'0'+secs:secs)+'.'+(cent<10?'0'+cent:cent);
  }
  function formatUnits(n){
    if(!isFinite(n)) return '-';
    const rounded=Math.round(n);
    return rounded.toLocaleString('en-US',{maximumFractionDigits:0});
  }
  function pct(n, digits=0){ if(!isFinite(n)) return '-'; return n.toFixed(digits)+'%'; }

  /* ============================
     ✅ Normalize operation names
     ============================ */
  function normOp(s){
    return (s||'')
      .toString()
      .trim()
      .replace(/\s+/g,' ')
      .toLowerCase();
  }

  const i18n = {
    en:{
      'title.subtitle':'Cycle Time & Capacity Analyzer',
      'btn.start':'Start','btn.pause':'Pause','btn.lap':'LAP',
      'btn.copyAll':'Copy All','btn.copySummary':'Copy Summary','btn.addManualLap':'Add Manual Lap','btn.reset':'Reset',
      'btn.copyWB':'Copy WB',
      'section.measurementSetup':'Measurement Setup',
      'section.contractSummary':'Contract vs Capacity Summary',
      'contract.note':'Uses current process + your laps (Median/P10/P90) with the Measurement Setup assumptions.',
      'section.statsFocus':'Stat Focus',
      'section.dataControls':'Data Controls',
      'section.rawData':'Raw Time Data',
      'section.charts':'Charts (selected process)',
      'section.statsDetail':'Statistical Detail (per process)',
      'section.wbPlanner':'WB – Capacity Planner (by process)',
      'section.methodGuide':'Method & Guide',
      'method.open':'Open',

      'label.process':'Process','label.processPlaceholder':'e.g. Op 30-1',
      'label.mode':'Mode','label.efficiency':'Efficiency %','label.contractPcd':'Contract Cap (pcs/day)',
      'label.hoursPerDay':'Hours / Day','label.daysPerWeek':'Days / Week','label.capView':'Capacity View',
      'label.chartProcessLabel':'Process / Mode:',

      'mode.ct':'Cycle Time (CT)','mode.mld':'Machine & Load/Unload',
      'capView.hour':'per Hour','capView.day':'per Day','capView.week':'per Week',

      'col.index':'#','col.process':'Process','col.mode':'Mode','col.status':'Status','col.note':'Note',
      'col.t1':'T1 (s)','col.t2':'T2 (s)','col.total':'Total (s)','col.edit':'Edit','col.del':'Del','col.n':'N',
      'col.sample':'Sample size / Error',
      'col.capCurrent':'Current @Eff','col.capPotential':'Potential @Eff','col.capWorst':'Worst @Eff',
      'col.contract':'Contract','col.gap':'Gap','col.vsContract':'% vs',
      'chart.timeSeriesTitle':'Time Series with Mean, Median, ±3σ',
      'chart.histTitle':'Histogram with Median & Percentiles',
      'stats.note':'Simple language on purpose: few / enough samples, low / high variation, capable / not capable.',
      'footer.note':'Created by Roberto González – Contact: hzaelglez@gmail.com',

      'btn.wbAdd':'+ Add Operation',
      'btn.wbClear':'Clear WB',
      'wb.enabled':'On',
      'wb.operation':'Operation',
      'wb.operators':'Operators',
      'wb.shifts':'Shifts (ref)',
      'wb.hours':'Hours',
      'wb.machines':'# Machines',
      'wb.contract':'Contract (pcs/day)',
      'wb.gross':'Gross min/day',
      'wb.lunch':'Lunch min/day',
      'wb.changeover':'Changeover (min/day)',
      'wb.cleaning':'5S/Clean (min/day)',
      'wb.maint':'Maintenance (min/day)',
      'wb.other':'Other (min/day)',
      'wb.shared':'Shared Capacity (min/day)',
      'wb.udt':'Unplanned DT',
      'wb.udtUnit':'Unit',
      'wb.net':'Net min/day',
      'wb.scrap':'Scrap %',
      'wb.yield':'Yield',
      'wb.oeeA':'A%',
      'wb.oeeP':'P%',
      'wb.oeeQ':'Q%',
      'wb.oee':'OEE%',
      'wb.ctCur':'CT Current (s)',
      'wb.ctWst':'CT Worst (s)',
      'wb.ctPot':'CT Potential (s)',
      'wb.ctCurOee':'CT@OEE (Cur)',
      'wb.cap100':'Cap 100% (Cur/day)',
      'wb.capOee':'Cap@OEE (Cur/day)',
      'wb.vsContract':'% vs contract',
      'wb.inputReq':'Input req. for Contract',
      'wb.actions':'Actions',
      'wb.constraintTitle':'Constraint / Next:',
      'wb.opsSum':'Operators total:'
    },
    es:{
      'title.subtitle':'Analizador de Tiempo de Ciclo y Capacidad',
      'btn.start':'Iniciar','btn.pause':'Pausar','btn.lap':'VUELTA',
      'btn.copyAll':'Copiar todo','btn.copySummary':'Copiar resumen','btn.addManualLap':'Agregar vuelta manual','btn.reset':'Reiniciar',
      'btn.copyWB':'Copiar WB',
      'section.measurementSetup':'Configuración de Medición',
      'section.contractSummary':'Resumen Contrato vs Capacidad',
      'contract.note':'Usa el proceso actual + tus vueltas (Mediana/P10/P90) con los supuestos de Measurement Setup.',
      'section.statsFocus':'Enfoque Estadístico',
      'section.dataControls':'Controles de Datos',
      'section.rawData':'Datos Crudos de Tiempo',
      'section.charts':'Gráficas (proceso seleccionado)',
      'section.statsDetail':'Detalle Estadístico (por proceso)',
      'section.wbPlanner':'WB – Planeador de Capacidad (por proceso)',
      'section.methodGuide':'Método & Guía',
      'method.open':'Abrir',

      'label.process':'Proceso','label.processPlaceholder':'p. ej. Op 30-1',
      'label.mode':'Modo','label.efficiency':'Eficiencia %','label.contractPcd':'Capacidad contrato (pzs/día)',
      'label.hoursPerDay':'Horas / día','label.daysPerWeek':'Días / semana','label.capView':'Vista de capacidad',
      'label.chartProcessLabel':'Proceso / Modo:',

      'mode.ct':'Tiempo de ciclo (CT)','mode.mld':'Máquina y Carga/Descarga',
      'capView.hour':'por hora','capView.day':'por día','capView.week':'por semana',

      'col.index':'#','col.process':'Proceso','col.mode':'Modo','col.status':'Estatus','col.note':'Nota',
      'col.t1':'T1 (s)','col.t2':'T2 (s)','col.total':'Total (s)','col.edit':'Editar','col.del':'Borrar','col.n':'N',
      'col.sample':'Tamaño de muestra / Error',
      'col.capCurrent':'Actual @Eff','col.capPotential':'Potencial @Eff','col.capWorst':'Peor @Eff',
      'col.contract':'Contrato','col.gap':'Gap','col.vsContract':'% vs',
      'chart.timeSeriesTitle':'Serie de tiempo con media, mediana y ±3σ',
      'chart.histTitle':'Histograma con mediana y percentiles',
      'stats.note':'Lenguaje simple: pocas / suficientes muestras, baja / alta variación, capaz / no capaz.',
      'footer.note':'Creado por Roberto González – Contacto: hzaelglez@gmail.com',

      'btn.wbAdd':'+ Agregar operación',
      'btn.wbClear':'Borrar WB',
      'wb.enabled':'On',
      'wb.operation':'Operación',
      'wb.operators':'Operadores',
      'wb.shifts':'Turnos (ref)',
      'wb.hours':'Horas',
      'wb.machines':'# Máquinas',
      'wb.contract':'Contrato (pzs/día)',
      'wb.gross':'Min brutos/día',
      'wb.lunch':'Comida/día',
      'wb.changeover':'Changeover (min/día)',
      'wb.cleaning':'5S/Limpieza (min/día)',
      'wb.maint':'Mtto (min/día)',
      'wb.other':'Otros (min/día)',
      'wb.shared':'Capacidad compartida (min/día)',
      'wb.udt':'DT no planeado',
      'wb.udtUnit':'Unidad',
      'wb.net':'Min netos/día',
      'wb.scrap':'Scrap %',
      'wb.yield':'Yield',
      'wb.oeeA':'Disp%',
      'wb.oeeP':'Rend%',
      'wb.oeeQ':'Calidad%',
      'wb.oee':'OEE%',
      'wb.ctCur':'CT Actual (s)',
      'wb.ctWst':'CT Peor (s)',
      'wb.ctPot':'CT Potencial (s)',
      'wb.ctCurOee':'CT@OEE (Act)',
      'wb.cap100':'Cap 100% (Act/día)',
      'wb.capOee':'Cap@OEE (Act/día)',
      'wb.vsContract':'% vs contrato',
      'wb.inputReq':'Entrada req. p/Contrato',
      'wb.actions':'Acciones',
      'wb.constraintTitle':'Restricción / Siguiente:',
      'wb.opsSum':'Operadores total:'
    }
  };

  // =========================
  // ✅ AUTOSAVE TOTAL (State Keys)
  // =========================
  const TL_STATE_KEY = 'taktlab_state_v3_full';
  const WB_KEY = 'taktlabWB_v2_sync';
  const LANG_KEY = 'taktlabLang';

  function safeJsonParse(raw){
    try{ return JSON.parse(raw); }catch(e){ return null; }
  }

  let _saveTimer = null;
  function scheduleSaveAll(){
    if(_saveTimer) clearTimeout(_saveTimer);
    _saveTimer = setTimeout(()=>{ saveAllNow(); }, 120);
  }

  function buildStateSnapshot(){
    return {
      v: 3,
      ts: Date.now(),
      lang: currentLang,
      settings: {
        processName: (processInput.value||'').toString(),
        mode: (modeSelect.value||'CT'),
        efficiency: (effInput.value||''),
        contractPcd: (pcdInput.value||''),
        hoursPerDay: (hInput.value||''),
        daysPerWeek: (dInput.value||''),
        capView: (capViewSel.value||'hour')
      },
      laps: Array.isArray(laps) ? laps : [],
      nextId: (isFinite(nextId)?nextId:1),
      wbRows: Array.isArray(wbRows) ? wbRows : []
    };
  }

  function saveAllNow(){
    const snap = buildStateSnapshot();
    try{ localStorage.setItem(TL_STATE_KEY, JSON.stringify(snap)); }catch(e){}
    try{ localStorage.setItem(WB_KEY, JSON.stringify(snap.wbRows || [])); }catch(e){}
    try{ localStorage.setItem(LANG_KEY, currentLang); }catch(e){}
  }

  function clearAllSaved(){
    try{ localStorage.removeItem(TL_STATE_KEY); }catch(e){}
    try{ localStorage.removeItem(WB_KEY); }catch(e){}
    try{ localStorage.removeItem(LANG_KEY); }catch(e){}
  }

  let currentLang = localStorage.getItem(LANG_KEY) || 'en';
  function t(key){ return (i18n[currentLang] && i18n[currentLang][key]) || i18n.en[key] || key; }

  function applyTranslations(){
    document.querySelectorAll('[data-i18n]').forEach(el=>{
      const key = el.dataset.i18n;
      if(el === btnStart) return;
      el.textContent = t(key);
    });
    document.querySelectorAll('[data-i18n-placeholder]').forEach(el=>{
      const key = el.dataset.i18nPlaceholder;
      el.placeholder = t(key);
    });
  }
  function updateLangButtons(){ langButtons.forEach(b=>b.classList.toggle('active', b.dataset.lang === currentLang)); }

  function setLanguage(lang){
    currentLang = (lang==='es') ? 'es' : 'en';
    try{ localStorage.setItem(LANG_KEY, currentLang); }catch(e){}
    document.documentElement.lang = currentLang;
    updateLangButtons();
    applyTranslations();
    btnStart.textContent = running ? t('btn.pause') : t('btn.start');
    renderAll();
    scheduleSaveAll();
  }
  langButtons.forEach(btn=>btn.addEventListener('click',()=>setLanguage(btn.dataset.lang)));

  function clamp(n,min,max){ n = isFinite(n)?n:0; return Math.min(Math.max(n,min),max); }

  let running=false, startTime=0, elapsed=0, timerId=null;
  let laps=[], nextId=1;
  let pendingT1=null;

  function updateDisplay(){
    display.textContent = formatTime(elapsed);
  }

  function updateSplitClocks(){
    const mode = modeSelect.value || 'CT';
    if(mode === 'CT'){
      t1Clock.textContent = formatTime(elapsed);
      t2Clock.textContent = '00:00.00';
      return;
    }
    if(pendingT1 === null){
      t1Clock.textContent = formatTime(elapsed);
      t2Clock.textContent = '00:00.00';
    }else{
      t1Clock.textContent = formatTime(pendingT1*1000);
      t2Clock.textContent = formatTime(elapsed);
    }
  }

  function refreshRingStates(){
    if(!running){ logoGear.classList.remove('spinning'); return; }
    logoGear.classList.add('spinning');
  }

  function tick(){
    const now=performance.now();
    elapsed=now-startTime;
    updateDisplay();
    updateSplitClocks();
    timerId=requestAnimationFrame(tick);
  }

  function start(){
    if(running) return;
    running=true;
    startTime=performance.now()-elapsed;
    timerId=requestAnimationFrame(tick);
    btnStart.textContent=t('btn.pause');
    refreshRingStates();
  }
  function pause(){
    if(!running) return;
    running=false;
    cancelAnimationFrame(timerId);
    timerId=null;
    btnStart.textContent=t('btn.start');
    refreshRingStates();
  }
  btnStart.addEventListener('click',()=>{ running?pause():start(); });

  function flashCard(){ timerCard.classList.add('flash'); setTimeout(()=>timerCard.classList.remove('flash'),120); }
  function vibrate(ms=18){ try{ if(navigator.vibrate) navigator.vibrate(ms); }catch(e){} }

  function ensureDefaults(){
    let proc=(processInput.value||'').trim();
    if(!proc){
      proc = currentLang==='es' ? 'Proceso 1' : 'Process 1';
      processInput.value=proc;
    }
    let mode=modeSelect.value||'CT';
    modeSelect.value=mode;
    return {proc,mode};
  }

  // ✅ statuses that must NOT affect statistics (atypical)
  function isAtypicalStatus(s){
    const x=(s||'').toString().trim().toLowerCase();
    return (x==='blocked' || x==='starved' || x==='bloqueado' || x==='hambriento');
  }

  function groupByProcess(){
    const map=new Map();
    laps.forEach(l=>{
      if(isAtypicalStatus(l.status)) return; // exclude atypical from stats
      const key=l.process+'||'+l.mode;
      if(!map.has(key)) map.set(key,[]);
      map.get(key).push(l);
    });
    return map;
  }

  function percentile(values,p){
    const n=values.length;
    if(n===0) return NaN;
    if(n===1) return values[0];
    const idx=(n-1)*p;
    const lo=Math.floor(idx), hi=Math.ceil(idx);
    if(lo===hi) return values[lo];
    return values[lo]+(values[hi]-values[lo])*(idx-lo);
  }

  function calcStats(arr){
    if(!arr.length) return null;
    const values=arr.map(x=>x.total).slice().sort((a,b)=>a-b);
    const n=values.length;
    const mean=values.reduce((s,v)=>s+v,0)/n;
    const median=n%2?values[(n-1)/2]:(values[n/2-1]+values[n/2])/2;
    const min=values[0], max=values[n-1];
    const variance=values.reduce((s,v)=>s+Math.pow(v-mean,2),0)/(n-1||1);
    const std=Math.sqrt(variance);
    const p10=percentile(values,0.1);
    const p90=percentile(values,0.9);
    const cv=mean?std/mean:0;
    return {n,values,mean,median,min,max,std,p10,p90,cv};
  }

  function capFromCt(ctSeconds, view, hours, days){
    if(!ctSeconds || ctSeconds<=0) return 0;
    const perHour=3600/ctSeconds;
    if(view==='hour') return perHour;
    if(view==='day') return perHour*hours;
    return perHour*hours*days;
  }
  function contractUnitsFromPcd(pcd, view, hours, days){
    if(!pcd || pcd<=0) return 0;
    if(view==='hour') return (pcd/hours)||0;
    if(view==='day') return pcd;
    return pcd*days;
  }

  function sampleReqN(cv){
    const Z=1.96, targetError=0.03;
    if(!isFinite(cv) || cv<=0) return 10;
    let n = Math.ceil(Math.pow((Z*cv)/targetError,2));
    if(n<10) n=10;
    return n;
  }
  function estErrorPct(cv,n){
    const Z=1.96;
    if(!isFinite(cv) || cv<=0 || n<=0) return 0;
    return (Z*cv)/Math.sqrt(n)*100;
  }

  function setInfo(div, cls, text){
    div.className = 'info-line ' + cls;
    div.textContent = text;
  }

  function buildSampleLine(st){
    if(!st || st.n<3){
      return {
        cls:'sample-neutral',
        text:(currentLang==='es'
          ? `Tamaño de muestra: ${st?st.n:0} / 3 – se requieren ≥3 vueltas antes de estimar el error.`
          : `Sample size: ${st?st.n:0} / 3 – need ≥3 laps before estimating error.`
        )
      };
    }
    const n=st.n;
    const cv=st.cv||0;
    const recN = sampleReqN(cv);
    const errPct = estErrorPct(cv,n);
    const ratio=n/recN;

    let cls='sample-warn', tail='';
    if(ratio<0.6){
      cls='sample-bad';
      tail = currentLang==='es'
        ? 'Muestra muy pequeña para ±3% – úsala solo como referencia.'
        : 'Sample too small for ±3% – use only as reference.';
    }else if(ratio<0.9){
      cls='sample-warn';
      tail = currentLang==='es'
        ? 'Casi suficiente para ±3% – un par de vueltas más ayudarán.'
        : 'Almost enough for ±3% – a couple more laps would help.';
    }else{
      cls='sample-good';
      tail = currentLang==='es'
        ? 'Tamaño de muestra suficiente para objetivo ±3%.'
        : 'Sample size is enough for ±3% target.';
    }

    const head = (currentLang==='es')
      ? `Tamaño de muestra: ${n} / ${recN} · Error estimado: ±${errPct.toFixed(1)}% (95%) – `
      : `Sample size: ${n} / ${recN} · Est. error: ±${errPct.toFixed(1)}% (95%) – `;

    return {cls, text: head + tail};
  }

  /* =======================
     ✅ WB DATA MODEL
     ======================= */
  function defaultWbRow(){
    const globalHours = clamp(parseFloat(hInput.value)||8, 1, 24);
    const globalContract = clamp(parseFloat(pcdInput.value)||0, 0, 99999);
    const globalQ = clamp(parseFloat(effInput.value)||100, 0, 100);
    const gOp = (processInput.value||'').trim();

    return {
      id: 'wb_' + Math.random().toString(36).slice(2,9),
      enabled: true,

      operation: gOp || '',
      opAuto: true,
      opAutoKey: normOp(gOp || ''),

      operators: 1,
      shifts: 1,
      hours: globalHours,
      hoursAuto: true,

      machines: 1,
      contractPcd: globalContract,
      contractAuto: true,

      lunchMin: 0,
      changeoverMin: 0,
      cleanMin: 0,
      maintMin: 0,
      otherMin: 0,

      sharedMin: 0,

      udtValue: 0,
      udtUnit: 'min_day',

      scrapPct: 0,

      oeeA: 100,
      oeeP: 100,
      oeeQ: globalQ,
      qAuto: true,

      ctCurManual: null,
      ctWstManual: null,
      ctPotManual: null
    };
  }

  let wbRows = [];

  function loadWB(){
    try{
      const raw = localStorage.getItem(WB_KEY);
      if(!raw){ wbRows=[]; return; }
      const parsed = JSON.parse(raw);
      wbRows = Array.isArray(parsed) ? parsed : [];
    }catch(e){ wbRows=[]; }
  }
  function saveWB(){
    try{ localStorage.setItem(WB_KEY, JSON.stringify(wbRows)); }catch(e){}
    scheduleSaveAll();
  }

  function applyGlobalToRow(row){
    const gHours = clamp(parseFloat(hInput.value)||8,1,24);
    const gContract = clamp(parseFloat(pcdInput.value)||0,0,99999);
    const gQ = clamp(parseFloat(effInput.value)||100,0,100);
    const gOp = (processInput.value||'').trim();
    const gOpKey = normOp(gOp);

    if(row.opAuto && gOp && gOpKey){
      row.operation = gOp;
      row.opAutoKey = gOpKey;
    }
    if(row.hoursAuto) row.hours = gHours;
    if(row.contractAuto) row.contractPcd = gContract;
    if(row.qAuto) row.oeeQ = gQ;
  }

  function ensureWbRowForOperation(opName){
    const op = (opName||'').trim();
    const opKey = normOp(op);
    if(!op || !opKey) return;

    let row = wbRows.find(r => normOp(r.operation) === opKey);
    if(!row){
      row = defaultWbRow();
      row.operation = op;
      row.opAuto = true;
      row.opAutoKey = opKey;
      wbRows.push(row);
      saveWB();
    }
  }

  function addLap(manualData){
    const {proc,mode}=ensureDefaults();
    ensureWbRowForOperation(proc);

    const status='', note='';
    if(manualData){
      const {t1,t2,total}=manualData;
      laps.push({id:nextId++,process:proc,mode,status,note,t1,t2,total});
      renderAll();
      scheduleSaveAll();
      return;
    }
    const seconds=Math.max(elapsed/1000,0);
    if(mode==='CT'){
      laps.push({id:nextId++,process:proc,mode,status,note,t1:seconds,t2:0,total:seconds});
      elapsed=0; startTime=performance.now();
      updateDisplay(); pendingT1=null; updateSplitClocks();
      renderAll();
      scheduleSaveAll();
      return;
    }
    if(pendingT1===null){
      pendingT1=seconds;
      elapsed=0; startTime=performance.now();
      updateSplitClocks();
    }else{
      const t2=seconds, t1=pendingT1;
      laps.push({id:nextId++,process:proc,mode,status,note,t1,t2,total:t1+t2});
      pendingT1=null;
      elapsed=0; startTime=performance.now();
      updateDisplay(); updateSplitClocks();
      renderAll();
      scheduleSaveAll();
    }
  }

  btnLap.addEventListener('click',()=>{ flashCard(); vibrate(18); addLap(); });

  btnAddMan.addEventListener('click',()=>{
    const t1 = parseFloat(prompt(currentLang==='es'?'T1 (s)':'T1 (s)',''));
    const t2 = parseFloat(prompt(currentLang==='es'?'T2 (s)':'T2 (s)',''));
    if(isNaN(t1) && isNaN(t2)) return;
    const v1=isNaN(t1)?0:t1, v2=isNaN(t2)?0:t2;
    addLap({t1:v1,t2:v2,total:v1+v2});
  });

  btnReset.addEventListener('click',()=>{
    if(!confirm(currentLang==='es'
      ? '¿Reset TOTAL? Borra laps, WB y configuración guardada.'
      : 'TOTAL reset? This will delete laps, WB and saved settings.'
    )) return;

    pause();
    elapsed=0; updateDisplay();
    laps=[]; nextId=1; pendingT1=null;
    wbRows=[];
    clearAllSaved();
    updateSplitClocks();
    renderAll();
  });

  modeSelect.addEventListener('change',()=>{ pendingT1=null; updateSplitClocks(); scheduleSaveAll(); });

  /* ======= CONTINÚA EN PARTE 2 ======= */
  // =========================
  // ✅ Rendering + Logic
  // =========================
  function computeOEE(row){
    const A = clamp(parseFloat(row.oeeA)||0,0,100);
    const P = clamp(parseFloat(row.oeeP)||0,0,100);
    const Q = clamp(parseFloat(row.oeeQ)||0,0,100);
    return (A/100)*(P/100)*(Q/100)*100;
  }

  function udtToMinPerDay(row){
    const v = clamp(parseFloat(row.udtValue)||0,0,999999);
    const u = row.udtUnit || 'min_day';
    if(u==='min_day') return v;

    // ✅ Shifts = referencia, NO afecta capacidad
    if(u==='min_shift') return v;
    if(u==='min_hour') return v * (clamp(parseFloat(row.hours)||8,1,24));

    if(u==='pct') {
      const gross = grossMinPerDay(row);
      return gross*(v/100);
    }
    return v;
  }

  function grossMinPerDay(row){
    const hours = clamp(parseFloat(row.hours)||8,1,24);
    const machines = clamp(parseFloat(row.machines)||1,1,999);

    // ✅ Shifts NO afecta capacidad: solo referencia
    return hours*60*machines;
  }

  function plannedLossMin(row){
    return (
      clamp(parseFloat(row.lunchMin)||0,0,999999) +
      clamp(parseFloat(row.changeoverMin)||0,0,999999) +
      clamp(parseFloat(row.cleanMin)||0,0,999999) +
      clamp(parseFloat(row.maintMin)||0,0,999999) +
      clamp(parseFloat(row.otherMin)||0,0,999999)
    );
  }

  function netMinPerDay(row){
    const gross = grossMinPerDay(row);
    const lunch = clamp(parseFloat(row.lunchMin)||0,0,999999);
    const pl = plannedLossMin(row);
    const shared = clamp(parseFloat(row.sharedMin)||0,0,999999);
    const udtMin = udtToMinPerDay(row);
    const used = lunch + (pl - lunch) + shared + udtMin;
    const net = gross - used;
    return Math.max(net,0);
  }

  function yieldFromScrap(row){
    const scrap = clamp(parseFloat(row.scrapPct)||0,0,99.99);
    return (100 - scrap)/100;
  }

  function getProcessStatsForRow(row){
    const op = (row.operation||'').trim();
    if(!op) return null;

    const map = groupByProcess();
    let keyCT = op + '||CT';
    let keyMLD = op + '||MLD';

    if(map.has(keyCT)){
      return {mode:'CT', stats: calcStats(map.get(keyCT))};
    }
    if(map.has(keyMLD)){
      return {mode:'MLD', stats: calcStats(map.get(keyMLD))};
    }

    let found = null;
    for(const [k,arr] of map.entries()){
      const [p,m]=k.split('||');
      if(normOp(p)===normOp(op)){
        found = {mode:m, stats: calcStats(arr)};
        break;
      }
    }
    return found;
  }

  function ctForRow(row){
    const st = getProcessStatsForRow(row);
    const manualCur = row.ctCurManual;
    const manualWst = row.ctWstManual;
    const manualPot = row.ctPotManual;

    let cur = null, wst = null, pot = null;

    if(manualCur!==null && isFinite(manualCur)) cur = manualCur;
    if(manualWst!==null && isFinite(manualWst)) wst = manualWst;
    if(manualPot!==null && isFinite(manualPot)) pot = manualPot;

    if(!st || !st.stats){
      cur = cur ?? NaN;
      wst = wst ?? NaN;
      pot = pot ?? NaN;
      return {cur,wst,pot, src:'manual'};
    }

    const S = st.stats;
    cur = cur ?? S.median;
    wst = wst ?? S.p90;
    pot = pot ?? S.p10;

    return {cur,wst,pot, src:st.mode};
  }

  function capPerDayFromRow(row){
    const {cur} = ctForRow(row);
    const oee = computeOEE(row);
    const netMin = netMinPerDay(row);
    const y = yieldFromScrap(row);

    if(!isFinite(cur) || cur<=0) return {cap100:0, capOee:0, ctOee:NaN};

    const ctOee = cur / Math.max(oee/100, 0.0001);
    const cap100 = (netMin*60)/cur * y;
    const capOee = (netMin*60)/ctOee * y;

    return {cap100, capOee, ctOee};
  }

  /* ✅ Operation dropdown options (laps + WB + current input) */
  function getOperationOptions(){
    const set = new Map();

    const g = (processInput.value||'').trim();
    if(g) set.set(normOp(g), g);

    laps.forEach(l=>{
      const p=(l.process||'').trim();
      if(p) set.set(normOp(p), p);
    });

    wbRows.forEach(r=>{
      const p=(r.operation||'').trim();
      if(p) set.set(normOp(p), p);
    });

    const arr = [...set.values()].sort((a,b)=>a.localeCompare(b, undefined, {numeric:true, sensitivity:'base'}));
    return arr;
  }

  function renderWB(){
    wbRows.forEach(r=>applyGlobalToRow(r));
    saveWB();

    wbBody.innerHTML = '';

    let opSum=0;
    let constr = null;
    let second = null;

    const ops = getOperationOptions();

    wbRows.forEach((row)=>{
      const enabled = !!row.enabled;
      const tr = document.createElement('tr');

      const gGross = grossMinPerDay(row);
      const net = netMinPerDay(row);

      const y = yieldFromScrap(row);
      const oee = computeOEE(row);
      const {cur,wst,pot} = ctForRow(row);
      const {cap100, capOee, ctOee} = capPerDayFromRow(row);

      const contract = clamp(parseFloat(row.contractPcd)||0,0,999999);
      const vs = contract>0 ? (capOee/contract*100) : NaN;

      const inputReq = (contract>0 && isFinite(capOee) && capOee>0)
        ? (contract / Math.max(y,0.0001))
        : NaN;

      if(enabled){
        opSum += clamp(parseFloat(row.operators)||0,0,999);
      }

      if(enabled && contract>0 && isFinite(vs)){
        const item = {row, vs};
        if(!constr || item.vs < constr.vs){
          second = constr;
          constr = item;
        }else if(!second || item.vs < second.vs){
          second = item;
        }
      }

      function td(html){ const c=document.createElement('td'); c.innerHTML=html; tr.appendChild(c); }

      function chkCell(checked, onChange){
        const c=document.createElement('td');
        const inp=document.createElement('input');
        inp.type='checkbox'; inp.className='wb-chk';
        inp.checked=checked;
        inp.addEventListener('change',()=>onChange(inp.checked));
        c.appendChild(inp);
        tr.appendChild(c);
      }

      function inpCell(val, cls, onInput, type='number', step='1', min=null, max=null){
        const c=document.createElement('td');
        const inp=document.createElement('input');
        inp.type=type;
        inp.className=(cls||'wb-inp');
        inp.value = (val===null || val===undefined) ? '' : val;
        if(step!==null) inp.step = step;
        if(min!==null) inp.min = min;
        if(max!==null) inp.max = max;
        inp.addEventListener('input',()=>onInput(inp.value));
        c.appendChild(inp);
        tr.appendChild(c);
      }

      function selCell(value, options, onChange){
        const c=document.createElement('td');
        const sel=document.createElement('select');
        sel.className='wb-sel';
        options.forEach(o=>{
          const op=document.createElement('option');
          op.value=o.value; op.textContent=o.label;
          if(o.value===value) op.selected=true;
          sel.appendChild(op);
        });
        sel.addEventListener('change',()=>onChange(sel.value));
        c.appendChild(sel); tr.appendChild(c);
        return sel;
      }

      function operationCell(){
        const c=document.createElement('td');

        const wrap=document.createElement('div');
        wrap.className='wb-opwrap';

        const sel=document.createElement('select');
        sel.className='wb-opselect';

        const currentOp = (row.operation||'').trim();
        const list = ops.slice();
        if(currentOp && !list.some(x=>normOp(x)===normOp(currentOp))) list.unshift(currentOp);

        const ph=document.createElement('option');
        ph.value='';
        ph.textContent = (currentLang==='es'?'Selecciona…':'Select…');
        if(!currentOp) ph.selected=true;
        sel.appendChild(ph);

        list.forEach(opName=>{
          const o=document.createElement('option');
          o.value=opName;
          o.textContent=opName;
          if(normOp(opName)===normOp(currentOp)) o.selected=true;
          sel.appendChild(o);
        });

        const customOpt=document.createElement('option');
        customOpt.value='__custom__';
        customOpt.textContent = (currentLang==='es'?'+ Personalizar…':'+ Custom…');
        sel.appendChild(customOpt);

        sel.addEventListener('change',()=>{
          let v = sel.value;
          if(v==='__custom__'){
            const newName = prompt(currentLang==='es'?'Nombre de operación:':'Operation name:', currentOp || (processInput.value||'').trim());
            if(newName===null){ sel.value = currentOp || ''; return; }
            v = (newName||'').toString().trim();
            if(!v){ sel.value = currentOp || ''; return; }
          }
          row.operation = (v||'').toString().trim();
          row.opAuto = false;
          row.opAutoKey = normOp(row.operation);
          saveWB(); renderAll(); scheduleSaveAll();
        });

        const bEdit=document.createElement('button');
        bEdit.className='wb-opbtn';
        bEdit.textContent = '✎';
        bEdit.title = (currentLang==='es'?'Editar nombre':'Edit name');
        bEdit.addEventListener('click',()=>{
          const newName = prompt(currentLang==='es'?'Nombre de operación:':'Operation name:', currentOp || '');
          if(newName===null) return;
          const v=(newName||'').toString().trim();
          if(!v) return;
          row.operation=v;
          row.opAuto=false;
          row.opAutoKey=normOp(v);
          saveWB(); renderAll(); scheduleSaveAll();
        });

        wrap.appendChild(sel);
        wrap.appendChild(bEdit);
        c.appendChild(wrap);
        tr.appendChild(c);
      }

      function btnCell(){
        const c=document.createElement('td');
        const bEdit=document.createElement('button');
        bEdit.textContent='Edit';
        bEdit.className='btn-edit';
        bEdit.addEventListener('click',()=>{
          const curIn = prompt(currentLang==='es'?'CT Actual (s) (2 dec)':'CT Current (s) (2 dec)', row.ctCurManual ?? '');
          const wstIn = prompt(currentLang==='es'?'CT Peor (s) (2 dec)':'CT Worst (s) (2 dec)', row.ctWstManual ?? '');
          const potIn = prompt(currentLang==='es'?'CT Potencial (s) (2 dec)':'CT Potential (s) (2 dec)', row.ctPotManual ?? '');

          function parse2(x){
            if(x===null) return null;
            const s=(''+x).trim();
            if(s==='') return null;
            const n=parseFloat(s);
            if(!isFinite(n)) return null;
            return Math.round(n*100)/100;
          }
          row.ctCurManual = parse2(curIn);
          row.ctWstManual = parse2(wstIn);
          row.ctPotManual = parse2(potIn);
          saveWB(); renderAll(); scheduleSaveAll();
        });

        const bRelink=document.createElement('button');
        bRelink.textContent='Relink';
        bRelink.className='btn-relink';
        bRelink.addEventListener('click',()=>{
          const gOp = (processInput.value||'').trim();
          const gKey = normOp(gOp);
          if(gOp && gKey){
            row.opAuto = true;
            row.opAutoKey = gKey;
            row.operation = gOp;
            saveWB(); renderAll(); scheduleSaveAll();
          }
        });

        const bDel=document.createElement('button');
        bDel.textContent='Del';
        bDel.className='btn-del';
        bDel.addEventListener('click',()=>{
          wbRows = wbRows.filter(r=>r.id!==row.id);
          saveWB(); renderAll(); scheduleSaveAll();
        });

        c.appendChild(bEdit);
        c.appendChild(document.createTextNode(' '));
        c.appendChild(bRelink);
        c.appendChild(document.createTextNode(' '));
        c.appendChild(bDel);
        tr.appendChild(c);
      }

      // On
      chkCell(row.enabled,(v)=>{ row.enabled=!!v; saveWB(); renderAll(); scheduleSaveAll(); });

      // Operation
      operationCell();

      // rest
      inpCell(row.operators,'wb-inp',v=>{ row.operators=clamp(parseFloat(v)||0,0,999); saveWB(); renderAll(); scheduleSaveAll(); },'number','1',0,999);
      inpCell(row.shifts,'wb-inp',v=>{ row.shifts=clamp(parseFloat(v)||1,1,10); saveWB(); renderAll(); scheduleSaveAll(); },'number','1',1,10);
      inpCell(row.hours,'wb-inp',v=>{ row.hours=clamp(parseFloat(v)||8,1,24); row.hoursAuto=false; saveWB(); renderAll(); scheduleSaveAll(); },'number','.5',1,24);

      inpCell(row.machines,'wb-inp',v=>{ row.machines=clamp(parseFloat(v)||1,1,999); saveWB(); renderAll(); scheduleSaveAll(); },'number','1',1,999);
      inpCell(row.contractPcd,'wb-inp',v=>{ row.contractPcd=clamp(parseFloat(v)||0,0,99999); row.contractAuto=false; saveWB(); renderAll(); scheduleSaveAll(); },'number','1',0,99999);

      td(formatUnits(gGross));
      inpCell(row.lunchMin||0,'wb-inp',v=>{ row.lunchMin=clamp(parseFloat(v)||0,0,999999); saveWB(); renderAll(); scheduleSaveAll(); },'number','1',0,999999);
      inpCell(row.changeoverMin||0,'wb-inp',v=>{ row.changeoverMin=clamp(parseFloat(v)||0,0,999999); saveWB(); renderAll(); scheduleSaveAll(); },'number','1',0,999999);
      inpCell(row.cleanMin||0,'wb-inp',v=>{ row.cleanMin=clamp(parseFloat(v)||0,0,999999); saveWB(); renderAll(); scheduleSaveAll(); },'number','1',0,999999);
      inpCell(row.maintMin||0,'wb-inp',v=>{ row.maintMin=clamp(parseFloat(v)||0,0,999999); saveWB(); renderAll(); scheduleSaveAll(); },'number','1',0,999999);
      inpCell(row.otherMin||0,'wb-inp',v=>{ row.otherMin=clamp(parseFloat(v)||0,0,999999); saveWB(); renderAll(); scheduleSaveAll(); },'number','1',0,999999);

      inpCell(row.sharedMin||0,'wb-inp',v=>{ row.sharedMin=clamp(parseFloat(v)||0,0,999999); saveWB(); renderAll(); scheduleSaveAll(); },'number','1',0,999999);

      inpCell(row.udtValue||0,'wb-inp',v=>{ row.udtValue=clamp(parseFloat(v)||0,0,999999); saveWB(); renderAll(); scheduleSaveAll(); },'number','1',0,999999);

      selCell(row.udtUnit||'min_day',[
        {value:'min_day', label:(currentLang==='es'?'min/día':'min/day')},
        {value:'min_shift', label:(currentLang==='es'?'min/turno (ref)':'min/shift (ref)')},
        {value:'min_hour', label:(currentLang==='es'?'min/hora':'min/hour')},
        {value:'pct', label:(currentLang==='es'?'% de brutos':'% gross')}
      ],v=>{ row.udtUnit=v; saveWB(); renderAll(); scheduleSaveAll(); });

      td(formatUnits(net));

      inpCell(row.scrapPct||0,'wb-inp',v=>{ row.scrapPct=clamp(parseFloat(v)||0,0,99.99); saveWB(); renderAll(); scheduleSaveAll(); },'number','.1',0,99.99);
      td(pct(y*100,1));

      inpCell(row.oeeA||100,'wb-inp',v=>{ row.oeeA=clamp(parseFloat(v)||0,0,100); saveWB(); renderAll(); scheduleSaveAll(); },'number','1',0,100);
      inpCell(row.oeeP||100,'wb-inp',v=>{ row.oeeP=clamp(parseFloat(v)||0,0,100); saveWB(); renderAll(); scheduleSaveAll(); },'number','1',0,100);
      inpCell(row.oeeQ||100,'wb-inp',v=>{ row.oeeQ=clamp(parseFloat(v)||0,0,100); row.qAuto=false; saveWB(); renderAll(); scheduleSaveAll(); },'number','1',0,100);
      td(pct(oee,1));

      td(isFinite(cur)?formatSecs(cur):'-');
      td(isFinite(wst)?formatSecs(wst):'-');
      td(isFinite(pot)?formatSecs(pot):'-');

      td(isFinite(ctOee)?formatSecs(ctOee):'-');

      td(isFinite(cap100)?formatUnits(cap100):'-');
      td(isFinite(capOee)?formatUnits(capOee):'-');

      let badge = 'badge-warn';
      if(isFinite(vs)){
        if(vs>=105) badge='badge-good';
        else if(vs<95) badge='badge-bad';
      }
      td(isFinite(vs)?(`<span class="badge ${badge}">${pct(vs,0)}</span>`):'-');

      td(isFinite(inputReq)?formatUnits(inputReq):'-');

      btnCell();

      if(!enabled){
        tr.style.opacity = '0.55';
      }
      wbBody.appendChild(tr);
    });

    wbOperatorsSum.textContent = String(Math.round(opSum));

    if(constr){
      const op = (constr.row.operation||'').trim() || '—';
      wbConstraint.textContent = `${op} · ${pct(constr.vs,0)}`;
      wbConstraint.className = 'badge badge-bad';
    }else{
      wbConstraint.textContent = '—';
      wbConstraint.className = 'badge badge-bad';
    }

    if(second){
      const op = (second.row.operation||'').trim() || '—';
      wbNextConstraint.textContent = `${op} · ${pct(second.vs,0)}`;
      wbNextConstraint.className = 'badge badge-warn';
    }else{
      wbNextConstraint.textContent = '—';
      wbNextConstraint.className = 'badge badge-warn';
    }

    wbConstraintNote.textContent = (currentLang==='es'
      ? 'Restricción = filas activas (On) con contrato > 0, usando Cap@OEE vs Contrato.'
      : 'Constraint = active rows (On) with contract > 0, using Cap@OEE vs Contract.'
    );
  }

  btnWbAdd.addEventListener('click',()=>{
    const r = defaultWbRow();
    wbRows.push(r);
    saveWB();
    renderAll();
    scheduleSaveAll();
  });

  btnWbClear.addEventListener('click',()=>{
    if(!confirm(currentLang==='es'?'¿Borrar WB completo?':'Clear WB entirely?')) return;
    wbRows = [];
    saveWB();
    renderAll();
    scheduleSaveAll();
  });

  // ✅ Copy WB (Excel-friendly TSV)
  btnCopyWB.addEventListener('click',()=>{
    let out=[];
    out.push(`WB Export (${new Date().toISOString()})`);
    out.push('On\tOperation\tOperators\tShifts(ref)\tHours\tMachines\tContractPcd\tNetMinDay\tOEE%\tYield%\tCTcur\tCap@OEE\t%vsContract');

    wbRows.forEach(r=>{
      const net = netMinPerDay(r);
      const oee = computeOEE(r);
      const y = yieldFromScrap(r)*100;
      const {cur} = ctForRow(r);
      const {capOee} = capPerDayFromRow(r);
      const contract = clamp(parseFloat(r.contractPcd)||0,0,999999);
      const vs = contract>0 ? (capOee/contract*100) : NaN;

      out.push([
        r.enabled?1:0,
        (r.operation||'').trim(),
        Math.round(clamp(parseFloat(r.operators)||0,0,999)),
        Math.round(clamp(parseFloat(r.shifts)||1,1,10)),
        clamp(parseFloat(r.hours)||8,1,24),
        clamp(parseFloat(r.machines)||1,1,999),
        Math.round(contract),
        Math.round(net),
        oee.toFixed(1),
        y.toFixed(1),
        (isFinite(cur)?formatSecs(cur):''),
        (isFinite(capOee)?Math.round(capOee):''),
        (isFinite(vs)?vs.toFixed(0):'')
      ].join('\t'));
    });

    copyText(out.join('\n'));
  });

  function renderRaw(){
    dataBody.innerHTML = '';
    laps.forEach((l, idx)=>{
      const tr=document.createElement('tr');

      function td(txt, left=false){
        const c=document.createElement('td');
        c.textContent = txt;
        if(left) c.style.textAlign='left';
        tr.appendChild(c);
      }

      td(String(idx+1), true);
      td(l.process, true);
      td(l.mode, true);

      // ✅ Status selector (Normal / Blocked / Starved) — editable
      {
        const c=document.createElement('td');
        c.style.textAlign='left';
        const sel=document.createElement('select');
        sel.className='wb-sel';

        const opts = [
          {v:'',        en:'',         es:''},
          {v:'Normal',  en:'Normal',   es:'Normal'},
          {v:'Blocked', en:'Blocked',  es:'Bloqueado'},
          {v:'Starved', en:'Starved',  es:'Hambriento'}
        ];
        opts.forEach(o=>{
          const op=document.createElement('option');
          op.value=o.v;
          op.textContent = (currentLang==='es'?o.es:o.en);
          if((l.status||'')===o.v) op.selected=true;
          sel.appendChild(op);
        });

        sel.addEventListener('change',()=>{
          l.status = sel.value;
          renderAll();          // ✅ stats update (blocked/starved excluded)
          scheduleSaveAll();
        });

        c.appendChild(sel);
        tr.appendChild(c);
      }

      // ✅ Note input (blank allowed)
      {
        const c=document.createElement('td');
        c.style.textAlign='left';
        const inp=document.createElement('input');
        inp.type='text';
        inp.className='wb-inp wide';
        inp.value = (l.note||'');
        inp.placeholder = (currentLang==='es'?'nota…':'note…');
        inp.addEventListener('input',()=>{
          l.note = inp.value;
          scheduleSaveAll();
        });
        c.appendChild(inp);
        tr.appendChild(c);
      }

      td(formatSecs(l.t1));
      td(formatSecs(l.t2));
      td(formatSecs(l.total));

      const tdEdit=document.createElement('td');
      const bEdit=document.createElement('button');
      bEdit.className='btn-edit';
      bEdit.textContent=t('col.edit');
      bEdit.addEventListener('click',()=>{
        const newProc = prompt(currentLang==='es'?'Proceso':'Process', l.process) ?? l.process;
        const newMode = prompt(currentLang==='es'?'Modo (CT/MLD)':'Mode (CT/MLD)', l.mode) ?? l.mode;
        const newT1 = prompt('T1 (s)', formatSecs(l.t1)) ?? l.t1;
        const newT2 = prompt('T2 (s)', formatSecs(l.t2)) ?? l.t2;

        const p = (newProc||'').toString().trim();
        const m = (newMode||'CT').toString().trim().toUpperCase()==='MLD'?'MLD':'CT';
        const t1v = Math.round((parseFloat(newT1)||0)*100)/100;
        const t2v = Math.round((parseFloat(newT2)||0)*100)/100;

        l.process = p || l.process;
        l.mode = m;
        l.t1 = t1v;
        l.t2 = t2v;
        l.total = Math.round((t1v+t2v)*100)/100;

        ensureWbRowForOperation(l.process);
        renderAll();
        scheduleSaveAll();
      });
      tdEdit.appendChild(bEdit);
      tr.appendChild(tdEdit);

      const tdDel=document.createElement('td');
      const bDel=document.createElement('button');
      bDel.className='btn-del';
      bDel.textContent=t('col.del');
      bDel.addEventListener('click',()=>{
        laps = laps.filter(x=>x.id!==l.id);
        renderAll();
        scheduleSaveAll();
      });
      tdDel.appendChild(bDel);
      tr.appendChild(tdDel);

      dataBody.appendChild(tr);
    });
  }

  /* ======= TODO lo demás de tu código sigue igual ======= */

  function renderStats(){
    focusBody.innerHTML='';
    statsBody.innerHTML='';

    const map=groupByProcess();
    const view=capViewSel.value;
    const hours=clamp(parseFloat(hInput.value)||8,1,24);
    const days=clamp(parseFloat(dInput.value)||5,1,7);
    const eff=clamp(parseFloat(effInput.value)||100,0,100);
    const contractPcd=clamp(parseFloat(pcdInput.value)||0,0,99999);
    const contractUnits = contractUnitsFromPcd(contractPcd, view, hours, days);

    let firstStats = null;

    for(const [key,arr] of map.entries()){
      const [proc,mode]=key.split('||');
      const st=calcStats(arr);
      if(!st) continue;
      if(!firstStats) firstStats = st;

      const capCur = capFromCt(st.median, view, hours, days) * (eff/100);
      const capPot = capFromCt(st.p10, view, hours, days) * (eff/100);
      const capWst = capFromCt(st.p90, view, hours, days) * (eff/100);

      const gap = contractUnits>0 ? (capCur - contractUnits) : NaN;
      const vs = contractUnits>0 ? (capCur/contractUnits*100) : NaN;

      const cvPct = st.cv*100;
      const recN = sampleReqN(st.cv);
      const errPct = estErrorPct(st.cv, st.n);

      let cp=NaN, cpk=NaN;
      if(contractUnits>0){
        const contractPerHour = contractUnits / (view==='hour'?1:(view==='day'?hours:(hours*days)));
        const targetCt = contractPerHour>0 ? 3600/contractPerHour : NaN;
        if(isFinite(targetCt) && st.std>0){
          const USL = targetCt*1.10;
          const LSL = targetCt*0.90;
          cp = (USL-LSL)/(6*st.std);
          cpk = Math.min((USL-st.mean)/(3*st.std),(st.mean-LSL)/(3*st.std));
        }
      }

      const tr=document.createElement('tr');
      function td(v, left=false){
        const c=document.createElement('td');
        c.textContent=v;
        if(left) c.style.textAlign='left';
        tr.appendChild(c);
      }
      td(proc,true);
      td(mode,false);
      td(String(st.n));
      td(`${st.n} / ${recN} · ±${errPct.toFixed(1)}%`);
      td(formatSecs(st.std));
      td(pct(cvPct,1));
      td(formatSecs(st.median));
      td(formatSecs(st.p10));
      td(formatSecs(st.p90));
      td(isFinite(capCur)?formatUnits(capCur):'-');
      td(isFinite(capPot)?formatUnits(capPot):'-');
      td(isFinite(capWst)?formatUnits(capWst):'-');
      td(contractUnits>0?formatUnits(contractUnits):'-');
      td(isFinite(gap)?formatUnits(gap):'-');
      td(isFinite(vs)?pct(vs,0):'-');
      td(isFinite(cp)?cp.toFixed(2):'-');
      td(isFinite(cpk)?cpk.toFixed(2):'-');

      let note='';
      if(st.n<3) note = currentLang==='es'?'Muy pocas muestras':'Too few samples';
      else if(st.n<recN*0.6) note = currentLang==='es'?'Muestra chica para ±3%':'Small sample for ±3%';
      else if(st.n<recN*0.9) note = currentLang==='es'?'Casi suficiente':'Almost enough';
      else note = currentLang==='es'?'Suficiente':'Enough';
      td(note,true);

      focusBody.appendChild(tr);

      const tr2=document.createElement('tr');
      function td2(v,left=false){
        const c=document.createElement('td'); c.textContent=v;
        if(left) c.style.textAlign='left';
        tr2.appendChild(c);
      }
      td2(proc,true);
      td2(mode,false);
      td2(String(st.n));
      td2(formatSecs(st.mean));
      td2(formatSecs(st.median));
      td2(formatSecs(st.p10));
      td2(formatSecs(st.p90));
      td2(formatSecs(st.min));
      td2(formatSecs(st.max));
      td2(formatSecs(st.std));
      td2(pct(cvPct,1));
      td2(isFinite(cp)?cp.toFixed(2):'-');
      td2(isFinite(cpk)?cpk.toFixed(2):'-');
      statsBody.appendChild(tr2);
    }

    const currentProc = (processInput.value||'').trim();
    const currentMode = modeSelect.value||'CT';
    const currentKey = currentProc+'||'+currentMode;
    const currentStats = map.has(currentKey) ? calcStats(map.get(currentKey)) : firstStats;

    const line = buildSampleLine(currentStats || {n:0,cv:0});
    setInfo(sampleInfoTop, line.cls, line.text);

    if(currentStats){
      const cvPct=currentStats.cv*100;
      const varTxt = `Std: ${formatSecs(currentStats.std)}s · CV: ${cvPct.toFixed(1)}%`;
      setInfo(stdInfoFocus, 'sample-neutral', varTxt);

      const dist = (Math.abs(currentStats.mean-currentStats.median)/Math.max(currentStats.median,0.0001))*100;
      const distTxt = (currentLang==='es')
        ? `Media vs Mediana: ${formatSecs(currentStats.mean)} vs ${formatSecs(currentStats.median)} (Δ ${dist.toFixed(1)}%)`
        : `Mean vs Median: ${formatSecs(currentStats.mean)} vs ${formatSecs(currentStats.median)} (Δ ${dist.toFixed(1)}%)`;
      setInfo(distInfoFocus, 'sample-neutral', distTxt);

      const nTxt = (currentLang==='es')
        ? `Muestras: ${currentStats.n}`
        : `Samples: ${currentStats.n}`;
      setInfo(sampleInfoFocus, 'sample-neutral', nTxt);
    }else{
      setInfo(sampleInfoFocus, 'sample-neutral', (currentLang==='es'?'Muestras: —':'Samples: —'));
      setInfo(stdInfoFocus, 'sample-neutral', 'Std dev: —');
      setInfo(distInfoFocus, 'sample-neutral', 'Mean vs Median: —');
    }

    if(contractUnits>0){
      setInfo(contractInfoFocus, 'sample-neutral',
        (currentLang==='es'
          ? `Contrato: ${formatUnits(contractUnits)} (${capViewSel.options[capViewSel.selectedIndex].text})`
          : `Contract: ${formatUnits(contractUnits)} (${capViewSel.options[capViewSel.selectedIndex].text})`
        )
      );
    }else{
      setInfo(contractInfoFocus, 'sample-neutral', (currentLang==='es'?'Sin contrato cargado':'No contract loaded'));
    }
  }

  function renderContractSummary(){
    const map=groupByProcess();
    const proc=(processInput.value||'').trim();
    const mode=(modeSelect.value||'CT');
    const key=proc+'||'+mode;

    const view=capViewSel.value;
    const hours=clamp(parseFloat(hInput.value)||8,1,24);
    const days=clamp(parseFloat(dInput.value)||5,1,7);
    const eff=clamp(parseFloat(effInput.value)||100,0,100);

    const contractPcd=clamp(parseFloat(pcdInput.value)||0,0,99999);
    const contractUnits = contractUnitsFromPcd(contractPcd, view, hours, days);

    let st=null;
    if(map.has(key)) st=calcStats(map.get(key));
    else{
      for(const [k,arr] of map.entries()){
        const [p,m]=k.split('||');
        if(normOp(p)===normOp(proc) && m===mode){ st=calcStats(arr); break; }
      }
    }

    const labelView = capViewSel.options[capViewSel.selectedIndex].text;

    if(!st){
      contractSumLine1.textContent = (currentLang==='es'?'Sin datos del proceso aún.':'No process data yet.');
      contractSumLine2.textContent = '—';
      contractSumLine3.textContent = '—';
      contractSumLine4.textContent = '—';
      contractSumLine4.className = 'info-line sample-neutral';
      return;
    }

    const capCur = capFromCt(st.median, view, hours, days) * (eff/100);
    const capPot = capFromCt(st.p10, view, hours, days) * (eff/100);
    const capWst = capFromCt(st.p90, view, hours, days) * (eff/100);

    contractSumLine1.textContent = (currentLang==='es'
      ? `Proceso: ${proc} (${mode}) · N=${st.n} · Eff=${eff}%`
      : `Process: ${proc} (${mode}) · N=${st.n} · Eff=${eff}%`
    );

    contractSumLine2.textContent = (currentLang==='es'
      ? `Capacidad (Actual/Mediana): ${formatUnits(capCur)} ${labelView}`
      : `Capacity (Current/Median): ${formatUnits(capCur)} ${labelView}`
    );

    contractSumLine3.textContent = (currentLang==='es'
      ? `Capacidad (Potencial/P10): ${formatUnits(capPot)} · Peor/P90: ${formatUnits(capWst)}`
      : `Capacity (Potential/P10): ${formatUnits(capPot)} · Worst/P90: ${formatUnits(capWst)}`
    );

    if(contractUnits>0){
      const vs = capCur/contractUnits*100;
      const gap = capCur-contractUnits;
      let badge = 'sample-warn';
      if(vs>=105) badge='sample-good';
      else if(vs<95) badge='sample-bad';

      contractSumLine4.className = 'info-line ' + badge;
      contractSumLine4.textContent = (currentLang==='es'
        ? `Contrato: ${formatUnits(contractUnits)} · % vs: ${vs.toFixed(0)}% · Gap: ${formatUnits(gap)}`
        : `Contract: ${formatUnits(contractUnits)} · % vs: ${vs.toFixed(0)}% · Gap: ${formatUnits(gap)}`
      );
    }else{
      contractSumLine4.className = 'info-line sample-neutral';
      contractSumLine4.textContent = (currentLang==='es'
        ? 'Carga un contrato para ver Gap y % vs contrato.'
        : 'Load a contract to see Gap and % vs contract.'
      );
    }
  }

  function clearCanvas(canvas){
    const ctx=canvas.getContext('2d');
    ctx.clearRect(0,0,canvas.width,canvas.height);
  }
  function resizeCanvas(canvas){
    const rect = canvas.getBoundingClientRect();
    canvas.width = Math.max(1, Math.floor(rect.width));
    canvas.height = Math.max(1, Math.floor(rect.height));
  }
  function drawAxes(ctx, w, h, pad){
    ctx.strokeStyle='rgba(255,255,255,.22)';
    ctx.lineWidth=1;
    ctx.beginPath();
    ctx.moveTo(pad, pad);
    ctx.lineTo(pad, h-pad);
    ctx.lineTo(w-pad, h-pad);
    ctx.stroke();
  }

  function drawTimeSeries(values, stats){
    resizeCanvas(timeSeriesCanvas);
    const ctx=timeSeriesCanvas.getContext('2d');
    const w=timeSeriesCanvas.width, h=timeSeriesCanvas.height;
    const pad=28;
    clearCanvas(timeSeriesCanvas);
    drawAxes(ctx,w,h,pad);

    if(!values.length) return;
    const minV=Math.min(...values), maxV=Math.max(...values);
    const range=Math.max(maxV-minV, 0.0001);

    function x(i){ return pad + (i/(values.length-1||1))*(w-2*pad); }
    function y(v){ return (h-pad) - ((v-minV)/range)*(h-2*pad); }

    ctx.strokeStyle='rgba(57,189,245,.90)';
    ctx.lineWidth=2;
    ctx.beginPath();
    values.forEach((v,i)=>{
      const X=x(i), Y=y(v);
      if(i===0) ctx.moveTo(X,Y); else ctx.lineTo(X,Y);
    });
    ctx.stroke();

    const mean=stats.mean, median=stats.median, std=stats.std;
    function hline(v, style){
      ctx.strokeStyle=style; ctx.lineWidth=1.5;
      ctx.beginPath(); ctx.moveTo(pad,y(v)); ctx.lineTo(w-pad,y(v)); ctx.stroke();
    }
    hline(mean,'rgba(24,201,122,.75)');
    hline(median,'rgba(242,193,78,.80)');
    hline(mean+3*std,'rgba(255,51,85,.55)');
    hline(mean-3*std,'rgba(255,51,85,.55)');

    ctx.fillStyle='rgba(255,255,255,.75)';
    ctx.font='12px system-ui';
    ctx.fillText('mean', pad+4, Math.max(14,y(mean)-4));
    ctx.fillText('median', pad+4, Math.max(14,y(median)-4));
  }

  function drawHistogram(values, stats){
    resizeCanvas(histCanvas);
    const ctx=histCanvas.getContext('2d');
    const w=histCanvas.width, h=histCanvas.height;
    const pad=28;
    clearCanvas(histCanvas);
    drawAxes(ctx,w,h,pad);

    if(!values.length) return;
    const minV=Math.min(...values), maxV=Math.max(...values);
    const bins = Math.min(12, Math.max(5, Math.round(Math.sqrt(values.length))));
    const range=Math.max(maxV-minV, 0.0001);
    const binW=range/bins;

    const counts=new Array(bins).fill(0);
    values.forEach(v=>{
      let b = Math.floor((v-minV)/binW);
      if(b>=bins) b=bins-1;
      if(b<0) b=0;
      counts[b]+=1;
    });

    const maxC=Math.max(...counts,1);
    const plotW=w-2*pad, plotH=h-2*pad;
    const barW=plotW/bins;

    ctx.fillStyle='rgba(57,189,245,.45)';
    counts.forEach((c,i)=>{
      const bh=(c/maxC)*plotH;
      const x=pad+i*barW;
      const y=h-pad-bh;
      ctx.fillRect(x+2,y,Math.max(1,barW-4),bh);
    });

    function xFor(v){ return pad + ((v-minV)/range)*plotW; }
    function vline(v, style){
      ctx.strokeStyle=style; ctx.lineWidth=2;
      ctx.beginPath(); ctx.moveTo(xFor(v), pad); ctx.lineTo(xFor(v), h-pad); ctx.stroke();
    }
    vline(stats.median,'rgba(242,193,78,.85)');
    vline(stats.p10,'rgba(24,201,122,.75)');
    vline(stats.p90,'rgba(255,51,85,.70)');

    ctx.fillStyle='rgba(255,255,255,.75)';
    ctx.font='12px system-ui';
    ctx.fillText('P10', xFor(stats.p10)+4, pad+14);
    ctx.fillText('Med', xFor(stats.median)+4, pad+28);
    ctx.fillText('P90', xFor(stats.p90)+4, pad+42);
  }

  function renderCharts(){
    const map=groupByProcess();
    const keys=[...map.keys()].sort();
    const prev=chartSelect.value;
    chartSelect.innerHTML='';
    keys.forEach(k=>{
      const opt=document.createElement('option');
      opt.value=k;
      const [p,m]=k.split('||');
      opt.textContent = `${p} (${m})`;
      chartSelect.appendChild(opt);
    });
    if(keys.includes(prev)) chartSelect.value=prev;
    else if(keys.length) chartSelect.value=keys[0];

    if(!keys.length){
      clearCanvas(timeSeriesCanvas);
      clearCanvas(histCanvas);
      return;
    }

    const arr=map.get(chartSelect.value)||[];
    const st=calcStats(arr);
    const values = st ? st.values : [];
    if(st){
      drawTimeSeries(values, st);
      drawHistogram(values, st);
    }else{
      clearCanvas(timeSeriesCanvas);
      clearCanvas(histCanvas);
    }
  }
  chartSelect.addEventListener('change', renderCharts);
  window.addEventListener('resize', ()=>{ renderCharts(); });

  function copyText(text){
    navigator.clipboard.writeText(text).catch(()=>{});
  }

  /* ======= Copy All / Copy Summary iguales ======= */

  function buildMethodGuide(){
    const es = (currentLang==='es');

    return es
? `MÉTODO & GUÍA – TAKTLAB + WB

1) OBJETIVO
• Medir tiempos reales (CT o MLD), estimar variación y convertirlo en capacidad.
• Separar “tiempo típico” vs “tiempo atípico” (bloqueado/hambriento).

2) MODOS DE MEDICIÓN
A) CT (Cycle Time)
• Cada VUELTA = 1 ciclo completo (total).
• Úsalo cuando solo te importa salida por ciclo.

B) MLD (Machine + Load/Unload)
• Primera VUELTA guarda T1.
• Segunda VUELTA guarda T2.
• Se registra Total = T1 + T2.
• Úsalo cuando quieres separar tiempos pero seguir calculando capacidad con el total.

3) ESTATUS DE MUESTRA (CRÍTICO)
• Normal: cuenta para estadísticas.
• Bloqueado / Hambriento: NO cuenta para estadísticas (es atípico).
  Ejemplos:
  - Bloqueado: esperando material, falla externa, quality hold, etc.
  - Hambriento: máquina esperando operador / alimentación / secuencia.

4) TAMAÑO DE MUESTRA (±3% como meta)
• La app estima un “N recomendado” basado en CV y 95% (Z=1.96).
• Si estás por debajo:
  - úsalo solo como referencia.
  - toma más vueltas antes de concluir.

5) QUÉ SIGNIFICA CADA ESTADÍSTICA
• Mediana (CTmed): tu “típico” robusto.
• P10: potencial (mejor escenario realista).
• P90: peor (escenario conservador).
• Std y CV%: variación (riesgo).

6) CONTRACT vs CAPACITY
• Contract Cap (pcs/day) = demanda objetivo.
• La app convierte CT → capacidad según Hours/Day y Efficiency.
• Gap y % vs contrato:
  - >105%: holgura
  - 95–105%: justo
  - <95%: riesgo / restricción

7) WB – PLANEADOR DE CAPACIDAD
• “Shifts/Turnos” es SOLO referencia (no cambia cálculos).
• Net min/day = Gross min/day - pérdidas planificadas - shared - UDT.
• OEE = A * P * Q.
• Yield = 1 - Scrap%.
• Cap@OEE usa CT ajustado por OEE y Yield.

8) RECOMENDACIÓN DE USO (rápida)
• Primero mide 10–20 muestras “Normal”.
• Marca atípicos como Bloqueado/Hambriento (para no contaminar).
• Revisa mediana y P90.
• Si estás corto vs contrato: ataca restricción (WB Constraint).

9) COPIAR / EXPORTAR
• Copy Summary: resumen del proceso actual.
• Copy All: export general.
• Copy WB: export del WB tabulado (pegar en Excel).

—`
: `METHOD & GUIDE – TAKTLAB + WB

1) PURPOSE
• Measure real times (CT or MLD), quantify variation, convert to capacity.
• Separate “typical” vs “atypical” time (blocked/starved).

2) MEASUREMENT MODES
A) CT (Cycle Time)
• Each LAP = one full cycle (total).
• Use when you only care about output per cycle.

B) MLD (Machine + Load/Unload)
• First LAP stores T1.
• Second LAP stores T2.
• Total = T1 + T2.
• Use when you want split times but capacity uses total.

3) SAMPLE STATUS (CRITICAL)
• Normal: included in stats.
• Blocked / Starved: excluded from stats (atypical).
  Examples:
  - Blocked: waiting material, external issue, quality hold.
  - Starved: machine waiting operator/feeding/sequence.

4) SAMPLE SIZE (±3% target)
• App estimates a recommended N using CV and 95% (Z=1.96).
• If below:
  - use as reference only
  - capture more laps before conclusions

5) STAT MEANING
• Median: robust “typical”.
• P10: potential (best realistic).
• P90: worst (conservative).
• Std/CV%: variation (risk).

6) CONTRACT vs CAPACITY
• Contract Cap (pcs/day) = demand.
• App converts CT → capacity using Hours/Day and Efficiency.
• Gap and % vs contract thresholds:
  - >105% buffer
  - 95–105% tight
  - <95% risk/constraint

7) WB – CAPACITY PLANNER
• “Shifts” is reference only (not used in calculations).
• Net min/day = Gross - planned losses - shared - UDT.
• OEE = A * P * Q.
• Yield = 1 - Scrap%.
• Cap@OEE uses CT adjusted by OEE and Yield.

8) QUICK RECOMMENDED FLOW
• Measure 10–20 “Normal” samples first.
• Mark atypical as Blocked/Starved (avoid contaminating stats).
• Review median and P90.
• If short vs contract: attack WB constraint.

9) COPY / EXPORT
• Copy Summary: current process summary.
• Copy All: full export.
• Copy WB: WB export for Excel.

—`;
  }

  function renderAll(){
    renderContractSummary();
    renderStats();
    renderRaw();
    renderWB();
    renderCharts();
    methodGuideText.textContent = buildMethodGuide();
    scheduleSaveAll();
  }

  processInput.addEventListener('input', ()=>{ scheduleSaveAll(); });
  processInput.addEventListener('blur', ()=>{
    const op = (processInput.value||'').trim();
    ensureWbRowForOperation(op);
    renderAll();
  });
  processInput.addEventListener('keydown', (e)=>{
    if(e.key==='Enter'){
      const op=(processInput.value||'').trim();
      ensureWbRowForOperation(op);
      renderAll();
    }
  });

  [effInput, pcdInput, hInput, dInput, capViewSel, modeSelect].forEach(el=>{
    el.addEventListener('input', ()=>{ renderAll(); });
    el.addEventListener('change', ()=>{ renderAll(); });
  });

  function restoreStateIfAny(){
    const raw = localStorage.getItem(TL_STATE_KEY);
    const st = raw ? safeJsonParse(raw) : null;
    if(!st || typeof st !== 'object') return false;

    if(st.lang){ currentLang = (st.lang==='es')?'es':'en'; }

    const s = st.settings || {};
    if(typeof s.processName === 'string') processInput.value = s.processName;
    if(typeof s.mode === 'string') modeSelect.value = (s.mode==='MLD')?'MLD':'CT';
    if(s.efficiency !== undefined) effInput.value = s.efficiency;
    if(s.contractPcd !== undefined) pcdInput.value = s.contractPcd;
    if(s.hoursPerDay !== undefined) hInput.value = s.hoursPerDay;
    if(s.daysPerWeek !== undefined) dInput.value = s.daysPerWeek;
    if(typeof s.capView === 'string') capViewSel.value = s.capView;

    if(Array.isArray(st.laps)) laps = st.laps;
    if(isFinite(st.nextId)) nextId = st.nextId;

    if(Array.isArray(st.wbRows)) wbRows = st.wbRows;

    running=false; elapsed=0; pendingT1=null;
    return true;
  }

  const restored = restoreStateIfAny();
  if(!restored){
    loadWB();
  }

  updateLangButtons();
  applyTranslations();
  btnStart.textContent = running ? t('btn.pause') : t('btn.start');
  document.documentElement.lang = currentLang;

  const firstOp = (processInput.value||'').trim();
  if(firstOp) ensureWbRowForOperation(firstOp);

  updateDisplay();
  updateSplitClocks();
  renderAll();
  saveAllNow();

})();
</script>
</body>
</html>
