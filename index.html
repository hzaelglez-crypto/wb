<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>TaktLab – Cycle Time & Capacity Analyzer</title>

<style>
  :root{
    /* ✅ fondo gris claro */
    --bg-main:#f3f5f7;
    --bg-card:#ffffff;
    --bg-card-soft:#fbfcfe;

    /* accents (professional) */
    --accent-green:#18c97a;
    --accent-amber:#f2c14e;
    --accent-red:#ff3355;
    --accent-blue:#39bdf5;
    --accent-grey:#cfd8dc;

    --text-main:#0b1220;
    --text-soft:#3a4a66;
    --text-muted:#6b7a90;

    --border-soft:#d9e2ef;

    --btn-green:#18c97a;
    --btn-orange:#f2a93b;
    --btn-grey:#455a64;
    --btn-amber:#f2c14e;

    --badge-green:rgba(24,201,122,.14);
    --badge-red:rgba(255,51,85,.14);
    --badge-amber:rgba(242,193,78,.14);

    /* WB sticky sizing */
    --wb-on-w:56px;
    --wb-op-w:210px;
  }

  *{box-sizing:border-box;}

  body{
    margin:0;
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    background:var(--bg-main);
    color:var(--text-main);
  }

  .page{
    max-width:1100px;
    margin:0 auto;
    padding:10px 10px 34px;
  }

  .sticky-timer-bar{
    position:sticky;
    top:0;
    z-index:100;
    background:rgba(243,245,247,.92);
    backdrop-filter: blur(8px);
    padding:6px 0 8px;
    border-bottom:1px solid var(--border-soft);
  }

  .top-row{
    display:flex;
    align-items:center;
    gap:10px;
    margin-bottom:6px;
  }

  .logo-circle{
    width:38px;height:38px;border-radius:50%;
    border:2px solid rgba(11,18,32,.18);
    display:flex;align-items:center;justify-content:center;
    background:#fff;
  }
  .logo-gear{
    width:22px;height:22px;border-radius:50%;
    border:2px solid rgba(11,18,32,.18);
    position:relative;
  }
  .logo-gear::before{
    content:"";
    position:absolute;
    inset:4px;
    border-radius:50%;
    border:2px solid rgba(24,201,122,.95);
    border-right-color:transparent;
    border-bottom-color:transparent;
    transform-origin:50% 50%;
  }
  .logo-gear.spinning::before{ animation:logo-spin 2s linear infinite; }
  @keyframes logo-spin{ from{transform:rotate(0deg);} to{transform:rotate(360deg);} }

  .title-block{display:flex;flex-direction:column;gap:2px;}
  .title-main{font-size:1.2rem;font-weight:800;letter-spacing:.02em;}
  .title-sub{font-size:.72rem;color:var(--text-soft);}

  .lang-switch{margin-left:auto;display:flex;align-items:center;gap:6px;}
  .lang-btn{
    border-radius:999px;border:1px solid var(--border-soft);
    background:#fff;color:var(--text-soft);
    font-size:.7rem;padding:5px 10px;cursor:pointer;min-width:34px;
  }
  .lang-btn.active{
    background:rgba(57,189,245,.95);
    color:#051018;border-color:rgba(57,189,245,.95);
    font-weight:800;
  }

  .timer-card{
    background:var(--bg-card);
    border-radius:18px;
    border:1px solid var(--border-soft);
    padding:6px 10px 10px;
    box-shadow:0 10px 22px rgba(10,20,40,.08);
  }

  .timer-display{
    text-align:center;
    font-size:2.8rem;
    font-weight:650;
    letter-spacing:.08em;
    padding:4px 4px 2px;
  }

  .split-clocks{
    display:flex;
    gap:8px;
    justify-content:center;
    margin:2px 0 8px;
    flex-wrap:wrap;
  }
  .split-pill{
    display:flex;
    align-items:center;
    gap:6px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid rgba(11,18,32,.10);
    background:rgba(11,18,32,.02);
    font-size:.78rem;
    color:var(--text-soft);
    min-width:150px;
    justify-content:center;
  }
  .split-pill .tag{font-weight:900;letter-spacing:.04em;color:var(--text-main);opacity:.9;}
  .split-pill .val{font-variant-numeric:tabular-nums;letter-spacing:.04em;color:var(--text-main);}
  .split-pill.t1{ border-color: rgba(57,189,245,.28); }
  .split-pill.t2{ border-color: rgba(242,193,78,.26); }

  .info-stack{ display:flex; flex-direction:column; gap:6px; margin:0 0 8px; }
  .info-line{
    font-size:.78rem;margin:0;padding:6px 10px;
    border-radius:12px;border:1px solid transparent;
    line-height:1.25;
  }
  .sample-neutral{background:rgba(11,18,32,.02);border-color:rgba(11,18,32,.08);color:var(--text-soft);}
  .sample-good{background:rgba(24,201,122,.10);border-color:rgba(24,201,122,.35);color:#0b5a33;}
  .sample-warn{background:rgba(242,193,78,.10);border-color:rgba(242,193,78,.35);color:#6a4a00;}
  .sample-bad{background:rgba(255,51,85,.10);border-color:rgba(255,51,85,.35);color:#6b0014;}

  .btn-row-main{display:flex;gap:10px;margin-bottom:2px;}
  .btn{
    border:none;border-radius:16px;padding:10px 12px;
    font-size:.9rem;font-weight:850;cursor:pointer;color:#051018;
    box-shadow:0 6px 14px rgba(10,20,40,.10);flex:1;
    transition:transform .04s ease, box-shadow .04s ease, background .15s, opacity .15s;
    touch-action:manipulation;
  }
  .btn:active{transform:translateY(1px);box-shadow:0 2px 8px rgba(10,20,40,.12);}
  .btn-start{background:rgba(24,201,122,.95); }
  .btn-lap{background:rgba(242,169,59,.95); }

  .btn[disabled],
  .btn-small[disabled],
  .btn-small-copy[disabled],
  .btn-small-summary[disabled],
  .btn-small-manual[disabled],
  .btn-small-reset[disabled]{
    opacity:.55;
    cursor:not-allowed;
    transform:none !important;
  }

  .flash{animation:flash-bg .12s ease-out;}
  @keyframes flash-bg{ from{background:rgba(57,189,245,.10);} to{background:transparent;} }

  .content-section{margin-top:10px;}

  /* ✅ cards con marco pintado por acento */
  .section-card{
    background:var(--bg-card);
    border-radius:18px;
    border:2px solid var(--border-soft);
    padding:10px 12px 12px;
    margin-bottom:12px;
    position:relative;
    box-shadow:0 10px 22px rgba(10,20,40,.06);
  }
  .section-card[data-accent="blue"]{ border-color: rgba(57,189,245,.55); }
  .section-card[data-accent="green"]{ border-color: rgba(24,201,122,.45); }
  .section-card[data-accent="amber"]{ border-color: rgba(242,193,78,.55); }
  .section-card[data-accent="red"]{ border-color: rgba(255,51,85,.40); }
  .section-card[data-accent="grey"]{ border-color: rgba(207,216,220,.85); }

  .section-head{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin:0 0 8px;
  }
  .section-title{font-size:1.02rem;font-weight:900;margin:0;}
  .section-tools{display:flex;gap:8px;align-items:center;}

  .btn-small{
    padding:10px 14px;
    border-radius:16px;
    font-size:.9rem;
    font-weight:950;
    flex:0 0 auto;
    background:var(--bg-card-soft);
    color:var(--text-main);
    border:1px solid var(--border-soft);
    cursor:pointer;
    box-shadow:0 6px 14px rgba(10,20,40,.08);
    transition:opacity .15s;
  }
  .btn-small-copy{background:rgba(57,189,245,.95);border-color:rgba(57,189,245,.95);color:#051018;}
  .btn-small-summary{background:var(--btn-amber);border-color:var(--btn-amber);color:#0b0b0b;}
  .btn-small-manual{background:rgba(24,201,122,.95);border-color:rgba(24,201,122,.95);color:#051018;}
  .btn-small-reset{background:rgba(255,51,85,.92);border-color:rgba(255,51,85,.92);color:#fff;}
  .btn-small-wbadd{background:rgba(11,18,32,.03);color:var(--text-main);}
  .btn-small-wbclear{background:rgba(255,51,85,.10);border-color:rgba(255,51,85,.30);color:#6b0014;}

  .mode-row{
    display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;
    font-size:.78rem;color:var(--text-soft);
  }
  .mode-row select,.mode-row input{
    background:#fff;border-radius:10px;border:1px solid var(--border-soft);
    padding:6px 10px;color:var(--text-main);font-size:.78rem;min-width:70px;
    outline:none;
  }
  .mode-row input[type="number"]{width:88px;}

  table{width:100%;border-collapse:collapse;font-size:.72rem;}
  th,td{
    padding:4px 6px;text-align:right;
    border-bottom:1px solid rgba(11,18,32,.06);
    white-space:nowrap;
    vertical-align:middle;
  }
  th:first-child,td:first-child{text-align:left;}
  th{
    color:var(--text-soft);font-weight:800;background:rgba(11,18,32,.02);
    position:sticky;top:0;z-index:5;
  }
  tbody tr:nth-child(even){background:rgba(11,18,32,.015);}

  .badge{
    display:inline-block;padding:2px 8px;border-radius:999px;
    font-size:.68rem;border:1px solid rgba(11,18,32,.12);
  }
  .badge-good{background:var(--badge-green);border-color:rgba(24,201,122,.36);color:#0b5a33;}
  .badge-warn{background:var(--badge-amber);border-color:rgba(242,193,78,.36);color:#6a4a00;}
  .badge-bad{background:var(--badge-red);border-color:rgba(255,51,85,.36);color:#6b0014;}

  .btn-row-secondary{display:flex;flex-wrap:wrap;gap:10px;margin:8px 0 4px;}

  .subsection-title{margin-top:10px;font-size:.82rem;font-weight:900;color:var(--text-soft);}
  .footer-note{margin-top:10px;font-size:.68rem;color:var(--text-muted);text-align:right;}

  .charts-wrapper{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
    gap:10px;
  }
  .chart-card{
    background:var(--bg-card-soft);
    border-radius:14px;
    border:1px solid var(--border-soft);
    padding:8px;
  }
  .chart-title{font-size:.75rem;margin-bottom:4px;color:var(--text-soft);font-weight:800;}
  canvas{width:100%;height:180px;background:#fff;border-radius:10px;border:1px solid rgba(11,18,32,.08);}

  .btn-edit,.btn-del,.btn-relink{
    padding:2px 8px;border-radius:10px;font-size:.7rem;
    border:1px solid rgba(11,18,32,.20);cursor:pointer;background:#fff;
  }
  .btn-edit{color:#085b7a;}
  .btn-del{color:#6b0014;}
  .btn-relink{color:#6a4a00;}

  .wb-inp, .wb-sel, .wb-chk{
    background:#fff;border-radius:10px;border:1px solid var(--border-soft);
    padding:3px 8px;color:var(--text-main);font-size:.70rem;
    outline:none;
  }
  .wb-inp{width:72px;}
  .wb-inp.wide{width:160px;}
  .wb-inp.slim{width:56px;}
  .wb-sel{width:120px;}
  .wb-sel.narrow{width:92px;}

  .wb-opwrap{display:flex;gap:6px;align-items:center;justify-content:flex-start;}
  .wb-opselect{
    width: calc(var(--wb-op-w) - 14px);
    max-width: calc(var(--wb-op-w) - 14px);
    background:#fff;border-radius:10px;border:1px solid var(--border-soft);
    padding:4px 8px;color:var(--text-main);font-size:.72rem;
  }
  .wb-opbtn{
    border:1px solid rgba(11,18,32,.16);
    background:#fff;
    color:var(--text-soft);
    border-radius:10px;
    padding:3px 8px;
    cursor:pointer;
    font-size:.72rem;
  }
  .wb-opbtn:hover{ background:rgba(11,18,32,.03); }

  .wb-alert{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-top:8px;}
  .wb-alert .badge{font-size:.72rem;padding:4px 10px;}
  .wb-badge-title{font-size:.72rem;color:var(--text-soft);font-weight:900;}
  .wb-mini{font-size:.7rem;color:var(--text-muted);line-height:1.25;margin-top:6px;}
  .wb-sumline{
    display:flex;justify-content:flex-end;gap:10px;align-items:center;
    margin-top:6px;font-size:.72rem;color:var(--text-soft);
    font-weight:800;
  }

  /* ✅ WB STICKY COLUMNS */
  #wbTable{ border-collapse:separate; border-spacing:0; }
  #wbTable th, #wbTable td{ position:relative; }

  #wbTable th:nth-child(1), #wbTable td:nth-child(1){ width:var(--wb-on-w); min-width:var(--wb-on-w); }
  #wbTable th:nth-child(2), #wbTable td:nth-child(2){ width:var(--wb-op-w); min-width:var(--wb-op-w); }

  #wbTable th:nth-child(1), #wbTable td:nth-child(1){
    position:sticky; left:0;
    z-index:30;
    background:#fff;
  }
  #wbTable th:nth-child(2), #wbTable td:nth-child(2){
    position:sticky; left:var(--wb-on-w);
    z-index:30;
    background:#fff;
  }
  #wbTable thead th:nth-child(1),
  #wbTable thead th:nth-child(2){ z-index:40; }

  @media (max-width:600px){
    .timer-display{font-size:2.2rem;}
    .btn-row-main{gap:6px;}
    .btn{font-size:.9rem;border-radius:14px;}
    canvas{height:160px;}
    th,td{font-size:.70rem;}

    :root{
      --wb-on-w:52px;
      --wb-op-w:190px;
    }
    .wb-opselect{
      width: calc(var(--wb-op-w) - 14px);
      max-width: calc(var(--wb-op-w) - 14px);
    }
  }
</style>
</head>

<body>
<div class="page">

  <div class="sticky-timer-bar">
    <div class="top-row">
      <div class="logo-circle"><div class="logo-gear" id="logoGear"></div></div>
      <div class="title-block">
        <div class="title-main">TaktLab</div>
        <div class="title-sub" data-i18n="title.subtitle">Analizador de Tiempo de Ciclo y Capacidad</div>
      </div>
      <div class="lang-switch">
        <button class="lang-btn" data-lang="en">EN</button>
        <button class="lang-btn" data-lang="es">ES</button>
      </div>
    </div>

    <div class="timer-card" id="timerCard">
      <div class="timer-display" id="display">00:00.00</div>

      <div class="split-clocks" id="splitClocks">
        <div class="split-pill t1"><span class="tag">T1</span><span class="val" id="t1Clock">00:00.00</span></div>
        <div class="split-pill t2"><span class="tag">T2</span><span class="val" id="t2Clock">00:00.00</span></div>
      </div>

      <div class="info-stack">
        <div class="info-line sample-neutral" id="sampleInfoTop">
          Sin muestras todavía para el proceso actual. Empieza a capturar vueltas.
        </div>
      </div>

      <div class="btn-row-main">
        <button class="btn btn-start" id="btnStart" data-i18n="btn.start">Iniciar</button>
        <button class="btn btn-lap" id="btnLap" data-i18n="btn.lap">VUELTA</button>
      </div>
    </div>
  </div>

  <div class="content-section">
    <!-- 1) Configuración de Medición -->
    <div class="section-card" data-accent="blue" id="secSetup">
      <div class="section-head">
        <div class="section-title" data-i18n="section.measurementSetup">Configuración de Medición</div>
        <div class="section-tools">
          <button class="btn-small btn-small-copy" id="btnCopySetup" data-i18n="btn.copySection">Copiar</button>
        </div>
      </div>

      <div class="mode-row">
        <div>
          <label for="processName" data-i18n="label.process">Proceso</label><br/>
          <input id="processName" type="text" placeholder="p. ej. Op 30" data-i18n-placeholder="label.processPlaceholder"/>
        </div>

        <div>
          <label for="mode" data-i18n="label.mode">Modo</label><br/>
          <select id="mode">
            <option value="CT" data-i18n="mode.ct">Tiempo de ciclo (CT)</option>
            <option value="MLD" data-i18n="mode.mld">Máquina y Carga/Descarga</option>
          </select>
        </div>

        <div>
          <label for="efficiency" data-i18n="label.efficiency">Eficiencia %</label><br/>
          <input id="efficiency" type="number" value="100" min="0" max="100" step="1"/>
        </div>

        <div>
          <label for="contractPcd" data-i18n="label.contractPcd">Capacidad contrato (pzs/día)</label><br/>
          <input id="contractPcd" type="number" min="0" max="99999" step="1"/>
        </div>

        <div>
          <label for="hoursPerDay" data-i18n="label.hoursPerDay">Horas / día</label><br/>
          <input id="hoursPerDay" type="number" value="8" min="0" max="24" step=".5"/>
        </div>

        <div>
          <label for="daysPerWeek" data-i18n="label.daysPerWeek">Días / semana</label><br/>
          <input id="daysPerWeek" type="number" value="5" min="1" max="7"/>
        </div>

        <div>
          <label for="capView" data-i18n="label.capView">Vista de capacidad</label><br/>
          <select id="capView">
            <option value="hour" data-i18n="capView.hour">por hora</option>
            <option value="day" data-i18n="capView.day">por día</option>
            <option value="week" data-i18n="capView.week">por semana</option>
          </select>
        </div>
      </div>
    </div>
<!-- =======================
     PARTE 2 de 4
     (continúa tal cual del código)
======================= -->

  <div class="content-section">
    <!-- 1) Configuración de Medición -->
    <div class="section-card" data-accent="blue" id="secSetup">
      <div class="section-head">
        <div class="section-title" data-i18n="section.measurementSetup">Configuración de Medición</div>
        <div class="section-tools">
          <button class="btn-small btn-small-copy" id="btnCopySetup" data-i18n="btn.copySection">Copiar</button>
        </div>
      </div>

      <div class="mode-row">
        <div>
          <label for="processName" data-i18n="label.process">Proceso</label><br/>
          <input id="processName" type="text" placeholder="p. ej. Op 30" data-i18n-placeholder="label.processPlaceholder"/>
        </div>

        <div>
          <label for="mode" data-i18n="label.mode">Modo</label><br/>
          <select id="mode">
            <option value="CT" data-i18n="mode.ct">Tiempo de ciclo (CT)</option>
            <option value="MLD" data-i18n="mode.mld">Máquina y Carga/Descarga</option>
          </select>
        </div>

        <div>
          <label for="efficiency" data-i18n="label.efficiency">Eficiencia %</label><br/>
          <input id="efficiency" type="number" value="100" min="0" max="100" step="1"/>
        </div>

        <div>
          <label for="contractPcd" data-i18n="label.contractPcd">Capacidad contrato (pzs/día)</label><br/>
          <input id="contractPcd" type="number" min="0" max="99999" step="1"/>
        </div>

        <div>
          <label for="hoursPerDay" data-i18n="label.hoursPerDay">Horas / día</label><br/>
          <input id="hoursPerDay" type="number" value="8" min="0" max="24" step=".5"/>
        </div>

        <div>
          <label for="daysPerWeek" data-i18n="label.daysPerWeek">Días / semana</label><br/>
          <input id="daysPerWeek" type="number" value="5" min="1" max="7"/>
        </div>

        <div>
          <label for="capView" data-i18n="label.capView">Vista de capacidad</label><br/>
          <select id="capView">
            <option value="hour" data-i18n="capView.hour">por hora</option>
            <option value="day" data-i18n="capView.day">por día</option>
            <option value="week" data-i18n="capView.week">por semana</option>
          </select>
        </div>
      </div>
    </div>

    <!-- 2) Controles de Datos (movido debajo del Setup) -->
    <div class="section-card" data-accent="red" id="secControls">
      <div class="section-head">
        <div class="section-title" data-i18n="section.dataControls">Controles de Datos</div>
        <div class="section-tools">
          <button class="btn-small btn-small-copy" id="btnCopyControls" data-i18n="btn.copySection">Copiar</button>
        </div>
      </div>

      <div class="btn-row-secondary">
        <button class="btn-small btn-small-copy" id="btnCopyAll" data-i18n="btn.copyAll">Copiar todo</button>
        <button class="btn-small btn-small-summary" id="btnCopySummary" data-i18n="btn.copySummary">Copiar resumen</button>
        <button class="btn-small btn-small-manual" id="btnAddManualLap" data-i18n="btn.addManualLap">Agregar vuelta manual</button>
        <button class="btn-small btn-small-reset" id="btnReset" data-i18n="btn.reset">Reiniciar</button>
      </div>
    </div>

    <!-- 3) Contract vs Capacity Summary -->
    <div class="section-card" data-accent="green" id="secContract">
      <div class="section-head">
        <div class="section-title" data-i18n="section.contractSummary">Resumen Contrato vs Capacidad</div>
        <div class="section-tools">
          <button class="btn-small btn-small-copy" id="btnCopyContract" data-i18n="btn.copySection">Copiar</button>
        </div>
      </div>

      <div class="info-stack" style="margin-top:4px;">
        <div class="info-line sample-neutral" id="contractSumLine1">—</div>
        <div class="info-line sample-neutral" id="contractSumLine2">—</div>
        <div class="info-line sample-neutral" id="contractSumLine3">—</div>
        <div class="info-line sample-neutral" id="contractSumLine4">—</div>
      </div>

      <div style="font-size:.68rem;color:var(--text-muted);margin:6px 0 0;">
        <span data-i18n="contract.note">Usa el proceso actual + tus vueltas (Mediana/P10/P90) con los supuestos del Setup.</span>
      </div>
    </div>

    <!-- 4) Stat Focus -->
    <div class="section-card" data-accent="amber" id="secFocus">
      <div class="section-head">
        <div class="section-title" data-i18n="section.statsFocus">Enfoque Estadístico</div>
        <div class="section-tools">
          <button class="btn-small btn-small-copy" id="btnCopyFocus" data-i18n="btn.copySection">Copiar</button>
        </div>
      </div>

      <div class="info-stack" style="margin-top:4px;">
        <div class="info-line sample-neutral" id="sampleInfoFocus">Tamaño de muestra: —</div>
        <div class="info-line sample-neutral" id="stdInfoFocus">Desv est: —</div>
        <div class="info-line sample-neutral" id="distInfoFocus">Media vs Mediana: —</div>
        <div class="info-line sample-neutral" id="contractInfoFocus">Sin contrato cargado</div>
      </div>

      <div style="font-size:.68rem;color:var(--text-muted);margin:6px 0 6px;">
        <span data-i18n="stats.note">Lenguaje simple a propósito: pocas/suficientes muestras, baja/alta variación, capaz/no capaz.</span>
      </div>

      <div style="max-height:300px;overflow:auto;">
        <table>
          <thead>
            <tr>
              <th data-i18n="col.process">Proceso</th>
              <th data-i18n="col.mode">Modo</th>
              <th>N</th>
              <th data-i18n="col.sample">Tamaño muestra / Error</th>
              <th>Std</th>
              <th>CV%</th>
              <th>CTmed</th>
              <th>P10</th>
              <th>P90</th>
              <th data-i18n="col.capCurrent">Actual @Eff</th>
              <th data-i18n="col.capPotential">Potencial @Eff</th>
              <th data-i18n="col.capWorst">Peor @Eff</th>
              <th data-i18n="col.contract">Contrato</th>
              <th data-i18n="col.gap">Gap</th>
              <th data-i18n="col.vsContract">% vs</th>
              <th>Cp</th>
              <th>Cpk</th>
              <th data-i18n="col.note">Nota</th>
            </tr>
          </thead>
          <tbody id="focusBody"></tbody>
        </table>
      </div>

      <div class="subsection-title" data-i18n="section.wbPlanner">WB – Planeador de Capacidad (por proceso)</div>

      <div class="btn-row-secondary" style="margin-top:8px;">
        <button class="btn-small btn-small-wbadd" id="btnWbAdd" data-i18n="btn.wbAdd">+ Agregar operación</button>
        <button class="btn-small btn-small-wbclear" id="btnWbClear" data-i18n="btn.wbClear">Borrar WB</button>
        <button class="btn-small btn-small-copy" id="btnCopyWB" data-i18n="btn.copyWB">Copiar WB</button>
      </div>

      <div style="max-height:320px;overflow:auto;">
        <table id="wbTable">
          <thead>
            <tr>
              <th data-i18n="wb.enabled">On</th>
              <th data-i18n="wb.operation">Operación</th>
              <th data-i18n="wb.operators">Operadores</th>
              <th data-i18n="wb.shifts">Turnos</th>
              <th data-i18n="wb.hours">Horas</th>
              <th data-i18n="wb.machines"># Máquinas</th>
              <th data-i18n="wb.pcsPerOp">Pzs/Op</th>
              <th data-i18n="wb.contract">Contrato (pzs/día)</th>

              <th data-i18n="wb.gross">Min brutos/día</th>
              <th data-i18n="wb.lunch">Comida min/día</th>
              <th data-i18n="wb.changeover">Changeover</th>
              <th data-i18n="wb.cleaning">5S/Limpieza</th>
              <th data-i18n="wb.maint">Mtto</th>
              <th data-i18n="wb.other">Otros</th>

              <th data-i18n="wb.shared">Capacidad compartida</th>

              <th data-i18n="wb.udt">DT no planeado (min/día)</th>

              <th data-i18n="wb.net">Min netos/día</th>

              <th data-i18n="wb.scrap">Scrap %</th>
              <th data-i18n="wb.yield">Yield</th>

              <th data-i18n="wb.oeeA">A%</th>
              <th data-i18n="wb.oeeP">P%</th>
              <th data-i18n="wb.oeeQ">Q%</th>
              <th data-i18n="wb.oee">OEE%</th>

              <th data-i18n="wb.ctCur">CT Actual</th>
              <th data-i18n="wb.ctWst">CT Peor</th>
              <th data-i18n="wb.ctPot">CT Potencial</th>

              <th data-i18n="wb.ctCurOee">CT@OEE (Act)</th>

              <th data-i18n="wb.cap100">Cap 100% (Act)</th>
              <th data-i18n="wb.capOee">Cap@OEE (Act)</th>

              <th data-i18n="wb.vsContract">% vs contrato</th>
              <th data-i18n="wb.inputReq">Entrada req. p/Contrato</th>

              <th data-i18n="wb.actions">Acciones</th>
            </tr>
          </thead>
          <tbody id="wbBody"></tbody>
        </table>
      </div>

      <div class="wb-sumline">
        <span data-i18n="wb.opsSum">Operadores total:</span>
        <span class="badge badge-warn" id="wbOperatorsSum">0</span>
      </div>

      <div class="wb-alert">
        <span class="wb-badge-title" data-i18n="wb.constraintTitle">Restricción / Siguiente:</span>
        <span class="badge badge-bad" id="wbConstraint">—</span>
        <span class="badge badge-warn" id="wbNextConstraint">—</span>
      </div>
      <div class="wb-mini" id="wbConstraintNote"></div>

      <div class="subsection-title" data-i18n="section.statsDetail">Detalle Estadístico (por proceso)</div>
      <div style="max-height:240px;overflow:auto;">
        <table id="statsTable">
          <thead>
            <tr>
              <th data-i18n="col.process">Proceso</th>
              <th data-i18n="col.mode">Modo</th>
              <th data-i18n="col.n">N</th>
              <th>Mean</th>
              <th>Median</th>
              <th>P10</th>
              <th>P90</th>
              <th>Min</th>
              <th>Max</th>
              <th>Std</th>
              <th>CV%</th>
              <th>Cp</th>
              <th>Cpk</th>
            </tr>
          </thead>
          <tbody id="statsBody"></tbody>
        </table>
      </div>
    </div>
<!-- =======================
     PARTE 3 de 4
======================= -->

    <!-- 5) Datos crudos de tiempo -->
    <div class="section-card" data-accent="blue" id="secRaw">
      <div class="section-head">
        <div class="section-title" data-i18n="section.rawData">Datos Crudos de Tiempo</div>
        <div class="section-tools">
          <button class="btn-small btn-small-copy" id="btnCopyRaw" data-i18n="btn.copySection">Copiar</button>
        </div>
      </div>

      <div class="notes">
        <div class="notes-title" data-i18n="raw.noteTitle">Método &amp; Guía</div>
        <div class="notes-body">
          <ul class="notes-list">
            <li data-i18n="raw.guide1">Captura vueltas reales. Evita “adivinar” valores. Si cambió el método (CT vs MLD), inicia un estudio nuevo.</li>
            <li data-i18n="raw.guide2">Si hay paros o eventos fuera de lo normal, registra ese lap aparte y explica en “Notas”.</li>
            <li data-i18n="raw.guide3">Entre más variación tengas, más muestras necesitas para confiar en el resultado.</li>
          </ul>
        </div>
      </div>

      <div class="muted" style="font-size:.72rem;margin-top:4px;">
        <span data-i18n="raw.columnsHint">Columnas: #, tiempo(s), tipo, timestamp, notas.</span>
      </div>

      <div style="max-height:260px; overflow:auto; margin-top:8px;">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th data-i18n="col.timeSec">Tiempo (s)</th>
              <th data-i18n="col.kind">Tipo</th>
              <th data-i18n="col.timestamp">Timestamp</th>
              <th data-i18n="col.notes">Notas</th>
            </tr>
          </thead>
          <tbody id="rawBody"></tbody>
        </table>
      </div>
    </div>

    <!-- 6) Resumen / Export -->
    <div class="section-card" data-accent="amber" id="secExport">
      <div class="section-head">
        <div class="section-title" data-i18n="section.export">Resumen &amp; Export</div>
        <div class="section-tools">
          <button class="btn-small btn-small-copy" id="btnCopyExport" data-i18n="btn.copySection">Copiar</button>
        </div>
      </div>

      <div class="notes">
        <div class="notes-title" data-i18n="export.noteTitle">Método &amp; Guía</div>
        <div class="notes-body">
          <ul class="notes-list">
            <li data-i18n="export.guide1">“Resumen” junta Setup + métricas + capacidad (Actual/Potencial/Peor) para enviar por Teams/Correo.</li>
            <li data-i18n="export.guide2">“Copiar todo” incluye WB si lo tienes lleno.</li>
            <li data-i18n="export.guide3">Si el contrato vs capacidad cambia, valida que horas/turnos/máquinas estén correctos.</li>
          </ul>
        </div>
      </div>

      <textarea id="exportBox" class="export-box" readonly></textarea>
    </div>

    <!-- 7) Gráficas -->
    <div class="section-card" data-accent="green" id="secCharts">
      <div class="section-head">
        <div class="section-title" data-i18n="section.charts">Gráficas</div>
        <div class="section-tools">
          <button class="btn-small btn-small-copy" id="btnCopyCharts" data-i18n="btn.copySection">Copiar</button>
        </div>
      </div>

      <div class="notes">
        <div class="notes-title" data-i18n="charts.noteTitle">Método &amp; Guía</div>
        <div class="notes-body">
          <ul class="notes-list">
            <li data-i18n="charts.guide1">Distribución: te muestra si hay “colas” o valores raros. Si hay cola larga, usa mediana y P90 para ser conservador.</li>
            <li data-i18n="charts.guide2">Serie temporal: identifica drift (se fue haciendo más lento/rápido) o eventos anómalos.</li>
            <li data-i18n="charts.guide3">Comparador: te enseña Actual vs Potencial vs Peor según tus percentiles.</li>
          </ul>
        </div>
      </div>

      <div class="chart-grid">
        <div class="chart-card">
          <div class="chart-title" data-i18n="chart.dist">Distribución</div>
          <canvas id="chartDist" width="400" height="220"></canvas>
        </div>
        <div class="chart-card">
          <div class="chart-title" data-i18n="chart.trend">Tendencia (vueltas)</div>
          <canvas id="chartTrend" width="400" height="220"></canvas>
        </div>
        <div class="chart-card">
          <div class="chart-title" data-i18n="chart.compare">Actual vs Potencial vs Peor</div>
          <canvas id="chartCompare" width="400" height="220"></canvas>
        </div>
      </div>
    </div>

    <!-- 8) Footer / Nota -->
    <div class="footer-note">
      <span data-i18n="footer.note">
        Nota: esta herramienta es para estimación rápida en piso. Si vas a tomar decisiones de inversión/capex, valida con estudio formal.
      </span>
    </div>

  </div><!-- /content-section -->

  <script>
  /* =========================
     i18n simple (ES/EN)
  ========================= */
  const I18N = {
    es:{
      "app.title":"TaktLab – Cycle Time & Capacity Analyzer",
      "top.live":"En vivo",
      "top.laps":"Vueltas",
      "top.start":"Iniciar",
      "top.pause":"Pausar",
      "top.lap":"Vuelta",
      "top.reset":"Reiniciar",
      "top.back":"Volver",
      "top.home":"Inicio",

      "section.measurementSetup":"Configuración de Medición",
      "section.dataControls":"Controles de Datos",
      "section.contractSummary":"Resumen Contrato vs Capacidad",
      "section.statsFocus":"Enfoque Estadístico",
      "section.wbPlanner":"WB – Planeador de Capacidad (por proceso)",
      "section.statsDetail":"Detalle Estadístico (por proceso)",
      "section.rawData":"Datos Crudos de Tiempo",
      "section.export":"Resumen & Export",
      "section.charts":"Gráficas",

      "btn.copySection":"Copiar",
      "btn.copyAll":"Copiar todo",
      "btn.copySummary":"Copiar resumen",
      "btn.addManualLap":"Agregar vuelta manual",
      "btn.reset":"Reiniciar",
      "btn.wbAdd":"+ Agregar operación",
      "btn.wbClear":"Borrar WB",
      "btn.copyWB":"Copiar WB",

      "label.process":"Proceso",
      "label.mode":"Modo",
      "label.efficiency":"Eficiencia %",
      "label.contractPcd":"Capacidad contrato (pzs/día)",
      "label.hoursPerDay":"Horas / día",
      "label.daysPerWeek":"Días / semana",
      "label.capView":"Vista de capacidad",
      "label.processPlaceholder":"Op / estación / máquina",

      "mode.ct":"Tiempo de ciclo (CT)",
      "mode.mld":"Máquina y Carga/Descarga",

      "capView.hour":"por hora",
      "capView.day":"por día",
      "capView.week":"por semana",

      "contract.note":"Usa el proceso actual + tus vueltas (Mediana/P10/P90) con los supuestos del Setup.",
      "stats.note":"Lenguaje simple a propósito: pocas/suficientes muestras, baja/alta variación, capaz/no capaz.",

      "col.process":"Proceso",
      "col.mode":"Modo",
      "col.n":"N",
      "col.sample":"Tamaño muestra / Error",
      "col.capCurrent":"Actual @Eff",
      "col.capPotential":"Potencial @Eff",
      "col.capWorst":"Peor @Eff",
      "col.contract":"Contrato",
      "col.gap":"Gap",
      "col.vsContract":"% vs",
      "col.note":"Nota",

      "wb.enabled":"On",
      "wb.operation":"Operación",
      "wb.operators":"Operadores",
      "wb.shifts":"Turnos",
      "wb.hours":"Horas",
      "wb.machines":"# Máquinas",
      "wb.pcsPerOp":"Pzs/Op",
      "wb.contract":"Contrato (pzs/día)",

      "wb.gross":"Min brutos/día",
      "wb.lunch":"Comida min/día",
      "wb.changeover":"Changeover",
      "wb.cleaning":"5S/Limpieza",
      "wb.maint":"Mtto",
      "wb.other":"Otros",
      "wb.shared":"Capacidad compartida",
      "wb.udt":"DT no planeado (min/día)",
      "wb.net":"Min netos/día",

      "wb.scrap":"Scrap %",
      "wb.yield":"Yield",

      "wb.oeeA":"A%",
      "wb.oeeP":"P%",
      "wb.oeeQ":"Q%",
      "wb.oee":"OEE%",

      "wb.ctCur":"CT Actual",
      "wb.ctWst":"CT Peor",
      "wb.ctPot":"CT Potencial",
      "wb.ctCurOee":"CT@OEE (Act)",

      "wb.cap100":"Cap 100% (Act)",
      "wb.capOee":"Cap@OEE (Act)",

      "wb.vsContract":"% vs contrato",
      "wb.inputReq":"Entrada req. p/Contrato",
      "wb.actions":"Acciones",

      "wb.opsSum":"Operadores total:",
      "wb.constraintTitle":"Restricción / Siguiente:",

      "raw.noteTitle":"Método & Guía",
      "raw.guide1":"Captura vueltas reales. Evita “adivinar” valores. Si cambió el método (CT vs MLD), inicia un estudio nuevo.",
      "raw.guide2":"Si hay paros o eventos fuera de lo normal, registra ese lap aparte y explica en “Notas”.",
      "raw.guide3":"Entre más variación tengas, más muestras necesitas para confiar en el resultado.",
      "raw.columnsHint":"Columnas: #, tiempo(s), tipo, timestamp, notas.",

      "col.timeSec":"Tiempo (s)",
      "col.kind":"Tipo",
      "col.timestamp":"Timestamp",
      "col.notes":"Notas",

      "export.noteTitle":"Método & Guía",
      "export.guide1":"“Resumen” junta Setup + métricas + capacidad (Actual/Potencial/Peor) para enviar por Teams/Correo.",
      "export.guide2":"“Copiar todo” incluye WB si lo tienes lleno.",
      "export.guide3":"Si el contrato vs capacidad cambia, valida que horas/turnos/máquinas estén correctos.",

      "chart.dist":"Distribución",
      "chart.trend":"Tendencia (vueltas)",
      "chart.compare":"Actual vs Potencial vs Peor",

      "charts.noteTitle":"Método & Guía",
      "charts.guide1":"Distribución: te muestra si hay “colas” o valores raros. Si hay cola larga, usa mediana y P90 para ser conservador.",
      "charts.guide2":"Serie temporal: identifica drift (se fue haciendo más lento/rápido) o eventos anómalos.",
      "charts.guide3":"Comparador: te enseña Actual vs Potencial vs Peor según tus percentiles.",

      "footer.note":"Nota: esta herramienta es para estimación rápida en piso. Si vas a tomar decisiones de inversión/capex, valida con estudio formal."
    },

    en:{
      "app.title":"TaktLab – Cycle Time & Capacity Analyzer",
      "top.live":"Live",
      "top.laps":"Laps",
      "top.start":"Start",
      "top.pause":"Pause",
      "top.lap":"Lap",
      "top.reset":"Reset",
      "top.back":"Back",
      "top.home":"Home",

      "section.measurementSetup":"Measurement Setup",
      "section.dataControls":"Data Controls",
      "section.contractSummary":"Contract vs Capacity Summary",
      "section.statsFocus":"Stat Focus",
      "section.wbPlanner":"WB – Capacity Planner (per process)",
      "section.statsDetail":"Stat Detail (per process)",
      "section.rawData":"Raw Time Data",
      "section.export":"Summary & Export",
      "section.charts":"Charts",

      "btn.copySection":"Copy",
      "btn.copyAll":"Copy all",
      "btn.copySummary":"Copy summary",
      "btn.addManualLap":"Add manual lap",
      "btn.reset":"Reset",
      "btn.wbAdd":"+ Add operation",
      "btn.wbClear":"Clear WB",
      "btn.copyWB":"Copy WB",

      "label.process":"Process",
      "label.mode":"Mode",
      "label.efficiency":"Efficiency %",
      "label.contractPcd":"Contract capacity (pcs/day)",
      "label.hoursPerDay":"Hours / day",
      "label.daysPerWeek":"Days / week",
      "label.capView":"Capacity view",
      "label.processPlaceholder":"Op / station / machine",

      "mode.ct":"Cycle time (CT)",
      "mode.mld":"Machine & Load/Unload",

      "capView.hour":"per hour",
      "capView.day":"per day",
      "capView.week":"per week",

      "contract.note":"Uses current process + your laps (Median/P10/P90) with Setup assumptions.",
      "stats.note":"Plain language on purpose: few/enough samples, low/high variation, capable/not capable.",

      "col.process":"Process",
      "col.mode":"Mode",
      "col.n":"N",
      "col.sample":"Sample / Error",
      "col.capCurrent":"Current @Eff",
      "col.capPotential":"Potential @Eff",
      "col.capWorst":"Worst @Eff",
      "col.contract":"Contract",
      "col.gap":"Gap",
      "col.vsContract":"% vs",
      "col.note":"Note",

      "wb.enabled":"On",
      "wb.operation":"Operation",
      "wb.operators":"Operators",
      "wb.shifts":"Shifts",
      "wb.hours":"Hours",
      "wb.machines":"# Machines",
      "wb.pcsPerOp":"Pcs/Op",
      "wb.contract":"Contract (pcs/day)",

      "wb.gross":"Gross min/day",
      "wb.lunch":"Lunch min/day",
      "wb.changeover":"Changeover",
      "wb.cleaning":"5S/Cleaning",
      "wb.maint":"Maintenance",
      "wb.other":"Other",
      "wb.shared":"Shared capacity",
      "wb.udt":"Unplanned DT (min/day)",
      "wb.net":"Net min/day",

      "wb.scrap":"Scrap %",
      "wb.yield":"Yield",

      "wb.oeeA":"A%",
      "wb.oeeP":"P%",
      "wb.oeeQ":"Q%",
      "wb.oee":"OEE%",

      "wb.ctCur":"CT Current",
      "wb.ctWst":"CT Worst",
      "wb.ctPot":"CT Potential",
      "wb.ctCurOee":"CT@OEE (Cur)",

      "wb.cap100":"Cap 100% (Cur)",
      "wb.capOee":"Cap@OEE (Cur)",

      "wb.vsContract":"% vs contract",
      "wb.inputReq":"Input req. for Contract",
      "wb.actions":"Actions",

      "wb.opsSum":"Total operators:",
      "wb.constraintTitle":"Constraint / Next:",

      "raw.noteTitle":"Method & Guide",
      "raw.guide1":"Capture real laps. Avoid guessing. If method changed (CT vs MLD), start a new study.",
      "raw.guide2":"If abnormal stops/events occur, record that lap separately and explain it in Notes.",
      "raw.guide3":"The more variation, the more samples you need to trust the result.",
      "raw.columnsHint":"Columns: #, time(s), kind, timestamp, notes.",

      "col.timeSec":"Time (s)",
      "col.kind":"Kind",
      "col.timestamp":"Timestamp",
      "col.notes":"Notes",

      "export.noteTitle":"Method & Guide",
      "export.guide1":"“Summary” bundles Setup + metrics + capacity (Current/Potential/Worst) for Teams/Email.",
      "export.guide2":"“Copy all” includes WB if filled.",
      "export.guide3":"If contract vs capacity changes, verify hours/shifts/machines are correct.",

      "chart.dist":"Distribution",
      "chart.trend":"Trend (laps)",
      "chart.compare":"Current vs Potential vs Worst",

      "charts.noteTitle":"Method & Guide",
      "charts.guide1":"Distribution shows tails/outliers. If long tail, use median and P90 to be conservative.",
      "charts.guide2":"Time series identifies drift (slower/faster) or anomalies.",
      "charts.guide3":"Comparator shows Current vs Potential vs Worst using your percentiles.",

      "footer.note":"Note: floor-level quick estimator. For capex decisions, validate with a formal study."
    }
  };

  let LANG = "es";

  function applyI18n(){
    document.querySelectorAll("[data-i18n]").forEach(el=>{
      const k = el.getAttribute("data-i18n");
      if(I18N[LANG] && I18N[LANG][k]) el.textContent = I18N[LANG][k];
    });
    document.querySelectorAll("[data-i18n-placeholder]").forEach(el=>{
      const k = el.getAttribute("data-i18n-placeholder");
      if(I18N[LANG] && I18N[LANG][k]) el.setAttribute("placeholder", I18N[LANG][k]);
    });
    // title
    document.title = I18N[LANG]["app.title"];
  }

  /* =========================
     Utilidades
  ========================= */
  const $ = (id)=>document.getElementById(id);

  function clamp(n,min,max){ return Math.min(max, Math.max(min, n)); }

  function mean(arr){
    if(!arr.length) return 0;
    return arr.reduce((a,b)=>a+b,0)/arr.length;
  }
  function median(arr){
    if(!arr.length) return 0;
    const a=[...arr].sort((x,y)=>x-y);
    const m=Math.floor(a.length/2);
    return (a.length%2)? a[m] : (a[m-1]+a[m])/2;
  }
  function percentile(arr,p){
    if(!arr.length) return 0;
    const a=[...arr].sort((x,y)=>x-y);
    const idx=(a.length-1)*p;
    const lo=Math.floor(idx), hi=Math.ceil(idx);
    if(lo===hi) return a[lo];
    return a[lo] + (a[hi]-a[lo])*(idx-lo);
  }
  function stddev(arr){
    if(arr.length<2) return 0;
    const m=mean(arr);
    const v=arr.reduce((s,x)=>s+(x-m)*(x-m),0)/(arr.length-1);
    return Math.sqrt(v);
  }

  function fmt(n,dec=2){
    if(!isFinite(n)) return "—";
    return Number(n).toLocaleString(undefined,{minimumFractionDigits:dec, maximumFractionDigits:dec});
  }

  function nowStamp(){
    const d=new Date();
    return d.toLocaleString();
  }

  function setPulse(btn, ms){
    btn.classList.add("pulse");
    setTimeout(()=>btn.classList.remove("pulse"), ms);
  }
  </script>

  <!-- (La lógica principal continúa en PARTE 4) -->

</body>
</html>
<!-- =======================
     PARTE 4 de 4
======================= -->

<script>
/* =========================
   Timer / Laps
========================= */
let running=false;
let t0=0;
let elapsed=0;
let raf=null;

const laps=[]; // {t:number, kind:'lap'|'manual', ts:string, note:string}

function renderTimer(){
  const ms = elapsed + (running ? (performance.now()-t0) : 0);
  const s = ms/1000;
  $("liveTimer").textContent = fmt(s,2);
  raf = requestAnimationFrame(renderTimer);
}

function addLap(seconds, kind="lap", note=""){
  const t = Number(seconds);
  if(!isFinite(t) || t<=0) return;
  laps.push({t, kind, ts: nowStamp(), note});
  updateAll();
}

function resetAll(){
  running=false;
  elapsed=0;
  t0=0;
  if(raf){ cancelAnimationFrame(raf); raf=null; }
  $("liveTimer").textContent = "0.00";
  laps.length=0;

  // no borrar WB por default; solo si el usuario usa "Borrar WB"
  updateAll();
}

$("btnStart").addEventListener("click", ()=>{
  if(running) return;
  running=true;
  t0=performance.now();
  if(!raf) raf=requestAnimationFrame(renderTimer);

  // retardo corto (1s)
  setPulse($("btnStart"), 1000);
});

$("btnPause").addEventListener("click", ()=>{
  if(!running) return;
  const ms = performance.now()-t0;
  elapsed += ms;
  running=false;

  // 6 segundos en botones (excepto Inicio/Volver según tu regla)
  setPulse($("btnPause"), 6000);
});

$("btnLap").addEventListener("click", ()=>{
  if(!running) return;
  const ms = elapsed + (performance.now()-t0);
  const s = ms/1000;
  // lap = delta desde último lap o desde 0
  const prevSum = laps.reduce((a,b)=>a+b.t,0);
  const delta = s - prevSum;
  if(delta>0.01) addLap(delta,"lap","");
  // 6 segundos
  setPulse($("btnLap"), 6000);
});

$("btnReset").addEventListener("click", ()=>{
  resetAll();
  // 6 segundos
  setPulse($("btnReset"), 6000);
});

// Back/Home: solo 1s (tú lo pediste)
$("btnBack").addEventListener("click", ()=> setPulse($("btnBack"), 1000));
$("btnHome").addEventListener("click", ()=> setPulse($("btnHome"), 1000));

/* =========================
   Manual lap
========================= */
$("btnAddManualLap").addEventListener("click", ()=>{
  const v = Number(($("manualLapSec").value||"").trim());
  const note = ($("manualLapNote").value||"").trim();
  if(isFinite(v) && v>0){
    addLap(v,"manual",note);
    $("manualLapSec").value="";
    $("manualLapNote").value="";
  }
  setPulse($("btnAddManualLap"), 6000);
});

/* =========================
   Setup inputs helpers
========================= */
function getSetup(){
  const mode = $("modeSel").value; // "ct" or "mld"
  const eff = clamp(Number($("effPct").value||85),0,100)/100;
  const contract = clamp(Number($("contractPcd").value||0),0,999999999);
  const hours = clamp(Number($("hoursPerDay").value||0),0,24);
  const days = clamp(Number($("daysPerWeek").value||0),0,7);
  const capView = $("capViewSel").value; // hour/day/week
  const processName = ($("processName").value||"").trim();

  return {mode, eff, contract, hours, days, capView, processName};
}

function sampleErrorPct(n){
  // Aproximación simple de error de muestra (95%), útil para tu texto.
  // Si quieres ±3% real estadístico, hay que definir población/variación.
  if(n<=1) return null;
  const base = 1/Math.sqrt(n);
  return base*1.96*100; // %
}

function sampleMessage(n, err){
  if(n<=0) return "—";
  if(!err) return `Samples: ${n}`;
  // guía simple para tu display estilo:
  // "Samples: 11 / 94 · Est. error: ±8.8% (95%) – Sample too small for ±3% – use only as reference."
  const ok = err<=3;
  let msg = `Samples: ${n} · Est. error: ±${fmt(err,1)}% (95%)`;
  if(!ok) msg += ` – Sample too small for ±3% – use only as reference.`;
  else msg += ` – Good enough for ±3% target.`;
  return msg;
}

/* =========================
   Capacity calculations
========================= */
function capacityFromCT(ctSec, setup, minutesNetPerDay=null){
  // ctSec: seconds per piece
  // returns pph, ppd, ppw based on hours/days and minutesNetPerDay if provided (WB)
  if(ctSec<=0) return {pph:0, ppd:0, ppw:0};

  const eff = setup.eff;
  const piecesPerHour = (3600/ctSec) * eff;

  const ppd = piecesPerHour * setup.hours;
  const ppw = ppd * setup.days;

  // If minutesNetPerDay passed (WB), override day/week using net minutes, not scheduled hours:
  if(minutesNetPerDay!==null && isFinite(minutesNetPerDay)){
    const hoursNet = minutesNetPerDay/60;
    const ppd2 = piecesPerHour * hoursNet;
    const ppw2 = ppd2 * setup.days; // still days/week for weekly
    return {pph:piecesPerHour, ppd:ppd2, ppw:ppw2};
  }

  return {pph:piecesPerHour, ppd, ppw};
}

function capPick(cap, view){
  if(view==="hour") return cap.pph;
  if(view==="week") return cap.ppw;
  return cap.ppd;
}

function niceCapLabel(view){
  if(view==="hour") return "pzs/hr";
  if(view==="week") return "pzs/sem";
  return "pzs/día";
}

/* =========================
   WB (Workbench) planner
========================= */
let wbRows = []; // each row object

const makeOptions = (min, max, step)=>{
  const arr=[];
  for(let v=min; v<=max+1e-9; v+=step) arr.push(Number(v.toFixed(10)));
  return arr;
};

// dropdown ranges requested:
const OPT = {
  operators: makeOptions(0,10,1),
  shifts: makeOptions(1,4,1),
  hours: makeOptions(0,24,0.5),
  machines: makeOptions(1,50,1),
  pcsPerOp: makeOptions(1,99,1),

  lunch: makeOptions(0,1440,5),
  changeover: makeOptions(1,1440,1),
  s5: makeOptions(0,1440,5),
  maint: makeOptions(1,1440,1),
  other: makeOptions(0,1440,5),
  shared: makeOptions(0,1440,5),
  udt: makeOptions(0,1440,5),

  scrap: makeOptions(0,100,1),
  oee: makeOptions(0,100,1)
};

function selHTML(options, value){
  return options.map(v=>{
    const sel = (Number(value)===Number(v))?"selected":"";
    return `<option value="${v}" ${sel}>${v}</option>`;
  }).join("");
}

function addWBRow(){
  wbRows.push({
    enabled:true,
    op:"Op "+(wbRows.length+1),
    operators:1,
    shifts:1,
    hours:8,
    machines:1,
    pcsPerOp:1,
    contract:0,

    grossMin:null, // derived
    lunch:0,
    changeover:0,
    s5:0,
    maint:0,
    other:0,
    shared:0,
    udt:0,
    netMin:null, // derived

    scrap:0,
    yield:100,

    A:90, P:90, Q:99,
    oee:null,

    ctCur:0, ctWst:0, ctPot:0,
    ctCurOee:0,

    cap100:0,
    capOee:0,
    vsContract:0,
    inputReq:0
  });
  renderWB();
  updateAll();
}

function clearWB(){
  wbRows=[];
  renderWB();
  updateAll();
}

$("btnWBAdd").addEventListener("click", ()=>{
  addWBRow();
  setPulse($("btnWBAdd"), 6000);
});
$("btnWBClear").addEventListener("click", ()=>{
  clearWB();
  setPulse($("btnWBClear"), 6000);
});

function computeWBRow(r){
  // gross minutes = shifts * hours * 60
  const gross = r.shifts * r.hours * 60;

  // net = gross - downtimes - shared - udt
  const net = Math.max(0, gross - r.lunch - r.changeover - r.s5 - r.maint - r.other - r.shared - r.udt);

  r.grossMin = gross;
  r.netMin = net;

  // yield from scrap
  r.yield = clamp(100 - r.scrap, 0, 100);

  // oee
  const A = clamp(r.A,0,100)/100;
  const P = clamp(r.P,0,100)/100;
  const Q = clamp(r.Q,0,100)/100;
  r.oee = (A*P*Q)*100;

  // CT@OEE (Actual)
  r.ctCurOee = r.ctCur>0 ? (r.ctCur / (A*P*Q || 1)) : 0;

  // capacities:
  // Cap 100% (Act): net minutes / (CT seconds/60) * machines * operators * pcsPerOp
  const pcsFactor = r.machines * Math.max(1, r.operators) * Math.max(1, r.pcsPerOp);

  const cap100 = (r.ctCur>0) ? (net / (r.ctCur/60)) * pcsFactor : 0;
  r.cap100 = cap100;

  const capOee = (r.ctCurOee>0) ? (net / (r.ctCurOee/60)) * pcsFactor : 0;
  r.capOee = capOee;

  // vs contract
  r.vsContract = (r.contract>0) ? (capOee / r.contract)*100 : 0;

  // input required for contract (piezas que debe "alimentar" o piezas/operación)
  // simple: contract / (capOee at pcsPerOp=1?) -> ajusta a pcs/op
  r.inputReq = (r.pcsPerOp>0) ? (r.contract / r.pcsPerOp) : 0;

  return r;
}

function renderWB(){
  const tb = $("wbBody");
  if(!tb) return;
  tb.innerHTML = "";

  wbRows.forEach((r,idx)=>{
    computeWBRow(r);
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td><input type="checkbox" ${r.enabled?"checked":""} data-wb="enabled" data-idx="${idx}"></td>

      <td><input class="input" value="${r.op}" data-wb="op" data-idx="${idx}" /></td>

      <td><select class="select" data-wb="operators" data-idx="${idx}">${selHTML(OPT.operators,r.operators)}</select></td>
      <td><select class="select" data-wb="shifts" data-idx="${idx}">${selHTML(OPT.shifts,r.shifts)}</select></td>
      <td><select class="select" data-wb="hours" data-idx="${idx}">${selHTML(OPT.hours,r.hours)}</select></td>
      <td><select class="select" data-wb="machines" data-idx="${idx}">${selHTML(OPT.machines,r.machines)}</select></td>
      <td><select class="select" data-wb="pcsPerOp" data-idx="${idx}">${selHTML(OPT.pcsPerOp,r.pcsPerOp)}</select></td>

      <td><input class="input" type="number" min="0" value="${r.contract}" data-wb="contract" data-idx="${idx}"></td>

      <td>${fmt(r.grossMin,0)}</td>

      <td><select class="select" data-wb="lunch" data-idx="${idx}">${selHTML(OPT.lunch,r.lunch)}</select></td>
      <td><input class="input" type="number" min="0" max="1440" value="${r.changeover}" data-wb="changeover" data-idx="${idx}"></td>
      <td><select class="select" data-wb="s5" data-idx="${idx}">${selHTML(OPT.s5,r.s5)}</select></td>
      <td><input class="input" type="number" min="0" max="1440" value="${r.maint}" data-wb="maint" data-idx="${idx}"></td>
      <td><select class="select" data-wb="other" data-idx="${idx}">${selHTML(OPT.other,r.other)}</select></td>
      <td><select class="select" data-wb="shared" data-idx="${idx}">${selHTML(OPT.shared,r.shared)}</select></td>
      <td><select class="select" data-wb="udt" data-idx="${idx}">${selHTML(OPT.udt,r.udt)}</select></td>

      <td>${fmt(r.netMin,0)}</td>

      <td><select class="select" data-wb="scrap" data-idx="${idx}">${selHTML(OPT.scrap,r.scrap)}</select></td>
      <td>${fmt(r.yield,0)}%</td>

      <td><select class="select" data-wb="A" data-idx="${idx}">${selHTML(OPT.oee,r.A)}</select></td>
      <td><select class="select" data-wb="P" data-idx="${idx}">${selHTML(OPT.oee,r.P)}</select></td>
      <td><select class="select" data-wb="Q" data-idx="${idx}">${selHTML(OPT.oee,r.Q)}</select></td>
      <td>${fmt(r.oee,1)}%</td>

      <td><input class="input" type="number" min="0" value="${r.ctCur}" data-wb="ctCur" data-idx="${idx}"></td>
      <td><input class="input" type="number" min="0" value="${r.ctWst}" data-wb="ctWst" data-idx="${idx}"></td>
      <td><input class="input" type="number" min="0" value="${r.ctPot}" data-wb="ctPot" data-idx="${idx}"></td>
      <td>${fmt(r.ctCurOee,2)}</td>

      <td>${fmt(r.cap100,0)}</td>
      <td>${fmt(r.capOee,0)}</td>

      <td>${fmt(r.vsContract,1)}%</td>
      <td>${fmt(r.inputReq,0)}</td>

      <td class="right">
        <button class="btn-small btn-small-danger" data-wb="del" data-idx="${idx}">X</button>
      </td>
    `;

    tb.appendChild(tr);
  });

  // events
  tb.querySelectorAll("[data-wb]").forEach(el=>{
    el.addEventListener("change", wbOnChange);
    el.addEventListener("input", wbOnChange);
    el.addEventListener("click", wbOnClick);
  });

  updateWBSummary();
}

function wbOnClick(e){
  const t=e.target;
  if(t.getAttribute("data-wb")==="del"){
    const idx=Number(t.getAttribute("data-idx"));
    if(isFinite(idx)){
      wbRows.splice(idx,1);
      renderWB();
      updateAll();
    }
  }
}

function wbOnChange(e){
  const t=e.target;
  const key=t.getAttribute("data-wb");
  const idx=Number(t.getAttribute("data-idx"));
  if(!isFinite(idx) || !wbRows[idx]) return;
  const row=wbRows[idx];

  if(key==="enabled"){
    row.enabled = t.checked;
  }else if(key==="op"){
    row.op = t.value;
  }else{
    // numeric-ish
    const val = (t.type==="checkbox") ? t.checked : Number(t.value);
    if(key in row) row[key] = isFinite(val) ? val : t.value;
  }
  computeWBRow(row);
  updateAll();
  renderWB(); // refresh derived values / tighten layout
}

function updateWBSummary(){
  const enabled = wbRows.filter(r=>r.enabled);
  const totalOps = enabled.reduce((s,r)=>s+Math.max(0,Number(r.operators)||0),0);
  $("wbOpsSum").textContent = `${I18N[LANG]["wb.opsSum"]} ${totalOps}`;

  // constraint = lowest % vs contract among enabled rows with contract>0
  let worst=null;
  enabled.forEach(r=>{
    if(r.contract>0){
      const pct = r.vsContract;
      if(worst===null || pct<worst.pct) worst={op:r.op,pct};
    }
  });
  $("wbConstraint").textContent = worst ? `${I18N[LANG]["wb.constraintTitle"]} ${worst.op} (${fmt(worst.pct,1)}%)` : `${I18N[LANG]["wb.constraintTitle"]} —`;
}

/* =========================
   Contract vs Capacity Summary
========================= */
function updateContractSummary(){
  const setup=getSetup();
  const times = laps.map(x=>x.t);

  const n = times.length;
  const err = sampleErrorPct(n);
  const msg = sampleMessage(n, err);

  // compute percentiles
  const med = median(times);
  const p10 = percentile(times,0.10);
  const p90 = percentile(times,0.90);

  // capacity (without WB net minutes)
  const capCur = capacityFromCT(med, setup);
  const capPot = capacityFromCT(p10, setup);
  const capWst = capacityFromCT(p90, setup);

  const v = setup.capView;
  const cur = capPick(capCur,v);
  const pot = capPick(capPot,v);
  const wst = capPick(capWst,v);

  const unit = niceCapLabel(v);

  // build rows in summary table
  const tb = $("sumBody");
  tb.innerHTML="";

  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td>${setup.processName || "—"}</td>
    <td>${setup.mode==="ct" ? I18N[LANG]["mode.ct"] : I18N[LANG]["mode.mld"]}</td>
    <td>${n}</td>
    <td class="muted">${msg}</td>
    <td>${fmt(cur,0)} <span class="muted">${unit}</span></td>
    <td>${fmt(pot,0)} <span class="muted">${unit}</span></td>
    <td>${fmt(wst,0)} <span class="muted">${unit}</span></td>
    <td>${fmt(setup.contract,0)}</td>
    <td>${fmt(cur-setup.contract,0)}</td>
    <td>${setup.contract>0 ? fmt((cur/setup.contract)*100,1)+"%" : "—"}</td>
    <td class="muted">${(err && err>3) ? "Sample small; reference only." : "OK"} </td>
  `;
  tb.appendChild(tr);

  // stats focus text
  const focus = $("statsFocusText");
  const sd = stddev(times);
  const cv = (med>0)? (sd/med)*100 : 0;
  let focusText = `• ${msg}\n• Median: ${fmt(med,2)}s · P10: ${fmt(p10,2)}s · P90: ${fmt(p90,2)}s\n• Variación (CV): ${fmt(cv,1)}%`;
  if(n<10) focusText += `\n• Pocas muestras: toma más para estabilizar percentiles.`;
  else if(err && err>3) focusText += `\n• Aún no llega a ±3%: úsalo como referencia y sigue midiendo.`;
  else focusText += `\n• Muestra razonable: ya puedes comparar contra contrato con más confianza.`;

  focus.textContent = focusText;

  // stats detail table (optional)
  const tb2=$("statsBody");
  tb2.innerHTML="";
  const meanV = mean(times);
  const tr2=document.createElement("tr");
  tr2.innerHTML = `
    <td>${setup.processName || "—"}</td>
    <td>${fmt(meanV,2)}</td>
    <td>${fmt(med,2)}</td>
    <td>${fmt(p10,2)}</td>
    <td>${fmt(p90,2)}</td>
    <td>${fmt(sd,2)}</td>
    <td>${fmt(cv,1)}%</td>
  `;
  tb2.appendChild(tr2);

  return {setup, n, err, msg, med, p10, p90, cur, pot, wst, unit};
}

/* =========================
   Raw table
========================= */
function updateRawTable(){
  $("lapCount").textContent = String(laps.length);

  const tb = $("rawBody");
  tb.innerHTML="";
  laps.forEach((r, i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${fmt(r.t,2)}</td>
      <td>${r.kind}</td>
      <td class="muted">${r.ts}</td>
      <td class="muted">${(r.note||"")}</td>
    `;
    tb.appendChild(tr);
  });
}

/* =========================
   Export box
========================= */
function buildExportText(){
  const S = updateContractSummary();
  const setup = S.setup;

  let txt = "";
  txt += `TaktLab Summary\n`;
  txt += `Process: ${setup.processName || "—"}\n`;
  txt += `Mode: ${setup.mode==="ct" ? "CT" : "MLD"}\n`;
  txt += `Efficiency: ${fmt(setup.eff*100,0)}%\n`;
  txt += `Hours/day: ${setup.hours} | Days/week: ${setup.days}\n`;
  txt += `Contract (pcs/day): ${fmt(setup.contract,0)}\n`;
  txt += `\nSamples: ${S.n} | ${S.msg}\n`;
  txt += `Median: ${fmt(S.med,2)}s | P10: ${fmt(S.p10,2)}s | P90: ${fmt(S.p90,2)}s\n`;
  txt += `Capacity (${setup.capView}): Current ${fmt(S.cur,0)} ${S.unit} | Potential ${fmt(S.pot,0)} ${S.unit} | Worst ${fmt(S.wst,0)} ${S.unit}\n`;
  if(setup.contract>0){
    txt += `Vs Contract (Current): ${fmt((S.cur/setup.contract)*100,1)}%\n`;
  }
  txt += `\n--- WB ---\n`;
  if(!wbRows.length){
    txt += `WB: (empty)\n`;
  }else{
    wbRows.forEach((r,idx)=>{
      computeWBRow(r);
      txt += `${idx+1}) ${r.op} | En:${r.enabled?"Y":"N"} | Ops:${r.operators} | Sh:${r.shifts} | H:${r.hours} | M:${r.machines} | Pzs/Op:${r.pcsPerOp}\n`;
      txt += `   NetMin:${fmt(r.netMin,0)} | OEE:${fmt(r.oee,1)}% | CT:${fmt(r.ctCur,2)}s | CT@OEE:${fmt(r.ctCurOee,2)}s\n`;
      txt += `   Cap@OEE:${fmt(r.capOee,0)} | Contract:${fmt(r.contract,0)} | %vs:${fmt(r.vsContract,1)}%\n`;
    });
  }
  txt += `\nRaw laps (s): ${laps.map(x=>fmt(x.t,2)).join(", ")}\n`;
  return txt;
}

function updateExport(){
  $("exportBox").value = buildExportText();
}

/* =========================
   Copy per section
========================= */
async function copyText(text){
  try{
    await navigator.clipboard.writeText(text);
    return true;
  }catch(e){
    // fallback
    const ta=document.createElement("textarea");
    ta.value=text;
    document.body.appendChild(ta);
    ta.select();
    const ok=document.execCommand("copy");
    document.body.removeChild(ta);
    return ok;
  }
}

function sectionTextById(id){
  if(id==="secSetup"){
    const s=getSetup();
    return `Configuración de Medición\nProcess: ${s.processName||"—"}\nMode: ${s.mode}\nEff%: ${fmt(s.eff*100,0)}\nHours/day: ${s.hours}\nDays/week: ${s.days}\nContract(pcs/day): ${fmt(s.contract,0)}\nCap view: ${s.capView}\n`;
  }
  if(id==="secControls"){
    return `Controles de Datos\nLaps: ${laps.length}\n(Usa Reset para borrar laps)\n`;
  }
  if(id==="secContract"){
    const S=updateContractSummary();
    return `Contrato vs Capacidad\n${S.msg}\nMedian:${fmt(S.med,2)}s P10:${fmt(S.p10,2)}s P90:${fmt(S.p90,2)}s\nCurrent:${fmt(S.cur,0)} ${S.unit} Potential:${fmt(S.pot,0)} ${S.unit} Worst:${fmt(S.wst,0)} ${S.unit}\nContract:${fmt(S.setup.contract,0)}\n`;
  }
  if(id==="secStats"){
    return `Enfoque Estadístico\n${$("statsFocusText").textContent}\n`;
  }
  if(id==="secWB"){
    return buildExportText().split("\n--- WB ---\n")[1]?.split("\nRaw laps")[0] || "WB: (empty)";
  }
  if(id==="secRaw"){
    return `Datos Crudos\n` + laps.map((r,i)=>`${i+1}\t${fmt(r.t,2)}\t${r.kind}\t${r.ts}\t${r.note||""}`).join("\n");
  }
  if(id==="secExport"){
    return $("exportBox").value;
  }
  if(id==="secCharts"){
    return `Gráficas (referencia)\nDistribución/Tendencia/Comparador se actualizan con laps.\n`;
  }
  return "";
}

function bindCopyButtons(){
  const map = [
    ["btnCopySetup","secSetup"],
    ["btnCopyControls","secControls"],
    ["btnCopyContract","secContract"],
    ["btnCopyStats","secStats"],
    ["btnCopyWB","secWB"],
    ["btnCopyRaw","secRaw"],
    ["btnCopyExport","secExport"],
    ["btnCopyCharts","secCharts"]
  ];
  map.forEach(([btnId, secId])=>{
    const btn=$(btnId);
    if(!btn) return;
    btn.addEventListener("click", async ()=>{
      const text = sectionTextById(secId);
      await copyText(text);
      setPulse(btn, 6000);
    });
  });

  $("btnCopyAll").addEventListener("click", async ()=>{
    const text = buildExportText();
    await copyText(text);
    setPulse($("btnCopyAll"), 6000);
  });

  $("btnCopySummary").addEventListener("click", async ()=>{
    const S=updateContractSummary();
    const text = `Process:${S.setup.processName||"—"} | ${S.msg}\nMedian:${fmt(S.med,2)}s | P10:${fmt(S.p10,2)}s | P90:${fmt(S.p90,2)}s\nCurrent:${fmt(S.cur,0)} ${S.unit} | Contract:${fmt(S.setup.contract,0)}\n`;
    await copyText(text);
    setPulse($("btnCopySummary"), 6000);
  });
}

/* =========================
   Charts (simple canvas)
========================= */
function clearCanvas(c){
  const ctx=c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);
  return ctx;
}

function drawAxes(ctx,w,h){
  // minimal axes
  ctx.globalAlpha=0.9;
  ctx.strokeStyle="#cfd8dc";
  ctx.lineWidth=1;
  ctx.beginPath();
  ctx.moveTo(30,10);
  ctx.lineTo(30,h-25);
  ctx.lineTo(w-10,h-25);
  ctx.stroke();
  ctx.globalAlpha=1;
}

function drawDistribution(){
  const c=$("chartDist");
  if(!c) return;
  const ctx=clearCanvas(c);
  const w=c.width,h=c.height;

  drawAxes(ctx,w,h);

  const data=laps.map(x=>x.t).sort((a,b)=>a-b);
  if(!data.length){
    ctx.fillStyle="#90a4ae";
    ctx.fillText("No data", 40, 40);
    return;
  }

  // histogram bins
  const bins=10;
  const min=data[0], max=data[data.length-1];
  const span = (max-min)||1;
  const counts=new Array(bins).fill(0);
  data.forEach(v=>{
    let b = Math.floor(((v-min)/span)*bins);
    if(b===bins) b=bins-1;
    counts[b]++;
  });
  const maxC=Math.max(...counts);

  const plotW=w-50, plotH=h-45;
  const barW = plotW/bins;

  counts.forEach((c0,i)=>{
    const bh = (c0/maxC)*plotH;
    const x = 30 + i*barW + 3;
    const y = (h-25) - bh;
    ctx.fillStyle="rgba(57,189,245,0.35)";
    ctx.fillRect(x,y,barW-6,bh);
  });

  ctx.fillStyle="#607d8b";
  ctx.fillText(`min ${fmt(min,2)}s`, 40, h-8);
  ctx.fillText(`max ${fmt(max,2)}s`, w-90, h-8);
}

function drawTrend(){
  const c=$("chartTrend");
  if(!c) return;
  const ctx=clearCanvas(c);
  const w=c.width,h=c.height;

  drawAxes(ctx,w,h);

  const data=laps.map(x=>x.t);
  if(data.length<2){
    ctx.fillStyle="#90a4ae";
    ctx.fillText("Need 2+ laps", 40, 40);
    return;
  }

  const min=Math.min(...data), max=Math.max(...data);
  const span=(max-min)||1;

  const plotW=w-50, plotH=h-45;

  ctx.strokeStyle="rgba(24,201,122,0.85)";
  ctx.lineWidth=2;
  ctx.beginPath();
  data.forEach((v,i)=>{
    const x = 30 + (i/(data.length-1))*plotW;
    const y = (h-25) - ((v-min)/span)*plotH;
    if(i===0) ctx.moveTo(x,y);
    else ctx.lineTo(x,y);
  });
  ctx.stroke();
}

function drawCompare(){
  const c=$("chartCompare");
  if(!c) return;
  const ctx=clearCanvas(c);
  const w=c.width,h=c.height;

  drawAxes(ctx,w,h);

  const setup=getSetup();
  const data=laps.map(x=>x.t);
  if(!data.length){
    ctx.fillStyle="#90a4ae";
    ctx.fillText("No data", 40, 40);
    return;
  }
  const med=median(data), p10=percentile(data,0.10), p90=percentile(data,0.90);

  const capCur=capPick(capacityFromCT(med,setup), setup.capView);
  const capPot=capPick(capacityFromCT(p10,setup), setup.capView);
  const capWst=capPick(capacityFromCT(p90,setup), setup.capView);

  const vals=[capWst, capCur, capPot];
  const maxV=Math.max(...vals, 1);

  const labels=["Worst","Current","Potential"];
  const plotW=w-50, plotH=h-45;
  const barW = plotW/3;

  vals.forEach((v,i)=>{
    const bh=(v/maxV)*plotH;
    const x=30 + i*barW + 20;
    const y=(h-25)-bh;

    // keep simple; no hard-coded palette beyond existing UI
    ctx.fillStyle="rgba(242,193,78,0.35)";
    ctx.fillRect(x,y,barW-40,bh);

    ctx.fillStyle="#607d8b";
    ctx.fillText(labels[i], x, h-8);
  });
}

/* =========================
   Global update
========================= */
function updateAll(){
  applyI18n();

  updateRawTable();
  const S = updateContractSummary();

  // WB
  renderWB();

  // Export
  updateExport();
  updateWBSummary();

  // charts
  drawDistribution();
  drawTrend();
  drawCompare();
}

/* =========================
   Setup bindings
========================= */
["modeSel","effPct","contractPcd","hoursPerDay","daysPerWeek","capViewSel","processName"].forEach(id=>{
  const el=$(id);
  if(el) el.addEventListener("change", updateAll);
  if(el) el.addEventListener("input", updateAll);
});

// Language toggle
$("langToggle").addEventListener("click", ()=>{
  LANG = (LANG==="es") ? "en" : "es";
  updateAll();
  setPulse($("langToggle"), 6000);
});

/* =========================
   Init
========================= */
bindCopyButtons();
updateAll();

// Start with 1 WB row for convenience
addWBRow();

</script>
