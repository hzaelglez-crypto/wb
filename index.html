<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>TaktLab – Cycle Time & Capacity Analyzer</title>

<style>
  :root{
    --bg-main:#07152b;
    --bg-card:#0b1f3a;
    --bg-card-soft:#0f2544;
    --accent-green:#00c853;
    --accent-amber:#ffb300;
    --accent-red:#ff1744;
    --accent-blue:#29b6f6;
    --accent-grey:#cfd8dc;
    --text-main:#ffffff;
    --text-soft:#c5cae9;
    --text-muted:#90a4ae;
    --border-soft:#1c3357;
    --btn-green:#00c853;
    --btn-orange:#ff9100;
    --btn-grey:#455a64;
    --badge-green:#004d40;
    --badge-red:#b71c1c;
    --badge-amber:#ff8f00;
  }

  *{box-sizing:border-box;}

  body{
    margin:0;
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    background:linear-gradient(180deg,#020b1a 0%,#07152b 40%,#020b1a 100%);
    color:var(--text-main);
  }

  .page{
    max-width:1100px;
    margin:0 auto;
    padding:10px 10px 34px; /* compact */
  }

  .sticky-timer-bar{
    position:sticky;
    top:0;
    z-index:100;
    background:linear-gradient(180deg,#020b1a 0%,#07152b 90%);
    padding:6px 0 8px; /* compact */
  }

  .top-row{
    display:flex;
    align-items:center;
    gap:10px;
    margin-bottom:6px; /* compact */
  }

  .logo-circle{
    width:38px;height:38px;border-radius:50%;
    border:2px solid var(--accent-grey);
    display:flex;align-items:center;justify-content:center;
  }
  .logo-gear{
    width:22px;height:22px;border-radius:50%;
    border:2px solid var(--accent-grey);
    position:relative;
  }
  .logo-gear::before{
    content:"";
    position:absolute;
    inset:4px;
    border-radius:50%;
    border:2px solid var(--accent-green);
    border-right-color:transparent;
    border-bottom-color:transparent;
    transform-origin:50% 50%;
  }
  .logo-gear.spinning::before{ animation:logo-spin 2s linear infinite; }
  @keyframes logo-spin{ from{transform:rotate(0deg);} to{transform:rotate(360deg);} }

  .title-block{display:flex;flex-direction:column;gap:2px;}
  .title-main{font-size:1.2rem;font-weight:700;letter-spacing:.03em;}
  .title-sub{font-size:.72rem;color:var(--text-soft);}

  .lang-switch{margin-left:auto;display:flex;align-items:center;gap:4px;}
  .lang-btn{
    border-radius:999px;border:1px solid var(--border-soft);
    background:rgba(2,11,26,.6);color:var(--text-soft);
    font-size:.7rem;padding:4px 8px;cursor:pointer;min-width:34px;
  }
  .lang-btn.active{background:var(--accent-blue);color:#fff;border-color:var(--accent-blue);font-weight:600;}

  .timer-card{
    background:var(--bg-card);
    border-radius:18px;
    border:1px solid var(--border-soft);
    padding:6px 10px 10px;
    box-shadow:0 8px 18px rgba(0,0,0,.45);
  }

  .timer-display{
    text-align:center;
    font-size:2.8rem;
    font-weight:600;
    letter-spacing:.08em;
    padding:4px 4px 6px; /* compact */
  }

  .info-stack{ display:flex; flex-direction:column; gap:6px; margin:0 0 8px; }
  .info-line{
    font-size:.78rem;margin:0;padding:6px 10px;
    border-radius:12px;border:1px solid transparent;
    line-height:1.25;
  }
  .sample-neutral{background:rgba(255,255,255,.03);border-color:rgba(255,255,255,.08);color:var(--text-soft);}
  .sample-good{background:rgba(0,200,83,.15);border-color:rgba(0,200,83,.7);color:#c8e6c9;}
  .sample-warn{background:rgba(255,193,7,.14);border-color:rgba(255,193,7,.8);color:#ffe082;}
  .sample-bad{background:rgba(244,67,54,.16);border-color:rgba(244,67,54,.9);color:#ffab91;}

  .btn-row-main{display:flex;gap:10px;margin-bottom:2px;}
  .btn{
    border:none;border-radius:16px;padding:10px 12px;
    font-size:.9rem;font-weight:600;cursor:pointer;color:#fff;
    box-shadow:0 4px 10px rgba(0,0,0,.4);flex:1;
    transition:transform .04s ease, box-shadow .04s ease, background .15s;
    touch-action:manipulation;
  }
  .btn:active{transform:translateY(1px);box-shadow:0 1px 4px rgba(0,0,0,.5);}
  .btn-start{background:var(--btn-green);}
  .btn-lap{background:var(--btn-orange);}

  .flash{animation:flash-bg .12s ease-out;}
  @keyframes flash-bg{ from{background:rgba(255,255,255,.18);} to{background:transparent;} }

  .content-section{margin-top:8px;} /* compact */

  .section-card{
    background:var(--bg-card);
    border-radius:18px;
    border:1px solid var(--border-soft);
    padding:8px 10px 10px; /* compact */
    margin-bottom:10px;
  }
  .section-title{font-size:1.0rem;font-weight:700;margin-bottom:6px;} /* compact */

  .mode-row{
    display:flex;gap:8px;flex-wrap:wrap;align-items:flex-end;
    font-size:.78rem;color:var(--text-soft);
  }
  .mode-row select,.mode-row input{
    background:#020b1a;border-radius:8px;border:1px solid var(--border-soft);
    padding:4px 8px;color:var(--text-soft);font-size:.78rem;min-width:70px;
  }
  .mode-row input[type="number"]{width:78px;}

  table{width:100%;border-collapse:collapse;font-size:.72rem;} /* compact */
  th,td{
    padding:3px 5px;text-align:right; /* compact */
    border-bottom:1px solid rgba(255,255,255,.04);
    white-space:nowrap;
    vertical-align:middle;
  }
  th:first-child,td:first-child{text-align:left;}
  th{
    color:var(--text-soft);font-weight:600;background:rgba(255,255,255,.02);
    position:sticky;top:0;z-index:5;
  }
  tbody tr:nth-child(even){background:rgba(255,255,255,.02);}

  .badge{
    display:inline-block;padding:2px 6px;border-radius:999px;
    font-size:.68rem;border:1px solid transparent;
  }
  .badge-good{background:var(--badge-green);border-color:#00e676;}
  .badge-warn{background:var(--badge-amber);border-color:#ffe082;color:#000;}
  .badge-bad{background:var(--badge-red);border-color:#ff8a80;}

  .btn-row-secondary{display:flex;flex-wrap:wrap;gap:10px;margin:8px 0 4px;}
  .btn-small{
    padding:12px 18px;            /* BIGGER */
    border-radius:18px;           /* BIGGER */
    font-size:.95rem;             /* BIGGER */
    font-weight:800;              /* BIGGER */
    flex:0 0 auto;background:var(--bg-card-soft);color:var(--text-soft);
    border:1px solid var(--border-soft);cursor:pointer;box-shadow:0 3px 8px rgba(0,0,0,.35);
  }
  .btn-small-copy{background:var(--accent-blue);border-color:var(--accent-blue);color:#fff;}
  .btn-small-summary{background:var(--accent-amber);border-color:var(--accent-amber);color:#000;}
  .btn-small-manual{background:var(--accent-green);border-color:var(--accent-green);color:#000;}
  .btn-small-reset{background:var(--accent-red);border-color:var(--accent-red);color:#fff;}
  .btn-small-wbadd{background:rgba(255,255,255,.06);color:var(--text-soft);}
  .btn-small-wbclear{background:rgba(255,23,68,.16);border-color:rgba(255,23,68,.6);color:#ff8a80;}

  .subsection-title{margin-top:10px;font-size:.82rem;font-weight:650;color:var(--text-soft);}

  .footer-note{margin-top:10px;font-size:.65rem;color:var(--text-muted);text-align:right;}

  .charts-wrapper{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
    gap:10px;
  }
  .chart-card{
    background:var(--bg-card-soft);
    border-radius:14px;
    border:1px solid var(--border-soft);
    padding:8px;
  }
  .chart-title{font-size:.75rem;margin-bottom:4px;color:var(--text-soft);}
  canvas{width:100%;height:180px;background:#020b1a;border-radius:10px;}

  .btn-edit,.btn-del,.btn-relink{
    padding:2px 6px;border-radius:8px;font-size:.7rem;
    border:1px solid rgba(255,255,255,.2);cursor:pointer;background:transparent;
  }
  .btn-edit{color:#81d4fa;}
  .btn-del{color:#ff8a80;}
  .btn-relink{color:#ffe082;}

  /* WB inputs – más compactos */
  .wb-inp, .wb-sel, .wb-chk{
    background:#020b1a;border-radius:8px;border:1px solid var(--border-soft);
    padding:2px 5px;color:var(--text-soft);font-size:.70rem;
  }
  .wb-inp{width:72px;}
  .wb-inp.wide{width:140px;}
  .wb-inp.slim{width:56px;}
  .wb-sel{width:84px;}
  .wb-pill{
    display:inline-block;padding:3px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.03);font-size:.72rem;color:var(--text-soft);
  }
  .wb-alert{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-top:8px;}
  .wb-alert .badge{font-size:.72rem;padding:4px 10px;}
  .wb-badge-title{font-size:.72rem;color:var(--text-soft);}
  .wb-mini{font-size:.7rem;color:var(--text-muted);line-height:1.25;margin-top:6px;}
  .wb-sumline{
    display:flex;justify-content:flex-end;gap:10px;align-items:center;
    margin-top:6px;font-size:.72rem;color:var(--text-soft);
  }
  .wb-sumline .badge{font-size:.70rem}

  @media (max-width:600px){
    .timer-display{font-size:2.2rem;}
    .btn-row-main{gap:6px;}
    .btn{font-size:.9rem;border-radius:14px;}
    canvas{height:160px;}
    th,td{font-size:.70rem;}
    .wb-inp{width:66px;}
    .wb-inp.wide{width:120px;}
    .btn-small{padding:12px 16px;font-size:.92rem;}
  }
</style>
</head>

<body>
<div class="page">

  <div class="sticky-timer-bar">
    <div class="top-row">
      <div class="logo-circle"><div class="logo-gear" id="logoGear"></div></div>
      <div class="title-block">
        <div class="title-main">TaktLab</div>
        <div class="title-sub" data-i18n="title.subtitle">Cycle Time &amp; Capacity Analyzer</div>
      </div>
      <div class="lang-switch">
        <button class="lang-btn" data-lang="en">EN</button>
        <button class="lang-btn" data-lang="es">ES</button>
      </div>
    </div>

    <div class="timer-card" id="timerCard">
      <div class="timer-display" id="display">00:00.00</div>

      <div class="info-stack">
        <div class="info-line sample-neutral" id="sampleInfoTop">
          No samples yet for current process. Start capturing laps.
        </div>
      </div>

      <div class="btn-row-main">
        <button class="btn btn-start" id="btnStart" data-i18n="btn.start">Start</button>
        <button class="btn btn-lap" id="btnLap" data-i18n="btn.lap">LAP</button>
      </div>
    </div>
  </div>

  <div class="content-section">

    <div class="section-card">
      <div class="section-title" data-i18n="section.measurementSetup">Measurement Setup</div>

      <div class="mode-row">
        <div>
          <label for="processName" data-i18n="label.process">Process</label><br/>
          <input id="processName" type="text" placeholder="e.g. Op 30-1" data-i18n-placeholder="label.processPlaceholder"/>
        </div>

        <div>
          <label for="mode" data-i18n="label.mode">Mode</label><br/>
          <select id="mode">
            <option value="CT" data-i18n="mode.ct">Cycle Time (CT)</option>
            <option value="MLD" data-i18n="mode.mld">Machine &amp; Load/Unload</option>
          </select>
        </div>

        <div>
          <label for="efficiency" data-i18n="label.efficiency">Efficiency %</label><br/>
          <input id="efficiency" type="number" value="100" min="0" max="100" step="1"/>
        </div>

        <div>
          <label for="contractPcd" data-i18n="label.contractPcd">Contract Cap (pcs/day)</label><br/>
          <input id="contractPcd" type="number" min="0" max="99999" step="1"/>
        </div>

        <div>
          <label for="hoursPerDay" data-i18n="label.hoursPerDay">Hours / Day</label><br/>
          <input id="hoursPerDay" type="number" value="8" min="1" max="24" step=".5"/>
        </div>

        <div>
          <label for="daysPerWeek" data-i18n="label.daysPerWeek">Days / Week</label><br/>
          <input id="daysPerWeek" type="number" value="5" min="1" max="7"/>
        </div>

        <div>
          <label for="capView" data-i18n="label.capView">Capacity View</label><br/>
          <select id="capView">
            <option value="hour" data-i18n="capView.hour">per Hour</option>
            <option value="day" data-i18n="capView.day">per Day</option>
            <option value="week" data-i18n="capView.week">per Week</option>
          </select>
        </div>
      </div>
    </div>

    <!-- NEW: CONTRACT vs CAPACITY SUMMARY -->
    <div class="section-card">
      <div class="section-title" data-i18n="section.contractSummary">Contract vs Capacity Summary</div>

      <div class="info-stack" style="margin-top:4px;">
        <div class="info-line sample-neutral" id="contractSumLine1">—</div>
        <div class="info-line sample-neutral" id="contractSumLine2">—</div>
        <div class="info-line sample-neutral" id="contractSumLine3">—</div>
        <div class="info-line sample-neutral" id="contractSumLine4">—</div>
      </div>

      <div style="font-size:.68rem;color:var(--text-muted);margin:6px 0 0;">
        <span data-i18n="contract.note">Uses current process + your laps (Median/P10/P90) with the Measurement Setup assumptions.</span>
      </div>
    </div>

    <div class="section-card">
      <div class="section-title" data-i18n="section.statsFocus">Stat Focus</div>

      <div class="info-stack" style="margin-top:4px;">
        <div class="info-line sample-neutral" id="sampleInfoFocus">Sample size: —</div>
        <div class="info-line sample-neutral" id="stdInfoFocus">Std dev: —</div>
        <div class="info-line sample-neutral" id="distInfoFocus">Mean vs Median: —</div>
        <div class="info-line sample-neutral" id="contractInfoFocus">No contract loaded</div>
      </div>

      <div style="font-size:.68rem;color:var(--text-muted);margin:6px 0 6px;">
        <span data-i18n="stats.note">Simple language on purpose: few / enough samples, low / high variation, capable / not capable.</span>
      </div>

      <div style="max-height:300px;overflow:auto;">
        <table>
          <thead>
            <tr>
              <th data-i18n="col.process">Process</th>
              <th data-i18n="col.mode">Mode</th>
              <th>N</th>
              <th data-i18n="col.sample">Sample size / Error</th>
              <th>Std</th>
              <th>CV%</th>
              <th>CTmed</th>
              <th>P10</th>
              <th>P90</th>
              <th data-i18n="col.capCurrent">Current @Eff</th>
              <th data-i18n="col.capPotential">Potential @Eff</th>
              <th data-i18n="col.capWorst">Worst @Eff</th>
              <th data-i18n="col.contract">Contract</th>
              <th data-i18n="col.gap">Gap</th>
              <th data-i18n="col.vsContract">% vs</th>
              <th>Cp</th>
              <th>Cpk</th>
              <th data-i18n="col.note">Note</th>
            </tr>
          </thead>
          <tbody id="focusBody"></tbody>
        </table>
      </div>

      <div class="subsection-title" data-i18n="section.wbPlanner">WB – Capacity Planner (by process)</div>

      <div class="btn-row-secondary" style="margin-top:8px;">
        <button class="btn-small btn-small-wbadd" id="btnWbAdd" data-i18n="btn.wbAdd">+ Add Operation</button>
        <button class="btn-small btn-small-wbclear" id="btnWbClear" data-i18n="btn.wbClear">Clear WB</button>
      </div>

      <div style="max-height:320px;overflow:auto;">
        <table id="wbTable">
          <thead>
            <tr>
              <th data-i18n="wb.seq">Seq</th>
              <th data-i18n="wb.enabled">On</th>
              <th data-i18n="wb.operation">Operation</th>
              <th data-i18n="wb.operators">Operators</th>
              <th data-i18n="wb.shifts">Shifts</th>
              <th data-i18n="wb.hours">Hours</th>
              <th data-i18n="wb.machines"># Machines</th>
              <th data-i18n="wb.contract">Contract (pcs/day)</th>

              <th data-i18n="wb.gross">Gross min/day</th>
              <th data-i18n="wb.lunch">Lunch min/day</th>
              <th data-i18n="wb.changeover">Changeover</th>
              <th data-i18n="wb.cleaning">5S/Clean</th>
              <th data-i18n="wb.maint">Maintenance</th>
              <th data-i18n="wb.other">Other</th>

              <th data-i18n="wb.shared">Shared Capacity</th>

              <th data-i18n="wb.udt">Unplanned DT</th>
              <th data-i18n="wb.udtUnit">Unit</th>

              <th data-i18n="wb.net">Net min/day</th>

              <th data-i18n="wb.scrap">Scrap %</th>
              <th data-i18n="wb.yield">Yield</th>

              <th data-i18n="wb.oeeA">A%</th>
              <th data-i18n="wb.oeeP">P%</th>
              <th data-i18n="wb.oeeQ">Q%</th>
              <th data-i18n="wb.oee">OEE%</th>

              <th data-i18n="wb.ctCur">CT Current</th>
              <th data-i18n="wb.ctWst">CT Worst</th>
              <th data-i18n="wb.ctPot">CT Potential</th>

              <th data-i18n="wb.ctCurOee">CT@OEE (Cur)</th>

              <th data-i18n="wb.cap100">Cap 100% (Cur)</th>
              <th data-i18n="wb.capOee">Cap@OEE (Cur)</th>

              <th data-i18n="wb.vsContract">% vs contract</th>
              <th data-i18n="wb.inputReq">Input req. for Contract</th>

              <th data-i18n="wb.actions">Actions</th>
            </tr>
          </thead>
          <tbody id="wbBody"></tbody>
        </table>
      </div>

      <div class="wb-sumline">
        <span data-i18n="wb.opsSum">Operators total:</span>
        <span class="badge badge-warn" id="wbOperatorsSum">0</span>
      </div>

      <div class="wb-alert">
        <span class="wb-badge-title" data-i18n="wb.constraintTitle">Constraint / Next:</span>
        <span class="badge badge-bad" id="wbConstraint">—</span>
        <span class="badge badge-warn" id="wbNextConstraint">—</span>
      </div>
      <div class="wb-mini" id="wbConstraintNote"></div>

      <div class="subsection-title" data-i18n="section.statsDetail">Statistical Detail (per process)</div>
      <div style="max-height:240px;overflow:auto;">
        <table id="statsTable">
          <thead>
            <tr>
              <th data-i18n="col.process">Process</th>
              <th data-i18n="col.mode">Mode</th>
              <th data-i18n="col.n">N</th>
              <th>Mean</th>
              <th>Median</th>
              <th>P10</th>
              <th>P90</th>
              <th>Min</th>
              <th>Max</th>
              <th>Std</th>
              <th>CV%</th>
              <th>Cp</th>
              <th>Cpk</th>
            </tr>
          </thead>
          <tbody id="statsBody"></tbody>
        </table>
      </div>
    </div>

    <!-- MOVED: DATA CONTROLS AFTER STAT FOCUS -->
    <div class="section-card">
      <div class="section-title" data-i18n="section.dataControls">Data Controls</div>
      <div class="btn-row-secondary">
        <button class="btn-small btn-small-copy" id="btnCopyAll" data-i18n="btn.copyAll">Copy All</button>
        <button class="btn-small btn-small-summary" id="btnCopySummary" data-i18n="btn.copySummary">Copy Summary</button>
        <button class="btn-small btn-small-manual" id="btnAddManualLap" data-i18n="btn.addManualLap">Add Manual Lap</button>
        <button class="btn-small btn-small-reset" id="btnReset" data-i18n="btn.reset">Reset</button>
      </div>
    </div>

    <div class="section-card">
      <div class="section-title" data-i18n="section.charts">Charts (selected process)</div>

      <div style="margin-bottom:6px;font-size:.75rem;">
        <label for="chartProcessSelect" data-i18n="label.chartProcessLabel">Process / Mode:</label>
        <select id="chartProcessSelect"></select>
      </div>

      <div class="charts-wrapper">
        <div class="chart-card">
          <div class="chart-title" data-i18n="chart.timeSeriesTitle">Time Series with Mean, Median, ±3σ</div>
          <canvas id="timeSeriesCanvas"></canvas>
        </div>

        <div class="chart-card">
          <div class="chart-title" data-i18n="chart.histTitle">Histogram with Median &amp; Percentiles</div>
          <canvas id="histCanvas"></canvas>
        </div>
      </div>
    </div>

    <div class="section-card">
      <div class="section-title" data-i18n="section.rawData">Raw Time Data</div>
      <div style="max-height:300px;overflow:auto;">
        <table id="dataTable">
          <thead>
            <tr>
              <th data-i18n="col.index">#</th>
              <th data-i18n="col.process">Process</th>
              <th data-i18n="col.mode">Mode</th>
              <th data-i18n="col.status">Status</th>
              <th data-i18n="col.note">Note</th>
              <th data-i18n="col.t1">T1 (s)</th>
              <th data-i18n="col.t2">T2 (s)</th>
              <th data-i18n="col.total">Total (s)</th>
              <th data-i18n="col.edit">Edit</th>
              <th data-i18n="col.del">Del</th>
            </tr>
          </thead>
          <tbody id="dataBody"></tbody>
        </table>
      </div>
    </div>

    <div class="section-card">
      <div class="section-title" data-i18n="section.methodGuide">Method &amp; Guide</div>
      <details style="background:var(--bg-card-soft);border:1px solid var(--border-soft);border-radius:14px;padding:10px;">
        <summary style="cursor:pointer;color:var(--text-soft);font-weight:700;">
          <span data-i18n="method.open">Open</span>
        </summary>
        <div style="margin-top:8px;font-size:.72rem;color:var(--text-soft);line-height:1.35;white-space:pre-wrap;" id="methodGuideText"></div>
      </details>
    </div>

  </div>

  <div class="footer-note" data-i18n="footer.note">
    Created by Roberto González – Contact: hzaelglez@gmail.com
  </div>
</div>

<script>
(function(){
  const display = document.getElementById('display');
  const btnStart = document.getElementById('btnStart');
  const btnLap = document.getElementById('btnLap');
  const timerCard = document.getElementById('timerCard');
  const logoGear = document.getElementById('logoGear');

  const sampleInfoTop = document.getElementById('sampleInfoTop');
  const sampleInfoFocus = document.getElementById('sampleInfoFocus');
  const stdInfoFocus = document.getElementById('stdInfoFocus');
  const distInfoFocus = document.getElementById('distInfoFocus');
  const contractInfoFocus = document.getElementById('contractInfoFocus');

  // Contract Summary lines
  const contractSumLine1 = document.getElementById('contractSumLine1');
  const contractSumLine2 = document.getElementById('contractSumLine2');
  const contractSumLine3 = document.getElementById('contractSumLine3');
  const contractSumLine4 = document.getElementById('contractSumLine4');

  const processInput = document.getElementById('processName');
  const modeSelect   = document.getElementById('mode');
  const effInput     = document.getElementById('efficiency');
  const pcdInput     = document.getElementById('contractPcd');
  const hInput       = document.getElementById('hoursPerDay');
  const dInput       = document.getElementById('daysPerWeek');
  const capViewSel   = document.getElementById('capView');

  const focusBody     = document.getElementById('focusBody');
  const statsBody     = document.getElementById('statsBody');

  const dataBody    = document.getElementById('dataBody');
  const btnCopyAll  = document.getElementById('btnCopyAll');
  const btnCopySum  = document.getElementById('btnCopySummary');
  const btnAddMan   = document.getElementById('btnAddManualLap');
  const btnReset    = document.getElementById('btnReset');

  const chartSelect      = document.getElementById('chartProcessSelect');
  const timeSeriesCanvas = document.getElementById('timeSeriesCanvas');
  const histCanvas       = document.getElementById('histCanvas');

  const langButtons = document.querySelectorAll('.lang-btn');

  const wbBody = document.getElementById('wbBody');
  const btnWbAdd = document.getElementById('btnWbAdd');
  const btnWbClear = document.getElementById('btnWbClear');
  const wbConstraint = document.getElementById('wbConstraint');
  const wbNextConstraint = document.getElementById('wbNextConstraint');
  const wbConstraintNote = document.getElementById('wbConstraintNote');
  const wbOperatorsSum = document.getElementById('wbOperatorsSum');
  const methodGuideText = document.getElementById('methodGuideText');

  const i18n = {
    en:{
      'title.subtitle':'Cycle Time & Capacity Analyzer',
      'btn.start':'Start','btn.pause':'Pause','btn.lap':'LAP',
      'btn.copyAll':'Copy All','btn.copySummary':'Copy Summary','btn.addManualLap':'Add Manual Lap','btn.reset':'Reset',
      'section.measurementSetup':'Measurement Setup',
      'section.contractSummary':'Contract vs Capacity Summary',
      'contract.note':'Uses current process + your laps (Median/P10/P90) with the Measurement Setup assumptions.',
      'section.statsFocus':'Stat Focus',
      'section.dataControls':'Data Controls',
      'section.rawData':'Raw Time Data',
      'section.charts':'Charts (selected process)',
      'section.statsDetail':'Statistical Detail (per process)',
      'section.wbPlanner':'WB – Capacity Planner (by process)',
      'section.methodGuide':'Method & Guide',
      'method.open':'Open',

      'label.process':'Process','label.processPlaceholder':'e.g. Op 30-1',
      'label.mode':'Mode','label.efficiency':'Efficiency %','label.contractPcd':'Contract Cap (pcs/day)',
      'label.hoursPerDay':'Hours / Day','label.daysPerWeek':'Days / Week','label.capView':'Capacity View',
      'label.chartProcessLabel':'Process / Mode:',

      'mode.ct':'Cycle Time (CT)','mode.mld':'Machine & Load/Unload',
      'capView.hour':'per Hour','capView.day':'per Day','capView.week':'per Week',

      'col.index':'#','col.process':'Process','col.mode':'Mode','col.status':'Status','col.note':'Note',
      'col.t1':'T1 (s)','col.t2':'T2 (s)','col.total':'Total (s)','col.edit':'Edit','col.del':'Del','col.n':'N',
      'col.sample':'Sample size / Error',
      'col.capCurrent':'Current @Eff','col.capPotential':'Potential @Eff','col.capWorst':'Worst @Eff',
      'col.contract':'Contract','col.gap':'Gap','col.vsContract':'% vs',
      'col.note':'Note',

      'chart.timeSeriesTitle':'Time Series with Mean, Median, ±3σ',
      'chart.histTitle':'Histogram with Median & Percentiles',

      'stats.note':'Simple language on purpose: few / enough samples, low / high variation, capable / not capable.',
      'footer.note':'Created by Roberto González – Contact: hzaelglez@gmail.com',

      'btn.wbAdd':'+ Add Operation',
      'btn.wbClear':'Clear WB',
      'wb.seq':'Seq',
      'wb.enabled':'On',
      'wb.operation':'Operation',
      'wb.operators':'Operators',
      'wb.shifts':'Shifts',
      'wb.hours':'Hours (per day)',
      'wb.machines':'# Machines',
      'wb.contract':'Contract (pcs/day)',
      'wb.gross':'Gross min/day',
      'wb.lunch':'Lunch min/day',
      'wb.changeover':'Changeover (min/day)',
      'wb.cleaning':'5S/Clean (min/day)',
      'wb.maint':'Maintenance (min/day)',
      'wb.other':'Other (min/day)',
      'wb.shared':'Shared Capacity (min/day)',
      'wb.udt':'Unplanned DT',
      'wb.udtUnit':'Unit',
      'wb.net':'Net min/day',
      'wb.scrap':'Scrap %',
      'wb.yield':'Yield',
      'wb.oeeA':'A%',
      'wb.oeeP':'P%',
      'wb.oeeQ':'Q%',
      'wb.oee':'OEE%',
      'wb.ctCur':'CT Current (s)',
      'wb.ctWst':'CT Worst (s)',
      'wb.ctPot':'CT Potential (s)',
      'wb.ctCurOee':'CT@OEE (Cur)',
      'wb.cap100':'Cap 100% (Cur/day)',
      'wb.capOee':'Cap@OEE (Cur/day)',
      'wb.vsContract':'% vs contract',
      'wb.inputReq':'Input req. for Contract',
      'wb.actions':'Actions',
      'wb.constraintTitle':'Constraint / Next:',
      'wb.opsSum':'Operators total:'
    },
    es:{
      'title.subtitle':'Analizador de Tiempo de Ciclo y Capacidad',
      'btn.start':'Iniciar','btn.pause':'Pausar','btn.lap':'VUELTA',
      'btn.copyAll':'Copiar todo','btn.copySummary':'Copiar resumen','btn.addManualLap':'Agregar vuelta manual','btn.reset':'Reiniciar',
      'section.measurementSetup':'Configuración de Medición',
      'section.contractSummary':'Resumen Contrato vs Capacidad',
      'contract.note':'Usa el proceso actual + tus vueltas (Mediana/P10/P90) con los supuestos de Measurement Setup.',
      'section.statsFocus':'Enfoque Estadístico',
      'section.dataControls':'Controles de Datos',
      'section.rawData':'Datos Crudos de Tiempo',
      'section.charts':'Gráficas (proceso seleccionado)',
      'section.statsDetail':'Detalle Estadístico (por proceso)',
      'section.wbPlanner':'WB – Planeador de Capacidad (por proceso)',
      'section.methodGuide':'Método & Guía',
      'method.open':'Abrir',

      'label.process':'Proceso','label.processPlaceholder':'p. ej. Op 30-1',
      'label.mode':'Modo','label.efficiency':'Eficiencia %','label.contractPcd':'Capacidad contrato (pzs/día)',
      'label.hoursPerDay':'Horas / día','label.daysPerWeek':'Días / semana','label.capView':'Vista de capacidad',
      'label.chartProcessLabel':'Proceso / Modo:',

      'mode.ct':'Tiempo de ciclo (CT)','mode.mld':'Máquina y Carga/Descarga',
      'capView.hour':'por hora','capView.day':'por día','capView.week':'por semana',

      'col.index':'#','col.process':'Proceso','col.mode':'Modo','col.status':'Estatus','col.note':'Nota',
      'col.t1':'T1 (s)','col.t2':'T2 (s)','col.total':'Total (s)','col.edit':'Editar','col.del':'Borrar','col.n':'N',
      'col.sample':'Tamaño de muestra / Error',
      'col.capCurrent':'Actual @Eff','col.capPotential':'Potencial @Eff','col.capWorst':'Peor @Eff',
      'col.contract':'Contrato','col.gap':'Gap','col.vsContract':'% vs',
      'col.note':'Nota',

      'chart.timeSeriesTitle':'Serie de tiempo con media, mediana y ±3σ',
      'chart.histTitle':'Histograma con mediana y percentiles',

      'stats.note':'Lenguaje simple: pocas / suficientes muestras, baja / alta variación, capaz / no capaz.',
      'footer.note':'Creado por Roberto González – Contacto: hzaelglez@gmail.com',

      'btn.wbAdd':'+ Agregar operación',
      'btn.wbClear':'Borrar WB',
      'wb.seq':'Orden',
      'wb.enabled':'On',
      'wb.operation':'Operación',
      'wb.operators':'Operadores',
      'wb.shifts':'Turnos',
      'wb.hours':'Horas (por día)',
      'wb.machines':'# Máquinas',
      'wb.contract':'Contrato (pzs/día)',
      'wb.gross':'Min brutos/día',
      'wb.lunch':'Comida (min/día)',
      'wb.changeover':'Changeover (min/día)',
      'wb.cleaning':'5S/Limpieza (min/día)',
      'wb.maint':'Mtto (min/día)',
      'wb.other':'Otros (min/día)',
      'wb.shared':'Capacidad compartida (min/día)',
      'wb.udt':'DT no planeado',
      'wb.udtUnit':'Unidad',
      'wb.net':'Min netos/día',
      'wb.scrap':'Scrap %',
      'wb.yield':'Yield',
      'wb.oeeA':'Disp%',
      'wb.oeeP':'Rend%',
      'wb.oeeQ':'Calidad%',
      'wb.oee':'OEE%',
      'wb.ctCur':'CT Actual (s)',
      'wb.ctWst':'CT Peor (s)',
      'wb.ctPot':'CT Potencial (s)',
      'wb.ctCurOee':'CT@OEE (Act)',
      'wb.cap100':'Cap 100% (Act/día)',
      'wb.capOee':'Cap@OEE (Act/día)',
      'wb.vsContract':'% vs contrato',
      'wb.inputReq':'Entrada req. p/Contrato',
      'wb.actions':'Acciones',
      'wb.constraintTitle':'Restricción / Siguiente:',
      'wb.opsSum':'Operadores total:'
    }
  };

  let currentLang = localStorage.getItem('taktlabLang') || 'en';
  function t(key){ return (i18n[currentLang] && i18n[currentLang][key]) || i18n.en[key] || key; }

  function applyTranslations(){
    document.querySelectorAll('[data-i18n]').forEach(el=>{
      const key = el.dataset.i18n;
      if(el === btnStart) return;
      el.textContent = t(key);
    });
    document.querySelectorAll('[data-i18n-placeholder]').forEach(el=>{
      const key = el.dataset.i18nPlaceholder;
      el.placeholder = t(key);
    });
  }
  function updateLangButtons(){ langButtons.forEach(b=>b.classList.toggle('active', b.dataset.lang === currentLang)); }
  function setLanguage(lang){
    currentLang = (lang==='es') ? 'es' : 'en';
    localStorage.setItem('taktlabLang', currentLang);
    document.documentElement.lang = currentLang;
    updateLangButtons();
    applyTranslations();
    btnStart.textContent = running ? t('btn.pause') : t('btn.start');
    renderAll();
  }
  langButtons.forEach(btn=>btn.addEventListener('click',()=>setLanguage(btn.dataset.lang)));

  let running=false, startTime=0, elapsed=0, timerId=null;
  let laps=[], nextId=1;
  let pendingT1=null;

  const WB_KEY = 'taktlabWB_v2_sync';

  function clamp(n,min,max){ n = isFinite(n)?n:0; return Math.min(Math.max(n,min),max); }
  function pad2(n){return n<10?'0'+n:''+n;}
  function formatTime(ms){
    const total=Math.max(ms,0);
    const mins=Math.floor(total/60000);
    const secs=Math.floor((total%60000)/1000);
    const cent=Math.floor((total%1000)/10);
    return pad2(mins)+':'+pad2(secs)+'.'+pad2(cent);
  }
  function formatSecs(s){
    if(!isFinite(s)) return '-';
    return (Math.round(s*10)/10).toFixed(1);
  }
  function formatUnits(n){
    if(!isFinite(n)) return '-';
    const rounded=Math.round(n);
    return rounded.toLocaleString('en-US',{maximumFractionDigits:0});
  }
  function pct(n, digits=0){ if(!isFinite(n)) return '-'; return n.toFixed(digits)+'%'; }

  function updateDisplay(){ display.textContent = formatTime(elapsed); }
  function refreshRingStates(){
    if(!running){ logoGear.classList.remove('spinning'); return; }
    logoGear.classList.add('spinning');
  }
  function tick(){
    const now=performance.now();
    elapsed=now-startTime;
    updateDisplay();
    timerId=requestAnimationFrame(tick);
  }
  function start(){
    if(running) return;
    running=true;
    startTime=performance.now()-elapsed;
    timerId=requestAnimationFrame(tick);
    btnStart.textContent=t('btn.pause');
    refreshRingStates();
  }
  function pause(){
    if(!running) return;
    running=false;
    cancelAnimationFrame(timerId);
    timerId=null;
    btnStart.textContent=t('btn.start');
    refreshRingStates();
  }
  btnStart.addEventListener('click',()=>{ running?pause():start(); });

  function flashCard(){ timerCard.classList.add('flash'); setTimeout(()=>timerCard.classList.remove('flash'),120); }
  function vibrate(ms=18){ try{ if(navigator.vibrate) navigator.vibrate(ms); }catch(e){} }

  function ensureDefaults(){
    let proc=(processInput.value||'').trim();
    if(!proc){
      proc = currentLang==='es' ? 'Proceso 1' : 'Process 1';
      processInput.value=proc;
    }
    let mode=modeSelect.value||'CT';
    modeSelect.value=mode;
    return {proc,mode};
  }

  /* ====== VALID LAPS (exclude Blocked/Starved from stats & charts) ====== */
  function isExcludedStatus(status){
    const s = (status||'').trim().toLowerCase();
    if(!s) return false;
    // Exclude only Blocked/Starved equivalents (EN/ES)
    const excluded = [
      'blocked','starved',
      'bloqueado','falta material'
    ];
    return excluded.includes(s);
  }
  function filterValidLaps(arr){
    return (arr||[]).filter(l => !isExcludedStatus(l.status));
  }

  /* ================= WB DATA MODEL (SYNC + OVERRIDE) ================= */
  function defaultWbRow(){
    const globalHours = clamp(parseFloat(hInput.value)||8, 1, 24);
    const globalContract = clamp(parseFloat(pcdInput.value)||0, 0, 99999);
    const globalQ = clamp(parseFloat(effInput.value)||100, 0, 100);

    return {
      id: 'wb_' + Math.random().toString(36).slice(2,9),
      seq: 10,
      enabled: true,

      operation: '',
      opAuto: true,

      operators: 1,
      shifts: 1, // INFO ONLY (no multiplies minutes)
      hours: globalHours,
      hoursAuto: true,

      machines: 1,
      contractPcd: globalContract,
      contractAuto: true,

      lunchMin: 0, // EDITABLE per operation (min/day)
      changeoverMin: 0,
      cleanMin: 0,
      maintMin: 0,
      otherMin: 0,

      sharedMin: 0,

      udtValue: 0,
      udtUnit: 'min_day',

      scrapPct: 0,

      oeeA: 100,
      oeeP: 100,
      oeeQ: globalQ,
      qAuto: true,

      ctCurManual: null,
      ctWstManual: null,
      ctPotManual: null
    };
  }

  let wbRows = [];

  function loadWB(){
    try{
      const raw = localStorage.getItem(WB_KEY);
      if(!raw){ wbRows=[]; return; }
      const parsed = JSON.parse(raw);
      wbRows = Array.isArray(parsed) ? parsed : [];
    }catch(e){ wbRows=[]; }
  }
  function saveWB(){ try{ localStorage.setItem(WB_KEY, JSON.stringify(wbRows)); }catch(e){} }

  function applyGlobalToRow(row){
    const gHours = clamp(parseFloat(hInput.value)||8,1,24);
    const gContract = clamp(parseFloat(pcdInput.value)||0,0,99999);
    const gQ = clamp(parseFloat(effInput.value)||100,0,100);
    const gOp = (processInput.value||'').trim();

    if(row.opAuto) row.operation = gOp || row.operation;
    if(row.hoursAuto) row.hours = gHours;
    if(row.contractAuto) row.contractPcd = gContract;
    if(row.qAuto) row.oeeQ = gQ;
  }

  function ensureWbRowForOperation(opName){
    const op = (opName||'').trim();
    if(!op) return;

    let row = wbRows.find(r => (r.operation||'').trim() === op);
    if(!row){
      row = defaultWbRow();
      const maxSeq = wbRows.reduce((m,x)=>Math.max(m, parseFloat(x.seq)||0), 0);
      row.seq = (maxSeq||0) + 10;
      row.operation = op;
      row.opAuto = true;
      wbRows.push(row);
      saveWB();
    }
  }

  function addLap(manualData){
    const {proc,mode}=ensureDefaults();
    ensureWbRowForOperation(proc);

    const status='', note='';
    if(manualData){
      const {t1,t2,total}=manualData;
      laps.push({id:nextId++,process:proc,mode,status,note,t1,t2,total});
      renderAll();
      return;
    }
    const seconds=Math.max(elapsed/1000,0);
    if(mode==='CT'){
      laps.push({id:nextId++,process:proc,mode,status,note,t1:seconds,t2:0,total:seconds});
      elapsed=0; startTime=performance.now();
      updateDisplay(); pendingT1=null;
      renderAll();
      return;
    }
    if(pendingT1===null){
      pendingT1=seconds;
      elapsed=0; startTime=performance.now();
    }else{
      const t2=seconds, t1=pendingT1;
      laps.push({id:nextId++,process:proc,mode,status,note,t1,t2,total:t1+t2});
      pendingT1=null;
      elapsed=0; startTime=performance.now();
      updateDisplay();
      renderAll();
    }
  }

  btnLap.addEventListener('click',()=>{ flashCard(); vibrate(18); addLap(); });

  btnAddMan.addEventListener('click',()=>{
    const t1 = parseFloat(prompt(currentLang==='es'?'T1 (s)':'T1 (s)',''));
    const t2 = parseFloat(prompt(currentLang==='es'?'T2 (s)':'T2 (s)',''));
    if(isNaN(t1) && isNaN(t2)) return;
    const v1=isNaN(t1)?0:t1, v2=isNaN(t2)?0:t2;
    addLap({t1:v1,t2:v2,total:v1+v2});
  });

  btnReset.addEventListener('click',()=>{
    pause();
    elapsed=0; updateDisplay();
    laps=[]; nextId=1; pendingT1=null;
    renderAll();
  });

  modeSelect.addEventListener('change',()=>{ pendingT1=null; });

  function groupByProcess(){
    const map=new Map();
    laps.forEach(l=>{
      const key=l.process+'||'+l.mode;
      if(!map.has(key)) map.set(key,[]);
      map.get(key).push(l);
    });
    return map;
  }

  function percentile(values,p){
    const n=values.length;
    if(n===0) return NaN;
    if(n===1) return values[0];
    const idx=(n-1)*p;
    const lo=Math.floor(idx), hi=Math.ceil(idx);
    if(lo===hi) return values[lo];
    return values[lo]+(values[hi]-values[lo])*(idx-lo);
  }

  function calcStats(arr){
    if(!arr.length) return null;
    const values=arr.map(x=>x.total).slice().sort((a,b)=>a-b);
    const n=values.length;
    const mean=values.reduce((s,v)=>s+v,0)/n;
    const median=n%2?values[(n-1)/2]:(values[n/2-1]+values[n/2])/2;
    const min=values[0], max=values[n-1];
    const variance=values.reduce((s,v)=>s+Math.pow(v-mean,2),0)/(n-1||1);
    const std=Math.sqrt(variance);
    const p10=percentile(values,0.1);
    const p90=percentile(values,0.9);
    const cv=mean?std/mean:0;
    return {n,values,mean,median,min,max,std,p10,p90,cv};
  }

  function capFromCt(ctSeconds, view, hours, days){
    if(!ctSeconds || ctSeconds<=0) return 0;
    const perHour=3600/ctSeconds;
    if(view==='hour') return perHour;
    if(view==='day') return perHour*hours;
    return perHour*hours*days;
  }
  function contractUnitsFromPcd(pcd, view, hours, days){
    if(!pcd || pcd<=0) return 0;
    if(view==='hour') return (pcd/hours)||0;
    if(view==='day') return pcd;
    return pcd*days;
  }

  function sampleReqN(cv){
    const Z=1.96, targetError=0.03;
    if(!isFinite(cv) || cv<=0) return 10;
    let n = Math.ceil(Math.pow((Z*cv)/targetError,2));
    if(n<10) n=10;
    return n;
  }
  function estErrorPct(cv,n){
    const Z=1.96;
    if(!isFinite(cv) || cv<=0 || n<=0) return 0;
    return (Z*cv)/Math.sqrt(n)*100;
  }

  function setInfo(div, cls, text){
    div.className = 'info-line ' + cls;
    div.textContent = text;
  }

  function buildSampleLine(st){
    if(!st || st.n<3){
      return {
        cls:'sample-neutral',
        text:(currentLang==='es'
          ? `Tamaño de muestra (válida): ${st?st.n:0} / 3 – se requieren ≥3 vueltas válidas antes de estimar el error.`
          : `Sample size (valid): ${st?st.n:0} / 3 – need ≥3 valid laps before estimating error.`
        )
      };
    }
    const n=st.n;
    const cv=st.cv||0;
    const recN = sampleReqN(cv);
    const errPct = estErrorPct(cv,n);
    const ratio=n/recN;

    let cls='sample-warn', tail='';
    if(ratio<0.6){
      cls='sample-bad';
      tail = currentLang==='es'
        ? 'Muestra muy pequeña para ±3% – úsala solo como referencia.'
        : 'Sample too small for ±3% – use only as reference.';
    }else if(ratio<0.9){
      cls='sample-warn';
      tail = currentLang==='es'
        ? 'Casi suficiente para ±3% – un par de vueltas más ayudarán.'
        : 'Almost enough for ±3% – a couple more laps would help.';
    }else{
      cls='sample-good';
      tail = currentLang==='es'
        ? 'Tamaño de muestra suficiente para objetivo ±3%.'
        : 'Sample size is enough for ±3% target.';
    }

    const head = (currentLang==='es')
      ? `Tamaño de muestra (válida): ${n} / ${recN} · Error estimado: ±${errPct.toFixed(1)}% (95%) – `
      : `Sample size (valid): ${n} / ${recN} · Est. error: ±${errPct.toFixed(1)}% (95%) – `;

    return {cls, text: head + tail};
  }

  function updateContractSummary(){
    const groups=groupByProcess();
    const {proc,mode}=ensureDefaults();
    const key=proc+'||'+mode;
    const arrAll=groups.get(key)||[];
    const arrValid=filterValidLaps(arrAll);

    const eff=clamp(parseFloat(effInput.value)||100,0,100);
    const hours=clamp(parseFloat(hInput.value)||8,1,24);
    const days=clamp(parseInt(dInput.value)||5,1,7);
    const pcd=Math.max(0, parseFloat(pcdInput.value)||0);
    const view=capViewSel.value;

    if(!arrValid.length){
      const excludedCount = arrAll.length - arrValid.length;
      setInfo(contractSumLine1,'sample-neutral', currentLang==='es'
        ? `Sin muestras válidas para el proceso actual. (Excluidas: ${excludedCount})`
        : `No valid samples for current process. (Excluded: ${excludedCount})`);
      setInfo(contractSumLine2,'sample-neutral', currentLang==='es'
        ? 'Nota: Blocked/Starved no entran al cálculo.'
        : 'Note: Blocked/Starved do not enter stats.');
      setInfo(contractSumLine3,'sample-neutral', currentLang==='es' ? 'Contrato: —' : 'Contract: —');
      setInfo(contractSumLine4,'sample-neutral', currentLang==='es' ? 'Resultado: —' : 'Result: —');
      return;
    }

    const st=calcStats(arrValid);
    const contractUnits = contractUnitsFromPcd(pcd,view,hours,days);

    const capCur = capFromCt(st.median,view,hours,days)*(eff/100);
    const capPot = capFromCt(st.p10,view,hours,days)*(eff/100);
    const capWst = capFromCt(st.p90,view,hours,days)*(eff/100);

    setInfo(contractSumLine1,'sample-neutral',
      (currentLang==='es'
        ? `Proceso: ${proc} (${mode}) · Vista: ${view==='hour'?'hora':(view==='day'?'día':'semana')} · Eff: ${eff}%`
        : `Process: ${proc} (${mode}) · View: ${view} · Eff: ${eff}%`
      )
    );

    setInfo(contractSumLine2,'sample-neutral',
      (currentLang==='es'
        ? `Capacidad (Cur/Med): ${formatUnits(capCur)} | Pot (P10): ${formatUnits(capPot)} | Worst (P90): ${formatUnits(capWst)}`
        : `Capacity (Cur/Med): ${formatUnits(capCur)} | Pot (P10): ${formatUnits(capPot)} | Worst (P90): ${formatUnits(capWst)}`
      )
    );

    if(!contractUnits || contractUnits<=0){
      setInfo(contractSumLine3,'sample-neutral', currentLang==='es'
        ? 'Contrato: no cargado (Contract Cap = 0).'
        : 'Contract: not loaded (Contract Cap = 0).');
      setInfo(contractSumLine4,'sample-neutral', currentLang==='es'
        ? 'Resultado: define contrato para evaluar.'
        : 'Result: set a contract to evaluate.');
      return;
    }

    const pctVs = (capCur/contractUnits*100);
    const gap = capCur - contractUnits;

    let cls='sample-bad';
    let msg = currentLang==='es' ? 'No alcanza.' : 'Below target.';
    if(pctVs>=85 && pctVs<100){ cls='sample-warn'; msg = currentLang==='es' ? 'Muy justo.' : 'Tight.'; }
    if(pctVs>=100){ cls='sample-good'; msg = currentLang==='es' ? 'Cumple contrato.' : 'Meets contract.'; }

    setInfo(contractSumLine3, cls,
      (currentLang==='es'
        ? `Contrato: ${formatUnits(contractUnits)} · Cap@Eff: ${formatUnits(capCur)} · Gap: ${(gap>=0?'+':'')+formatUnits(gap)}`
        : `Contract: ${formatUnits(contractUnits)} · Cap@Eff: ${formatUnits(capCur)} · Gap: ${(gap>=0?'+':'')+formatUnits(gap)}`
      )
    );

    setInfo(contractSumLine4, cls,
      (currentLang==='es'
        ? `Resultado: ${pctVs.toFixed(0)}% vs contrato – ${msg}`
        : `Result: ${pctVs.toFixed(0)}% vs contract – ${msg}`
      )
    );
  }

  function updateSemaphores(){
    const groups=groupByProcess();
    const {proc,mode}=ensureDefaults();
    const key=proc+'||'+mode;
    const arrAll=groups.get(key)||[];
    const arr=filterValidLaps(arrAll);

    if(!arr.length){
      const excludedCount = arrAll.length - arr.length;
      const topMsg = currentLang==='es'
        ? `Aún no hay muestras válidas para el proceso actual. (Excluidas: ${excludedCount})`
        : `No valid samples yet for current process. (Excluded: ${excludedCount})`;
      setInfo(sampleInfoTop,'sample-neutral', topMsg);

      setInfo(sampleInfoFocus,'sample-neutral', topMsg);
      setInfo(stdInfoFocus,'sample-neutral', currentLang==='es' ? 'Std dev: — (—). Captura más vueltas válidas.' : 'Std dev: — (—). Capture more valid laps.');
      setInfo(distInfoFocus,'sample-neutral', currentLang==='es' ? 'Media vs Mediana: —. Captura más vueltas válidas.' : 'Mean vs Median: —. Capture more valid laps.');
      setInfo(contractInfoFocus,'sample-neutral', currentLang==='es'
        ? 'Sin contrato cargado – no se evalúa capacidad vs objetivo.'
        : 'No contract loaded – capacity vs target not evaluated.'
      );
      updateContractSummary();
      return;
    }

    const st=calcStats(arr);
    const sampleLine = buildSampleLine(st);
    setInfo(sampleInfoTop, sampleLine.cls, sampleLine.text);
    setInfo(sampleInfoFocus, sampleLine.cls, sampleLine.text);

    if(!st || st.n<3 || !isFinite(st.std)){
      setInfo(stdInfoFocus,'sample-neutral',
        currentLang==='es' ? 'Std dev: — (—). Captura más vueltas válidas.' : 'Std dev: — (—). Capture more valid laps.'
      );
    } else {
      const cvPct = st.cv*100;
      let cls = 'sample-good';
      let label = currentLang==='es' ? 'Variación baja.' : 'Low variation.';
      if(cvPct>=10 && cvPct<20){ cls='sample-warn'; label = currentLang==='es'?'Variación moderada.':'Moderate variation.'; }
      if(cvPct>=20){ cls='sample-bad'; label = currentLang==='es'?'Variación alta: proceso “nervioso”.':'High variation: process is “nervy”.'; }
      setInfo(stdInfoFocus, cls, `Std dev ≈ ${formatSecs(st.std)} s (${cvPct.toFixed(1)}%). ${label}`);
    }

    if(!st || st.n<3 || !isFinite(st.mean) || !isFinite(st.median) || st.mean===0){
      setInfo(distInfoFocus,'sample-neutral',
        currentLang==='es' ? 'Media vs Mediana: —. Captura más vueltas válidas.' : 'Mean vs Median: —. Capture more valid laps.'
      );
    } else {
      const diff = Math.abs(st.mean - st.median) / st.mean * 100;
      let cls='sample-good';
      let msg = currentLang==='es'
        ? 'Media y mediana cercanas – distribución cercana a normal.'
        : 'Mean and median are close – distribution near normal.';
      if(diff>=5 && diff<10){
        cls='sample-warn';
        msg = currentLang==='es'
          ? 'Media y mediana algo separadas – posible sesgo.'
          : 'Mean and median somewhat apart – possible skew.';
      }
      if(diff>=10){
        cls='sample-bad';
        msg = currentLang==='es'
          ? 'Media y mediana muy separadas – hay cola/sesgo fuerte.'
          : 'Mean and median far apart – strong skew/tail.';
      }
      setInfo(distInfoFocus, cls, `Mean ≈ ${formatSecs(st.mean)} s, Median ≈ ${formatSecs(st.median)} s. ${msg}`);
    }

    const eff=clamp(parseFloat(effInput.value)||100,0,100);
    const hours=clamp(parseFloat(hInput.value)||8,1,24);
    const days=clamp(parseInt(dInput.value)||5,1,7);
    const pcd=Math.max(0, parseFloat(pcdInput.value)||0);
    const view=capViewSel.value;

    const contractUnits = contractUnitsFromPcd(pcd,view,hours,days);
    if(!contractUnits || contractUnits<=0 || !st || st.n<1){
      setInfo(contractInfoFocus,'sample-neutral',
        currentLang==='es'
          ? 'Sin contrato cargado – no se evalúa capacidad vs objetivo.'
          : 'No contract loaded – capacity vs target not evaluated.'
      );
    } else {
      const capCur = capFromCt(st.median,view,hours,days)*(eff/100);
      const pctVs = (capCur/contractUnits*100);
      let cls='sample-bad';
      let msg = currentLang==='es' ? 'No alcanza.' : 'Below target.';
      if(pctVs>=85 && pctVs<100){ cls='sample-warn'; msg = currentLang==='es' ? 'Muy justo.' : 'Tight.'; }
      if(pctVs>=100){ cls='sample-good'; msg = currentLang==='es' ? 'Cumple contrato.' : 'Meets contract.'; }

      setInfo(contractInfoFocus, cls,
        (currentLang==='es'
          ? `Capacidad actual @${eff}%: ${formatUnits(capCur)} vs Contrato: ${formatUnits(contractUnits)} · ${pctVs.toFixed(0)}% – ${msg}`
          : `Current capacity @${eff}%: ${formatUnits(capCur)} vs Contract: ${formatUnits(contractUnits)} · ${pctVs.toFixed(0)}% – ${msg}`
        )
      );
    }

    updateContractSummary();
  }

  /* ===== REST OF SCRIPT continues in PART 2 ===== */
  function setMethodGuide(){
    const txtEN =
`How to use (quick):
1) Set Process + Mode.
2) Press Start, then LAP each cycle. In MLD: first LAP=T1 (machine), second LAP=T2 (load/unload).
3) IMPORTANT: If a lap is Blocked/Starved (or Bloqueado/Falta material), edit the row Status. Those laps stay in Raw Data but are excluded from stats + charts.
4) Use Contract Cap (pcs/day), Hours/Day, Days/Week and Efficiency % to evaluate capacity.

Stats:
- Median is used as "Current" because it is robust.
- P10 is "Potential" (best typical), P90 is "Worst" (bad typical).
- Sample Size / Error estimates your confidence. Target is ±3% at 95%.

WB (Capacity Planner):
- Gross min/day is limited to 1440 min/day.
- Shifts is informational only (WB does NOT multiply minutes by shifts).
- Lunch is editable per operation (min/day).`;

    const txtES =
`Cómo usar (rápido):
1) Define Proceso + Modo.
2) Inicia y presiona VUELTA en cada ciclo. En MLD: 1ª vuelta=T1 (máquina), 2ª vuelta=T2 (carga/descarga).
3) IMPORTANTE: Si una vuelta fue Blocked/Starved (o Bloqueado/Falta material), edita el Estatus. Esas vueltas se quedan en Datos Crudos pero NO entran a estadística ni gráficas.
4) Usa Contrato (pzs/día), Horas/día, Días/semana y Eficiencia % para evaluar capacidad.

Estadística:
- Usamos Mediana como “Actual” (es robusta).
- P10 es “Potencial”, P90 es “Peor”.
- Tamaño de muestra / Error estima tu confianza. Meta: ±3% al 95%.

WB (Planeador de Capacidad):
- Min brutos/día limitado a 1440 min/día.
- Turnos es informativo (WB NO multiplica por turnos).
- Comida es editable por operación (min/día).`;

    methodGuideText.textContent = (currentLang==='es') ? txtES : txtEN;
  }

  /* ===================== RAW DATA EDIT/DELETE ===================== */
  function renderRawData(){
    dataBody.innerHTML='';
    laps.forEach((l,idx)=>{
      const tr=document.createElement('tr');

      const tdIdx=document.createElement('td'); tdIdx.textContent=(idx+1); tdIdx.style.textAlign='right';
      const tdP=document.createElement('td'); tdP.textContent=l.process;
      const tdM=document.createElement('td'); tdM.textContent=l.mode;

      const tdS=document.createElement('td');
      const sInp=document.createElement('input');
      sInp.value=l.status||'';
      sInp.className='wb-inp wide';
      sInp.addEventListener('input',()=>{ l.status=sInp.value; renderAll(); });
      tdS.appendChild(sInp);

      const tdN=document.createElement('td');
      const nInp=document.createElement('input');
      nInp.value=l.note||'';
      nInp.className='wb-inp wide';
      nInp.addEventListener('input',()=>{ l.note=nInp.value; });
      tdN.appendChild(nInp);

      const tdT1=document.createElement('td'); tdT1.textContent=formatSecs(l.t1);
      const tdT2=document.createElement('td'); tdT2.textContent=formatSecs(l.t2);
      const tdTot=document.createElement('td'); tdTot.textContent=formatSecs(l.total);

      const tdE=document.createElement('td');
      const bE=document.createElement('button');
      bE.textContent=t('col.edit'); bE.className='btn-edit';
      bE.addEventListener('click',()=>{
        const newProc = prompt(currentLang==='es'?'Proceso:':'Process:', l.process);
        if(newProc!==null) l.process=(newProc||'').trim()||l.process;
        const newMode = prompt(currentLang==='es'?'Modo (CT/MLD):':'Mode (CT/MLD):', l.mode);
        if(newMode!==null){
          const m=(newMode||'').trim().toUpperCase();
          if(m==='CT' || m==='MLD') l.mode=m;
        }
        const nt1 = parseFloat(prompt('T1 (s):', String(l.t1||0)));
        const nt2 = parseFloat(prompt('T2 (s):', String(l.t2||0)));
        if(!isNaN(nt1)) l.t1=nt1;
        if(!isNaN(nt2)) l.t2=nt2;
        l.total=(l.t1||0)+(l.t2||0);
        ensureWbRowForOperation(l.process);
        renderAll();
      });
      tdE.appendChild(bE);

      const tdD=document.createElement('td');
      const bD=document.createElement('button');
      bD.textContent=t('col.del'); bD.className='btn-del';
      bD.addEventListener('click',()=>{
        laps=laps.filter(x=>x.id!==l.id);
        renderAll();
      });
      tdD.appendChild(bD);

      tr.appendChild(tdIdx);
      tr.appendChild(tdP);
      tr.appendChild(tdM);
      tr.appendChild(tdS);
      tr.appendChild(tdN);
      tr.appendChild(tdT1);
      tr.appendChild(tdT2);
      tr.appendChild(tdTot);
      tr.appendChild(tdE);
      tr.appendChild(tdD);

      dataBody.appendChild(tr);
    });
  }

  /* ===================== STATS TABLES ===================== */
  function renderStatsTables(){
    const groups=groupByProcess();
    const eff=clamp(parseFloat(effInput.value)||100,0,100);
    const hours=clamp(parseFloat(hInput.value)||8,1,24);
    const days=clamp(parseInt(dInput.value)||5,1,7);
    const pcd=Math.max(0, parseFloat(pcdInput.value)||0);
    const view=capViewSel.value;

    // Focus: current process only
    focusBody.innerHTML='';
    const {proc,mode}=ensureDefaults();
    const key=proc+'||'+mode;
    const arrAll=groups.get(key)||[];
    const arr=filterValidLaps(arrAll);
    if(arr.length){
      const st=calcStats(arr);
      const contractUnits = contractUnitsFromPcd(pcd,view,hours,days);
      const capCur = capFromCt(st.median,view,hours,days)*(eff/100);
      const capPot = capFromCt(st.p10,view,hours,days)*(eff/100);
      const capWst = capFromCt(st.p90,view,hours,days)*(eff/100);

      const gap = contractUnits? (capCur-contractUnits): NaN;
      const pctVs = contractUnits? (capCur/contractUnits*100): NaN;

      const cvPct = st.cv*100;
      const cp = st.std>0 ? ( (st.p90-st.p10) / (6*st.std) ) : NaN; // simple proxy
      const cpk = cp; // keep simple

      const nLine = buildSampleLine(st).text;

      const note = (currentLang==='es')
        ? (cvPct>=20?'Variación alta.':'OK.')
        : (cvPct>=20?'High variation.':'OK.');

      const tr=document.createElement('tr');

      function td(txt, alignLeft=false){
        const td=document.createElement('td');
        td.textContent=txt;
        if(alignLeft) td.style.textAlign='left';
        return td;
      }
      tr.appendChild(td(proc,true));
      tr.appendChild(td(mode));
      tr.appendChild(td(String(st.n)));
      tr.appendChild(td(nLine, true));
      tr.appendChild(td(formatSecs(st.std)));
      tr.appendChild(td(cvPct.toFixed(1)));
      tr.appendChild(td(formatSecs(st.median)));
      tr.appendChild(td(formatSecs(st.p10)));
      tr.appendChild(td(formatSecs(st.p90)));
      tr.appendChild(td(formatUnits(capCur)));
      tr.appendChild(td(formatUnits(capPot)));
      tr.appendChild(td(formatUnits(capWst)));
      tr.appendChild(td(formatUnits(contractUnits)));
      tr.appendChild(td(isFinite(gap)?((gap>=0?'+':'')+formatUnits(gap)):'-'));
      tr.appendChild(td(isFinite(pctVs)?pctVs.toFixed(0):'-'));
      tr.appendChild(td(isFinite(cp)?cp.toFixed(2):'-'));
      tr.appendChild(td(isFinite(cpk)?cpk.toFixed(2):'-'));
      tr.appendChild(td(note,true));
      focusBody.appendChild(tr);
    }

    // Detailed stats table: all processes, valid only
    statsBody.innerHTML='';
    const rows=[];
    groups.forEach((arrAll, key)=>{
      const arr=filterValidLaps(arrAll);
      if(!arr.length) return;
      const st=calcStats(arr);
      const [p,m]=key.split('||');
      const cp = st.std>0 ? ( (st.p90-st.p10) / (6*st.std) ) : NaN;
      const cpk = cp;
      rows.push({p,m,st,cp,cpk});
    });
    rows.sort((a,b)=>a.p.localeCompare(b.p));
    rows.forEach(r=>{
      const tr=document.createElement('tr');
      const cvPct=r.st.cv*100;
      tr.innerHTML = `
        <td style="text-align:left">${r.p}</td>
        <td>${r.m}</td>
        <td>${r.st.n}</td>
        <td>${formatSecs(r.st.mean)}</td>
        <td>${formatSecs(r.st.median)}</td>
        <td>${formatSecs(r.st.p10)}</td>
        <td>${formatSecs(r.st.p90)}</td>
        <td>${formatSecs(r.st.min)}</td>
        <td>${formatSecs(r.st.max)}</td>
        <td>${formatSecs(r.st.std)}</td>
        <td>${cvPct.toFixed(1)}</td>
        <td>${isFinite(r.cp)?r.cp.toFixed(2):'-'}</td>
        <td>${isFinite(r.cpk)?r.cpk.toFixed(2):'-'}</td>
      `;
      statsBody.appendChild(tr);
    });
  }

  /* ===================== CHARTS (valid only) ===================== */
  let timeSeriesCtx = timeSeriesCanvas.getContext('2d');
  let histCtx = histCanvas.getContext('2d');

  function clearCanvas(ctx, canvas){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    // resize to actual CSS box for crisp
    const rect=canvas.getBoundingClientRect();
    const dpr=window.devicePixelRatio||1;
    canvas.width=Math.max(10,Math.floor(rect.width*dpr));
    canvas.height=Math.max(10,Math.floor(rect.height*dpr));
    ctx.setTransform(dpr,0,0,dpr,0,0);
    ctx.clearRect(0,0,rect.width,rect.height);
  }

  function drawAxes(ctx,w,h){
    ctx.globalAlpha=1;
    ctx.lineWidth=1;
    ctx.strokeStyle='rgba(255,255,255,.18)';
    ctx.beginPath();
    ctx.moveTo(36,10); ctx.lineTo(36,h-26);
    ctx.lineTo(w-10,h-26);
    ctx.stroke();
  }

  function drawTimeSeries(values, mean, median, std){
    clearCanvas(timeSeriesCtx, timeSeriesCanvas);
    const rect=timeSeriesCanvas.getBoundingClientRect();
    const w=rect.width, h=rect.height;
    drawAxes(timeSeriesCtx,w,h);

    if(!values.length) return;

    const padL=36, padR=10, padT=10, padB=26;
    const plotW=w-padL-padR, plotH=h-padT-padB;

    const vMin=Math.min(...values, mean-3*std, median-3*std);
    const vMax=Math.max(...values, mean+3*std, median+3*std);
    const minY = isFinite(vMin)?vMin:Math.min(...values);
    const maxY = isFinite(vMax)?vMax:Math.max(...values);

    const y0=minY, y1=maxY;
    const xScale = (i)=> padL + (values.length===1? plotW/2 : (i/(values.length-1))*plotW);
    const yScale = (v)=> padT + (1-((v-y0)/(y1-y0||1)))*plotH;

    // line
    timeSeriesCtx.strokeStyle='rgba(255,255,255,.6)';
    timeSeriesCtx.lineWidth=1.5;
    timeSeriesCtx.beginPath();
    values.forEach((v,i)=>{
      const x=xScale(i), y=yScale(v);
      if(i===0) timeSeriesCtx.moveTo(x,y);
      else timeSeriesCtx.lineTo(x,y);
    });
    timeSeriesCtx.stroke();

    // markers
    timeSeriesCtx.fillStyle='rgba(255,255,255,.8)';
    values.forEach((v,i)=>{
      const x=xScale(i), y=yScale(v);
      timeSeriesCtx.beginPath(); timeSeriesCtx.arc(x,y,2.2,0,Math.PI*2); timeSeriesCtx.fill();
    });

    // mean, median, ±3σ (same neutral style)
    const lines = [
      {v:mean, a:.55},
      {v:median, a:.55},
      {v:mean+3*std, a:.35},
      {v:mean-3*std, a:.35}
    ].filter(o=>isFinite(o.v));
    lines.forEach(o=>{
      timeSeriesCtx.strokeStyle=`rgba(255,255,255,${o.a})`;
      timeSeriesCtx.lineWidth=1;
      const y=yScale(o.v);
      timeSeriesCtx.beginPath();
      timeSeriesCtx.moveTo(padL,y); timeSeriesCtx.lineTo(w-10,y);
      timeSeriesCtx.stroke();
    });

    // labels (simple)
    timeSeriesCtx.fillStyle='rgba(255,255,255,.6)';
    timeSeriesCtx.font='12px system-ui';
    timeSeriesCtx.fillText('s', 14, 18);
  }

  function drawHistogram(values, median, p10, p90){
    clearCanvas(histCtx, histCanvas);
    const rect=histCanvas.getBoundingClientRect();
    const w=rect.width, h=rect.height;
    drawAxes(histCtx,w,h);

    if(values.length<2) return;

    const padL=36, padR=10, padT=10, padB=26;
    const plotW=w-padL-padR, plotH=h-padT-padB;

    const min=Math.min(...values);
    const max=Math.max(...values);
    const bins = Math.max(6, Math.min(18, Math.round(Math.sqrt(values.length))));
    const binW=(max-min)/(bins||1) || 1;
    const counts=new Array(bins).fill(0);
    values.forEach(v=>{
      const idx=Math.min(bins-1, Math.max(0, Math.floor((v-min)/binW)));
      counts[idx]++;
    });
    const maxC=Math.max(...counts);

    // bars
    counts.forEach((c,i)=>{
      const x=padL + (i/bins)*plotW;
      const bw=(plotW/bins)*0.9;
      const bh=(c/(maxC||1))*plotH;
      const y=padT + (plotH-bh);
      histCtx.fillStyle='rgba(255,255,255,.35)';
      histCtx.fillRect(x,y,bw,bh);
    });

    // vertical markers: median / p10 / p90
    function xOf(v){ return padL + ((v-min)/(max-min||1))*plotW; }
    const markers=[median,p10,p90].filter(v=>isFinite(v));
    markers.forEach(v=>{
      const x=xOf(v);
      histCtx.strokeStyle='rgba(255,255,255,.65)';
      histCtx.lineWidth=1;
      histCtx.beginPath();
      histCtx.moveTo(x,padT); histCtx.lineTo(x,h-26);
      histCtx.stroke();
    });

    histCtx.fillStyle='rgba(255,255,255,.6)';
    histCtx.font='12px system-ui';
    histCtx.fillText('s', 14, 18);
  }

  function buildChartSelect(){
    const groups=groupByProcess();
    const items=[];
    groups.forEach((arrAll,key)=>{
      const arr=filterValidLaps(arrAll);
      if(arr.length<1) return;
      items.push(key);
    });
    items.sort();
    chartSelect.innerHTML='';
    items.forEach(k=>{
      const opt=document.createElement('option');
      opt.value=k;
      const [p,m]=k.split('||');
      opt.textContent=`${p} (${m})`;
      chartSelect.appendChild(opt);
    });

    if(items.length){
      const curKey = (ensureDefaults().proc+'||'+ensureDefaults().mode);
      const want = items.includes(curKey) ? curKey : items[0];
      chartSelect.value=want;
    }
  }

  function renderCharts(){
    const groups=groupByProcess();
    const key=chartSelect.value;
    if(!key){
      clearCanvas(timeSeriesCtx,timeSeriesCanvas);
      clearCanvas(histCtx,histCanvas);
      return;
    }
    const arrAll=groups.get(key)||[];
    const arr=filterValidLaps(arrAll);
    if(!arr.length){
      clearCanvas(timeSeriesCtx,timeSeriesCanvas);
      clearCanvas(histCtx,histCanvas);
      return;
    }
    const st=calcStats(arr);
    drawTimeSeries(st.values, st.mean, st.median, st.std);
    drawHistogram(st.values, st.median, st.p10, st.p90);
  }

  chartSelect.addEventListener('change', renderCharts);

  /* ===================== WB CALCULATIONS ===================== */
  function toNum(x, def=0){ const n=parseFloat(x); return isFinite(n)?n:def; }

  function calcWBRow(row){
    const days=clamp(parseInt(dInput.value)||5,1,7);

    // Gross minutes/day capped 1440. DO NOT multiply by shifts.
    const hours = clamp(toNum(row.hours,8), 0, 24);
    const grossMin = clamp(hours*60, 0, 1440);

    const lunch = clamp(toNum(row.lunchMin,0), 0, 1440);
    const chg   = clamp(toNum(row.changeoverMin,0), 0, 1440);
    const clean = clamp(toNum(row.cleanMin,0), 0, 1440);
    const maint = clamp(toNum(row.maintMin,0), 0, 1440);
    const other = clamp(toNum(row.otherMin,0), 0, 1440);
    const shared= clamp(toNum(row.sharedMin,0), 0, 1440);

    // Unplanned DT convert to min/day
    let udtMinDay=0;
    const udtVal=clamp(toNum(row.udtValue,0), 0, 999999);
    const unit=(row.udtUnit||'min_day');
    if(unit==='min_day') udtMinDay=udtVal;
    else if(unit==='min_week') udtMinDay=udtVal/(days||1);
    else if(unit==='pct') udtMinDay=grossMin*(udtVal/100);
    udtMinDay=clamp(udtMinDay,0,1440);

    let netMin = grossMin - lunch - chg - clean - maint - other - shared - udtMinDay;
    netMin = Math.max(0, netMin);

    // Yield
    const scrap=clamp(toNum(row.scrapPct,0), 0, 99.99);
    const yieldFrac = Math.max(0, 1 - scrap/100);

    // OEE
    const A=clamp(toNum(row.oeeA,100), 0, 100);
    const P=clamp(toNum(row.oeeP,100), 0, 100);
    const Q=clamp(toNum(row.oeeQ,100), 0, 100);
    const oeeFrac = (A/100)*(P/100)*(Q/100);

    // CTs (sec)
    const ctCur = toNum(row.ctCur, NaN);
    const ctWst = toNum(row.ctWst, NaN);
    const ctPot = toNum(row.ctPot, NaN);

    // Minutes available (total seconds) across machines
    const machines = Math.max(1, Math.floor(toNum(row.machines,1)));
    const totalAvailSec = netMin*60*machines;

    // Cap at 100% (cur) and Cap@OEE (cur)
    const cap100 = (isFinite(ctCur) && ctCur>0) ? (totalAvailSec/ctCur) : NaN;
    const capOee = isFinite(cap100) ? (cap100*oeeFrac) : NaN;

    // CT@OEE (cur)
    const ctCurOee = (isFinite(ctCur) && oeeFrac>0) ? (ctCur/oeeFrac) : NaN;

    // Contract + requirements (per day)
    const contract = Math.max(0, toNum(row.contractPcd,0));
    const inputReq = (yieldFrac>0) ? (contract / yieldFrac) : NaN;

    const pctVsContract = (contract>0 && isFinite(capOee)) ? (capOee/contract*100) : NaN;

    return {
      grossMin, netMin, udtMinDay,
      yieldFrac, oeeFrac, machines,
      ctCur, ctWst, ctPot, ctCurOee,
      cap100, capOee,
      contract, inputReq, pctVsContract
    };
  }

  function pullCtFromStatsForOp(opName){
    const groups=groupByProcess();
    // Prefer CT mode if exists, else MLD
    const keyCT = opName+'||CT';
    const keyMLD = opName+'||MLD';
    let arr = filterValidLaps(groups.get(keyCT)||[]);
    let mode='CT';
    if(!arr.length){ arr = filterValidLaps(groups.get(keyMLD)||[]); mode='MLD'; }
    if(!arr.length) return null;
    const st=calcStats(arr);
    return {mode, median:st.median, p10:st.p10, p90:st.p90};
  }

  function renderWB(){
    // Sync globals into rows respecting overrides
    wbRows.forEach(r=>applyGlobalToRow(r));
    wbRows.sort((a,b)=>(toNum(a.seq,0)-toNum(b.seq,0)));

    wbBody.innerHTML='';

    // Operators sum + constraints
    let opsSum=0;
    const evalRows=[];

    wbRows.forEach(row=>{
      const enabled=!!row.enabled;
      if(enabled) opsSum += Math.max(0, Math.floor(toNum(row.operators,0)));

      const st = pullCtFromStatsForOp((row.operation||'').trim());

      // CT fields: manual overrides win
      row.ctCur = isFinite(toNum(row.ctCurManual,NaN)) ? toNum(row.ctCurManual,NaN)
                : (st?st.median:NaN);
      row.ctWst = isFinite(toNum(row.ctWstManual,NaN)) ? toNum(row.ctWstManual,NaN)
                : (st?st.p90:NaN);
      row.ctPot = isFinite(toNum(row.ctPotManual,NaN)) ? toNum(row.ctPotManual,NaN)
                : (st?st.p10:NaN);

      const c = calcWBRow(row);
      if(enabled) evalRows.push({row, c});

      const tr=document.createElement('tr');

      function tdEl(el, alignLeft=false){
        const td=document.createElement('td');
        if(alignLeft) td.style.textAlign='left';
        td.appendChild(el); return td;
      }
      function tdTxt(txt, alignLeft=false){
        const td=document.createElement('td');
        td.textContent=txt;
        if(alignLeft) td.style.textAlign='left';
        return td;
      }

      // Seq
      const seqInp=document.createElement('input');
      seqInp.className='wb-inp slim';
      seqInp.value=row.seq;
      seqInp.addEventListener('input',()=>{ row.seq=toNum(seqInp.value,row.seq); saveWB(); renderWB(); });
      tr.appendChild(tdEl(seqInp));

      // Enabled
      const onChk=document.createElement('input');
      onChk.type='checkbox'; onChk.className='wb-chk';
      onChk.checked=enabled;
      onChk.addEventListener('change',()=>{ row.enabled=onChk.checked; saveWB(); renderWB(); });
      tr.appendChild(tdEl(onChk));

      // Operation
      const opInp=document.createElement('input');
      opInp.className='wb-inp wide';
      opInp.value=row.operation||'';
      opInp.addEventListener('input',()=>{
        row.operation=opInp.value;
        row.opAuto=false;
        saveWB();
        renderWB();
      });
      tr.appendChild(tdEl(opInp,true));

      // Operators
      const opersInp=document.createElement('input');
      opersInp.type='number'; opersInp.min='0';
      opersInp.className='wb-inp slim';
      opersInp.value=row.operators;
      opersInp.addEventListener('input',()=>{ row.operators=toNum(opersInp.value,0); saveWB(); renderWB(); });
      tr.appendChild(tdEl(opersInp));

      // Shifts (info only)
      const shInp=document.createElement('input');
      shInp.type='number'; shInp.min='1'; shInp.max='4';
      shInp.className='wb-inp slim';
      shInp.value=row.shifts;
      shInp.addEventListener('input',()=>{ row.shifts=toNum(shInp.value,1); saveWB(); renderWB(); });
      tr.appendChild(tdEl(shInp));

      // Hours/day
      const hrsInp=document.createElement('input');
      hrsInp.type='number'; hrsInp.min='0'; hrsInp.max='24'; hrsInp.step='0.5';
      hrsInp.className='wb-inp slim';
      hrsInp.value=row.hours;
      hrsInp.addEventListener('input',()=>{ row.hours=toNum(hrsInp.value,row.hours); row.hoursAuto=false; saveWB(); renderWB(); });
      tr.appendChild(tdEl(hrsInp));

      // Machines
      const macInp=document.createElement('input');
      macInp.type='number'; macInp.min='1';
      macInp.className='wb-inp slim';
      macInp.value=row.machines;
      macInp.addEventListener('input',()=>{ row.machines=toNum(macInp.value,1); saveWB(); renderWB(); });
      tr.appendChild(tdEl(macInp));

      // Contract
      const conInp=document.createElement('input');
      conInp.type='number'; conInp.min='0';
      conInp.className='wb-inp';
      conInp.value=row.contractPcd;
      conInp.addEventListener('input',()=>{ row.contractPcd=toNum(conInp.value,0); row.contractAuto=false; saveWB(); renderWB(); });
      tr.appendChild(tdEl(conInp));

      // Gross min/day (display)
      tr.appendChild(tdTxt(Math.round(c.grossMin).toString()));

      // Lunch min/day (editable per operation)
      const lunchInp=document.createElement('input');
      lunchInp.type='number'; lunchInp.min='0';
      lunchInp.className='wb-inp slim';
      lunchInp.value=row.lunchMin;
      lunchInp.addEventListener('input',()=>{ row.lunchMin=toNum(lunchInp.value,0); saveWB(); renderWB(); });
      tr.appendChild(tdEl(lunchInp));

      // Changeover/Clean/Maint/Other
      function mkMinInp(prop){
        const inp=document.createElement('input');
        inp.type='number'; inp.min='0';
        inp.className='wb-inp slim';
        inp.value=row[prop];
        inp.addEventListener('input',()=>{ row[prop]=toNum(inp.value,0); saveWB(); renderWB(); });
        return inp;
      }
      tr.appendChild(tdEl(mkMinInp('changeoverMin')));
      tr.appendChild(tdEl(mkMinInp('cleanMin')));
      tr.appendChild(tdEl(mkMinInp('maintMin')));
      tr.appendChild(tdEl(mkMinInp('otherMin')));

      // Shared
      tr.appendChild(tdEl(mkMinInp('sharedMin')));

      // UDT value + unit
      const udtInp=document.createElement('input');
      udtInp.type='number'; udtInp.min='0';
      udtInp.className='wb-inp slim';
      udtInp.value=row.udtValue;
      udtInp.addEventListener('input',()=>{ row.udtValue=toNum(udtInp.value,0); saveWB(); renderWB(); });
      tr.appendChild(tdEl(udtInp));

      const udtSel=document.createElement('select');
      udtSel.className='wb-sel';
      udtSel.innerHTML = `
        <option value="min_day">min/day</option>
        <option value="min_week">min/week</option>
        <option value="pct">%</option>
      `;
      udtSel.value=row.udtUnit||'min_day';
      udtSel.addEventListener('change',()=>{ row.udtUnit=udtSel.value; saveWB(); renderWB(); });
      tr.appendChild(tdEl(udtSel));

      // Net
      tr.appendChild(tdTxt(Math.round(c.netMin).toString()));

      // Scrap %
      const scInp=document.createElement('input');
      scInp.type='number'; scInp.min='0'; scInp.max='99.99'; scInp.step='0.1';
      scInp.className='wb-inp slim';
      scInp.value=row.scrapPct;
      scInp.addEventListener('input',()=>{ row.scrapPct=toNum(scInp.value,0); saveWB(); renderWB(); });
      tr.appendChild(tdEl(scInp));

      // Yield
      tr.appendChild(tdTxt((c.yieldFrac*100).toFixed(1)+'%'));

      // OEE A/P/Q + OEE
      function mkPctInp(prop, autoFlag){
        const inp=document.createElement('input');
        inp.type='number'; inp.min='0'; inp.max='100';
        inp.className='wb-inp slim';
        inp.value=row[prop];
        inp.addEventListener('input',()=>{
          row[prop]=toNum(inp.value,row[prop]);
          if(autoFlag) row[autoFlag]=false;
          saveWB(); renderWB();
        });
        return inp;
      }
      tr.appendChild(tdEl(mkPctInp('oeeA')));
      tr.appendChild(tdEl(mkPctInp('oeeP')));
      tr.appendChild(tdEl(mkPctInp('oeeQ','qAuto')));
      tr.appendChild(tdTxt((c.oeeFrac*100).toFixed(1)+'%'));

      // CT Current/Worst/Potential (editable overrides)
      function mkCtInp(propManual, fallbackVal){
        const inp=document.createElement('input');
        inp.type='number'; inp.min='0'; inp.step='0.1';
        inp.className='wb-inp';
        inp.value = isFinite(toNum(row[propManual],NaN)) ? row[propManual] : (isFinite(fallbackVal)?fallbackVal:'');
        inp.addEventListener('input',()=>{
          const v=toNum(inp.value,NaN);
          row[propManual] = isFinite(v) ? v : null;
          saveWB(); renderWB();
        });
        return inp;
      }
      tr.appendChild(tdEl(mkCtInp('ctCurManual', row.ctCur)));
      tr.appendChild(tdEl(mkCtInp('ctWstManual', row.ctWst)));
      tr.appendChild(tdEl(mkCtInp('ctPotManual', row.ctPot)));

      // CT@OEE
      tr.appendChild(tdTxt(isFinite(c.ctCurOee)?formatSecs(c.ctCurOee):'-'));

      // Cap 100% (cur/day)
      tr.appendChild(tdTxt(isFinite(c.cap100)?formatUnits(c.cap100):'-'));

      // Cap@OEE (cur/day)
      tr.appendChild(tdTxt(isFinite(c.capOee)?formatUnits(c.capOee):'-'));

      // % vs contract
      const pctTxt = isFinite(c.pctVsContract) ? c.pctVsContract.toFixed(0)+'%' : '-';
      tr.appendChild(tdTxt(pctTxt));

      // Input req for Contract
      tr.appendChild(tdTxt(isFinite(c.inputReq)?formatUnits(c.inputReq):'-'));

      // Actions
      const actWrap=document.createElement('div');
      actWrap.style.display='flex';
      actWrap.style.gap='6px';

      const bRelink=document.createElement('button');
      bRelink.className='btn-relink';
      bRelink.textContent='↺';
      bRelink.title = currentLang==='es'?'Vincular a Proceso actual':'Relink to current Process';
      bRelink.addEventListener('click',()=>{
        row.operation=(processInput.value||'').trim();
        row.opAuto=true;
        saveWB(); renderWB();
      });

      const bDel=document.createElement('button');
      bDel.className='btn-del';
      bDel.textContent='✕';
      bDel.title=currentLang==='es'?'Borrar fila':'Delete row';
      bDel.addEventListener('click',()=>{
        wbRows = wbRows.filter(r=>r.id!==row.id);
        saveWB(); renderWB();
      });

      actWrap.appendChild(bRelink);
      actWrap.appendChild(bDel);
      tr.appendChild(tdEl(actWrap));

      wbBody.appendChild(tr);
    });

    wbOperatorsSum.textContent = String(opsSum);

    // Constraints
    const rated = evalRows
      .map(x=>{
        const pct = x.c.pctVsContract;
        const op = (x.row.operation||'').trim() || '(blank)';
        return {op, pct, contract:x.c.contract, cap:x.c.capOee};
      })
      .filter(x=>isFinite(x.pct) && x.contract>0);

    rated.sort((a,b)=>a.pct-b.pct);

    const c1=rated[0];
    const c2=rated[1];

    if(!c1){
      wbConstraint.textContent='—';
      wbNextConstraint.textContent='—';
      wbConstraintNote.textContent = currentLang==='es'
        ? 'Carga contrato por operación para detectar la restricción.'
        : 'Load contract per operation to detect constraint.';
    }else{
      wbConstraint.textContent = `${c1.op} (${c1.pct.toFixed(0)}%)`;
      wbNextConstraint.textContent = c2 ? `${c2.op} (${c2.pct.toFixed(0)}%)` : '—';
      wbConstraintNote.textContent = (currentLang==='es')
        ? `Cap@OEE: ${formatUnits(c1.cap)} vs Contrato: ${formatUnits(c1.contract)}. El menor % vs contrato es la restricción.`
        : `Cap@OEE: ${formatUnits(c1.cap)} vs Contract: ${formatUnits(c1.contract)}. Lowest % vs contract is the constraint.`;
    }
  }

  btnWbAdd.addEventListener('click',()=>{
    const r=defaultWbRow();
    const maxSeq = wbRows.reduce((m,x)=>Math.max(m,toNum(x.seq,0)),0);
    r.seq = (maxSeq||0)+10;
    r.operation = '';
    r.opAuto = false;
    wbRows.push(r);
    saveWB();
    renderWB();
  });

  btnWbClear.addEventListener('click',()=>{
    wbRows=[];
    saveWB();
    renderWB();
  });

  /* ===================== COPY ===================== */
  function toTSV(rows){
    return rows.map(r=>r.map(x=>String(x).replace(/\t/g,' ')).join('\t')).join('\n');
  }

  btnCopyAll.addEventListener('click',()=>{
    const lines=[];
    lines.push(['TaktLab Export','']);
    lines.push(['Date', new Date().toISOString()]);
    lines.push(['Language', currentLang]);
    lines.push(['','']);

    // Raw data
    lines.push(['RAW DATA']);
    lines.push(['#','Process','Mode','Status','Note','T1(s)','T2(s)','Total(s)']);
    laps.forEach((l,i)=>lines.push([i+1,l.process,l.mode,l.status||'',l.note||'',formatSecs(l.t1),formatSecs(l.t2),formatSecs(l.total)]));
    lines.push(['','']);

    // Stats (valid only)
    lines.push(['STATS (valid only - excludes Blocked/Starved)']);
    lines.push(['Process','Mode','N','Mean','Median','P10','P90','Min','Max','Std','CV%']);
    const groups=groupByProcess();
    const keys=[...groups.keys()].sort();
    keys.forEach(k=>{
      const arr=filterValidLaps(groups.get(k)||[]);
      if(!arr.length) return;
      const st=calcStats(arr);
      const [p,m]=k.split('||');
      lines.push([p,m,st.n,formatSecs(st.mean),formatSecs(st.median),formatSecs(st.p10),formatSecs(st.p90),formatSecs(st.min),formatSecs(st.max),formatSecs(st.std),(st.cv*100).toFixed(1)]);
    });
    lines.push(['','']);

    // WB
    lines.push(['WB']);
    lines.push(['Seq','On','Operation','Operators','Shifts','Hours/day','Machines','Contract(pcs/day)','Gross(min/day)','Lunch','Changeover','5S','Maint','Other','Shared','UDT','UDT Unit','Net(min/day)','Scrap%','Yield%','A%','P%','Q%','OEE%','CT Cur','CT Worst','CT Pot','CT@OEE','Cap100 Cur/day','Cap@OEE Cur/day','% vs contract','Input req']);
    wbRows
      .slice()
      .sort((a,b)=>toNum(a.seq,0)-toNum(b.seq,0))
      .forEach(r=>{
        const c=calcWBRow(r);
        lines.push([
          r.seq, r.enabled?'1':'0', r.operation||'', r.operators, r.shifts, r.hours, r.machines, r.contractPcd,
          Math.round(c.grossMin), r.lunchMin, r.changeoverMin, r.cleanMin, r.maintMin, r.otherMin, r.sharedMin,
          r.udtValue, r.udtUnit,
          Math.round(c.netMin),
          r.scrapPct,
          (c.yieldFrac*100).toFixed(1),
          r.oeeA, r.oeeP, r.oeeQ,
          (c.oeeFrac*100).toFixed(1),
          isFinite(r.ctCur)?r.ctCur:'', isFinite(r.ctWst)?r.ctWst:'', isFinite(r.ctPot)?r.ctPot:'',
          isFinite(c.ctCurOee)?c.ctCurOee.toFixed(2):'',
          isFinite(c.cap100)?Math.round(c.cap100):'',
          isFinite(c.capOee)?Math.round(c.capOee):'',
          isFinite(c.pctVsContract)?c.pctVsContract.toFixed(0):'',
          isFinite(c.inputReq)?Math.round(c.inputReq):''
        ]);
      });

    const text=toTSV(lines);
    navigator.clipboard?.writeText(text);
  });

  btnCopySum.addEventListener('click',()=>{
    const {proc,mode}=ensureDefaults();
    const eff=clamp(parseFloat(effInput.value)||100,0,100);
    const hours=clamp(parseFloat(hInput.value)||8,1,24);
    const days=clamp(parseInt(dInput.value)||5,1,7);
    const pcd=Math.max(0, parseFloat(pcdInput.value)||0);
    const view=capViewSel.value;

    const groups=groupByProcess();
    const key=proc+'||'+mode;
    const arrAll=groups.get(key)||[];
    const arr=filterValidLaps(arrAll);

    let out='';
    out += `Process: ${proc} (${mode})\n`;
    out += `View: ${view} | Eff: ${eff}% | Hours/day: ${hours} | Days/week: ${days}\n`;
    out += `Excluded laps (Blocked/Starved): ${arrAll.length - arr.length}\n`;

    if(!arr.length){
      out += (currentLang==='es')
        ? 'No hay muestras válidas.\n'
        : 'No valid samples.\n';
    }else{
      const st=calcStats(arr);
      const contractUnits = contractUnitsFromPcd(pcd,view,hours,days);
      const capCur = capFromCt(st.median,view,hours,days)*(eff/100);
      const capPot = capFromCt(st.p10,view,hours,days)*(eff/100);
      const capWst = capFromCt(st.p90,view,hours,days)*(eff/100);

      out += `N(valid): ${st.n}\n`;
      out += `Median(Current): ${formatSecs(st.median)}s | P10(Potential): ${formatSecs(st.p10)}s | P90(Worst): ${formatSecs(st.p90)}s\n`;
      out += `Std: ${formatSecs(st.std)}s | CV: ${(st.cv*100).toFixed(1)}%\n`;
      out += `Capacity@Eff -> Cur: ${formatUnits(capCur)} | Pot: ${formatUnits(capPot)} | Worst: ${formatUnits(capWst)}\n`;
      out += `Contract: ${formatUnits(contractUnits)}\n`;
      if(contractUnits>0){
        out += `% vs contract (Cur): ${(capCur/contractUnits*100).toFixed(0)}%\n`;
      }
    }
    navigator.clipboard?.writeText(out);
  });

  /* ===================== INPUT LISTENERS ===================== */
  [processInput, modeSelect, effInput, pcdInput, hInput, dInput, capViewSel].forEach(el=>{
    el.addEventListener('input',()=>{
      ensureWbRowForOperation((processInput.value||'').trim());
      renderAll();
    });
    el.addEventListener('change',()=>{
      ensureWbRowForOperation((processInput.value||'').trim());
      renderAll();
    });
  });

  /* ===================== MASTER RENDER ===================== */
  function renderAll(){
    setMethodGuide();
    updateLangButtons();
    applyTranslations();

    // Ensure WB row for current process even if no laps yet
    ensureWbRowForOperation((processInput.value||'').trim());

    updateSemaphores();
    renderRawData();
    renderStatsTables();

    buildChartSelect();
    renderCharts();

    renderWB();
  }

  // Init
  loadWB();
  updateDisplay();
  setLanguage(currentLang);
  renderAll();

  // Resize charts
  window.addEventListener('resize',()=>{ renderCharts(); });
})();
</script>

</body>
</html>
