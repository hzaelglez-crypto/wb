<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TaktLab + WB</title>

<style>
/* =========================
   PALETA GENERAL
   ========================= */
:root{
  --bg-main:#e6e9ee;          /* gris claro oscuro */
  --card-blue:#dfefff;
  --card-green:#e2f4ec;
  --card-amber:#fff0d6;
  --card-red:#ffe2e7;
  --card-grey:#eef1f4;

  --border-blue:#7fb6ff;
  --border-green:#5fbf9f;
  --border-amber:#f2c14e;
  --border-red:#ff6b81;
  --border-grey:#9aa7b5;

  --text-main:#0b1220;
  --text-soft:#44546a;
  --text-muted:#6b7a90;

  --btn-blue:#39bdf5;
  --btn-green:#18c97a;
  --btn-amber:#f2c14e;
  --btn-red:#ff3355;
  --btn-grey:#7a8794;
}

/* =========================
   BASE
   ========================= */
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
  background:var(--bg-main);
  color:var(--text-main);
}

.page{
  max-width:1180px;
  margin:0 auto;
  padding:10px 12px 40px;
}

/* =========================
   CARDS / SECCIONES
   ========================= */
.section{
  border-radius:14px;
  padding:10px 12px 12px;
  margin-bottom:10px;
  border:4px solid;
  box-shadow:0 6px 16px rgba(0,0,0,.08);
}

.section.blue{background:var(--card-blue);border-color:var(--border-blue)}
.section.green{background:var(--card-green);border-color:var(--border-green)}
.section.amber{background:var(--card-amber);border-color:var(--border-amber)}
.section.red{background:var(--card-red);border-color:var(--border-red)}
.section.grey{background:var(--card-grey);border-color:var(--border-grey)}

.section-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:6px;
}

.section-title{
  font-size:.95rem;
  font-weight:900;
  letter-spacing:.03em;
}

/* =========================
   BOTONES
   ========================= */
.btn{
  border:none;
  border-radius:10px;
  padding:6px 10px;
  font-size:.72rem;
  font-weight:900;
  cursor:pointer;
  box-shadow:0 4px 10px rgba(0,0,0,.12);
}

.btn.blue{background:var(--btn-blue)}
.btn.green{background:var(--btn-green)}
.btn.amber{background:var(--btn-amber)}
.btn.red{background:var(--btn-red);color:#fff}
.btn.grey{background:var(--btn-grey);color:#fff}

.btn:active{
  transform:translateY(1px);
}

/* =========================
   INPUTS / SELECTS (COMPACTOS)
   ========================= */
input,select{
  background:#fff;
  border:1px solid #9fb3c8;
  border-radius:8px;
  padding:2px 6px;
  font-size:.7rem;
  height:24px;
  color:var(--text-main);
}

label{
  font-size:.65rem;
  font-weight:800;
  color:var(--text-soft);
  line-height:1.1;
}

/* =========================
   GRID UTIL
   ========================= */
.grid{
  display:grid;
  gap:6px;
}

.grid-2{grid-template-columns:repeat(2,1fr)}
.grid-3{grid-template-columns:repeat(3,1fr)}
.grid-4{grid-template-columns:repeat(4,1fr)}
.grid-6{grid-template-columns:repeat(6,1fr)}

/* =========================
   TABLAS COMPACTAS
   ========================= */
table{
  width:100%;
  border-collapse:collapse;
  font-size:.68rem;
}

th,td{
  padding:3px 5px;
  border-bottom:1px solid rgba(0,0,0,.12);
  white-space:nowrap;
  text-align:center;
}

th{
  background:rgba(255,255,255,.6);
  font-weight:900;
  color:var(--text-soft);
}

td.left,th.left{text-align:left}

/* =========================
   UTIL
   ========================= */
.small-note{
  font-size:.65rem;
  color:var(--text-muted);
  margin-top:4px;
}
</style>
</head>

<body>
<div class="page">

  <!-- =========================
       CONFIGURACIÓN DE MEDICIÓN
       ========================= -->
  <section class="section blue">
    <div class="section-header">
      <div class="section-title">Configuración de Medición</div>
    </div>

    <div class="grid grid-4">
      <div>
        <label>Proceso</label>
        <input type="text" placeholder="Nombre del proceso">
      </div>
      <div>
        <label>Modo</label>
        <select>
          <option>CT</option>
          <option>MLD</option>
        </select>
      </div>
      <div>
        <label>Eficiencia %</label>
        <input type="number" value="100">
      </div>
      <div>
        <label>Contrato (pzs/día)</label>
        <input type="number">
      </div>
    </div>
  </section>

  <!-- =========================
       CONTROLES DE DATOS
       ========================= -->
  <section class="section green">
    <div class="section-header">
      <div class="section-title">Controles de Datos</div>
      <!-- ❌ SIN botón copiar aquí -->
    </div>

    <div class="grid grid-3">
      <button class="btn blue">Start</button>
      <button class="btn amber">Lap</button>
      <button class="btn red">Reset</button>
    </div>

    <div class="small-note">
      Start / Lap tienen retardo de 1s. Reset y copias usan retardo largo.
    </div>
  </section>

  <!-- =========================
       (LAS SIGUIENTES SECCIONES
       VIENEN EN PARTE 2)
       ========================= -->

</div>
</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TaktLab + WB</title>

<style>
:root{
  --bg-main:#e6e9ee;

  --card-blue:#dfefff;
  --card-green:#e2f4ec;
  --card-amber:#fff0d6;
  --card-red:#ffe2e7;
  --card-grey:#eef1f4;

  --border-blue:#7fb6ff;
  --border-green:#5fbf9f;
  --border-amber:#f2c14e;
  --border-red:#ff6b81;
  --border-grey:#9aa7b5;

  --text-main:#0b1220;
  --text-soft:#44546a;
  --text-muted:#6b7a90;

  --btn-blue:#39bdf5;
  --btn-green:#18c97a;
  --btn-amber:#f2c14e;
  --btn-red:#ff3355;
  --btn-grey:#7a8794;

  --shadow:0 6px 16px rgba(0,0,0,.08);
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
  background:var(--bg-main);
  color:var(--text-main);
}

.page{
  max-width:1180px;
  margin:0 auto;
  padding:10px 12px 40px;
}

.section{
  border-radius:14px;
  padding:10px 12px 12px;
  margin-bottom:10px;
  border:4px solid;
  box-shadow:var(--shadow);
}

.section.blue{background:var(--card-blue);border-color:var(--border-blue)}
.section.green{background:var(--card-green);border-color:var(--border-green)}
.section.amber{background:var(--card-amber);border-color:var(--border-amber)}
.section.red{background:var(--card-red);border-color:var(--border-red)}
.section.grey{background:var(--card-grey);border-color:var(--border-grey)}

.section-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:6px;
  gap:8px;
}

.section-title{
  font-size:.95rem;
  font-weight:900;
  letter-spacing:.03em;
}

.header-actions{
  display:flex;
  gap:6px;
  align-items:center;
}

.btn{
  border:none;
  border-radius:10px;
  padding:6px 10px;
  font-size:.72rem;
  font-weight:900;
  cursor:pointer;
  box-shadow:0 4px 10px rgba(0,0,0,.12);
  transition:transform .08s ease;
  user-select:none;
}
.btn.blue{background:var(--btn-blue)}
.btn.green{background:var(--btn-green)}
.btn.amber{background:var(--btn-amber)}
.btn.red{background:var(--btn-red);color:#fff}
.btn.grey{background:var(--btn-grey);color:#fff}

.btn:active{transform:translateY(1px)}
.btn[disabled]{opacity:.6;cursor:not-allowed}

.grid{display:grid;gap:6px}
.grid-2{grid-template-columns:repeat(2,1fr)}
.grid-3{grid-template-columns:repeat(3,1fr)}
.grid-4{grid-template-columns:repeat(4,1fr)}
.grid-6{grid-template-columns:repeat(6,1fr)}

.field{
  display:flex;
  flex-direction:column;
  gap:2px; /* ✅ compacto */
}

input,select,textarea{
  background:#fff;
  border:1px solid #9fb3c8;
  border-radius:8px;
  padding:2px 6px;
  font-size:.7rem;
  height:24px;
  color:var(--text-main);
}

textarea{
  height:84px;
  resize:vertical;
  padding:6px 8px;
  line-height:1.2;
}

label{
  font-size:.65rem;
  font-weight:900;
  color:var(--text-soft);
  line-height:1.05;
}

.small-note{
  font-size:.65rem;
  color:var(--text-muted);
  margin-top:4px;
}

.kpi-row{
  display:grid;
  grid-template-columns: 1.1fr .9fr;
  gap:8px;
  align-items:stretch;
}

.kpi{
  background:rgba(255,255,255,.65);
  border:1px solid rgba(0,0,0,.12);
  border-radius:12px;
  padding:8px 10px;
}

.kpi-title{
  font-size:.7rem;
  font-weight:900;
  color:var(--text-soft);
  margin-bottom:4px;
}

.kpi-value{
  font-size:1.35rem;
  font-weight:1000;
  letter-spacing:.02em;
}

.badge{
  display:inline-flex;
  align-items:center;
  gap:6px;
  font-size:.68rem;
  font-weight:900;
  color:#0b1220;
  background:rgba(255,255,255,.7);
  border:1px solid rgba(0,0,0,.12);
  border-radius:999px;
  padding:4px 8px;
}

.help{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width:18px;height:18px;
  border-radius:999px;
  font-weight:1000;
  border:1px solid rgba(0,0,0,.25);
  background:rgba(255,255,255,.7);
  cursor:help;
  font-size:.7rem;
}

.tooltip{
  position:relative;
  display:inline-flex;
  align-items:center;
  gap:6px;
}
.tooltip .tip{
  position:absolute;
  right:0;
  top:24px;
  width:min(420px, 86vw);
  background:#0b1220;
  color:#fff;
  padding:10px 10px;
  border-radius:10px;
  font-size:.72rem;
  line-height:1.25;
  box-shadow:0 10px 25px rgba(0,0,0,.25);
  display:none;
  z-index:10;
}
.tooltip:hover .tip{display:block}

hr.sep{
  border:none;
  border-top:1px dashed rgba(0,0,0,.18);
  margin:10px 0;
}
</style>
</head>

<body>
<div class="page">

  <!-- =========================
       CONFIGURACIÓN DE MEDICIÓN
       ========================= -->
  <section class="section blue" id="sec-config">
    <div class="section-header">
      <div class="section-title">Configuración de Medición</div>
      <div class="header-actions">
        <button class="btn grey" id="copy-config" data-delay="6">Copiar</button>
      </div>
    </div>

    <div class="grid grid-4">
      <div class="field">
        <label>Proceso</label>
        <input id="procName" type="text" placeholder="Nombre del proceso">
      </div>

      <div class="field">
        <label>Modo</label>
        <select id="modeSel">
          <option value="CT">CT</option>
          <option value="MLD">MLD</option>
        </select>
      </div>

      <div class="field">
        <div class="tooltip">
          <label>Eficiencia %</label>
          <span class="help">?</span>
          <div class="tip">
            <b>Qué es:</b> factor de rendimiento real vs ideal.<br>
            <b>Cómo usar:</b> 100% si estás midiendo en “modo ideal”; si hay pérdidas típicas, usa 85–95%.<br>
            <b>Impacto:</b> ajusta capacidad disponible (no maquilla milagros).
          </div>
        </div>
        <input id="effPct" type="number" min="1" max="200" value="100">
      </div>

      <div class="field">
        <label>Contrato (pzs/día)</label>
        <input id="contractDay" type="number" min="0" step="1" value="0">
      </div>
    </div>
  </section>

  <!-- =========================
       CONTROLES DE DATOS (SIN COPIAR)
       ========================= -->
  <section class="section green" id="sec-controls">
    <div class="section-header">
      <div class="section-title">Controles de Datos</div>
      <div class="header-actions">
        <span class="badge" id="statusBadge">Listo</span>
      </div>
    </div>

    <div class="grid grid-3">
      <button class="btn blue" id="btnStart" data-delay="1">Start</button>
      <button class="btn amber" id="btnLap" data-delay="1">Lap</button>
      <button class="btn red" id="btnReset" data-delay="6">Reset</button>
    </div>

    <div class="small-note">
      Start y Lap tienen retardo de 1s. Reset, copiar y demás usan 6s (sí, es intencional… para que no le pegues como metralleta).
    </div>
  </section>

  <!-- =========================
       RESUMEN (básico por ahora)
       ========================= -->
  <section class="section amber" id="sec-summary">
    <div class="section-header">
      <div class="section-title">Resumen</div>
      <div class="header-actions">
        <button class="btn grey" id="copy-summary" data-delay="6">Copiar</button>
      </div>
    </div>

    <div class="kpi-row">
      <div class="kpi">
        <div class="kpi-title">Último Lap (s)</div>
        <div class="kpi-value" id="kpiLastLap">—</div>
      </div>
      <div class="kpi">
        <div class="kpi-title">Laps capturados</div>
        <div class="kpi-value" id="kpiCount">0</div>
      </div>
    </div>

    <div class="small-note" id="sampleNote">
      Muestras: 0 · Est. error: — (95%) · Referencia solamente
    </div>
  </section>

  <!-- =========================
       DATOS CRUDOS DE TIEMPO
       ========================= -->
  <section class="section grey" id="sec-raw">
    <div class="section-header">
      <div class="section-title">Datos Crudos de Tiempo</div>
      <div class="header-actions">
        <button class="btn grey" id="copy-raw" data-delay="6">Copiar</button>
      </div>
    </div>

    <div class="grid grid-2">
      <div class="field">
        <label>Laps (segundos, separados por coma)</label>
        <textarea id="rawTimes" placeholder="Ej: 12.3, 11.9, 12.1"></textarea>
      </div>
      <div class="field">
        <label>Registro automático</label>
        <textarea id="autoLog" readonly placeholder="Aquí se van agregando laps..."></textarea>
      </div>
    </div>

    <div class="small-note">
      Guía: cada Lap guarda <b>segundos</b>. Si pegas una lista manual, el análisis la toma igual.
    </div>
  </section>

  <!-- =========================
       WB – CONFIG / INPUTS
       ========================= -->
  <section class="section blue" id="sec-wb">
    <div class="section-header">
      <div class="section-title">WB – Inputs de Capacidad</div>
      <div class="header-actions">
        <button class="btn grey" id="copy-wb" data-delay="6">Copiar</button>
      </div>
    </div>

    <div class="grid grid-6">
      <div class="field">
        <label>Operadores</label>
        <select id="opsSel"></select>
      </div>

      <div class="field">
        <label>Shift</label>
        <select id="shiftSel"></select>
      </div>

      <div class="field">
        <label>Hours</label>
        <select id="hoursSel"></select>
      </div>

      <div class="field">
        <label>Machines</label>
        <select id="machinesSel"></select>
      </div>

      <div class="field">
        <label>Pzs/Op</label>
        <select id="pzsOpSel"></select>
      </div>

      <div class="field">
        <div class="tooltip">
          <label>Método & Guía</label>
          <span class="help">?</span>
          <div class="tip">
            <b>Qué es:</b> define cómo interpretas la medición para capacidad.<br>
            <b>Regla rápida:</b><br>
            • CT: tiempos por pieza (manual / semi).<br>
            • MLD: máquina + carga/descarga (automatizado).<br>
            <b>Tip:</b> si la gente discute “qué cuenta”, aquí se mata la discusión.
          </div>
        </div>
        <select id="methodSel">
          <option value="CT">CT – Tiempo por pieza</option>
          <option value="MLD">MLD – Máquina + Load/Unload</option>
        </select>
      </div>
    </div>

    <hr class="sep">

    <div class="grid grid-6">
      <div class="field">
        <label>Lunch (min)</label>
        <select id="lunchSel"></select>
      </div>
      <div class="field">
        <label>Changeover (min)</label>
        <select id="chgSel"></select>
      </div>
      <div class="field">
        <label>5s (min)</label>
        <select id="s5Sel"></select>
      </div>
      <div class="field">
        <label>Maintenance (min)</label>
        <select id="mntSel"></select>
      </div>
      <div class="field">
        <label>Other (min)</label>
        <select id="othSel"></select>
      </div>
      <div class="field">
        <label>Capacidad<br>compartida (min)</label>
        <select id="sharedSel"></select>
      </div>
    </div>

    <hr class="sep">

    <div class="grid grid-6">
      <div class="field">
        <label>Scrap %</label>
        <select id="scrapSel"></select>
      </div>
      <div class="field">
        <label>A %</label>
        <select id="aSel"></select>
      </div>
      <div class="field">
        <label>P %</label>
        <select id="pSel"></select>
      </div>
      <div class="field">
        <label>Q %</label>
        <select id="qSel"></select>
      </div>
      <div class="field">
        <label>DT no planeado (min)</label>
        <select id="dtSel"></select>
      </div>
      <div class="field">
        <label>—</label>
        <input type="text" value="(Cálculos en Parte 3)" readonly>
      </div>
    </div>

    <div class="small-note">
      Guía: DT no planeado va de <b>0 a 1440</b> de <b>5 en 5</b>. Pzs/Op va de <b>1 a 99</b>. Shared también es diario.
    </div>
  </section>

<script>
/* =========================================================
   UTILIDADES
   ========================================================= */
const $ = (id) => document.getElementById(id);

function setStatus(msg){
  $("statusBadge").textContent = msg;
}

async function delayedAction(btn, fn){
  const delaySec = Number(btn.dataset.delay || "6");
  const original = btn.textContent;
  btn.disabled = true;

  setStatus(`Procesando… (${delaySec}s)`);
  btn.textContent = `…${delaySec}s`;

  // cuenta regresiva visual
  for(let t = delaySec; t >= 1; t--){
    btn.textContent = `…${t}s`;
    await new Promise(r => setTimeout(r, 1000));
  }

  try{
    await fn();
    setStatus("Listo");
  }catch(e){
    console.error(e);
    setStatus("Error");
  }finally{
    btn.textContent = original;
    btn.disabled = false;
  }
}

function fillSelectRange(sel, start, end, step, formatter){
  for(let v = start; v <= end + 1e-9; v += step){
    const opt = document.createElement("option");
    const value = (Math.round(v*1000)/1000);
    opt.value = value;
    opt.textContent = formatter ? formatter(value) : String(value);
    sel.appendChild(opt);
  }
}

function fillSelectInt(sel, start, end){
  for(let v = start; v <= end; v++){
    const opt = document.createElement("option");
    opt.value = v;
    opt.textContent = v;
    sel.appendChild(opt);
  }
}

function readAllLaps(){
  // combina manual + auto
  const manual = $("rawTimes").value.trim();
  const auto = $("autoLog").value.trim();
  const combined = [manual, auto].filter(Boolean).join(",");
  if(!combined) return [];
  return combined
    .split(",")
    .map(s => Number(String(s).trim()))
    .filter(n => Number.isFinite(n) && n > 0);
}

function updateKPIs(){
  const laps = readAllLaps();
  $("kpiCount").textContent = String(laps.length);
  $("kpiLastLap").textContent = laps.length ? laps[laps.length-1].toFixed(2) : "—";

  // Nota simple de “error” (placeholder) — Parte 3 lo hace bien
  if(laps.length === 0){
    $("sampleNote").textContent = "Muestras: 0 · Est. error: — (95%) · Referencia solamente";
  }else{
    $("sampleNote").textContent = `Muestras: ${laps.length} · Est. error: (estimación completa en Parte 3) · Referencia`;
  }
}

async function copyText(text){
  await navigator.clipboard.writeText(text);
}

/* =========================================================
   RELLENO DE SELECTS (WB)
   ========================================================= */
(function initWB(){
  fillSelectInt($("opsSel"), 0, 10);
  fillSelectInt($("shiftSel"), 1, 4);
  fillSelectRange($("hoursSel"), 0, 24, 0.5, v => v.toFixed(1));
  fillSelectInt($("machinesSel"), 1, 50);
  fillSelectInt($("pzsOpSel"), 1, 99);

  // minutos (0 a 1440) para varios, excepto donde pediste 1 a 1440
  fillSelectRange($("lunchSel"), 0, 1440, 5, v => String(v));
  fillSelectRange($("chgSel"), 1, 1440, 5, v => String(v));
  fillSelectRange($("s5Sel"), 0, 1440, 5, v => String(v));
  fillSelectRange($("mntSel"), 1, 1440, 5, v => String(v));
  fillSelectRange($("othSel"), 0, 1440, 5, v => String(v));
  fillSelectRange($("sharedSel"), 0, 1440, 5, v => String(v));

  // porcentajes
  fillSelectRange($("scrapSel"), 0, 100, 1, v => `${v}%`);
  fillSelectRange($("aSel"), 0, 100, 1, v => `${v}%`);
  fillSelectRange($("pSel"), 0, 100, 1, v => `${v}%`);
  fillSelectRange($("qSel"), 0, 100, 1, v => `${v}%`);

  // DT no planeado 0–1440 de 5 en 5
  fillSelectRange($("dtSel"), 0, 1440, 5, v => String(v));

  // defaults decentes
  $("opsSel").value = "1";
  $("shiftSel").value = "1";
  $("hoursSel").value = "8.0";
  $("machinesSel").value = "1";
  $("pzsOpSel").value = "1";
  $("lunchSel").value = "30";
  $("chgSel").value = "0"; // no existe (porque empieza en 1) -> ajusto
  $("chgSel").value = "5";
  $("s5Sel").value = "0";
  $("mntSel").value = "5";
  $("othSel").value = "0";
  $("sharedSel").value = "0";
  $("scrapSel").value = "0";
  $("aSel").value = "100";
  $("pSel").value = "100";
  $("qSel").value = "100";
  $("dtSel").value = "0";
})();

/* =========================================================
   CRONÓMETRO SIMPLE (Start/Lap)
   ========================================================= */
let running = false;
let t0 = 0;

function nowMs(){ return performance.now(); }

function startTimer(){
  running = true;
  t0 = nowMs();
}

function lapTimer(){
  if(!running) return null;
  const dt = (nowMs() - t0) / 1000;
  t0 = nowMs();
  return dt;
}

function resetAll(){
  running = false;
  t0 = 0;
  $("rawTimes").value = "";
  $("autoLog").value = "";
  updateKPIs();
}

/* =========================================================
   EVENTOS (con delays)
   ========================================================= */
$("btnStart").addEventListener("click", (e)=>{
  delayedAction(e.currentTarget, async ()=>{
    startTimer();
  });
});

$("btnLap").addEventListener("click", (e)=>{
  delayedAction(e.currentTarget, async ()=>{
    const lap = lapTimer();
    if(lap == null) return;
    const cur = $("autoLog").value.trim();
    $("autoLog").value = cur ? (cur + ", " + lap.toFixed(2)) : lap.toFixed(2);
    updateKPIs();
  });
});

$("btnReset").addEventListener("click", (e)=>{
  delayedAction(e.currentTarget, async ()=>{
    resetAll();
  });
});

$("rawTimes").addEventListener("input", ()=> updateKPIs());

/* =========================================================
   COPIAR POR SECCIÓN (6s)
   ========================================================= */
function buildConfigText(){
  return [
    "=== Configuración de Medición ===",
    `Proceso: ${$("procName").value || ""}`,
    `Modo: ${$("modeSel").value}`,
    `Eficiencia %: ${$("effPct").value}`,
    `Contrato (pzs/día): ${$("contractDay").value}`,
  ].join("\n");
}

function buildSummaryText(){
  const laps = readAllLaps();
  return [
    "=== Resumen ===",
    `Laps: ${laps.length}`,
    `Último Lap (s): ${laps.length ? laps[laps.length-1].toFixed(2) : ""}`,
    $("sampleNote").textContent
  ].join("\n");
}

function buildRawText(){
  return [
    "=== Datos Crudos de Tiempo ===",
    `Manual: ${$("rawTimes").value.trim()}`,
    `Auto: ${$("autoLog").value.trim()}`
  ].join("\n");
}

function buildWBText(){
  return [
    "=== WB – Inputs de Capacidad ===",
    `Operadores: ${$("opsSel").value}`,
    `Shift: ${$("shiftSel").value}`,
    `Hours: ${$("hoursSel").value}`,
    `Machines: ${$("machinesSel").value}`,
    `Pzs/Op: ${$("pzsOpSel").value}`,
    `Método: ${$("methodSel").value}`,
    "",
    `Lunch (min): ${$("lunchSel").value}`,
    `Changeover (min): ${$("chgSel").value}`,
    `5s (min): ${$("s5Sel").value}`,
    `Maintenance (min): ${$("mntSel").value}`,
    `Other (min): ${$("othSel").value}`,
    `Capacidad compartida (min): ${$("sharedSel").value}`,
    "",
    `Scrap %: ${$("scrapSel").value}`,
    `A %: ${$("aSel").value}`,
    `P %: ${$("pSel").value}`,
    `Q %: ${$("qSel").value}`,
    `DT no planeado (min): ${$("dtSel").value}`,
  ].join("\n");
}

$("copy-config").addEventListener("click", (e)=>{
  delayedAction(e.currentTarget, async ()=>{
    await copyText(buildConfigText());
  });
});

$("copy-summary").addEventListener("click", (e)=>{
  delayedAction(e.currentTarget, async ()=>{
    await copyText(buildSummaryText());
  });
});

$("copy-raw").addEventListener("click", (e)=>{
  delayedAction(e.currentTarget, async ()=>{
    await copyText(buildRawText());
  });
});

$("copy-wb").addEventListener("click", (e)=>{
  delayedAction(e.currentTarget, async ()=>{
    await copyText(buildWBText());
  });
});

// inicial
updateKPIs();
</script>

</div>
</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TaktLab + WB</title>

<style>
:root{
  --bg-main:#e6e9ee;

  --card-blue:#dfefff;
  --card-green:#e2f4ec;
  --card-amber:#fff0d6;
  --card-red:#ffe2e7;
  --card-grey:#eef1f4;

  --border-blue:#7fb6ff;
  --border-green:#5fbf9f;
  --border-amber:#f2c14e;
  --border-red:#ff6b81;
  --border-grey:#9aa7b5;

  --text-main:#0b1220;
  --text-soft:#44546a;
  --text-muted:#6b7a90;

  --btn-blue:#39bdf5;
  --btn-green:#18c97a;
  --btn-amber:#f2c14e;
  --btn-red:#ff3355;
  --btn-grey:#7a8794;

  --shadow:0 6px 16px rgba(0,0,0,.08);
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
  background:var(--bg-main);
  color:var(--text-main);
}

.page{
  max-width:1180px;
  margin:0 auto;
  padding:10px 12px 40px;
}

.section{
  border-radius:14px;
  padding:10px 12px 12px;
  margin-bottom:10px;
  border:4px solid;
  box-shadow:var(--shadow);
}

.section.blue{background:var(--card-blue);border-color:var(--border-blue)}
.section.green{background:var(--card-green);border-color:var(--border-green)}
.section.amber{background:var(--card-amber);border-color:var(--border-amber)}
.section.red{background:var(--card-red);border-color:var(--border-red)}
.section.grey{background:var(--card-grey);border-color:var(--border-grey)}

.section-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:6px;
  gap:8px;
}

.section-title{
  font-size:.95rem;
  font-weight:900;
  letter-spacing:.03em;
}

.header-actions{
  display:flex;
  gap:6px;
  align-items:center;
}

.btn{
  border:none;
  border-radius:10px;
  padding:6px 10px;
  font-size:.72rem;
  font-weight:900;
  cursor:pointer;
  box-shadow:0 4px 10px rgba(0,0,0,.12);
  transition:transform .08s ease;
  user-select:none;
}
.btn.blue{background:var(--btn-blue)}
.btn.green{background:var(--btn-green)}
.btn.amber{background:var(--btn-amber)}
.btn.red{background:var(--btn-red);color:#fff}
.btn.grey{background:var(--btn-grey);color:#fff}

.btn:active{transform:translateY(1px)}
.btn[disabled]{opacity:.6;cursor:not-allowed}

.grid{display:grid;gap:6px}
.grid-2{grid-template-columns:repeat(2,1fr)}
.grid-3{grid-template-columns:repeat(3,1fr)}
.grid-4{grid-template-columns:repeat(4,1fr)}
.grid-6{grid-template-columns:repeat(6,1fr)}

.field{
  display:flex;
  flex-direction:column;
  gap:2px; /* compacto */
}

input,select,textarea{
  background:#fff;
  border:1px solid #9fb3c8;
  border-radius:8px;
  padding:2px 6px;
  font-size:.7rem;
  height:24px;
  color:var(--text-main);
}

textarea{
  height:84px;
  resize:vertical;
  padding:6px 8px;
  line-height:1.2;
}

label{
  font-size:.65rem;
  font-weight:900;
  color:var(--text-soft);
  line-height:1.05;
}

.small-note{
  font-size:.65rem;
  color:var(--text-muted);
  margin-top:4px;
}

.kpi-row{
  display:grid;
  grid-template-columns: 1.1fr .9fr;
  gap:8px;
  align-items:stretch;
}

.kpi{
  background:rgba(255,255,255,.65);
  border:1px solid rgba(0,0,0,.12);
  border-radius:12px;
  padding:8px 10px;
}

.kpi-title{
  font-size:.7rem;
  font-weight:900;
  color:var(--text-soft);
  margin-bottom:4px;
}

.kpi-value{
  font-size:1.35rem;
  font-weight:1000;
  letter-spacing:.02em;
}

.badge{
  display:inline-flex;
  align-items:center;
  gap:6px;
  font-size:.68rem;
  font-weight:900;
  color:#0b1220;
  background:rgba(255,255,255,.7);
  border:1px solid rgba(0,0,0,.12);
  border-radius:999px;
  padding:4px 8px;
}

.badge.good{border-color:rgba(24,201,122,.55)}
.badge.bad{border-color:rgba(255,51,85,.6)}
.badge.warn{border-color:rgba(242,193,78,.75)}

.help{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width:18px;height:18px;
  border-radius:999px;
  font-weight:1000;
  border:1px solid rgba(0,0,0,.25);
  background:rgba(255,255,255,.7);
  cursor:help;
  font-size:.7rem;
}

.tooltip{
  position:relative;
  display:inline-flex;
  align-items:center;
  gap:6px;
}
.tooltip .tip{
  position:absolute;
  right:0;
  top:24px;
  width:min(460px, 90vw);
  background:#0b1220;
  color:#fff;
  padding:10px 10px;
  border-radius:10px;
  font-size:.72rem;
  line-height:1.25;
  box-shadow:0 10px 25px rgba(0,0,0,.25);
  display:none;
  z-index:10;
}
.tooltip:hover .tip{display:block}

hr.sep{
  border:none;
  border-top:1px dashed rgba(0,0,0,.18);
  margin:10px 0;
}

.tablelike{
  display:grid;
  grid-template-columns: 1.1fr .9fr .9fr .9fr;
  gap:6px;
}
.cell{
  background:rgba(255,255,255,.6);
  border:1px solid rgba(0,0,0,.12);
  border-radius:10px;
  padding:8px 10px;
}
.cell .t{font-size:.68rem;font-weight:900;color:var(--text-soft)}
.cell .v{font-size:1.05rem;font-weight:1000;margin-top:2px}
</style>
</head>

<body>
<div class="page">

  <!-- =========================
       CONFIGURACIÓN DE MEDICIÓN
       ========================= -->
  <section class="section blue" id="sec-config">
    <div class="section-header">
      <div class="section-title">Configuración de Medición</div>
      <div class="header-actions">
        <button class="btn grey" id="copy-config" data-delay="6">Copiar</button>
      </div>
    </div>

    <div class="grid grid-4">
      <div class="field">
        <label>Proceso</label>
        <input id="procName" type="text" placeholder="Nombre del proceso">
      </div>

      <div class="field">
        <label>Modo</label>
        <select id="modeSel">
          <option value="CT">CT</option>
          <option value="MLD">MLD</option>
        </select>
      </div>

      <div class="field">
        <div class="tooltip">
          <label>Eficiencia %</label>
          <span class="help">?</span>
          <div class="tip">
            <b>Qué es:</b> factor de rendimiento real vs ideal.<br>
            <b>Cómo usar:</b> 100% si estás midiendo “limpio”. Si hay pérdidas típicas, usa 85–95%.<br>
            <b>Impacto:</b> reduce capacidad sin inventar magia (o sea, como debe ser).
          </div>
        </div>
        <input id="effPct" type="number" min="1" max="200" value="100">
      </div>

      <div class="field">
        <label>Contrato (pzs/día)</label>
        <input id="contractDay" type="number" min="0" step="1" value="0">
      </div>
    </div>
  </section>

  <!-- =========================
       CONTROLES DE DATOS (SIN COPIAR)
       ========================= -->
  <section class="section green" id="sec-controls">
    <div class="section-header">
      <div class="section-title">Controles de Datos</div>
      <div class="header-actions">
        <span class="badge" id="statusBadge">Listo</span>
      </div>
    </div>

    <div class="grid grid-3">
      <button class="btn blue" id="btnStart" data-delay="1">Start</button>
      <button class="btn amber" id="btnLap" data-delay="1">Lap</button>
      <button class="btn red" id="btnReset" data-delay="6">Reset</button>
    </div>

    <div class="small-note">
      Start y Lap: <b>1s</b>. Reset / Copiar / demás: <b>6s</b>.
    </div>
  </section>

  <!-- =========================
       RESUMEN
       ========================= -->
  <section class="section amber" id="sec-summary">
    <div class="section-header">
      <div class="section-title">Resumen</div>
      <div class="header-actions">
        <button class="btn grey" id="copy-summary" data-delay="6">Copiar</button>
      </div>
    </div>

    <div class="kpi-row">
      <div class="kpi">
        <div class="kpi-title">Último Lap (s)</div>
        <div class="kpi-value" id="kpiLastLap">—</div>
      </div>
      <div class="kpi">
        <div class="kpi-title">Laps capturados</div>
        <div class="kpi-value" id="kpiCount">0</div>
      </div>
    </div>

    <div class="small-note" id="sampleNote">
      Samples: 0 / — · Est. error: — (95%) – Sample too small for ±3% – use only as reference.
    </div>
  </section>

  <!-- =========================
       DATOS CRUDOS DE TIEMPO
       ========================= -->
  <section class="section grey" id="sec-raw">
    <div class="section-header">
      <div class="section-title">Datos Crudos de Tiempo</div>
      <div class="header-actions">
        <button class="btn grey" id="copy-raw" data-delay="6">Copiar</button>
      </div>
    </div>

    <div class="grid grid-2">
      <div class="field">
        <label>Laps (segundos, separados por coma)</label>
        <textarea id="rawTimes" placeholder="Ej: 12.3, 11.9, 12.1"></textarea>
      </div>
      <div class="field">
        <label>Registro automático</label>
        <textarea id="autoLog" readonly placeholder="Aquí se van agregando laps..."></textarea>
      </div>
    </div>

    <div class="small-note">
      Guía: cada Lap guarda <b>segundos</b>. Si pegas una lista manual, el análisis la toma igual.
    </div>
  </section>

  <!-- =========================
       WB – INPUTS
       ========================= -->
  <section class="section blue" id="sec-wb">
    <div class="section-header">
      <div class="section-title">WB – Inputs de Capacidad</div>
      <div class="header-actions">
        <button class="btn grey" id="copy-wb" data-delay="6">Copiar</button>
      </div>
    </div>

    <div class="grid grid-6">
      <div class="field">
        <label>Operadores</label>
        <select id="opsSel"></select>
      </div>

      <div class="field">
        <label>Shift</label>
        <select id="shiftSel"></select>
      </div>

      <div class="field">
        <label>Hours</label>
        <select id="hoursSel"></select>
      </div>

      <div class="field">
        <label>Machines</label>
        <select id="machinesSel"></select>
      </div>

      <div class="field">
        <div class="tooltip">
          <label>Pzs/Op</label>
          <span class="help">?</span>
          <div class="tip">
            <b>Qué es:</b> cuántas piezas representa <b>cada “ciclo”</b> medido.<br>
            Ejemplo: si tu Lap representa 2 piezas (dual), pon 2.<br>
            Si cada Lap es 1 pieza, pon 1.
          </div>
        </div>
        <select id="pzsOpSel"></select>
      </div>

      <div class="field">
        <div class="tooltip">
          <label>Método & Guía</label>
          <span class="help">?</span>
          <div class="tip">
            <b>CT:</b> tiempo por pieza (manual / semi).<br>
            <b>MLD:</b> máquina + load/unload (automatizado).<br>
            Aquí se define <b>la interpretación</b> (para que no haya “yo creí que…”).
          </div>
        </div>
        <select id="methodSel">
          <option value="CT">CT – Tiempo por pieza</option>
          <option value="MLD">MLD – Máquina + Load/Unload</option>
        </select>
      </div>
    </div>

    <hr class="sep">

    <div class="grid grid-6">
      <div class="field">
        <label>Lunch (min)</label>
        <select id="lunchSel"></select>
      </div>
      <div class="field">
        <label>Changeover (min)</label>
        <select id="chgSel"></select>
      </div>
      <div class="field">
        <label>5s (min)</label>
        <select id="s5Sel"></select>
      </div>
      <div class="field">
        <label>Maintenance (min)</label>
        <select id="mntSel"></select>
      </div>
      <div class="field">
        <label>Other (min)</label>
        <select id="othSel"></select>
      </div>
      <div class="field">
        <label>Capacidad<br>compartida (min)</label>
        <select id="sharedSel"></select>
      </div>
    </div>

    <hr class="sep">

    <div class="grid grid-6">
      <div class="field">
        <label>Scrap %</label>
        <select id="scrapSel"></select>
      </div>
      <div class="field">
        <label>A %</label>
        <select id="aSel"></select>
      </div>
      <div class="field">
        <label>P %</label>
        <select id="pSel"></select>
      </div>
      <div class="field">
        <label>Q %</label>
        <select id="qSel"></select>
      </div>
      <div class="field">
        <label>DT no planeado (min)</label>
        <select id="dtSel"></select>
      </div>
      <div class="field">
        <label>—</label>
        <input type="text" value="Cálculos abajo" readonly>
      </div>
    </div>

    <div class="small-note">
      DT no planeado: <b>0–1440</b> de <b>5 en 5</b>. Pzs/Op: <b>1–99</b>.
    </div>
  </section>

  <!-- =========================
       CONTRACT vs CAPACITY SUMMARY (ANTES de Stats)
       ========================= -->
  <section class="section green" id="sec-cap">
    <div class="section-header">
      <div class="section-title">Contract vs Capacity Summary</div>
      <div class="header-actions">
        <button class="btn grey" id="copy-cap" data-delay="6">Copiar</button>
        <span class="badge" id="capBadge">—</span>
      </div>
    </div>

    <div class="tablelike">
      <div class="cell">
        <div class="t">Available time (min/day)</div>
        <div class="v" id="capAvailMin">—</div>
      </div>
      <div class="cell">
        <div class="t">Median CT (s)</div>
        <div class="v" id="capMedian">—</div>
      </div>
      <div class="cell">
        <div class="t">Gross capacity (pzs/day)</div>
        <div class="v" id="capGross">—</div>
      </div>
      <div class="cell">
        <div class="t">Net capacity (pzs/day)</div>
        <div class="v" id="capNet">—</div>
      </div>

      <div class="cell">
        <div class="t">Contract (pzs/day)</div>
        <div class="v" id="capContract">—</div>
      </div>
      <div class="cell">
        <div class="t">Gap vs contract</div>
        <div class="v" id="capGap">—</div>
      </div>
      <div class="cell">
        <div class="t">Yield factors</div>
        <div class="v" id="capYield">—</div>
      </div>
      <div class="cell">
        <div class="t">Notes</div>
        <div class="v" id="capNotes">—</div>
      </div>
    </div>

    <div class="small-note">
      “Gross” = sin yield. “Net” = aplica Scrap y A·P·Q. Si no hay laps, no hay magia: sale “—”.
    </div>
  </section>

  <!-- =========================
       STATS FOCUS
       ========================= -->
  <section class="section amber" id="sec-stats">
    <div class="section-header">
      <div class="section-title">Stats Focus</div>
      <div class="header-actions">
        <button class="btn grey" id="copy-stats" data-delay="6">Copiar</button>
      </div>
    </div>

    <div class="tablelike">
      <div class="cell">
        <div class="t">Mean (s)</div>
        <div class="v" id="stMean">—</div>
      </div>
      <div class="cell">
        <div class="t">Median (s)</div>
        <div class="v" id="stMedian">—</div>
      </div>
      <div class="cell">
        <div class="t">P10 / P90 (s)</div>
        <div class="v" id="stP1090">—</div>
      </div>
      <div class="cell">
        <div class="t">Std dev (s)</div>
        <div class="v" id="stStd">—</div>
      </div>

      <div class="cell">
        <div class="t">Samples</div>
        <div class="v" id="stN">—</div>
      </div>
      <div class="cell">
        <div class="t">95% error (±%)</div>
        <div class="v" id="stErr">—</div>
      </div>
      <div class="cell">
        <div class="t">Req. samples for ±3%</div>
        <div class="v" id="stNreq">—</div>
      </div>
      <div class="cell">
        <div class="t">Message</div>
        <div class="v" id="stMsg">—</div>
      </div>
    </div>

    <div class="small-note">
      Error calcula margen (95%) de la <b>media</b>. Para capacidad, usamos <b>mediana</b> (más robusta a outliers).
    </div>
  </section>

<script>
/* =========================================================
   UTILIDADES
   ========================================================= */
const $ = (id) => document.getElementById(id);

function setStatus(msg){
  $("statusBadge").textContent = msg;
}

async function delayedAction(btn, fn){
  const delaySec = Number(btn.dataset.delay || "6");
  const original = btn.textContent;
  btn.disabled = true;

  setStatus(`Procesando… (${delaySec}s)`);
  btn.textContent = `…${delaySec}s`;

  for(let t = delaySec; t >= 1; t--){
    btn.textContent = `…${t}s`;
    await new Promise(r => setTimeout(r, 1000));
  }

  try{
    await fn();
    setStatus("Listo");
  }catch(e){
    console.error(e);
    setStatus("Error");
  }finally{
    btn.textContent = original;
    btn.disabled = false;
  }
}

function fillSelectRange(sel, start, end, step, formatter){
  for(let v = start; v <= end + 1e-9; v += step){
    const opt = document.createElement("option");
    const value = (Math.round(v*1000)/1000);
    opt.value = value;
    opt.textContent = formatter ? formatter(value) : String(value);
    sel.appendChild(opt);
  }
}

function fillSelectInt(sel, start, end){
  for(let v = start; v <= end; v++){
    const opt = document.createElement("option");
    opt.value = v;
    opt.textContent = v;
    sel.appendChild(opt);
  }
}

function quantile(sorted, q){
  // sorted asc
  const n = sorted.length;
  if(n === 0) return NaN;
  if(n === 1) return sorted[0];
  const pos = (n - 1) * q;
  const base = Math.floor(pos);
  const rest = pos - base;
  if(sorted[base + 1] === undefined) return sorted[base];
  return sorted[base] + rest * (sorted[base + 1] - sorted[base]);
}

function mean(arr){
  if(!arr.length) return NaN;
  let s = 0;
  for(const x of arr) s += x;
  return s / arr.length;
}

function stdevSample(arr){
  const n = arr.length;
  if(n < 2) return NaN;
  const m = mean(arr);
  let ss = 0;
  for(const x of arr) ss += (x - m) * (x - m);
  return Math.sqrt(ss / (n - 1));
}

function readAllLaps(){
  const manual = $("rawTimes").value.trim();
  const auto = $("autoLog").value.trim();
  const combined = [manual, auto].filter(Boolean).join(",");
  if(!combined) return [];
  return combined
    .split(",")
    .map(s => Number(String(s).trim()))
    .filter(n => Number.isFinite(n) && n > 0);
}

function fmtNum(x, d=2){
  if(!Number.isFinite(x)) return "—";
  return x.toFixed(d);
}

function fmtInt(x){
  if(!Number.isFinite(x)) return "—";
  return Math.round(x).toString();
}

function safeNum(id){
  const v = Number($(id).value);
  return Number.isFinite(v) ? v : 0;
}

function updateBadge(el, type, text){
  el.classList.remove("good","bad","warn");
  if(type) el.classList.add(type);
  el.textContent = text;
}

/* =========================================================
   WB SELECTS INIT
   ========================================================= */
(function initWB(){
  fillSelectInt($("opsSel"), 0, 10);
  fillSelectInt($("shiftSel"), 1, 4);
  fillSelectRange($("hoursSel"), 0, 24, 0.5, v => v.toFixed(1));
  fillSelectInt($("machinesSel"), 1, 50);
  fillSelectInt($("pzsOpSel"), 1, 99);

  fillSelectRange($("lunchSel"), 0, 1440, 5, v => String(v));
  fillSelectRange($("chgSel"), 1, 1440, 5, v => String(v));
  fillSelectRange($("s5Sel"), 0, 1440, 5, v => String(v));
  fillSelectRange($("mntSel"), 1, 1440, 5, v => String(v));
  fillSelectRange($("othSel"), 0, 1440, 5, v => String(v));
  fillSelectRange($("sharedSel"), 0, 1440, 5, v => String(v));

  fillSelectRange($("scrapSel"), 0, 100, 1, v => `${v}%`);
  fillSelectRange($("aSel"), 0, 100, 1, v => `${v}%`);
  fillSelectRange($("pSel"), 0, 100, 1, v => `${v}%`);
  fillSelectRange($("qSel"), 0, 100, 1, v => `${v}%`);

  fillSelectRange($("dtSel"), 0, 1440, 5, v => String(v));

  // defaults
  $("opsSel").value = "1";
  $("shiftSel").value = "1";
  $("hoursSel").value = "8.0";
  $("machinesSel").value = "1";
  $("pzsOpSel").value = "1";
  $("lunchSel").value = "30";
  $("chgSel").value = "5";
  $("s5Sel").value = "0";
  $("mntSel").value = "5";
  $("othSel").value = "0";
  $("sharedSel").value = "0";
  $("scrapSel").value = "0";
  $("aSel").value = "100";
  $("pSel").value = "100";
  $("qSel").value = "100";
  $("dtSel").value = "0";
})();

/* =========================================================
   TIMER
   ========================================================= */
let running = false;
let t0 = 0;
function nowMs(){ return performance.now(); }

function startTimer(){
  running = true;
  t0 = nowMs();
}

function lapTimer(){
  if(!running) return null;
  const dt = (nowMs() - t0) / 1000;
  t0 = nowMs();
  return dt;
}

function resetAll(){
  running = false;
  t0 = 0;
  $("rawTimes").value = "";
  $("autoLog").value = "";
  recalcAll();
}

/* =========================================================
   STATS + CAPACITY ENGINE
   ========================================================= */
function computeStats(laps){
  const n = laps.length;
  if(n === 0) return null;

  const sorted = [...laps].sort((a,b)=>a-b);
  const m = mean(sorted);
  const med = quantile(sorted, 0.5);
  const p10 = quantile(sorted, 0.10);
  const p90 = quantile(sorted, 0.90);
  const s = stdevSample(sorted);

  // 95% margin of error of mean: approx z=1.96
  // (si quieres t exacto por n, lo meto en Parte 4)
  let errPct = NaN;
  if(Number.isFinite(s) && m > 0 && n > 1){
    const moe = 1.96 * (s / Math.sqrt(n));
    errPct = (moe / m) * 100;
  }

  // required sample size for ±3% mean error at 95% (aprox z)
  let nReq = NaN;
  if(Number.isFinite(s) && m > 0){
    const target = 0.03; // 3%
    const nCalc = Math.pow((1.96 * s) / (target * m), 2);
    nReq = Math.ceil(nCalc);
    if(nReq < 2) nReq = 2;
  }

  return {n, mean:m, median:med, p10, p90, stdev:s, errPct, nReq};
}

function computeCapacity(stats){
  // si no hay stats, no hay CT
  if(!stats || !Number.isFinite(stats.median) || stats.median <= 0){
    return null;
  }

  const shift = safeNum("shiftSel");
  const hours = safeNum("hoursSel");
  const machines = safeNum("machinesSel");
  const eff = safeNum("effPct") / 100;
  const pzsOp = safeNum("pzsOpSel");

  const lunch = safeNum("lunchSel");
  const chg = safeNum("chgSel");
  const s5 = safeNum("s5Sel");
  const mnt = safeNum("mntSel");
  const oth = safeNum("othSel");
  const shared = safeNum("sharedSel");
  const dt = safeNum("dtSel");

  const scrap = safeNum("scrapSel") / 100;
  const A = safeNum("aSel") / 100;
  const P = safeNum("pSel") / 100;
  const Q = safeNum("qSel") / 100;

  const totalMin = shift * hours * 60;
  const lossMin = lunch + chg + s5 + mnt + oth + shared + dt;
  const availMin = Math.max(0, totalMin - lossMin);

  const availSec = availMin * 60;

  // Gross cycles per day = available_seconds * eff * machines / median_seconds
  const cycles = (availSec * eff * machines) / stats.median;

  // piezas por op: cada ciclo equivale a N piezas
  const grossPzs = cycles * pzsOp;

  // yield: scrap + A*P*Q (OEE-ish)
  const oee = A * P * Q;
  const yieldNet = (1 - scrap) * oee;
  const netPzs = grossPzs * yieldNet;

  return {
    totalMin, lossMin, availMin,
    median: stats.median,
    grossPzs, netPzs,
    yieldNet, oee, scrap, A, P, Q
  };
}

function recalcAll(){
  const laps = readAllLaps();

  // KPIs
  $("kpiCount").textContent = String(laps.length);
  $("kpiLastLap").textContent = laps.length ? laps[laps.length-1].toFixed(2) : "—";

  // STATS
  const st = computeStats(laps);
  if(!st){
    $("stMean").textContent = "—";
    $("stMedian").textContent = "—";
    $("stP1090").textContent = "—";
    $("stStd").textContent = "—";
    $("stN").textContent = "—";
    $("stErr").textContent = "—";
    $("stNreq").textContent = "—";
    $("stMsg").textContent = "—";
    $("sampleNote").textContent = "Samples: 0 / — · Est. error: — (95%) – Sample too small for ±3% – use only as reference.";

    // CAP
    $("capAvailMin").textContent = "—";
    $("capMedian").textContent = "—";
    $("capGross").textContent = "—";
    $("capNet").textContent = "—";
    $("capContract").textContent = fmtInt(safeNum("contractDay"));
    $("capGap").textContent = "—";
    $("capYield").textContent = "—";
    $("capNotes").textContent = "Sin laps → sin CT.";
    updateBadge($("capBadge"), "warn", "No data");
    return;
  }

  $("stMean").textContent = fmtNum(st.mean, 2);
  $("stMedian").textContent = fmtNum(st.median, 2);
  $("stP1090").textContent = `${fmtNum(st.p10,2)} / ${fmtNum(st.p90,2)}`;
  $("stStd").textContent = fmtNum(st.stdev, 2);
  $("stN").textContent = `${st.n}`;

  const errTxt = Number.isFinite(st.errPct) ? `±${fmtNum(st.errPct,1)}%` : "—";
  $("stErr").textContent = errTxt;
  $("stNreq").textContent = Number.isFinite(st.nReq) ? `${st.nReq}` : "—";

  const nReqTxt = Number.isFinite(st.nReq) ? st.nReq : NaN;
  const msg =
    Number.isFinite(st.errPct) && Number.isFinite(nReqTxt)
      ? `Samples: ${st.n} / ${nReqTxt} · Est. error: ±${fmtNum(st.errPct,1)}% (95%) – ` +
        (st.n >= nReqTxt ? "OK for ±3% target." : "Sample too small for ±3% – use only as reference.")
      : `Samples: ${st.n} · Est. error: — (95%) – use only as reference.`;

  $("stMsg").textContent = msg;
  $("sampleNote").textContent = msg;

  // CAPACITY
  const cap = computeCapacity(st);
  const contract = safeNum("contractDay");

  if(!cap){
    $("capAvailMin").textContent = "—";
    $("capMedian").textContent = "—";
    $("capGross").textContent = "—";
    $("capNet").textContent = "—";
    $("capContract").textContent = fmtInt(contract);
    $("capGap").textContent = "—";
    $("capYield").textContent = "—";
    $("capNotes").textContent = "CT inválido.";
    updateBadge($("capBadge"), "warn", "Check CT");
    return;
  }

  $("capAvailMin").textContent = `${fmtInt(cap.availMin)} / ${fmtInt(cap.totalMin)} (loss ${fmtInt(cap.lossMin)})`;
  $("capMedian").textContent = fmtNum(cap.median, 2);

  $("capGross").textContent = fmtInt(cap.grossPzs);
  $("capNet").textContent = fmtInt(cap.netPzs);
  $("capContract").textContent = fmtInt(contract);

  const gap = cap.netPzs - contract;
  $("capGap").textContent = `${fmtInt(gap)} (${gap >= 0 ? "surplus" : "short"})`;

  const yieldPct = cap.yieldNet * 100;
  const oeePct = cap.oee * 100;
  $("capYield").textContent = `Yield ${fmtNum(yieldPct,1)}% · OEE ${fmtNum(oeePct,1)}% · Scrap ${fmtNum(cap.scrap*100,1)}%`;

  const effPct = safeNum("effPct");
  $("capNotes").textContent =
    `Calc: availSec*eff(${effPct}%) * machines / medianCT * pzsOp. ` +
    `Net aplica (1-scrap)*A*P*Q.`;

  if(contract <= 0){
    updateBadge($("capBadge"), "warn", "No contract");
  }else if(cap.netPzs >= contract){
    updateBadge($("capBadge"), "good", "OK");
  }else{
    updateBadge($("capBadge"), "bad", "Not OK");
  }
}

/* =========================================================
   EVENTOS
   ========================================================= */
$("btnStart").addEventListener("click", (e)=>{
  delayedAction(e.currentTarget, async ()=>{
    startTimer();
  });
});

$("btnLap").addEventListener("click", (e)=>{
  delayedAction(e.currentTarget, async ()=>{
    const lap = lapTimer();
    if(lap == null) return;
    const cur = $("autoLog").value.trim();
    $("autoLog").value = cur ? (cur + ", " + lap.toFixed(2)) : lap.toFixed(2);
    recalcAll();
  });
});

$("btnReset").addEventListener("click", (e)=>{
  delayedAction(e.currentTarget, async ()=>{
    resetAll();
  });
});

$("rawTimes").addEventListener("input", ()=> recalcAll());

// recalcular cuando cambie cualquier input WB/config
[
 "procName","modeSel","effPct","contractDay",
 "opsSel","shiftSel","hoursSel","machinesSel","pzsOpSel","methodSel",
 "lunchSel","chgSel","s5Sel","mntSel","othSel","sharedSel",
 "scrapSel","aSel","pSel","qSel","dtSel"
].forEach(id=>{
  $(id).addEventListener("change", ()=> recalcAll());
  $(id).addEventListener("input", ()=> recalcAll());
});

/* =========================================================
   COPIAR POR SECCIÓN
   ========================================================= */
async function copyText(text){
  await navigator.clipboard.writeText(text);
}

function buildConfigText(){
  return [
    "=== Configuración de Medición ===",
    `Proceso: ${$("procName").value || ""}`,
    `Modo: ${$("modeSel").value}`,
    `Eficiencia %: ${$("effPct").value}`,
    `Contrato (pzs/día): ${$("contractDay").value}`,
  ].join("\n");
}

function buildSummaryText(){
  const laps = readAllLaps();
  return [
    "=== Resumen ===",
    `Laps: ${laps.length}`,
    `Último Lap (s): ${laps.length ? laps[laps.length-1].toFixed(2) : ""}`,
    $("sampleNote").textContent
  ].join("\n");
}

function buildRawText(){
  return [
    "=== Datos Crudos de Tiempo ===",
    `Manual: ${$("rawTimes").value.trim()}`,
    `Auto: ${$("autoLog").value.trim()}`
  ].join("\n");
}

function buildWBText(){
  return [
    "=== WB – Inputs de Capacidad ===",
    `Operadores: ${$("opsSel").value}`,
    `Shift: ${$("shiftSel").value}`,
    `Hours: ${$("hoursSel").value}`,
    `Machines: ${$("machinesSel").value}`,
    `Pzs/Op: ${$("pzsOpSel").value}`,
    `Método: ${$("methodSel").value}`,
    "",
    `Lunch (min): ${$("lunchSel").value}`,
    `Changeover (min): ${$("chgSel").value}`,
    `5s (min): ${$("s5Sel").value}`,
    `Maintenance (min): ${$("mntSel").value}`,
    `Other (min): ${$("othSel").value}`,
    `Capacidad compartida (min): ${$("sharedSel").value}`,
    "",
    `Scrap %: ${$("scrapSel").value}`,
    `A %: ${$("aSel").value}`,
    `P %: ${$("pSel").value}`,
    `Q %: ${$("qSel").value}`,
    `DT no planeado (min): ${$("dtSel").value}`,
  ].join("\n");
}

function buildCapText(){
  return [
    "=== Contract vs Capacity Summary ===",
    `Available time (min/day): ${$("capAvailMin").textContent}`,
    `Median CT (s): ${$("capMedian").textContent}`,
    `Gross capacity (pzs/day): ${$("capGross").textContent}`,
    `Net capacity (pzs/day): ${$("capNet").textContent}`,
    `Contract (pzs/day): ${$("capContract").textContent}`,
    `Gap vs contract: ${$("capGap").textContent}`,
    `Yield factors: ${$("capYield").textContent}`,
    `Notes: ${$("capNotes").textContent}`
  ].join("\n");
}

function buildStatsText(){
  return [
    "=== Stats Focus ===",
    `Mean (s): ${$("stMean").textContent}`,
    `Median (s): ${$("stMedian").textContent}`,
    `P10/P90 (s): ${$("stP1090").textContent}`,
    `Std dev (s): ${$("stStd").textContent}`,
    `Samples: ${$("stN").textContent}`,
    `95% error (±%): ${$("stErr").textContent}`,
    `Req samples for ±3%: ${$("stNreq").textContent}`,
    `Message: ${$("stMsg").textContent}`
  ].join("\n");
}

$("copy-config").addEventListener("click", (e)=>{
  delayedAction(e.currentTarget, async ()=> copyText(buildConfigText()));
});
$("copy-summary").addEventListener("click", (e)=>{
  delayedAction(e.currentTarget, async ()=> copyText(buildSummaryText()));
});
$("copy-raw").addEventListener("click", (e)=>{
  delayedAction(e.currentTarget, async ()=> copyText(buildRawText()));
});
$("copy-wb").addEventListener("click", (e)=>{
  delayedAction(e.currentTarget, async ()=> copyText(buildWBText()));
});
$("copy-cap").addEventListener("click", (e)=>{
  delayedAction(e.currentTarget, async ()=> copyText(buildCapText()));
});
$("copy-stats").addEventListener("click", (e)=>{
  delayedAction(e.currentTarget, async ()=> copyText(buildStatsText()));
});

// init
recalcAll();
</script>

</div>
</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TaktLab + WB</title>

<style>
:root{
  --bg-main:#e6e9ee;

  --card-blue:#dfefff;
  --card-green:#e2f4ec;
  --card-amber:#fff0d6;
  --card-red:#ffe2e7;
  --card-grey:#eef1f4;

  --border-blue:#7fb6ff;
  --border-green:#5fbf9f;
  --border-amber:#f2c14e;
  --border-red:#ff6b81;
  --border-grey:#9aa7b5;

  --text-main:#0b1220;
  --text-soft:#44546a;
  --text-muted:#6b7a90;

  --btn-blue:#39bdf5;
  --btn-green:#18c97a;
  --btn-amber:#f2c14e;
  --btn-red:#ff3355;
  --btn-grey:#7a8794;

  --shadow:0 6px 16px rgba(0,0,0,.08);
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
  background:var(--bg-main);
  color:var(--text-main);
}
.page{
  max-width:1180px;
  margin:0 auto;
  padding:10px 12px 40px;
}
.section{
  border-radius:14px;
  padding:10px 12px 12px;
  margin-bottom:10px;
  border:4px solid;
  box-shadow:var(--shadow);
}
.section.blue{background:var(--card-blue);border-color:var(--border-blue)}
.section.green{background:var(--card-green);border-color:var(--border-green)}
.section.amber{background:var(--card-amber);border-color:var(--border-amber)}
.section.red{background:var(--card-red);border-color:var(--border-red)}
.section.grey{background:var(--card-grey);border-color:var(--border-grey)}

.section-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:6px;
  gap:8px;
}
.section-title{
  font-size:.95rem;
  font-weight:900;
  letter-spacing:.03em;
}
.header-actions{display:flex;gap:6px;align-items:center}

.btn{
  border:none;
  border-radius:10px;
  padding:6px 10px;
  font-size:.72rem;
  font-weight:900;
  cursor:pointer;
  box-shadow:0 4px 10px rgba(0,0,0,.12);
  transition:transform .08s ease;
  user-select:none;
}
.btn.blue{background:var(--btn-blue)}
.btn.green{background:var(--btn-green)}
.btn.amber{background:var(--btn-amber)}
.btn.red{background:var(--btn-red);color:#fff}
.btn.grey{background:var(--btn-grey);color:#fff}
.btn:active{transform:translateY(1px)}
.btn[disabled]{opacity:.6;cursor:not-allowed}

.grid{display:grid;gap:6px}
.grid-2{grid-template-columns:repeat(2,1fr)}
.grid-3{grid-template-columns:repeat(3,1fr)}
.grid-4{grid-template-columns:repeat(4,1fr)}
.grid-6{grid-template-columns:repeat(6,1fr)}

.field{display:flex;flex-direction:column;gap:2px}

input,select,textarea{
  background:#fff;
  border:1px solid #9fb3c8;
  border-radius:8px;
  padding:2px 6px;
  font-size:.7rem;
  height:22px; /* más compacto */
  color:var(--text-main);
}
textarea{
  height:84px;
  resize:vertical;
  padding:6px 8px;
  line-height:1.2;
}

label{
  font-size:.65rem;
  font-weight:900;
  color:var(--text-soft);
  line-height:1.05;
}

.small-note{
  font-size:.65rem;
  color:var(--text-muted);
  margin-top:4px;
}

.kpi-row{
  display:grid;
  grid-template-columns: 1.1fr .9fr;
  gap:8px;
  align-items:stretch;
}
.kpi{
  background:rgba(255,255,255,.65);
  border:1px solid rgba(0,0,0,.12);
  border-radius:12px;
  padding:8px 10px;
}
.kpi-title{
  font-size:.7rem;
  font-weight:900;
  color:var(--text-soft);
  margin-bottom:4px;
}
.kpi-value{
  font-size:1.35rem;
  font-weight:1000;
  letter-spacing:.02em;
}

.badge{
  display:inline-flex;
  align-items:center;
  gap:6px;
  font-size:.68rem;
  font-weight:900;
  color:#0b1220;
  background:rgba(255,255,255,.7);
  border:1px solid rgba(0,0,0,.12);
  border-radius:999px;
  padding:4px 8px;
}
.badge.good{border-color:rgba(24,201,122,.55)}
.badge.bad{border-color:rgba(255,51,85,.6)}
.badge.warn{border-color:rgba(242,193,78,.75)}

.help{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width:18px;height:18px;
  border-radius:999px;
  font-weight:1000;
  border:1px solid rgba(0,0,0,.25);
  background:rgba(255,255,255,.7);
  cursor:help;
  font-size:.7rem;
}
.tooltip{position:relative;display:inline-flex;align-items:center;gap:6px}
.tooltip .tip{
  position:absolute;
  right:0;
  top:24px;
  width:min(460px, 90vw);
  background:#0b1220;
  color:#fff;
  padding:10px 10px;
  border-radius:10px;
  font-size:.72rem;
  line-height:1.25;
  box-shadow:0 10px 25px rgba(0,0,0,.25);
  display:none;
  z-index:10;
}
.tooltip:hover .tip{display:block}

hr.sep{border:none;border-top:1px dashed rgba(0,0,0,.18);margin:10px 0}

.tablelike{
  display:grid;
  grid-template-columns: 1.1fr .9fr .9fr .9fr;
  gap:6px;
}
.cell{
  background:rgba(255,255,255,.6);
  border:1px solid rgba(0,0,0,.12);
  border-radius:10px;
  padding:8px 10px;
}
.cell .t{font-size:.68rem;font-weight:900;color:var(--text-soft)}
.cell .v{font-size:1.05rem;font-weight:1000;margin-top:2px}
</style>
</head>

<body>
<div class="page">

  <!-- CONFIGURACIÓN -->
  <section class="section blue" id="sec-config">
    <div class="section-header">
      <div class="section-title">Configuración de Medición</div>
      <div class="header-actions">
        <button class="btn grey" id="copy-config" data-delay="6">Copiar</button>
      </div>
    </div>

    <div class="grid grid-4">
      <div class="field">
        <label>Proceso</label>
        <input id="procName" type="text" placeholder="Nombre del proceso">
      </div>

      <div class="field">
        <label>Modo</label>
        <select id="modeSel">
          <option value="CT">CT</option>
          <option value="MLD">MLD</option>
        </select>
      </div>

      <div class="field">
        <div class="tooltip">
          <label>Eficiencia %</label><span class="help">?</span>
          <div class="tip">
            <b>Qué es:</b> factor de rendimiento real vs ideal.<br>
            <b>Cómo usar:</b> 100% si estás midiendo “limpio”. Si hay pérdidas típicas, usa 85–95%.<br>
            <b>Impacto:</b> reduce capacidad sin inventar magia.
          </div>
        </div>
        <input id="effPct" type="number" min="1" max="200" value="100">
      </div>

      <div class="field">
        <label>Contrato (pzs/día)</label>
        <input id="contractDay" type="number" min="0" step="1" value="0">
      </div>
    </div>
  </section>

  <!-- CONTROLES -->
  <section class="section green" id="sec-controls">
    <div class="section-header">
      <div class="section-title">Controles de Datos</div>
      <div class="header-actions">
        <span class="badge" id="statusBadge">Listo</span>
      </div>
    </div>

    <div class="grid grid-3">
      <button class="btn blue" id="btnStart" data-delay="1">Start</button>
      <button class="btn amber" id="btnLap" data-delay="1">Lap</button>
      <button class="btn red" id="btnReset" data-delay="6">Reset</button>
    </div>

    <div class="small-note">
      Start y Lap: <b>1s</b>. Reset / Copiar / demás: <b>6s</b>.
    </div>
  </section>

  <!-- RESUMEN -->
  <section class="section amber" id="sec-summary">
    <div class="section-header">
      <div class="section-title">Resumen</div>
      <div class="header-actions">
        <button class="btn grey" id="copy-summary" data-delay="6">Copiar</button>
      </div>
    </div>

    <div class="kpi-row">
      <div class="kpi">
        <div class="kpi-title">Último Lap (s)</div>
        <div class="kpi-value" id="kpiLastLap">—</div>
      </div>
      <div class="kpi">
        <div class="kpi-title">Laps capturados</div>
        <div class="kpi-value" id="kpiCount">0</div>
      </div>
    </div>

    <div class="small-note" id="sampleNote">
      Samples: 0 / — · Est. error: — (95%) – Sample too small for ±3% – use only as reference.
    </div>
  </section>

  <!-- DATOS CRUDOS -->
  <section class="section grey" id="sec-raw">
    <div class="section-header">
      <div class="section-title">Datos Crudos de Tiempo</div>
      <div class="header-actions">
        <button class="btn grey" id="copy-raw" data-delay="6">Copiar</button>
      </div>
    </div>

    <div class="grid grid-2">
      <div class="field">
        <label>Laps (segundos, separados por coma)</label>
        <textarea id="rawTimes" placeholder="Ej: 12.3, 11.9, 12.1"></textarea>
      </div>
      <div class="field">
        <label>Registro automático</label>
        <textarea id="autoLog" readonly placeholder="Aquí se van agregando laps..."></textarea>
      </div>
    </div>

    <div class="small-note">
      Guía: cada Lap guarda <b>segundos</b>. Si pegas una lista manual, el análisis la toma igual.
    </div>
  </section>

  <!-- WB INPUTS -->
  <section class="section blue" id="sec-wb">
    <div class="section-header">
      <div class="section-title">WB – Inputs de Capacidad</div>
      <div class="header-actions">
        <button class="btn grey" id="copy-wb" data-delay="6">Copiar</button>
      </div>
    </div>

    <div class="grid grid-6">
      <div class="field"><label>Operadores</label><select id="opsSel"></select></div>
      <div class="field"><label>Shift</label><select id="shiftSel"></select></div>
      <div class="field"><label>Hours</label><select id="hoursSel"></select></div>
      <div class="field"><label>Machines</label><select id="machinesSel"></select></div>

      <div class="field">
        <div class="tooltip">
          <label>Pzs/Op</label><span class="help">?</span>
          <div class="tip">
            <b>Qué es:</b> cuántas piezas representa <b>cada “ciclo”</b> medido.<br>
            Ej: dual → 2. Normal → 1.
          </div>
        </div>
        <select id="pzsOpSel"></select>
      </div>

      <div class="field">
        <div class="tooltip">
          <label>Método & Guía</label><span class="help">?</span>
          <div class="tip">
            <b>CT:</b> tiempo por pieza (manual/semi).<br>
            <b>MLD:</b> máquina + load/unload (automatizado).<br>
            Define interpretación para que no haya “yo pensé…”.
          </div>
        </div>
        <select id="methodSel">
          <option value="CT">CT – Tiempo por pieza</option>
          <option value="MLD">MLD – Máquina + Load/Unload</option>
        </select>
      </div>
    </div>

    <hr class="sep">

    <div class="grid grid-6">
      <div class="field"><label>Lunch (min)</label><select id="lunchSel"></select></div>
      <div class="field"><label>Changeover (min)</label><select id="chgSel"></select></div>
      <div class="field"><label>5s (min)</label><select id="s5Sel"></select></div>
      <div class="field"><label>Maintenance (min)</label><select id="mntSel"></select></div>
      <div class="field"><label>Other (min)</label><select id="othSel"></select></div>
      <div class="field"><label>Capacidad<br>compartida (min)</label><select id="sharedSel"></select></div>
    </div>

    <hr class="sep">

    <div class="grid grid-6">
      <div class="field"><label>Scrap %</label><select id="scrapSel"></select></div>
      <div class="field"><label>A %</label><select id="aSel"></select></div>
      <div class="field"><label>P %</label><select id="pSel"></select></div>
      <div class="field"><label>Q %</label><select id="qSel"></select></div>
      <div class="field"><label>DT no planeado (min)</label><select id="dtSel"></select></div>
      <div class="field"><label>—</label><input type="text" value="Cálculos abajo" readonly></div>
    </div>

    <div class="small-note">
      DT no planeado: <b>0–1440</b> de <b>5 en 5</b>. Pzs/Op: <b>1–99</b>.
    </div>
  </section>

  <!-- CONTRACT vs CAPACITY (ANTES DE STATS) -->
  <section class="section green" id="sec-cap">
    <div class="section-header">
      <div class="section-title">Contract vs Capacity Summary</div>
      <div class="header-actions">
        <button class="btn grey" id="copy-cap" data-delay="6">Copiar</button>
        <span class="badge" id="capBadge">—</span>
      </div>
    </div>

    <div class="tablelike">
      <div class="cell"><div class="t">Available time (min/day)</div><div class="v" id="capAvailMin">—</div></div>
      <div class="cell"><div class="t">Median CT (s)</div><div class="v" id="capMedian">—</div></div>
      <div class="cell"><div class="t">Gross capacity (pzs/day)</div><div class="v" id="capGross">—</div></div>
      <div class="cell"><div class="t">Net capacity (pzs/day)</div><div class="v" id="capNet">—</div></div>

      <div class="cell"><div class="t">Contract (pzs/day)</div><div class="v" id="capContract">—</div></div>
      <div class="cell"><div class="t">Gap vs contract</div><div class="v" id="capGap">—</div></div>
      <div class="cell"><div class="t">Yield factors</div><div class="v" id="capYield">—</div></div>
      <div class="cell"><div class="t">Notes</div><div class="v" id="capNotes">—</div></div>
    </div>

    <div class="small-note">
      “Gross” = sin yield. “Net” = aplica Scrap y A·P·Q. Si no hay laps, no hay magia.
    </div>
  </section>

  <!-- STATS -->
  <section class="section amber" id="sec-stats">
    <div class="section-header">
      <div class="section-title">Stats Focus</div>
      <div class="header-actions">
        <button class="btn grey" id="copy-stats" data-delay="6">Copiar</button>
      </div>
    </div>

    <div class="tablelike">
      <div class="cell"><div class="t">Mean (s)</div><div class="v" id="stMean">—</div></div>
      <div class="cell"><div class="t">Median (s)</div><div class="v" id="stMedian">—</div></div>
      <div class="cell"><div class="t">P10 / P90 (s)</div><div class="v" id="stP1090">—</div></div>
      <div class="cell"><div class="t">Std dev (s)</div><div class="v" id="stStd">—</div></div>

      <div class="cell"><div class="t">Samples</div><div class="v" id="stN">—</div></div>
      <div class="cell"><div class="t">95% error (±%)</div><div class="v" id="stErr">—</div></div>
      <div class="cell"><div class="t">Req. samples for ±3%</div><div class="v" id="stNreq">—</div></div>
      <div class="cell"><div class="t">Message</div><div class="v" id="stMsg">—</div></div>
    </div>

    <div class="small-note">
      Error usa <b>t-Student</b> (95%) para la <b>media</b>. Para capacidad usamos <b>mediana</b> (más robusta).
    </div>
  </section>

<script>
/* =========================
   UTILIDADES
   ========================= */
const $ = (id) => document.getElementById(id);

function setStatus(msg){ $("statusBadge").textContent = msg; }

async function delayedAction(btn, fn){
  const delaySec = Number(btn.dataset.delay || "6");
  const original = btn.textContent;
  btn.disabled = true;

  setStatus(`Procesando… (${delaySec}s)`);
  btn.textContent = `…${delaySec}s`;

  for(let t = delaySec; t >= 1; t--){
    btn.textContent = `…${t}s`;
    await new Promise(r => setTimeout(r, 1000));
  }

  try{ await fn(); setStatus("Listo"); }
  catch(e){ console.error(e); setStatus("Error"); }
  finally{ btn.textContent = original; btn.disabled = false; }
}

function fillSelectRange(sel, start, end, step, formatter){
  for(let v = start; v <= end + 1e-9; v += step){
    const opt = document.createElement("option");
    const value = (Math.round(v*1000)/1000);
    opt.value = value;
    opt.textContent = formatter ? formatter(value) : String(value);
    sel.appendChild(opt);
  }
}
function fillSelectInt(sel, start, end){
  for(let v = start; v <= end; v++){
    const opt = document.createElement("option");
    opt.value = v;
    opt.textContent = v;
    sel.appendChild(opt);
  }
}
function quantile(sorted, q){
  const n = sorted.length;
  if(n === 0) return NaN;
  if(n === 1) return sorted[0];
  const pos = (n - 1) * q;
  const base = Math.floor(pos);
  const rest = pos - base;
  if(sorted[base + 1] === undefined) return sorted[base];
  return sorted[base] + rest * (sorted[base + 1] - sorted[base]);
}
function mean(arr){
  if(!arr.length) return NaN;
  let s = 0;
  for(const x of arr) s += x;
  return s / arr.length;
}
function stdevSample(arr){
  const n = arr.length;
  if(n < 2) return NaN;
  const m = mean(arr);
  let ss = 0;
  for(const x of arr) ss += (x - m) * (x - m);
  return Math.sqrt(ss / (n - 1));
}

function readAllLaps(){
  const manual = $("rawTimes").value.trim();
  const auto = $("autoLog").value.trim();
  const combined = [manual, auto].filter(Boolean).join(",");
  if(!combined) return [];
  return combined.split(",")
    .map(s => Number(String(s).trim()))
    .filter(n => Number.isFinite(n) && n > 0);
}

function fmtNum(x, d=2){ return Number.isFinite(x) ? x.toFixed(d) : "—"; }
function fmtInt(x){ return Number.isFinite(x) ? Math.round(x).toString() : "—"; }
function safeNum(id){ const v = Number($(id).value); return Number.isFinite(v) ? v : 0; }

function updateBadge(el, type, text){
  el.classList.remove("good","bad","warn");
  if(type) el.classList.add(type);
  el.textContent = text;
}

/* =========================
   t-Student 95% (two-sided)
   - Usamos tabla (df 1..30) + puntos 40,60,120 + infinito.
   - Interpolación lineal simple para df intermedios.
   ========================= */
const T95 = [
  // df: t_(0.975,df)
  [1,12.706],[2,4.303],[3,3.182],[4,2.776],[5,2.571],[6,2.447],[7,2.365],[8,2.306],[9,2.262],[10,2.228],
  [11,2.201],[12,2.179],[13,2.160],[14,2.145],[15,2.131],[16,2.120],[17,2.110],[18,2.101],[19,2.093],[20,2.086],
  [21,2.080],[22,2.074],[23,2.069],[24,2.064],[25,2.060],[26,2.056],[27,2.052],[28,2.048],[29,2.045],[30,2.042],
  [40,2.021],[60,2.000],[120,1.980],[1e9,1.960] // infinito aprox
];

function tCritical95(df){
  if(!Number.isFinite(df) || df <= 1) return 12.706; // df=1
  // si exacto
  for(const [d,t] of T95) if(d === df) return t;
  // encontrar vecinos
  let lo = T95[0], hi = T95[T95.length-1];
  for(let i=0;i<T95.length-1;i++){
    const a = T95[i], b = T95[i+1];
    if(df >= a[0] && df <= b[0]){ lo=a; hi=b; break; }
  }
  const [d1,t1]=lo, [d2,t2]=hi;
  if(d2 === d1) return t1;
  const w = (df - d1) / (d2 - d1);
  return t1 + w*(t2 - t1);
}

/* =========================
   WB init
   ========================= */
(function initWB(){
  fillSelectInt($("opsSel"), 0, 10);
  fillSelectInt($("shiftSel"), 1, 4);
  fillSelectRange($("hoursSel"), 0, 24, 0.5, v => v.toFixed(1));
  fillSelectInt($("machinesSel"), 1, 50);
  fillSelectInt($("pzsOpSel"), 1, 99);

  fillSelectRange($("lunchSel"), 0, 1440, 5, v => String(v));
  fillSelectRange($("chgSel"), 1, 1440, 5, v => String(v));
  fillSelectRange($("s5Sel"), 0, 1440, 5, v => String(v));
  fillSelectRange($("mntSel"), 1, 1440, 5, v => String(v));
  fillSelectRange($("othSel"), 0, 1440, 5, v => String(v));
  fillSelectRange($("sharedSel"), 0, 1440, 5, v => String(v));

  fillSelectRange($("scrapSel"), 0, 100, 1, v => `${v}%`);
  fillSelectRange($("aSel"), 0, 100, 1, v => `${v}%`);
  fillSelectRange($("pSel"), 0, 100, 1, v => `${v}%`);
  fillSelectRange($("qSel"), 0, 100, 1, v => `${v}%`);

  fillSelectRange($("dtSel"), 0, 1440, 5, v => String(v));

  $("opsSel").value = "1";
  $("shiftSel").value = "1";
  $("hoursSel").value = "8.0";
  $("machinesSel").value = "1";
  $("pzsOpSel").value = "1";
  $("lunchSel").value = "30";
  $("chgSel").value = "5";
  $("s5Sel").value = "0";
  $("mntSel").value = "5";
  $("othSel").value = "0";
  $("sharedSel").value = "0";
  $("scrapSel").value = "0";
  $("aSel").value = "100";
  $("pSel").value = "100";
  $("qSel").value = "100";
  $("dtSel").value = "0";
})();

/* =========================
   TIMER
   ========================= */
let running = false;
let t0 = 0;
function nowMs(){ return performance.now(); }

function startTimer(){ running = true; t0 = nowMs(); }
function lapTimer(){
  if(!running) return null;
  const dt = (nowMs() - t0) / 1000;
  t0 = nowMs();
  return dt;
}
function resetAll(){
  running = false;
  t0 = 0;
  $("rawTimes").value = "";
  $("autoLog").value = "";
  recalcAll();
}

/* =========================
   STATS + CAPACITY
   ========================= */
function computeStats(laps){
  const n = laps.length;
  if(n === 0) return null;

  const sorted = [...laps].sort((a,b)=>a-b);
  const m = mean(sorted);
  const med = quantile(sorted, 0.5);
  const p10 = quantile(sorted, 0.10);
  const p90 = quantile(sorted, 0.90);
  const s = stdevSample(sorted);

  // 95% t-Student (two-sided) for mean
  let errPct = NaN;
  let tcrit = NaN;
  if(Number.isFinite(s) && m > 0 && n > 1){
    const df = n - 1;
    tcrit = tCritical95(df);
    const moe = tcrit * (s / Math.sqrt(n));
    errPct = (moe / m) * 100;
  }

  // required sample size for ±3% mean error at 95%
  let nReq = NaN;
  if(Number.isFinite(s) && m > 0){
    const target = 0.03;
    // usamos aproximación conservadora con t≈1.96 (porque n aún es desconocido);
    // si ya hay n, podemos usar tcrit actual para estimación más realista:
    const z = 1.96;
    const nCalc = Math.pow((z * s) / (target * m), 2);
    nReq = Math.ceil(nCalc);
    if(nReq < 2) nReq = 2;
  }

  return {n, mean:m, median:med, p10, p90, stdev:s, errPct, nReq, tcrit};
}

function computeCapacity(stats){
  if(!stats || !Number.isFinite(stats.median) || stats.median <= 0) return null;

  const shift = safeNum("shiftSel");
  const hours = safeNum("hoursSel");
  const machines = safeNum("machinesSel");
  const eff = safeNum("effPct") / 100;
  const pzsOp = safeNum("pzsOpSel");

  const lunch = safeNum("lunchSel");
  const chg = safeNum("chgSel");
  const s5 = safeNum("s5Sel");
  const mnt = safeNum("mntSel");
  const oth = safeNum("othSel");
  const shared = safeNum("sharedSel");
  const dt = safeNum("dtSel");

  const scrap = safeNum("scrapSel") / 100;
  const A = safeNum("aSel") / 100;
  const P = safeNum("pSel") / 100;
  const Q = safeNum("qSel") / 100;

  const totalMin = shift * hours * 60;
  const lossMin = lunch + chg + s5 + mnt + oth + shared + dt;

  // GUARDRAIL: pérdidas no pueden superar el día
  const availMin = Math.max(0, totalMin - lossMin);
  const overLoss = (lossMin > totalMin);

  const availSec = availMin * 60;

  const cycles = (availSec * eff * machines) / stats.median;
  const grossPzs = cycles * pzsOp;

  const oee = A * P * Q;
  const yieldNet = (1 - scrap) * oee;
  const netPzs = grossPzs * yieldNet;

  return {
    totalMin, lossMin, availMin, overLoss,
    median: stats.median,
    grossPzs, netPzs,
    yieldNet, oee, scrap, A, P, Q
  };
}

function recalcAll(){
  const laps = readAllLaps();

  $("kpiCount").textContent = String(laps.length);
  $("kpiLastLap").textContent = laps.length ? laps[laps.length-1].toFixed(2) : "—";

  const st = computeStats(laps);

  if(!st){
    $("stMean").textContent = "—";
    $("stMedian").textContent = "—";
    $("stP1090").textContent = "—";
    $("stStd").textContent = "—";
    $("stN").textContent = "—";
    $("stErr").textContent = "—";
    $("stNreq").textContent = "—";
    $("stMsg").textContent = "—";
    $("sampleNote").textContent = "Samples: 0 / — · Est. error: — (95%) – Sample too small for ±3% – use only as reference.";

    $("capAvailMin").textContent = "—";
    $("capMedian").textContent = "—";
    $("capGross").textContent = "—";
    $("capNet").textContent = "—";
    $("capContract").textContent = fmtInt(safeNum("contractDay"));
    $("capGap").textContent = "—";
    $("capYield").textContent = "—";
    $("capNotes").textContent = "Sin laps → sin CT.";
    updateBadge($("capBadge"), "warn", "No data");
    return;
  }

  $("stMean").textContent = fmtNum(st.mean, 2);
  $("stMedian").textContent = fmtNum(st.median, 2);
  $("stP1090").textContent = `${fmtNum(st.p10,2)} / ${fmtNum(st.p90,2)}`;
  $("stStd").textContent = fmtNum(st.stdev, 2);
  $("stN").textContent = `${st.n}`;

  const errTxt = Number.isFinite(st.errPct) ? `±${fmtNum(st.errPct,1)}%` : "—";
  $("stErr").textContent = errTxt;
  $("stNreq").textContent = Number.isFinite(st.nReq) ? `${st.nReq}` : "—";

  const nReqTxt = Number.isFinite(st.nReq) ? st.nReq : NaN;
  const msg =
    Number.isFinite(st.errPct) && Number.isFinite(nReqTxt)
      ? `Samples: ${st.n} / ${nReqTxt} · Est. error: ±${fmtNum(st.errPct,1)}% (95%, t=${fmtNum(st.tcrit,3)}) – ` +
        (st.n >= nReqTxt ? "OK for ±3% target." : "Sample too small for ±3% – use only as reference.")
      : `Samples: ${st.n} · Est. error: — (95%) – use only as reference.`;

  $("stMsg").textContent = msg;
  $("sampleNote").textContent = msg;

  const cap = computeCapacity(st);
  const contract = safeNum("contractDay");

  if(!cap){
    $("capAvailMin").textContent = "—";
    $("capMedian").textContent = "—";
    $("capGross").textContent = "—";
    $("capNet").textContent = "—";
    $("capContract").textContent = fmtInt(contract);
    $("capGap").textContent = "—";
    $("capYield").textContent = "—";
    $("capNotes").textContent = "CT inválido.";
    updateBadge($("capBadge"), "warn", "Check CT");
    return;
  }

  const lossFlag = cap.overLoss ? " ⚠️ pérdidas > día" : "";
  $("capAvailMin").textContent = `${fmtInt(cap.availMin)} / ${fmtInt(cap.totalMin)} (loss ${fmtInt(cap.lossMin)})${lossFlag}`;
  $("capMedian").textContent = fmtNum(cap.median, 2);

  $("capGross").textContent = fmtInt(cap.grossPzs);
  $("capNet").textContent = fmtInt(cap.netPzs);
  $("capContract").textContent = fmtInt(contract);

  const gap = cap.netPzs - contract;
  $("capGap").textContent = `${fmtInt(gap)} (${gap >= 0 ? "surplus" : "short"})`;

  const yieldPct = cap.yieldNet * 100;
  const oeePct = cap.oee * 100;
  $("capYield").textContent = `Yield ${fmtNum(yieldPct,1)}% · OEE ${fmtNum(oeePct,1)}% · Scrap ${fmtNum(cap.scrap*100,1)}%`;

  const effPct = safeNum("effPct");
  $("capNotes").textContent =
    cap.overLoss
      ? "Guardrail: tus pérdidas exceden el tiempo total del día. Available se fuerza a 0."
      : `Calc: availSec*eff(${effPct}%) * machines / medianCT * pzsOp. Net aplica (1-scrap)*A*P*Q.`;

  if(cap.overLoss){
    updateBadge($("capBadge"), "warn", "Loss>Day");
  } else if(contract <= 0){
    updateBadge($("capBadge"), "warn", "No contract");
  } else if(cap.netPzs >= contract){
    updateBadge($("capBadge"), "good", "OK");
  } else {
    updateBadge($("capBadge"), "bad", "Not OK");
  }
}

/* =========================
   EVENTOS
   ========================= */
$("btnStart").addEventListener("click", (e)=>{
  delayedAction(e.currentTarget, async ()=> startTimer());
});
$("btnLap").addEventListener("click", (e)=>{
  delayedAction(e.currentTarget, async ()=>{
    const lap = lapTimer();
    if(lap == null) return;
    const cur = $("autoLog").value.trim();
    $("autoLog").value = cur ? (cur + ", " + lap.toFixed(2)) : lap.toFixed(2);
    recalcAll();
  });
});
$("btnReset").addEventListener("click", (e)=>{
  delayedAction(e.currentTarget, async ()=> resetAll());
});

$("rawTimes").addEventListener("input", ()=> recalcAll());

[
 "procName","modeSel","effPct","contractDay",
 "opsSel","shiftSel","hoursSel","machinesSel","pzsOpSel","methodSel",
 "lunchSel","chgSel","s5Sel","mntSel","othSel","sharedSel",
 "scrapSel","aSel","pSel","qSel","dtSel"
].forEach(id=>{
  $(id).addEventListener("change", ()=> recalcAll());
  $(id).addEventListener("input", ()=> recalcAll());
});

/* =========================
   COPIAR POR SECCIÓN
   ========================= */
async function copyText(text){ await navigator.clipboard.writeText(text); }

function buildConfigText(){
  return [
    "=== Configuración de Medición ===",
    `Proceso: ${$("procName").value || ""}`,
    `Modo: ${$("modeSel").value}`,
    `Eficiencia %: ${$("effPct").value}`,
    `Contrato (pzs/día): ${$("contractDay").value}`,
  ].join("\n");
}
function buildSummaryText(){
  const laps = readAllLaps();
  return [
    "=== Resumen ===",
    `Laps: ${laps.length}`,
    `Último Lap (s): ${laps.length ? laps[laps.length-1].toFixed(2) : ""}`,
    $("sampleNote").textContent
  ].join("\n");
}
function buildRawText(){
  return [
    "=== Datos Crudos de Tiempo ===",
    `Manual: ${$("rawTimes").value.trim()}`,
    `Auto: ${$("autoLog").value.trim()}`
  ].join("\n");
}
function buildWBText(){
  return [
    "=== WB – Inputs de Capacidad ===",
    `Operadores: ${$("opsSel").value}`,
    `Shift: ${$("shiftSel").value}`,
    `Hours: ${$("hoursSel").value}`,
    `Machines: ${$("machinesSel").value}`,
    `Pzs/Op: ${$("pzsOpSel").value}`,
    `Método: ${$("methodSel").value}`,
    "",
    `Lunch (min): ${$("lunchSel").value}`,
    `Changeover (min): ${$("chgSel").value}`,
    `5s (min): ${$("s5Sel").value}`,
    `Maintenance (min): ${$("mntSel").value}`,
    `Other (min): ${$("othSel").value}`,
    `Capacidad compartida (min): ${$("sharedSel").value}`,
    "",
    `Scrap %: ${$("scrapSel").value}`,
    `A %: ${$("aSel").value}`,
    `P %: ${$("pSel").value}`,
    `Q %: ${$("qSel").value}`,
    `DT no planeado (min): ${$("dtSel").value}`,
  ].join("\n");
}
function buildCapText(){
  return [
    "=== Contract vs Capacity Summary ===",
    `Available time (min/day): ${$("capAvailMin").textContent}`,
    `Median CT (s): ${$("capMedian").textContent}`,
    `Gross capacity (pzs/day): ${$("capGross").textContent}`,
    `Net capacity (pzs/day): ${$("capNet").textContent}`,
    `Contract (pzs/day): ${$("capContract").textContent}`,
    `Gap vs contract: ${$("capGap").textContent}`,
    `Yield factors: ${$("capYield").textContent}`,
    `Notes: ${$("capNotes").textContent}`
  ].join("\n");
}
function buildStatsText(){
  return [
    "=== Stats Focus ===",
    `Mean (s): ${$("stMean").textContent}`,
    `Median (s): ${$("stMedian").textContent}`,
    `P10/P90 (s): ${$("stP1090").textContent}`,
    `Std dev (s): ${$("stStd").textContent}`,
    `Samples: ${$("stN").textContent}`,
    `95% error (±%): ${$("stErr").textContent}`,
    `Req samples for ±3%: ${$("stNreq").textContent}`,
    `Message: ${$("stMsg").textContent}`
  ].join("\n");
}

$("copy-config").addEventListener("click", (e)=> delayedAction(e.currentTarget, async ()=> copyText(buildConfigText())));
$("copy-summary").addEventListener("click", (e)=> delayedAction(e.currentTarget, async ()=> copyText(buildSummaryText())));
$("copy-raw").addEventListener("click", (e)=> delayedAction(e.currentTarget, async ()=> copyText(buildRawText())));
$("copy-wb").addEventListener("click", (e)=> delayedAction(e.currentTarget, async ()=> copyText(buildWBText())));
$("copy-cap").addEventListener("click", (e)=> delayedAction(e.currentTarget, async ()=> copyText(buildCapText())));
$("copy-stats").addEventListener("click", (e)=> delayedAction(e.currentTarget, async ()=> copyText(buildStatsText())));

// init
recalcAll();
</script>

</div>
</body>
</html>
